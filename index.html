<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EDAFY Basin Insights</title>
<link rel="icon" type="image/svg+xml" href="edafy-logo.svg">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  /* AFED Digital ‚Äî Light theme */
  --bg:#F4F6FA;--bg2:#FFFFFF;--bg3:#F0F2F8;--bg4:#E8ECF5;
  /* EDAFY Purple sidebar ‚Äî darkened to match reference */
  --sb:#30094F;--sb2:#2D1B69;--sb3:#4A2D8F;--sb-accent:#7C5FE0;
  --brand:#FF6B2B;--brand2:#E55A1A;
  --cyan:#0088CC;--gold:#C07800;--green:#00875A;--red:#D93025;--amber:#C07800;
  --purple:#6B46C1;--purple2:#7B5FE0;
  --t1:#1A1D2E;--t2:#4A5568;--t3:#8896A5;--t4:#C5CEE0;
  --b1:rgba(107,70,193,.12);--b2:rgba(107,70,193,.25);
  --sb-b:rgba(255,255,255,.07);
  --card-shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);
  --card-shadow-hover:0 4px 12px rgba(0,0,0,.12);
  --glow:0 0 20px rgba(107,70,193,.15);
  --sb-width:232px
}
html{height:100%}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--t1);height:100%;margin:0}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sb{position:fixed;left:0;top:0;bottom:0;width:var(--sb-width);background:var(--sb);display:flex;flex-direction:column;z-index:200;transition:width .28s cubic-bezier(.4,0,.2,1);overflow:hidden;box-shadow:2px 0 12px rgba(0,0,0,.15)}
.sb.collapsed{width:56px}
.sb-logo{padding:16px 16px 14px;border-bottom:1px solid var(--sb-b);flex-shrink:0;background:rgba(0,0,0,.15)}
.sb-brand{display:flex;align-items:center;gap:10px;margin-bottom:5px}
.sb-brand-icon{width:30px;height:30px;flex-shrink:0}
.sb-brand-texts{overflow:hidden;white-space:nowrap;transition:opacity .2s}
.sb.collapsed .sb-brand-texts{opacity:0;width:0}
.sb-brand-name{font-size:10px;font-weight:700;letter-spacing:2px;color:rgba(255,255,255,.9);text-transform:uppercase}
.sb-brand-sub{font-size:7px;letter-spacing:1px;color:var(--brand);font-weight:600;text-transform:uppercase}
.sb-product-wrap{overflow:hidden;white-space:nowrap;transition:opacity .2s}
.sb.collapsed .sb-product-wrap{opacity:0}
.sb-product{font-size:15px;font-weight:900;letter-spacing:2.5px;color:#fff}
.sb-product-sub{font-size:7px;letter-spacing:2px;color:rgba(255,255,255,.45);margin-top:1px;text-transform:uppercase}

/* Collapse button */
.sb-collapse{position:absolute;top:50%;right:-13px;transform:translateY(-50%);width:26px;height:26px;background:var(--sb3);border:2px solid rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:300;transition:all .2s;color:rgba(255,255,255,.8);font-size:11px;font-weight:700}
.sb-collapse:hover{background:var(--purple2);border-color:rgba(255,255,255,.5)}

.sb-sec{font-size:8px;letter-spacing:2px;color:rgba(255,255,255,.35);text-transform:uppercase;padding:14px 16px 4px;white-space:nowrap;overflow:hidden;transition:opacity .2s}
.sb.collapsed .sb-sec{opacity:0}
.nav{display:flex;align-items:center;gap:10px;padding:8px 16px;cursor:pointer;transition:all .18s;border-left:3px solid transparent;font-size:12px;color:rgba(255,255,255,.65);user-select:none;white-space:nowrap;overflow:hidden;position:relative}
.nav:hover{background:rgba(255,255,255,.08);color:#fff;border-left-color:rgba(255,255,255,.3)}
.nav.on{background:rgba(123,95,224,.3);color:#fff;border-left-color:var(--purple2)}
.nav svg{width:15px;height:15px;flex-shrink:0;opacity:.8}
.nav.on svg{opacity:1}
.nav-label{overflow:hidden;transition:opacity .2s,width .28s}
.sb.collapsed .nav-label{opacity:0;width:0}
.sb.collapsed .nav{padding:8px;justify-content:center;border-left:none;border-radius:0}
.sb.collapsed .nav.on{background:rgba(123,95,224,.4)}
/* Tooltip for collapsed */
.sb.collapsed .nav::after{content:attr(data-tip);position:absolute;left:60px;background:#1A1D2E;color:#fff;font-size:11px;padding:5px 10px;border-radius:5px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:400;box-shadow:0 4px 12px rgba(0,0,0,.3)}
.sb.collapsed .nav:hover::after{opacity:1}

.sb-notif{display:flex;align-items:center;justify-content:space-between;padding:6px 16px;font-size:10px;background:rgba(217,48,37,.15);border-left:3px solid #D93025;margin:4px 0;overflow:hidden;white-space:nowrap}
.sb.collapsed .sb-notif{justify-content:center;padding:6px 8px}
.sb.collapsed .sb-notif span:first-child{display:none}
.notif-count{background:var(--red);color:#fff;font-size:8px;font-weight:700;padding:1px 5px;border-radius:8px;flex-shrink:0}
.sb-btm{margin-top:auto;padding:12px 16px;border-top:1px solid var(--sb-b);flex-shrink:0;overflow:hidden}
.avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--purple2),#4A2E99);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}
.sb-user{overflow:hidden;white-space:nowrap;transition:opacity .2s}
.sb.collapsed .sb-user{opacity:0;width:0}
.sb.collapsed.hover-expanded{width:232px}
.sb.collapsed.hover-expanded .sb-brand-texts,.sb.collapsed.hover-expanded .sb-product-wrap,.sb.collapsed.hover-expanded .sb-sec,.sb.collapsed.hover-expanded .sb-notif,.sb.collapsed.hover-expanded .sb-user{opacity:1;width:auto}
.sb.collapsed.hover-expanded .sb-notif{justify-content:space-between;padding:6px 16px}
.sb.collapsed.hover-expanded .sb-notif span:first-child{display:block}
.sb.collapsed.hover-expanded .nav-label{opacity:1;width:auto}
.sb.collapsed.hover-expanded .nav{padding:8px 16px;justify-content:flex-start;border-radius:5px}
.sb.collapsed.hover-expanded .nav::after{display:none}

/* TOPBAR */
.tb{display:flex;align-items:center;gap:14px;padding:0 26px;height:56px;border-bottom:1px solid #E2E8F0;background:rgba(255,255,255,.95);backdrop-filter:blur(14px);position:sticky;top:0;z-index:100;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.tb-title{font-size:13px;font-weight:700;letter-spacing:.5px;white-space:nowrap;color:var(--t1)}
.tb-div{width:1px;height:18px;background:#E2E8F0}
.nlp{flex:1;max-width:540px;position:relative}
.nlp input{width:100%;background:var(--bg4);border:1px solid #D1D9E6;border-radius:6px;padding:8px 14px 8px 34px;color:var(--t1);font-family:'Segoe UI',sans-serif;font-size:12px;outline:none;transition:border-color .2s,box-shadow .2s}
.nlp input:focus{border-color:var(--purple);box-shadow:0 0 0 3px rgba(107,70,193,.1)}
.nlp input::placeholder{color:var(--t3)}
.nlp-ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--purple);font-size:13px;pointer-events:none}
.nlp-suggestions{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1px solid #E2E8F0;border-radius:6px;box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;z-index:300}
.nlp-sug-item{padding:9px 14px;font-size:11px;color:var(--t2);cursor:pointer;transition:all .15s;border-bottom:1px solid #F0F2F8}
.nlp-sug-item:last-child{border-bottom:none}
.nlp-sug-item:hover{background:rgba(107,70,193,.05);color:var(--purple)}
.nlp-sug-item span{color:var(--t3);font-size:10px}
.tb-acts{display:flex;gap:7px;margin-left:auto}
.ic-btn{width:33px;height:33px;border-radius:6px;border:1px solid #E2E8F0;background:var(--bg4);color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .2s;position:relative}
.ic-btn:hover{border-color:var(--purple);color:var(--purple);background:#fff}
.ic-btn .dot{position:absolute;top:5px;right:5px;width:6px;height:6px;border-radius:50%;background:var(--red);border:2px solid #fff}

/* MAIN */
.main{margin-left:var(--sb-width);height:100vh;overflow-y:auto;overflow-x:hidden;transition:margin-left .28s cubic-bezier(.4,0,.2,1);scrollbar-width:thin;scrollbar-color:rgba(107,70,193,.25) transparent;position:relative;z-index:1}
.main::-webkit-scrollbar{width:6px}
.main::-webkit-scrollbar-track{background:transparent}
.main::-webkit-scrollbar-thumb{background:rgba(107,70,193,.3);border-radius:3px}
.main::-webkit-scrollbar-thumb:hover{background:rgba(107,70,193,.55)}
.main.sb-collapsed{margin-left:56px}
.content{padding:14px 18px}

/* TABS */
.tabs{display:flex;border-bottom:2px solid #E2E8F0;margin-bottom:14px;gap:2px}
.tab{padding:9px 16px;font-size:11px;font-weight:600;letter-spacing:.4px;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s;text-transform:uppercase;user-select:none;border-radius:4px 4px 0 0}
.tab:hover{color:var(--t1);background:rgba(107,70,193,.04)}
.tab.on{color:var(--purple);border-bottom-color:var(--purple);background:rgba(107,70,193,.05)}
.tab.inactive{color:#B0BEC5;cursor:not-allowed;pointer-events:none;opacity:.55;position:relative}
.tab.inactive::after{content:'üîí';font-size:8px;margin-left:5px;opacity:.7}

/* SECTIONS */
.sec{display:none;opacity:0;transform:translateY(12px)}.sec.on{display:block;animation:pageIn .32s cubic-bezier(.4,0,.2,1) both}.sec-exit{animation:pageOut .18s ease forwards}@keyframes pageOut{to{opacity:0;transform:translateY(-8px)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* KPI */
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.kpi{background:#fff;border:1px solid #E2E8F0;border-radius:10px;padding:12px 14px;position:relative;overflow:hidden;cursor:pointer;transition:all .2s;box-shadow:var(--card-shadow)}
.kpi:hover{box-shadow:var(--card-shadow-hover);border-color:#CBD5E0}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
/* .kpi.c::before{background:linear-gradient(90deg,var(--cyan),transparent)} */
/* .kpi.g::before{background:linear-gradient(90deg,var(--gold),transparent)} */
/* .kpi.e::before{background:linear-gradient(90deg,var(--green),transparent)} */
/* .kpi.r::before{background:linear-gradient(90deg,var(--red),transparent)} */
.kpi-lbl{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:8px}
.kpi-val{font-size:28px;font-weight:700;letter-spacing:-1px;line-height:1}
.kpi.c .kpi-val{color:var(--cyan)}
.kpi.g .kpi-val{color:var(--gold)}
.kpi.e .kpi-val{color:var(--green)}
.kpi.r .kpi-val{color:var(--red)}
.kpi-sub{font-size:10px;color:var(--t3);margin-top:5px}
.kpi-delta{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;margin-top:5px}
.up{background:#DCFCE7;color:#166534}
.dn{background:#FEE2E2;color:#991B1B}

/* CARDS */
.card{background:#fff;border:1px solid #E2E8F0;border-radius:10px;overflow:hidden;transition:all .2s;box-shadow:var(--card-shadow);display:flex;flex-direction:column}
.card-tall{max-height:none}
.card-short{max-height:none}
.card-auto{max-height:none}
/* Card body scrolls when content exceeds a sensible height */
.card .cb{flex:1;overflow-y:auto;min-height:0;max-height:340px;scrollbar-width:thin;scrollbar-color:rgba(107,70,193,.3) transparent}
.card .cb::-webkit-scrollbar{width:5px}
.card .cb::-webkit-scrollbar-track{background:transparent}
.card .cb::-webkit-scrollbar-thumb{background:rgba(107,70,193,.3);border-radius:3px}
.card .cb::-webkit-scrollbar-thumb:hover{background:rgba(107,70,193,.6)}
/* Override for cards that need taller or unlimited body */
.card-tall .cb{max-height:480px}
.card-auto .cb{max-height:none;overflow-y:visible}
/* Canvas/SVG cards should never clip */
.card:has(canvas) .cb,.card:has(svg) .cb{max-height:none;overflow-y:visible}
.card:hover{box-shadow:var(--card-shadow-hover)}
.ch{display:flex;align-items:center;justify-content:space-between;padding:9px 14px;border-bottom:1px solid #F0F2F8;background:#FAFBFF}
.ct{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--t2)}
.ca{font-size:10px;color:var(--purple);cursor:pointer;letter-spacing:.5px;text-transform:uppercase;transition:opacity .2s}
.ca:hover{opacity:.7}
.cb{padding:14px 16px}

/* GRID */
.g21{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-bottom:14px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:14px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}

/* TABLE */
table{width:100%;border-collapse:collapse}
th{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);padding:8px 10px;text-align:left;border-bottom:2px solid #E2E8F0;white-space:nowrap;cursor:pointer;user-select:none;background:#FAFBFF}
th:hover{color:var(--purple)}
td{padding:9px 10px;font-size:11px;color:var(--t2);border-bottom:1px solid #F0F4FA;transition:background .15s}
tr:last-child td{border-bottom:none}
tr:hover td{background:#F7F8FF;color:var(--t1)}
#cp-table tbody tr{cursor:pointer;transition:background .12s}
#cp-table tbody tr:hover td{background:rgba(107,70,193,.06);color:var(--t1)}
.sort-ico{font-size:9px;margin-left:3px}

/* SCORES */
.sbar{display:flex;align-items:center;gap:7px}
.sbar-track{flex:1;height:5px;background:#E8ECF5;border-radius:3px;overflow:hidden}
.sbar-fill{height:100%;border-radius:3px;transition:width .4s ease}
.sval{font-size:11px;font-weight:700;min-width:26px;text-align:right}
.tl{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:10px;font-size:9px;font-weight:700;letter-spacing:.5px}
.tl-g{background:#DCFCE7;color:#166534}
.tl-a{background:#FEF3C7;color:#92400E}
.tl-r{background:#FEE2E2;color:#991B1B}
.btn-view{font-size:10px;letter-spacing:.8px;text-transform:uppercase;background:var(--purple);color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;transition:opacity .15s}
.btn-view:hover{opacity:.82}
.badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:8px;font-size:9px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.bc{background:#EFF6FF;color:#1D4ED8}
.bg{background:#FEF3C7;color:#92400E}
.be{background:#DCFCE7;color:#166534}

/* FORMS */
.fg{display:flex;flex-direction:column;gap:3px}
.fg label{font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--t3)}
.fc{width:100%;background:#fff;border:1px solid #D1D9E6;border-radius:5px;padding:5px 8px;color:var(--t1);font-family:'Segoe UI',sans-serif;font-size:11px;outline:none;appearance:none;transition:border-color .2s,box-shadow .2s}
.fc:focus{border-color:var(--purple);box-shadow:0 0 0 3px rgba(107,70,193,.1)}
.fc option{background:#fff;color:var(--t1)}
.btn{background:linear-gradient(135deg,var(--purple),#4A2E99);color:#fff;border:none;border-radius:6px;padding:8px 18px;font-family:'Segoe UI',sans-serif;font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;cursor:pointer;transition:all .2s;box-shadow:0 2px 8px rgba(107,70,193,.25)}
.btn:hover{opacity:.9;box-shadow:0 4px 16px rgba(107,70,193,.35);transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn2{background:transparent;color:var(--purple);border:1px solid #B794F4;border-radius:6px;padding:7px 14px;font-family:'Segoe UI',sans-serif;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;transition:all .2s}
.btn2:hover{background:rgba(107,70,193,.07);border-color:var(--purple)}
.btn2.danger{color:var(--red);border-color:#FCA5A5}
.btn2.danger:hover{background:#FEF2F2}

/* SLIDERS */
.slider{-webkit-appearance:none;appearance:none;width:100%;height:5px;border-radius:3px;background:#E2E8F0;outline:none;cursor:pointer}
.slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--purple);cursor:pointer;box-shadow:0 2px 6px rgba(107,70,193,.4);border:2px solid #fff;transition:transform .15s}
.slider::-webkit-slider-thumb:hover{transform:scale(1.15)}

/* MAP */
.map-area{height:300px;background:#EEF2FF;border-radius:6px;position:relative;overflow:hidden;cursor:pointer;border:1px solid #E2E8F0}
.map-area svg{width:100%;height:100%}
.map-lbl{position:absolute;top:10px;left:10px;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--purple);background:rgba(255,255,255,.9);padding:3px 8px;border-radius:3px;border:1px solid #E2E8F0}
.map-legend{position:absolute;bottom:10px;right:10px;background:rgba(255,255,255,.95);border:1px solid #E2E8F0;border-radius:6px;padding:7px 11px;font-size:9px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.map-legend-item{display:flex;align-items:center;gap:5px;color:var(--t2);margin-bottom:3px}
.map-legend-item:last-child{margin-bottom:0}
.ldot{width:7px;height:7px;border-radius:50%}
.map-tooltip{position:absolute;pointer-events:none;background:#fff;border:1px solid #E2E8F0;border-radius:6px;padding:8px 12px;font-size:10px;display:none;z-index:10;min-width:160px;box-shadow:0 4px 16px rgba(0,0,0,.12)}
.map-tooltip-name{font-weight:700;color:var(--t1);margin-bottom:4px}
.map-tooltip-row{display:flex;justify-content:space-between;gap:16px;color:var(--t2);margin-top:2px}
.map-tooltip-val{color:var(--purple);font-weight:700}

/* ANALOGUE ITEMS */
.ana-item{display:grid;grid-template-columns:28px 1fr auto;gap:10px;align-items:center;padding:9px 0;border-bottom:1px solid #F0F4FA;cursor:pointer;transition:all .15s}
.ana-item:last-child{border-bottom:none}
.ana-item:hover .ana-name{color:var(--purple)}
.ana-item.selected{background:#F7F4FF;border-radius:4px;padding-left:6px;padding-right:6px}
.ana-rank{font-size:10px;font-weight:700;color:var(--t3);text-align:center}
.ana-name{font-size:12px;font-weight:600;color:var(--t1);transition:color .15s}
.ana-meta{font-size:9px;color:var(--t3);margin-top:1px}
.sim-score{font-size:17px;font-weight:700;line-height:1}
.sim-lbl{font-size:8px;letter-spacing:1px;color:var(--t3);text-transform:uppercase}

/* RISK ELEMENTS */
.risk-el{background:var(--bg4);border:1px solid #E2E8F0;border-radius:6px;padding:11px 13px}
.risk-el-name{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px}
.risk-el-val{font-size:15px;font-weight:700;color:var(--purple);min-width:38px;text-align:right}
.risk-bench{font-size:8px;margin-top:3px}

/* DIST BARS */
.dist-wrap{display:flex;gap:2px;height:42px;align-items:flex-end;margin-bottom:7px}
.dbar{flex:1;min-width:4px;border-radius:1px 1px 0 0;transition:opacity .2s,height .3s}
.dbar:hover{opacity:.6}
.pcts{display:flex;justify-content:space-between}
.pct-g{text-align:center}
.pct-lbl{font-size:7px;color:var(--t3);letter-spacing:1px}
.pct-v{font-size:11px;font-weight:700;color:var(--t1)}

/* MC BARS */
.mc-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid #F0F4FA}
.mc-row:last-child{border-bottom:none}
.mc-lbl{font-size:10px;font-weight:700;width:34px}
.mc-track{flex:1;height:8px;background:#E8ECF5;border-radius:4px;overflow:hidden}
.mc-fill{height:100%;border-radius:4px;transition:width .8s ease}
.mc-val{font-size:12px;font-weight:700;width:90px;text-align:right;color:var(--t1)}

/* GOV PIPELINE */
.gov-pipe{display:flex;gap:0;margin-bottom:18px}
.gov-stage{flex:1;background:var(--bg4);border:1px solid #E2E8F0;padding:10px 8px;text-align:center;position:relative;cursor:pointer;transition:all .2s}
.gov-stage:not(:last-child)::after{content:'‚ñ∂';position:absolute;right:-8px;top:50%;transform:translateY(-50%);color:var(--t3);font-size:9px;z-index:2;background:var(--bg4);padding:0 1px}
.gov-stage:first-child{border-radius:5px 0 0 5px}
.gov-stage:last-child{border-radius:0 5px 5px 0}
.gov-stage.act{background:rgba(107,70,193,.08);border-color:var(--purple)}
.gov-stage:hover:not(.act){background:rgba(107,70,193,.04)}
.gov-sn{font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:3px}
.gov-sc{font-size:18px;font-weight:700;color:var(--t1)}
.gov-stage.act .gov-sn{color:var(--purple)}
.gov-stage.act .gov-sc{color:var(--purple)}

/* AUDIT */
.audit-row{display:grid;grid-template-columns:125px 70px 1fr 70px;gap:8px;align-items:center;padding:7px 0;border-bottom:1px solid #F0F4FA;font-size:10px}
.audit-row:last-child{border-bottom:none}
.a-time{color:var(--t3)}
.a-user{color:var(--purple)}
.a-act{color:var(--t2)}

/* LOADING */
.loading-bar{height:3px;background:linear-gradient(90deg,transparent,var(--purple),transparent);animation:loadbar 1.2s ease infinite;display:none}
.loading-bar.show{display:block}
@keyframes loadbar{0%{transform:translateX(-100%)}100%{transform:translateX(400%)}}

/* TOAST */
.toast-wrap{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:9999}
.toast{background:#fff;border:1px solid #E2E8F0;border-radius:8px;padding:10px 16px;font-size:11px;color:var(--t1);box-shadow:0 4px 20px rgba(0,0,0,.12);animation:toastIn .3s ease;display:flex;align-items:center;gap:10px;min-width:260px}
.toast.success{border-color:rgba(0,135,90,.3);background:#F0FFF8}
.toast.error{border-color:rgba(217,48,37,.3);background:#FFF5F5}
.toast.warning{border-color:rgba(192,120,0,.3);background:#FFFBF0}
@keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:500;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:24px;max-width:640px;width:95%;box-shadow:0 20px 60px rgba(0,0,0,.2);position:relative;animation:modalIn .25s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.modal-close{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer;transition:color .2s;line-height:1}
.modal-close:hover{color:var(--t1)}
.modal-title{font-size:14px;font-weight:700;color:var(--t1);margin-bottom:6px}
.modal-sub{font-size:11px;color:var(--t3);margin-bottom:18px}

/* PROGRESS RING */
.prog-ring{display:inline-block;position:relative}
.prog-ring circle{transition:stroke-dashoffset .6s ease}

/* DRAG DROP */
.drop-zone{border:2px dashed #CBD5E0;border-radius:8px;padding:28px;text-align:center;cursor:pointer;transition:all .25s;position:relative;background:var(--bg4)}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--purple);background:rgba(107,70,193,.04)}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}

/* INGESTION PROGRESS */
.ing-file{display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--bg4);border-radius:4px;margin-bottom:6px;animation:fadeUp .3s ease;border:1px solid #E2E8F0}
.ing-prog{flex:1;height:3px;background:#E2E8F0;border-radius:2px;overflow:hidden}
.ing-prog-fill{height:100%;border-radius:2px;background:var(--purple);transition:width .1s linear}

/* SCROLLBAR */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:#F0F2F8}
::-webkit-scrollbar-thumb{background:#CBD5E0;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--purple2)}

/* PULSE */
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.edafy-popup .leaflet-popup-content-wrapper{border-radius:8px;padding:1;box-shadow:0 4px 20px rgba(0,0,0,.15)}
.edafy-popup .leaflet-popup-content{margin:12px 14px;line-height:1.5}
.map-area{border-radius:8px;overflow:hidden;min-height:280px}
@keyframes pageIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse-dot{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.5);opacity:.5}}
.pulse{animation:pulse 2s infinite}

/* NLP RESULT PANEL */
.nlp-result{position:fixed;top:56px;left:var(--sb-width);right:0;z-index:90;background:rgba(255,255,255,.97);border-bottom:2px solid var(--purple);box-shadow:0 4px 20px rgba(107,70,193,.12);padding:0;display:none;animation:nlpSlide .3s cubic-bezier(.16,1,.3,1);transition:left .28s cubic-bezier(.4,0,.2,1)}
.nlp-result.show{display:block}
.nlp-result.sb-collapsed{left:56px}
@keyframes nlpSlide{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
.nlp-result-inner{display:flex;align-items:flex-start;gap:14px;padding:12px 26px}
.nlp-result-icon{font-size:20px;color:var(--purple);margin-top:1px;flex-shrink:0}
.nlp-result-body{flex:1;min-width:0}
.nlp-result-q{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:5px}
.nlp-result-a{font-size:13px;color:var(--t1);line-height:1.5}
.nlp-result-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.nlp-result-tag{display:inline-flex;align-items:center;padding:4px 10px;border-radius:5px;background:rgba(107,70,193,.1);border:1px solid rgba(107,70,193,.2);color:var(--purple);font-size:10px;font-weight:700;cursor:pointer;transition:all .15s}
.nlp-result-tag:hover{background:rgba(107,70,193,.18)}
.nlp-result-close{flex-shrink:0;background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer;padding:2px 4px;transition:color .2s;margin-top:-2px;line-height:1}
.nlp-result-close:hover{color:var(--t1)}
.content.nlp-open{padding-top:38px}

/* CHECKBOX */
.chk{display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px;color:var(--t2);user-select:none}
.chk input{accent-color:var(--purple);width:13px;height:13px}

/* Detail sub-tabs */
#dtab-bar{display:grid;grid-template-columns:repeat(6,1fr);border-bottom:2px solid #E2E8F0;padding:0;margin-top:10px}
.dtab{padding:10px 4px;font-size:10px;font-weight:600;letter-spacing:.4px;text-transform:uppercase;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;white-space:nowrap;text-align:center;overflow:hidden;text-overflow:ellipsis}
.dtab:hover{color:var(--t1);background:#F7F8FF}
.dtab.on{color:var(--purple);border-bottom-color:var(--purple);background:#F4F0FF}

/* Horizontal analogue result cards */
.ana-hcard{flex:0 0 168px;background:#fff;border:1px solid #E2E8F0;border-radius:8px;padding:11px 12px;cursor:pointer;transition:all .18s;margin-right:8px;box-shadow:var(--card-shadow)}
.ana-hcard:hover{border-color:#B794F4;box-shadow:var(--card-shadow-hover)}
.ana-hcard.selected{border-color:var(--purple);background:#F7F4FF;box-shadow:0 0 0 2px rgba(107,70,193,.15)}

/* Mini stat grid */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.stat-cell{background:var(--bg4);border-radius:6px;padding:7px 9px;border:1px solid #EEF2F8}
.stat-lbl{font-size:7px;letter-spacing:1.2px;text-transform:uppercase;color:var(--t3);margin-bottom:2px}
.stat-val{font-size:12px;font-weight:700;color:var(--t1)}
.stat-val.cyan{color:var(--cyan)}
.stat-val.gold{color:var(--gold)}
.stat-val.green{color:var(--green)}
.stat-val.red{color:var(--red)}
.stat-val.amber{color:var(--amber)}

/* Mineral bar chart */
.min-row{display:flex;align-items:center;gap:7px;padding:3px 0}
.min-name{font-size:9px;color:var(--t2);min-width:100px}
.min-track{flex:1;height:6px;background:#EEF2F8;border-radius:3px;overflow:hidden}
.min-fill{height:100%;border-radius:3px;transition:width .5s ease}
.min-pct{font-size:9px;font-weight:700;min-width:28px;text-align:right}

/* Alert pill */
.alert-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:12px;font-size:9px;font-weight:700;margin-top:4px}
.ap-warn{background:rgba(255,170,0,.12);color:var(--amber);border:1px solid rgba(255,170,0,.25)}
.ap-ok{background:rgba(0,229,160,.1);color:var(--green);border:1px solid rgba(0,229,160,.2)}
.ap-bad{background:rgba(255,77,106,.1);color:var(--red);border:1px solid rgba(255,77,106,.2)}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="map-area" id="world-map" style="position:relative">
  <div id="leaflet-map" style="width:100%;height:100%;border-radius:8px;z-index:1"></div>
  <div id="map-tt" class="map-tooltip" style="display:none;position:absolute;z-index:9999;pointer-events:none"></div>
</div>
<!-- SIDEBAR -->
<nav class="sb" id="sidebar">
  <div class="sb-collapse" id="sb-toggle" onclick="toggleSidebar()">‚Äπ</div>

  <div class="sb-logo">
    <div class="sb-brand">
      <img src="edafy-logo.svg" class="sb-brand-icon" alt="EDAFY">
      <div class="sb-brand-texts">
        <div class="sb-brand-name">AFED Digital</div>
        <div class="sb-brand-sub">EDAFY Intelligence</div>
      </div>
    </div>
    <div class="sb-product-wrap">
      <div class="sb-product">EDAFY</div>
      <div class="sb-product-sub">Basin Insights</div>
    </div>
  </div>

  <div class="sb-notif">
    <span style="color: white;">3 records need review</span>
    <span class="notif-count">3</span>
  </div>

  <div class="sb-sec">Analytics</div>
  <div class="nav on" onclick="goTo('portfolio',this)" data-tip="Portfolio Dashboard">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="6" height="6" rx="1"/><rect x="9" y="1" width="6" height="6" rx="1"/><rect x="1" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/></svg>
    <span class="nav-label">Portfolio Dashboard</span>
  </div>
  <div class="nav" onclick="goTo('basins',this)" data-tip="Basin Catalogue">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><ellipse cx="8" cy="8" rx="6" ry="3"/><line x1="2" y1="8" x2="14" y2="8"/></svg>
    <span class="nav-label">Basin Catalogue</span>
  </div>
  <div class="nav" onclick="goTo('analogues',this)" data-tip="Analogue Engine">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5" cy="5" r="3"/><circle cx="11" cy="11" r="3"/><line x1="7" y1="7" x2="9" y2="9" stroke-dasharray="2"/></svg>
    <span class="nav-label">Analogue Engine</span>
  </div>
  <div class="nav" onclick="goTo('params',this)" data-tip="Parameter Library">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="1,12 4,7 7,10 10,5 13,8 15,3"/></svg>
    <span class="nav-label">Parameter Library</span>
  </div>
  <div class="nav" onclick="goTo('risk',this)" data-tip="Risk & Uncertainty">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="8,2 15,14 1,14"/><line x1="8" y1="7" x2="8" y2="10"/><circle cx="8" cy="12" r=".5" fill="currentColor"/></svg>
    <span class="nav-label">Risk & Uncertainty</span>
  </div>
  <div class="nav" onclick="goTo('screening',this)" data-tip="Basin Screening">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="14" height="14" rx="2"/><line x1="4" y1="5" x2="12" y2="5"/><line x1="4" y1="8" x2="10" y2="8"/><line x1="4" y1="11" x2="8" y2="11"/></svg>
    <span class="nav-label">Basin Screening</span>
  </div>

  <div class="sb-sec">Data</div>
  <div class="nav" onclick="goTo('ingestion',this)" data-tip="Data Ingestion">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 1v10M4 7l4 4 4-4"/><rect x="1" y="12" width="14" height="3" rx="1"/></svg>
    <span class="nav-label">Data Ingestion</span>
  </div>
  <div class="nav" onclick="goTo('governance',this)" data-tip="Governance">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 1l7 3v4c0 4-7 7-7 7S1 12 1 8V4l7-3z"/></svg>
    <span class="nav-label">Governance & Audit</span>
  </div>

  <div class="sb-btm">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="avatar">VJ</div>
      <div class="sb-user">
        <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,.9)">VJ</div>
        <div style="font-size:9px;color:rgba(255,255,255,.45)">Exploration Geologist</div>
      </div>
    </div>
  </div>
</nav>

<!-- MAIN -->
<main class="main">
  <!-- NLP RESULT PANEL ‚Äî fixed banner below topbar -->
  <div class="nlp-result" id="nlp-result">
    <div class="nlp-result-inner">
      <div class="nlp-result-icon">‚¨°</div>
      <div class="nlp-result-body">
        <div class="nlp-result-q" id="nlp-q">AI Query</div>
        <div class="nlp-result-a" id="nlp-a"></div>
        <div class="nlp-result-tags" id="nlp-tags"></div>
      </div>
      <button class="nlp-result-close" onclick="closeNLP()" title="Dismiss">‚úï</button>
    </div>
  </div>

  <div class="loading-bar" id="loadbar"></div>
  <header class="tb">
    <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
      <span class="tb-title" id="tb-title">Portfolio Dashboard</span>
      <span style="color:var(--t4);font-size:10px">/</span>
      <span id="breadcrumb-section" style="font-size:10px;color:var(--t3);font-weight:600"></span>
      <span id="breadcrumb-sub" style="font-size:10px;color:var(--t3)"></span>
    </div>
    <div class="tb-div"></div>
    <div class="nlp" id="nlp-wrap">
      <span class="nlp-ico">‚¨°</span>
      <input id="nlp-input" type="text" placeholder='Ask: "Show Eocene sandstones >3000m SE Asia API >30¬∞"' autocomplete="off"
        oninput="nlpSuggest(this.value)" onkeydown="nlpKey(event)" onfocus="showSuggestions()" onblur="setTimeout(hideSuggestions,200)">
      <div class="nlp-suggestions" id="nlp-sug"></div>
    </div>
    <div class="tb-acts">
      <button class="ic-btn" onclick="showAlerts()" title="Alerts"><span class="dot"></span>
        <svg viewBox="0 0 16 16" width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2a5 5 0 0 1 5 5v2l1.5 2.5h-13L3 9V7a5 5 0 0 1 5-5z"/><path d="M6.5 13.5a1.5 1.5 0 0 0 3 0"/></svg>
      </button>
      <button class="ic-btn" onclick="showHelp()" title="Help" style="font-weight:700;font-size:12px">?</button>
    </div>
  </header>

  <div class="content" id="main-content">

    <!-- ==================== PORTFOLIO ==================== -->
    <section class="sec on" id="sec-portfolio">
      <div class="tabs" id="portfolio-tabs">
        <div class="tab on" onclick="switchPortfolioTab('overview',this)">Overview</div>
        <div class="tab"    onclick="switchPortfolioTab('resource',this)">Resource Summary</div>
        <div class="tab"    onclick="switchPortfolioTab('risk',this)">Risk Profile</div>
      </div>

      <!-- OVERVIEW PANEL -->
      <div id="pt-overview-panel">
        <div class="kpis" style="margin-bottom:10px">
          <div class="kpi c" onclick="goTo('basins',null)" style="cursor:pointer">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <!-- <div style="width:26px;height:26px;border-radius:6px;background:rgba(0,136,204,.12);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">üó∫Ô∏è</div> -->
              <div class="kpi-lbl" style="font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--t3)">Active Basins</div>
            </div>
            <div class="kpi-val" id="kpi-basins" style="font-size:26px;font-weight:800;color:var(--cyan)">612</div>
            <div class="kpi-sub" style="font-size:10px;color:var(--t3);margin-top:2px">Global catalogue</div>
            <div class="kpi-delta up" style="margin-top:6px;font-size:9px">‚Üë +18 this quarter</div>
            <div style="margin-top:8px;height:3px;background:rgba(0,136,204,.12);border-radius:2px;overflow:hidden"><div style="height:100%;width:72%;background:var(--cyan);border-radius:2px"></div></div>
          </div>
          <div class="kpi g" onclick="goTo('analogues',null)" style="cursor:pointer">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <!-- <div style="width:26px;height:26px;border-radius:6px;background:rgba(192,120,0,.12);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">‚öóÔ∏è</div> -->
              <div class="kpi-lbl" style="font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--t3)">Analogue Intervals</div>
            </div>
            <div class="kpi-val counter" id="kpi-analogues" data-target="5847" style="font-size:26px;font-weight:800;color:var(--gold)">0</div>
            <div class="kpi-sub" style="font-size:10px;color:var(--t3);margin-top:2px">Reservoir records</div>
            <div class="kpi-delta up" style="margin-top:6px;font-size:9px">‚Üë +340 new</div>
            <div style="margin-top:8px;height:3px;background:rgba(192,120,0,.12);border-radius:2px;overflow:hidden"><div style="height:100%;width:85%;background:var(--gold);border-radius:2px"></div></div>
          </div>
          <div class="kpi e">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <!-- <div style="width:26px;height:26px;border-radius:6px;background:rgba(0,135,90,.12);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">üìà</div> -->
              <div class="kpi-lbl" style="font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--t3)">Avg Prospectivity</div>
            </div>
            <div class="kpi-val" id="kpi-prospectivity" style="font-size:26px;font-weight:800;color:var(--green)">67.4</div>
            <div class="kpi-sub" style="font-size:10px;color:var(--t3);margin-top:2px">Portfolio composite score</div>
            <div class="kpi-delta up" style="margin-top:6px;font-size:9px">‚Üë +3.2 pts</div>
            <div style="margin-top:8px;height:3px;background:rgba(0,135,90,.12);border-radius:2px;overflow:hidden"><div id="kpi-prosp-bar" style="height:100%;width:67%;background:var(--green);border-radius:2px"></div></div>
          </div>
          <div class="kpi r" onclick="goTo('governance',null)" style="cursor:pointer">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <!-- <div style="width:26px;height:26px;border-radius:6px;background:rgba(217,48,37,.12);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">üõ°Ô∏è</div> -->
              <div class="kpi-lbl" style="font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--t3)">Data Quality</div>
            </div>
            <div class="kpi-val" id="kpi-quality" style="font-size:26px;font-weight:800;color:var(--green)">96.1%</div>
            <div class="kpi-sub" style="font-size:10px;color:var(--t3);margin-top:2px">Completeness score</div>
            <div class="kpi-delta dn" style="margin-top:6px;font-size:9px" id="kpi-quality-delta">‚Üì 12 flagged</div>
            <div style="margin-top:8px;height:3px;background:rgba(217,48,37,.12);border-radius:2px;overflow:hidden"><div id="kpi-quality-bar" style="height:100%;width:96%;background:var(--green);border-radius:2px"></div></div>
          </div>
        </div>

      <div class="g21">
        <div class="card card-tall">
          <div class="ch"><span class="ct">Global Basin Map ‚Äî Prospectivity Overlay</span><span class="ca" onclick="goTo('basins',null)">Full Catalogue ‚Üí</span></div>
          <div class="cb" style="padding:0">
            <div class="map-area" id="world-map" style="height:240px;border-radius:8px;overflow:hidden;position:relative">
              <div id="portfolio-leaflet-map" style="width:100%;height:100%;z-index:1"></div>
              <div class="map-lbl" style="z-index:10;position:absolute;top:10px;left:10px">PROSPECTIVITY HEAT MAP ‚Äî GLOBAL VIEW</div>
              <div class="map-legend" style="z-index:10;position:absolute;bottom:10px;left:10px;background:rgba(255,255,255,.92);padding:5px 10px;border-radius:5px;display:flex;gap:10px;font-size:9px">
                <div class="map-legend-item"><div class="ldot" style="background:#00875A"></div>High (>70)</div>
                <div class="map-legend-item"><div class="ldot" style="background:#C07800"></div>Med (40‚Äì70)</div>
                <div class="map-legend-item"><div class="ldot" style="background:#D93025"></div>Low (<40)</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="ch">
            <span class="ct">Activity Feed</span>
            <div style="display:flex;gap:6px;align-items:center">
              <button class="btn2" style="font-size:9px;padding:4px 10px;background:linear-gradient(135deg,rgba(107,70,193,.1),rgba(0,136,204,.08));border-color:rgba(107,70,193,.3);color:var(--purple)" onclick="getAIPortfolioInsight()">AI Insight</button>
              <span class="ca" onclick="goTo('governance',null)">Audit Log ‚Üí</span>
            </div>
          </div>
          <div class="cb" style="" id="activity-feed">
          </div>
        </div>
      </div>

      <div class="g3">
        <div class="card">
          <div class="ch"><span class="ct">Top Basins by Prospectivity</span><span class="ca" onclick="goTo('screening',null)">Full Ranking ‚Üí</span></div>
          <div class="cb" style="padding:10px 12px" id="top-basins-table"></div>
        </div>

        <div class="card">
          <div class="ch"><span class="ct">Resource Distribution P10/P50/P90</span></div>
          <div class="cb">
            <svg id="resource-dist-svg" viewBox="0 0 260 150" xmlns="http://www.w3.org/2000/svg" width="100%">
              <defs>
                <linearGradient id="rg" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stop-color="#00C8FF" stop-opacity=".28"/>
                  <stop offset="100%" stop-color="#00C8FF" stop-opacity=".02"/>
                </linearGradient>
              </defs>
              <line x1="30" y1="10" x2="30" y2="122" stroke="rgba(0,200,255,.2)" stroke-width="1"/>
              <line x1="30" y1="122" x2="250" y2="122" stroke="rgba(0,200,255,.2)" stroke-width="1"/>
              <path d="M35,120 C50,120 60,112 75,87 C90,60 100,27 130,14 C160,27 170,60 185,87 C200,112 210,120 245,120" fill="url(#rg)" stroke="#00C8FF" stroke-width="1.5"/>
              <line x1="80" y1="10" x2="80" y2="120" stroke="#FF4D6A" stroke-width="1" stroke-dasharray="3,2"/>
              <line x1="130" y1="10" x2="130" y2="120" stroke="#00E5A0" stroke-width="1.5" stroke-dasharray="3,2"/>
              <line x1="183" y1="10" x2="183" y2="120" stroke="#F0A500" stroke-width="1" stroke-dasharray="3,2"/>
              <text x="74" y="136" fill="#FF4D6A" font-size="7" text-anchor="middle" font-family="Arial">P10</text>
              <text x="130" y="136" fill="#00E5A0" font-size="7" text-anchor="middle" font-family="Arial">P50</text>
              <text x="183" y="136" fill="#F0A500" font-size="7" text-anchor="middle" font-family="Arial">P90</text>
              <text id="rv-p10" x="74" y="8" fill="#FF4D6A" font-size="7" text-anchor="middle" font-family="Arial">142 MMboe</text>
              <text id="rv-p50" x="130" y="8" fill="#00E5A0" font-size="7" text-anchor="middle" font-family="Arial">387 MMboe</text>
              <text id="rv-p90" x="183" y="8" fill="#F0A500" font-size="7" text-anchor="middle" font-family="Arial">920 MMboe</text>
            </svg>
          </div>
        </div>

        <div class="card">
          <div class="ch"><span class="ct">Data Quality Summary</span></div>
          <div class="cb" id="dq-summary" ></div>
        </div>
      </div>
      </div><!-- end overview panel -->

      <!-- RESOURCE SUMMARY PANEL -->
      <div id="pt-resource-panel" style="display:none">

        <!-- KPI strip -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px" id="rs-kpis"></div>

        <div class="g2" style="margin-bottom:14px">
          <!-- STOIIP Waterfall by Basin -->
          <div class="card">
            <div class="ch">
              <span class="ct">Gross STOIIP by Basin (MMboe)</span>
              <button class="btn2" onclick="exportTable('rs-basin-table','resource_summary')">Export</button>
            </div>
            <div class="cb" style="padding:0;overflow-x:auto">
              <table id="rs-basin-table">
                <thead><tr>
                  <th>Basin</th><th>Analogues</th><th>P10 (MMboe)</th><th>P50 (MMboe)</th><th>P90 (MMboe)</th>
                  <th>Avg œÜ%</th><th>Avg k (mD)</th><th>HC Phase</th><th>Status</th>
                </tr></thead>
                <tbody id="rs-basin-tbody"></tbody>
              </table>
            </div>
          </div>

          <!-- Stacked bar chart by phase -->
          <div class="card">
            <div class="ch"><span class="ct">Resource Distribution by HC Phase</span><span style="font-size:9px;color:var(--t3)">P50 estimates</span></div>
            <div class="cb" id="rs-phase-chart"></div>
          </div>
        </div>

        <div class="g3">
          <!-- Porosity distribution histogram -->
          <div class="card">
            <div class="ch"><span class="ct">Porosity Distribution</span><span style="font-size:9px;color:var(--t3)">All analogues</span></div>
            <div class="cb"><canvas id="rs-por-hist" style="width:100%;height:220px;display:block"></canvas></div>
          </div>
          <!-- Permeability distribution -->
          <div class="card">
            <div class="ch"><span class="ct">Permeability Distribution</span><span style="font-size:9px;color:var(--t3)">Log scale</span></div>
            <div class="cb"><canvas id="rs-perm-hist" style="width:100%;height:220px;display:block"></canvas></div>
          </div>
          <!-- Recovery Factor by lithology -->
          <div class="card">
            <div class="ch"><span class="ct">Recovery Factor by Lithology</span></div>
            <div class="cb"><canvas id="rs-rf-bar" style="width:100%;height:220px;display:block"></canvas></div>
          </div>
        </div>
      </div>

      <!-- RISK PROFILE PANEL -->
      <div id="pt-risk-panel" style="display:none">

        <!-- KPI strip -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px" id="rp-kpis"></div>

        <div class="g2" style="margin-bottom:14px">
          <!-- GCoS distribution table -->
          <div class="card card-tall">
            <div class="ch"><span class="ct">Geological Chance of Success ‚Äî Basin Summary</span></div>
            <div class="cb" style="padding:0;overflow-x:auto">
              <table id="rp-gcos-table">
                <thead><tr>
                  <th>Basin</th><th>Score</th><th>GCoS Est.</th>
                  <th title="Source Rock">Source ‚ìò</th>
                  <th title="Reservoir Quality">Reservoir ‚ìò</th>
                  <th title="Seal Integrity">Seal ‚ìò</th>
                  <th title="Trap & Migration">Trap ‚ìò</th>
                  <th>Risk Tier</th>
                </tr></thead>
                <tbody id="rp-gcos-tbody"></tbody>
              </table>
            </div>
          </div>

          <!-- Risk radar chart -->
          <div class="card">
            <div class="ch"><span class="ct">Portfolio Risk Radar</span><span style="font-size:9px;color:var(--t3)">Average across all basins</span></div>
            <div class="cb">
              <div style="position:relative;height:280px;width:100%">
                <canvas id="rp-radar-canvas"></canvas>
              </div>
              <div style="margin-top:8px;font-size:9px;color:var(--t3);text-align:center">Purple = portfolio average ¬∑ Dashed = industry benchmark (65%)</div>
            </div>
          </div>
        </div>

        <!-- Overpressure & geochemical risk flags -->
        <div class="g2">
          <div class="card card-tall">
            <div class="ch"><span class="ct">Overpressure Flags</span><span style="font-size:9px;color:var(--red)" id="rp-op-count"></span></div>
            <div class="cb" id="rp-overpressure" ></div>
          </div>
          <div class="card card-tall">
            <div class="ch"><span class="ct">Geochemical Risk Flags</span><span style="font-size:9px;color:var(--amber)" id="rp-gc-count"></span></div>
            <div class="cb" id="rp-geochem-risk" ></div>
          </div>
        </div>
      </div>

    </section>
    <section class="sec" id="sec-basins">
      <div class="tabs" id="basin-tabs">
        <div class="tab on"  onclick="switchBasinTab('browse',this)">Browse</div>
        <div class="tab"     onclick="switchBasinTab('strat',this)">Stratigraphic</div>
        <div class="tab"     onclick="switchBasinTab('export',this)">Export</div>
      </div>
      
      <!-- BROWSE PANEL -->
      <div id="basin-browse-panel">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-bottom:16px">
        <div class="fg" style="flex:1;min-width:130px"><label>Keyword Search</label><input class="fc" id="basin-search" placeholder="e.g. Permian, Cretaceous‚Ä¶" oninput="filterBasins()"></div>
        <div class="fg" style="flex:1;min-width:120px"><label>Region</label><select class="fc" id="basin-region" onchange="filterBasins()"><option value="">All Regions</option><option>Middle East</option><option>Southeast Asia</option><option>North Africa</option><option>North America</option><option>Europe</option><option>South America</option></select></div>
        <div class="fg" style="flex:1;min-width:120px"><label>Tectonic Setting</label><select class="fc" id="basin-tecto" onchange="filterBasins()"><option value="">All Types</option><option>Passive Margin</option><option>Foreland</option><option>Rift Basin</option><option>Fold Belt</option><option>Intracratonic</option></select></div>
        <div class="fg" style="flex:1;min-width:100px"><label>HC Phase</label><select class="fc" id="basin-hc" onchange="filterBasins()"><option value="">All</option><option>Oil</option><option>Gas</option><option>Oil & Gas</option></select></div>
        <div class="fg" style="flex:1;min-width:100px"><label>Status</label><select class="fc" id="basin-status" onchange="filterBasins()"><option value="">All</option><option>Mature</option><option>Active</option><option>Frontier</option></select></div>
        <button class="btn" onclick="filterBasins()">Search</button>
        <button class="btn2" onclick="resetBasinFilters()">Reset</button>
      </div>

      <div class="card card-tall">
        <div class="ch">
          <span class="ct" id="basin-count">Basin Catalogue ‚Äî 612 Records</span>
          <div style="display:flex;gap:7px">
            <button class="btn2" onclick="exportTable('basin-table','basins')">Export Excel</button>
            <button class="btn2" onclick="exportBasinsGeoJSON(BASINS,'all_basins')">Export GeoJSON</button>
          </div>
        </div>
        <div class="cb" style="padding:0;overflow-x:auto">
          <table id="basin-table">
            <thead><tr>
              <th onclick="sortBasins('name')">Basin Name<span class="sort-ico">‚Üï</span></th>
              <th onclick="sortBasins('country')">Country / Region<span class="sort-ico">‚Üï</span></th>
              <th onclick="sortBasins('tectonic')">Tectonic Setting<span class="sort-ico">‚Üï</span></th>
              <th>Age Range</th><th>HC Phase</th>
              <th onclick="sortBasins('area')">Area (km¬≤)<span class="sort-ico">‚Üï</span></th>
              <th>Plays</th>
              <th onclick="sortBasins('score')">Prospectivity<span class="sort-ico">‚Üï</span></th>
              <th>Status</th>
              <th></th>
            </tr></thead>
            <tbody id="basin-tbody"></tbody>
          </table>
        </div>
      </div>
      </div><!-- end browse panel -->

      <!-- STRATIGRAPHIC PANEL -->
      <div id="basin-strat-panel" style="display:none">
        <div style="display:flex;gap:10px;align-items:flex-end;margin-bottom:16px;flex-wrap:wrap">
          <div class="fg" style="flex:1;max-width:280px">
            <label>Select Basin</label>
            <select class="fc" id="strat-basin-select" onchange="renderStratColumn(this.value)">
              <option value="">‚Äî Choose a basin ‚Äî</option>
            </select>
          </div>
          <div class="fg" style="flex:1;max-width:160px">
            <label>Display Mode</label>
            <select class="fc" id="strat-mode" onchange="renderStratColumn(document.getElementById('strat-basin-select').value)">
              <option value="age">Age Scale</option>
              <option value="depth">Depth Scale</option>
              <option value="thick">Thickness</option>
            </select>
          </div>
          <div class="fg" style="flex:1;max-width:160px">
            <label>Colour By</label>
            <select class="fc" id="strat-colour" onchange="renderStratColumn(document.getElementById('strat-basin-select').value)">
              <option value="lith">Lithology</option>
              <option value="hc">HC Potential</option>
              <option value="age">Geological Age</option>
            </select>
          </div>
          <button class="btn2" onclick="exportStratPDF()">Export PDF</button>
        </div>
        <div class="g2">
          <div class="card" style="min-height:520px">
            <div class="ch">
              <span class="ct" id="strat-title">Stratigraphic Column</span>
              <span style="font-size:9px;color:var(--t3)" id="strat-subtitle">Select a basin above</span>
            </div>
            <div class="cb" style="padding:0">
              <div id="strat-column-wrap" style="overflow-y:auto;max-height:560px;padding:12px">
                <div style="padding:60px;text-align:center;color:var(--t3)">
                  <!-- <div style="font-size:36px;margin-bottom:12px">ü™®</div> -->
                  <div style="font-size:12px;font-weight:600">Select a basin to view its stratigraphic column</div>
                  <div style="font-size:10px;margin-top:6px">Formation-by-formation breakdown with lithology, age, HC potential and seal quality</div>
                </div>
              </div>
            </div>
          </div>
          <div>
            <div class="card" style="margin-bottom:12px">
              <div class="ch"><span class="ct">Legend</span></div>
              <div class="cb" id="strat-legend">
                <div style="font-size:10px;color:var(--t3);padding:8px 0">Select a basin to see legend</div>
              </div>
            </div>
            <div class="card">
              <div class="ch"><span class="ct">Formation Details</span></div>
              <div class="cb" id="strat-detail">
                <div style="font-size:10px;color:var(--t3);padding:8px 0">Click a formation row to view details</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- EXPORT PANEL -->
      <div id="basin-export-panel" style="display:none">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:16px" id="export-format-cards"></div>
        <div class="g2" style="margin-bottom:14px">
          <div class="card">
            <div class="ch"><span class="ct">Export Configuration</span></div>
            <div class="cb">
              <div class="fg" style="margin-bottom:10px">
                <label>Basin Selection</label>
                <select class="fc" id="exp-basin-filter">
                  <option value="all">All Basins (15)</option>
                  <option value="mature">Mature basins only</option>
                  <option value="active">Active basins only</option>
                  <option value="frontier">Frontier basins only</option>
                  <option value="highscore">High prospectivity (‚â•70)</option>
                  <option value="custom">Custom selection</option>
                </select>
              </div>
              <div class="fg" style="margin-bottom:10px">
                <label>Fields to Include</label>
                <div id="exp-field-toggles" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px"></div>
              </div>
              <div class="fg" style="margin-bottom:14px">
                <label>Coordinate Reference System (GIS)</label>
                <select class="fc" id="exp-crs">
                  <option>WGS84 (EPSG:4326)</option>
                  <option>Web Mercator (EPSG:3857)</option>
                  <option>UTM Zone 37N (EPSG:32637)</option>
                </select>
              </div>
              <div style="display:flex;gap:7px;flex-wrap:wrap">
                <button class="btn" onclick="runExport('csv')">Export CSV</button>
                <button class="btn" onclick="runExport('json')">Export JSON</button>
                <button class="btn" onclick="runExport('excel')">Export Excel</button>
                <button class="btn2" onclick="runExport('gis')">Export GeoJSON</button>
                <button class="btn2" onclick="runExport('shapefile')">Export GIS Shapefile</button>
                <button class="btn2" onclick="runExport('pdf')">Basin Reports PDF</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="ch"><span class="ct">Data Completeness</span><span style="font-size:9px;color:var(--t3)">Per field, across all basins</span></div>
            <div class="cb" id="exp-completeness" ></div>
          </div>
        </div>
        <div class="card">
          <div class="ch"><span class="ct">Export History</span></div>
          <div class="cb" id="exp-history">
            <div style="font-size:10px;color:var(--t3);padding:8px 0;text-align:center">No exports yet in this session</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== ANALOGUES ==================== -->
    <section class="sec" id="sec-analogues">
      <div class="tabs" id="ana-tabs"><div class="tab on" onclick="switchAnalogueTab('search',this)">Analogue Search</div><div class="tab" id="ana-tab-compare" onclick="anaTabGuard('compare',this)">Comparison Table</div><div class="tab" id="ana-tab-similarity" onclick="anaTabGuard('similarity',this)">Similarity Analysis</div></div>

      <div id="ana-search-panel">
        <div class="card card-auto" style="margin-bottom:10px">
          <div class="ch"><span class="ct">Target Reservoir Profile</span><span class="ca" onclick="loadSavedSearch()">Load Saved ‚ñæ</span></div>
          <div class="cb">
            <!-- Section: Core Reservoir -->
            <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--purple);font-weight:700;margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid rgba(107,70,193,.15)">Core Reservoir Parameters</div>
            <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:8px">
              <div class="fg"><label>Lithology</label><select class="fc" id="s-lith"><option>Sandstone</option><option>Carbonate</option><option>Chalk</option><option>Conglomerate</option><option>Mixed</option></select></div>
              <div class="fg"><label>Depositional Env.</label><select class="fc" id="s-dep"><option>Deltaic</option><option>Fluvial</option><option>Shallow Marine</option><option>Deep Marine</option><option>Reef</option><option>Turbidite</option></select></div>
              <div class="fg"><label>Geological Age</label><select class="fc" id="s-age"><option>Eocene</option><option>Miocene</option><option>Cretaceous</option><option>Jurassic</option><option>Triassic</option><option>Oligocene</option><option>Paleocene</option></select></div>
              <div class="fg"><label>HC Phase</label><select class="fc" id="s-hc"><option>Oil</option><option>Gas</option><option>Condensate</option><option>Oil & Gas</option></select></div>
              <div class="fg"><label>Depth Min (mTVDSS)</label><input class="fc" id="s-dmin" type="number" value="2500" min="0"></div>
              <div class="fg"><label>Depth Max (mTVDSS)</label><input class="fc" id="s-dmax" type="number" value="4500" min="0"></div>
              <div class="fg"><label>API Gravity Min (¬∞)</label><input class="fc" id="s-apimin" type="number" value="28" min="0" max="60"></div>
              <div class="fg"><label>API Gravity Max (¬∞)</label><input class="fc" id="s-apimax" type="number" value="38" min="0" max="60"></div>
              <div class="fg"><label>Drive Mechanism</label><select class="fc" id="s-drive"><option>Any</option><option>Solution Gas Drive</option><option>Water Drive</option><option>Gas Cap Drive</option><option>Combination</option></select></div>
              <div class="fg"><label>Tectonic Setting</label><select class="fc" id="s-tecto"><option>Any</option><option>Passive Margin</option><option>Rift</option><option>Foreland</option><option>Fold Belt</option></select></div>
              <div class="fg"><label>Min Similarity Score</label><input class="fc" id="s-minsim" type="number" value="60" min="0" max="100"></div>
              <div class="fg" style="display:flex;align-items:flex-end;gap:6px;padding-bottom:2px">
                <label class="chk" style="margin-bottom:0"><input type="checkbox" id="s-adv-toggle" onchange="document.getElementById('s-adv-panel').style.display=this.checked?'block':'none'"> Advanced Filters</label>
              </div>
            </div>

            <!-- Advanced / Additional filters (hidden by default) -->
            <div id="s-adv-panel" style="display:none">

              <!-- Petrophysical Ranges -->
              <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--cyan);font-weight:700;margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid rgba(0,200,255,.12)">Petrophysical Ranges</div>
              <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:8px">
                <div class="fg"><label>Porosity Min (%)</label><input class="fc" id="s-pormin" type="number" placeholder="e.g. 15" min="0" max="50"></div>
                <div class="fg"><label>Porosity Max (%)</label><input class="fc" id="s-pormax" type="number" placeholder="e.g. 30" min="0" max="50"></div>
                <div class="fg"><label>Permeability Min (mD)</label><input class="fc" id="s-permmin" type="number" placeholder="e.g. 50" min="0"></div>
                <div class="fg"><label>Permeability Max (mD)</label><input class="fc" id="s-permmax" type="number" placeholder="e.g. 1000" min="0"></div>
                <div class="fg"><label>Net-to-Gross Min (%)</label><input class="fc" id="s-ntgmin" type="number" placeholder="e.g. 50" min="0" max="100"></div>
                <div class="fg"><label>Recovery Factor Min (%)</label><input class="fc" id="s-rfmin" type="number" placeholder="e.g. 25" min="0" max="100"></div>
                <div class="fg"><label>Effective Porosity (PHIE) Min</label><input class="fc" id="s-phiemin" type="number" placeholder="e.g. 12" min="0" max="40"></div>
                <div class="fg"><label>Water Saturation Max (Sw)</label><input class="fc" id="s-swmax" type="number" placeholder="e.g. 0.4" min="0" max="1" step="0.05"></div>
              </div>

              <!-- Geopressure Constraints -->
              <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--amber);font-weight:700;margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid rgba(240,165,0,.12)">Geopressure Constraints</div>
              <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:8px">
                <div class="fg"><label>Pressure Regime</label><select class="fc" id="s-preg"><option value="">Any</option><option>Normally pressured</option><option>Slightly overpressured</option><option>Moderately overpressured</option><option>Highly overpressured</option></select></div>
                <div class="fg"><label>Max Pressure Coefficient</label><input class="fc" id="s-pcmax" type="number" placeholder="e.g. 1.3" min="0.9" max="2.5" step="0.05"></div>
                <div class="fg"><label>Min Mud Weight (ppg)</label><input class="fc" id="s-mwmin" type="number" placeholder="e.g. 8.6" min="7" max="20" step="0.1"></div>
                <div class="fg"><label>Max Mud Weight (ppg)</label><input class="fc" id="s-mwmax" type="number" placeholder="e.g. 14" min="7" max="20" step="0.1"></div>
              </div>

              <!-- Geochemistry / Source Rock -->
              <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--green);font-weight:700;margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid rgba(0,229,160,.12)">Geochemistry & Source Rock</div>
              <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:8px">
                <div class="fg"><label>Kerogen Type</label><select class="fc" id="s-kero"><option value="">Any</option><option>Type I</option><option>Type II</option><option>Type II/III</option><option>Type III</option><option>Type II/IIS</option></select></div>
                <div class="fg"><label>Min TOC (%)</label><input class="fc" id="s-tocmin" type="number" placeholder="e.g. 1.5" min="0" max="20" step="0.1"></div>
                <div class="fg"><label>Maturity (Ro) Min</label><input class="fc" id="s-romin" type="number" placeholder="e.g. 0.5" min="0" max="4" step="0.05"></div>
                <div class="fg"><label>Maturity (Ro) Max</label><input class="fc" id="s-romax" type="number" placeholder="e.g. 1.3" min="0" max="4" step="0.05"></div>
                <div class="fg"><label>Oil Family</label><select class="fc" id="s-oilfam"><option value="">Any</option><option>Waxy</option><option>Paraffinic</option><option>Sulfur-rich</option><option>Mixed</option></select></div>
                <div class="fg"><label>Charge Volume</label><select class="fc" id="s-charge"><option value="">Any</option><option>Very High</option><option>High</option><option>Moderate</option><option>Low</option></select></div>
              </div>

              <!-- Fluid & Contaminants -->
              <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--red);font-weight:700;margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid rgba(255,77,106,.12)">Fluid Properties & Contaminants</div>
              <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:8px">
                <div class="fg"><label>Max H‚ÇÇS (ppm)</label><input class="fc" id="s-h2smax" type="number" placeholder="e.g. 100" min="0"></div>
                <div class="fg"><label>Max CO‚ÇÇ (%)</label><input class="fc" id="s-co2max" type="number" placeholder="e.g. 5" min="0" max="100" step="0.5"></div>
                <div class="fg"><label>Max Sulfur Content (%)</label><input class="fc" id="s-sulmax" type="number" placeholder="e.g. 1.0" min="0" max="10" step="0.1"></div>
                <div class="fg"><label>Bubble Point Min (bar)</label><input class="fc" id="s-pbmin" type="number" placeholder="e.g. 100" min="0"></div>
              </div>

              <!-- Geomechanics -->
              <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#B45309;font-weight:700;margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid rgba(180,83,9,.12)">Geomechanics</div>
              <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:8px">
                <div class="fg"><label>Stress Regime</label><select class="fc" id="s-stress"><option value="">Any</option><option>Normal faulting</option><option>Strike-slip</option><option>Reverse faulting</option></select></div>
                <div class="fg"><label>Min UCS (MPa)</label><input class="fc" id="s-ucsmin" type="number" placeholder="e.g. 20" min="0"></div>
                <div class="fg"><label>Sand Production Risk</label><select class="fc" id="s-sandprod"><option value="">Any</option><option>Low</option><option>Moderate</option><option>High</option></select></div>
                <div class="fg"><label>Fracture Density</label><select class="fc" id="s-fracdns"><option value="">Any</option><option>Low</option><option>Moderate</option><option>High</option></select></div>
              </div>

              <!-- Thermal & Basin Modelling -->
              <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#DC2626;font-weight:700;margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid rgba(220,38,38,.12)">Thermal & Basin Modelling</div>
              <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:8px">
                <div class="fg"><label>Min Heat Flow (mW/m¬≤)</label><input class="fc" id="s-hfmin" type="number" placeholder="e.g. 50" min="0"></div>
                <div class="fg"><label>Max Heat Flow (mW/m¬≤)</label><input class="fc" id="s-hfmax" type="number" placeholder="e.g. 100" min="0"></div>
                <div class="fg"><label>Min Thermal Gradient (¬∞C/km)</label><input class="fc" id="s-tgradmin" type="number" placeholder="e.g. 25" min="0"></div>
                <div class="fg"><label>Max Burial Depth (m)</label><input class="fc" id="s-burialmax" type="number" placeholder="e.g. 6000" min="0"></div>
              </div>

              <!-- Environmental & Commercial -->
              <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#059669;font-weight:700;margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid rgba(5,150,105,.12)">Environmental & Commercial</div>
              <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-bottom:8px">
                <div class="fg"><label>Protected Area</label><select class="fc" id="s-protect"><option value="">Any</option><option value="no">Not Protected</option><option value="yes">Protected</option></select></div>
                <div class="fg"><label>Hydrate Risk</label><select class="fc" id="s-hydrate"><option value="">Any</option><option>Low</option><option>Moderate</option><option>High</option></select></div>
                <div class="fg"><label>Min NPV‚ÇÅ‚ÇÄ (MUSD)</label><input class="fc" id="s-npvmin" type="number" placeholder="e.g. 100" min="0"></div>
                <div class="fg"><label>Fiscal Regime</label><select class="fc" id="s-fiscal"><option value="">Any</option><option>PSC</option><option>Concession / Royalty-Tax</option><option>Service Contract</option><option>Joint Venture</option></select></div>
              </div>
            </div>

            <div style="display:flex;gap:7px;align-items:center;flex-wrap:wrap">
              <button class="btn" onclick="runSearch()" id="search-btn">‚¨° Run Search</button>
              <button class="btn2" onclick="saveSearch()">Save Profile</button>
              <button class="btn2" onclick="clearSearchFilters()">Clear All</button>
            </div>
          </div>
        </div>

        <div id="ana-results-area" style="display:none">
          <!-- Results list ‚Äî compact horizontal strip -->
          <div class="card card-auto" style="margin-bottom:10px">
            <div class="ch">
              <span class="ct" id="ana-count-lbl">Results</span>
              <div style="display:flex;gap:7px;align-items:center">
                <label class="chk"><input type="checkbox" onchange="toggleAIMode(this)"> AI Discovery Mode</label>
                <button class="btn2" style="background:linear-gradient(135deg,rgba(107,70,193,.1),rgba(0,136,204,.08));border-color:rgba(107,70,193,.3);color:var(--purple)" onclick="getAIAnalogueInsight()">AI Interpret</button>
                <button class="btn2" onclick="exportAnalogues()">Export PDF</button>
              </div>
            </div>
            <!-- Horizontal scrollable results strip -->
            <div style="display:flex;gap:0;overflow-x:auto;padding:6px 8px" id="ana-results-list"></div>
          </div>

          <!-- Detail panel ‚Äî full width, all 6 tabs visible -->
          <div class="card card-tall" id="ana-detail-card" style="overflow:hidden">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 18px 0">
              <div>
                <div id="ana-detail-name" style="font-size:13px;font-weight:700;color:var(--t1)">Select an analogue above</div>
                <div id="ana-detail-sub" style="font-size:10px;color:var(--t3);margin-top:2px"></div>
              </div>
              <div id="ana-match-badge" style="display:none;text-align:right">
                <div id="ana-match-val" style="font-size:28px;font-weight:700;line-height:1"></div>
                <div style="font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--t3)">Match Score</div>
              </div>
            </div>
            <!-- Full-width tab bar ‚Äî all tabs always visible -->
            <div id="dtab-bar" style="overflow-x:auto;white-space:nowrap">
              <div class="dtab on" onclick="switchDetailTab('reservoir',this)">Reservoir</div>
              <div class="dtab" onclick="switchDetailTab('geopressure',this)">Geopressure</div>
              <div class="dtab" onclick="switchDetailTab('geochem',this)">Geochemistry</div>
              <div class="dtab" onclick="switchDetailTab('mineral',this)">Mineralogy</div>
              <div class="dtab" onclick="switchDetailTab('fluid',this)">Fluid PVT</div>
              <div class="dtab" onclick="switchDetailTab('diagenesis',this)">Diagenesis</div>
              <div class="dtab" onclick="switchDetailTab('petrophysics',this)">Petrophysics</div>
              <div class="dtab" onclick="switchDetailTab('geomechanics',this)">Geomechanics</div>
              <div class="dtab" onclick="switchDetailTab('thermal',this)">Thermal</div>
              <div class="dtab" onclick="switchDetailTab('environmental',this)">Environmental</div>
              <div class="dtab" onclick="switchDetailTab('commercial',this)">Commercial</div>
            </div>
            <div style="padding:16px 18px;max-height:480px;overflow-y:auto" id="ana-detail-body">
              <div style="color:var(--t3);font-size:11px;padding:32px 0;text-align:center">Click an analogue card above to explore its full dataset</div>
            </div>
          </div>
        </div>
      </div>

      <!-- CROSSPLOT PANEL -->
      <div id="ana-crossplot-panel" style="display:none">
        <!-- Analogue context banner -->
        <div id="cp-analogue-banner" style="display:none;margin-bottom:12px;padding:10px 16px;background:linear-gradient(135deg,rgba(107,70,193,.08),rgba(0,136,204,.06));border:1px solid rgba(107,70,193,.2);border-radius:8px;display:flex;align-items:center;gap:10px">
          <div style="width:8px;height:8px;border-radius:50%;background:var(--red);flex-shrink:0"></div>
          <div>
            <span style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Active Analogue ‚Äî </span>
            <span id="cp-analogue-name" style="font-size:11px;font-weight:700;color:var(--purple)"></span>
            <span id="cp-analogue-meta" style="font-size:10px;color:var(--t3);margin-left:8px"></span>
          </div>
          <div style="margin-left:auto;display:flex;gap:6px">
            <span id="cp-analogue-sim" style="font-size:11px;font-weight:700"></span>
          </div>
        </div>
        <div class="g21">
          <div class="card">
            <div class="ch">
              <div><span class="ct" id="cp-chart-title">Search Results Cross-Plot</span><div id="cp-data-source" style="font-size:9px;color:var(--t3);margin-top:2px"></div></div>
              <button class="btn2" onclick="exportChart()">Export PNG</button>
            </div>
            <div class="cb">
              <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
                <div class="fg" style="flex:1"><label>X Axis</label>
                  <select class="fc" id="cp-x" onchange="onCrossplotAxisChange()">
                    <option value="por">Porosity (%)</option>
                    <option value="perm">Permeability (mD)</option>
                    <option value="rf">Recovery Factor (%)</option>
                    <option value="ntg">Net-to-Gross (%)</option>
                    <option value="depth">Depth (mTVDSS)</option>
                    <option value="api">API Gravity (¬∞)</option>
                    <option value="gor">GOR (scf/bbl)</option>
                    <option value="gross_pay">Gross Pay (m)</option>
                    <option value="net_pay">Net Pay (m)</option>
                    <option value="temp">Temperature (¬∞C)</option>
                    <option value="sw">Water Saturation</option>
                  </select>
                </div>
                <div class="fg" style="flex:1"><label>Y Axis</label>
                  <select class="fc" id="cp-y" onchange="onCrossplotAxisChange()">
                    <option value="perm">Permeability (mD)</option>
                    <option value="por">Porosity (%)</option>
                    <option value="rf">Recovery Factor (%)</option>
                    <option value="ntg">Net-to-Gross (%)</option>
                    <option value="depth">Depth (mTVDSS)</option>
                    <option value="api">API Gravity (¬∞)</option>
                    <option value="gor">GOR (scf/bbl)</option>
                    <option value="gross_pay">Gross Pay (m)</option>
                    <option value="net_pay">Net Pay (m)</option>
                    <option value="temp">Temperature (¬∞C)</option>
                    <option value="sw">Water Saturation</option>
                  </select>
                </div>
                <div class="fg" style="flex:1"><label>Color By</label><select class="fc" id="cp-col" onchange="renderCrossplot()"><option value="lith">Lithology</option><option value="basin">Basin</option><option value="age">Age</option><option value="hc">HC Phase</option><option value="sim">Match Score</option></select></div>
                <div class="fg" style="flex:1"><label>Show</label><select class="fc" id="cp-show" onchange="renderCrossplot()"><option value="all">All Search Results</option><option value="top5">Top 5 Only</option><option value="top10">Top 10 Only</option><option value="selected">Selected Analogues</option></select></div>
              </div>
              <!-- Target reservoir values row -->
              <div style="display:flex;gap:8px;margin-bottom:12px;padding:8px 10px;background:rgba(255,77,106,.04);border:1px dashed rgba(255,77,106,.25);border-radius:6px;align-items:center;flex-wrap:wrap">
                <span style="font-size:9px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:1px;white-space:nowrap">‚äô Target</span>
                <div class="fg" style="flex:1;min-width:80px">
                  <label style="color:rgba(255,77,106,.8)" id="cp-tx-label">Target X</label>
                  <input class="fc" id="cp-tx" type="number" placeholder="auto" style="border-color:rgba(255,77,106,.3)" onchange="renderCrossplot()">
                </div>
                <div class="fg" style="flex:1;min-width:80px">
                  <label style="color:rgba(255,77,106,.8)" id="cp-ty-label">Target Y</label>
                  <input class="fc" id="cp-ty" type="number" placeholder="auto" style="border-color:rgba(255,77,106,.3)" onchange="renderCrossplot()">
                </div>
                <button class="btn2" style="font-size:9px;padding:4px 9px;border-color:rgba(255,77,106,.3);color:var(--red);white-space:nowrap;margin-top:14px" onclick="autoFillTarget()">Auto-fill from Search</button>
                <button class="btn2" style="font-size:9px;padding:4px 9px;margin-top:14px" onclick="document.getElementById('cp-tx').value='';document.getElementById('cp-ty').value='';renderCrossplot()">Clear</button>
              </div>
              <canvas id="cp-canvas" width="520" height="320" style="width:100%;border-radius:4px;background:#FFFFFF"></canvas>
              <div style="display:flex;gap:12px;margin-top:8px;font-size:9px;flex-wrap:wrap" id="cp-legend"></div>
            </div>
          </div>
          <div class="card">
            <div class="ch"><span class="ct" id="cp-table-title">Data Points</span><span id="cp-point-count" style="font-size:9px;color:var(--t3)"></span></div>
            <div class="cb" >
              <table id="cp-table"><thead><tr><th>Analogue</th><th id="cp-h-x">Por%</th><th id="cp-h-y">Perm mD</th><th>Match</th><th>Lith</th></tr></thead><tbody id="cp-tbody"></tbody></table>
            </div>
          </div>
        </div>
      </div>

      <!-- COMPARISON PANEL -->
      <div id="ana-compare-panel" style="display:none">
        <!-- Analogue context banner for comparison -->
        <div id="cmp-analogue-banner" style="display:none;margin-bottom:12px;padding:10px 16px;background:linear-gradient(135deg,rgba(0,136,204,.07),rgba(0,229,160,.05));border:1px solid rgba(0,136,204,.2);border-radius:8px">
          <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Active Analogue in Context</div>
          <div style="display:flex;align-items:center;gap:10px">
            <span id="cmp-analogue-name" style="font-size:12px;font-weight:700;color:var(--cyan)"></span>
            <span id="cmp-analogue-sub" style="font-size:10px;color:var(--t3)"></span>
            <span id="cmp-analogue-score" style="font-size:11px;font-weight:700;margin-left:auto"></span>
          </div>
        </div>
        <div class="card card-tall">
          <div class="ch"><span class="ct" id="cmp-table-title">Side-by-Side Comparison ‚Äî Select analogues from search results</span>
            <div style="display:flex;gap:6px">
              <button class="btn2" onclick="exportComparisonExcel()">Export Excel</button>
              <button class="btn2" onclick="exportComparisonCSV()">Export CSV</button>
            </div>
          </div>
          <div class="cb" id="compare-table-wrap" style="overflow-x:auto"></div>
        </div>
      </div>
      <!-- SIMILARITY ANALYSIS PANEL -->
      <div id="ana-similarity-panel" style="display:none">

        <!-- Header: analogue selector -->
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;padding:12px 16px;background:linear-gradient(135deg,rgba(107,70,193,.07),rgba(0,136,204,.05));border:1px solid rgba(107,70,193,.18);border-radius:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:160px">
            <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Analysing Analogue</div>
            <div id="sim-analogue-name" style="font-size:13px;font-weight:700;color:var(--purple)">Select an analogue from search results</div>
            <div id="sim-analogue-meta" style="font-size:10px;color:var(--t3);margin-top:2px"></div>
          </div>
          <div id="sim-score-badge" style="display:none;text-align:center;padding:10px 18px;background:rgba(107,70,193,.08);border-radius:8px;border:1px solid rgba(107,70,193,.2)">
            <div id="sim-score-val" style="font-size:32px;font-weight:800;line-height:1"></div>
            <div style="font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-top:2px">Overall Match</div>
          </div>
          <div style="display:flex;gap:7px;flex-wrap:wrap">
            <select class="fc" id="sim-analogue-select" style="font-size:10px;min-width:180px" onchange="loadSimilarityAnalogue()">
              <option value="">‚Äî Pick from search results ‚Äî</option>
            </select>
            <button class="btn2" style="font-size:10px" onclick="exportSimilarityPDF()">Export PDF</button>
          </div>
        </div>

        <!-- Target reservoir values summary -->
        <div id="sim-target-summary" style="margin-bottom:14px;padding:10px 14px;background:rgba(255,77,106,.04);border:1px dashed rgba(255,77,106,.3);border-radius:8px">
          <div style="font-size:9px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px">‚äô Target Reservoir Profile (from search inputs)</div>
          <div id="sim-target-chips" style="display:flex;gap:6px;flex-wrap:wrap"></div>
        </div>

        <!-- Row 1: Data Points | Cross-Plot | Radar | Score Decomposition -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px">

          <!-- Col 1: Data Points -->
          <div class="card" style="max-height:441px">
            <div class="ch"><span class="ct">Data Points</span><span id="sim-cp-count" style="font-size:9px;color:var(--t3)"></span></div>
            <div class="cb" style="max-height:399px;overflow-y:auto">
              <table id="sim-cp-table">
                <thead><tr><th>#</th><th>Analogue</th><th id="sim-cp-hx">X</th><th id="sim-cp-hy">Y</th><th>Match</th><th>Lith</th></tr></thead>
                <tbody id="sim-cp-tbody"></tbody>
              </table>
            </div>
          </div>

          <!-- Col 2: Cross-Plot -->
          <div class="card card-auto">
            <div class="ch">
              <span class="ct">Cross-Plot</span>
              <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">
                <select class="fc" id="sim-cp-x" style="font-size:9px;width:auto" onchange="renderSimCrossplot()"><option value="por">Por%</option><option value="perm">Perm</option><option value="rf">RF%</option><option value="depth">Depth</option><option value="api">API</option><option value="ntg">NTG%</option><option value="gor">GOR</option></select>
                <span style="font-size:9px;color:var(--t3)">vs</span>
                <select class="fc" id="sim-cp-y" style="font-size:9px;width:auto" onchange="renderSimCrossplot()"><option value="perm">Perm</option><option value="por">Por%</option><option value="rf">RF%</option><option value="depth">Depth</option><option value="api">API</option><option value="ntg">NTG%</option><option value="gor">GOR</option></select>
              </div>
            </div>
            <div class="cb">
              <canvas id="sim-cp-canvas" width="340" height="219" style="width:100%;border-radius:4px;background:#fff"></canvas>
              <div style="display:flex;gap:8px;margin-top:4px;font-size:8px;flex-wrap:wrap">
                <span style="display:flex;align-items:center;gap:3px;color:rgba(107,70,193,.6)"><span style="width:7px;height:7px;background:rgba(107,70,193,.15);border:1px solid rgba(107,70,193,.5);border-radius:50%;display:inline-block"></span>Others</span>
                <span style="display:flex;align-items:center;gap:3px;color:var(--red);font-weight:600"><span style="width:7px;height:7px;background:rgba(255,77,106,.2);border:2px solid var(--red);border-radius:50%;display:inline-block"></span>Target</span>
                <span style="display:flex;align-items:center;gap:3px;color:var(--purple);font-weight:600"><span style="width:7px;height:7px;background:rgba(107,70,193,.3);border:2px solid var(--purple);border-radius:50%;display:inline-block"></span>Selected</span>
              </div>
            </div>
          </div>

          <!-- Col 3: Radar Profile -->
          <div class="card card-auto">
            <div class="ch"><span class="ct">Radar Profile</span><span style="font-size:9px;color:var(--t3)">Normalised 0‚Äì100</span></div>
            <div class="cb" style="display:flex;flex-direction:column;align-items:center">
              <div style="position:relative;height:201px;width:100%"><canvas id="sim-radar"></canvas></div>
              <div style="display:flex;gap:8px;margin-top:6px;font-size:8px;flex-wrap:wrap;justify-content:center">
                <span style="display:flex;align-items:center;gap:3px;color:var(--red);font-weight:700"><span style="width:10px;height:2px;background:var(--red);display:inline-block;border-radius:2px"></span>Target</span>
                <span style="display:flex;align-items:center;gap:3px;color:var(--purple);font-weight:700"><span style="width:10px;height:2px;background:var(--purple);display:inline-block;border-radius:2px"></span>Analogue</span>
                <span style="display:flex;align-items:center;gap:3px;color:rgba(0,200,255,.8)"><span style="width:10px;height:2px;background:rgba(0,200,255,.5);display:inline-block;border-radius:2px"></span>Median</span>
              </div>
              <div id="sim-radar-target-vals" style="margin-top:8px;width:100%;padding:6px 8px;background:rgba(255,77,106,.04);border:1px dashed rgba(255,77,106,.25);border-radius:5px;font-size:7px;color:var(--t3);line-height:1.7"></div>
            </div>
          </div>

          <!-- Col 4: Score Decomposition -->
          <div class="card" style="max-height:441px">
            <div class="ch"><span class="ct">Score Decomposition</span><span style="font-size:9px;color:var(--t3)">Per factor</span></div>
            <div class="cb" id="sim-decomp" style="max-height:399px;overflow-y:auto"></div>
          </div>

        </div>

        <!-- Row 2: Scorecard | Std Deviation | Distribution | Parallel Coords -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px">

          <!-- Col 1: Parameter Match Scorecard -->
          <div class="card" style="max-height:240px">
            <div class="ch"><span class="ct">Parameter Match Scorecard</span><span style="font-size:9px;color:var(--t3)">Target vs Analogue</span></div>
            <div class="cb" id="sim-scorecard" style="max-height:200px;overflow-y:auto"></div>
          </div>

          <!-- Col 2: Std Deviation Cards -->
          <div class="card" style="max-height:240px">
            <div class="ch"><span class="ct">Std Deviation from Target</span><span style="font-size:9px;color:var(--t3)">œÉ vs database</span></div>
            <div class="cb" id="sim-deviation" style="display:grid;grid-template-columns:1fr;gap:4px;max-height:200px;overflow-y:auto"></div>
          </div>

          <!-- Col 3: Population Distribution -->
          <div class="card" style="max-height:240px">
            <div class="ch">
              <span class="ct">Population Distribution</span>
              <select class="fc" id="sim-hist-param" style="font-size:9px;width:auto" onchange="renderSimilarityHistogram()">
                <option value="por">Porosity (%)</option>
                <option value="perm">Permeability (mD)</option>
                <option value="rf">Recovery Factor (%)</option>
                <option value="ntg">NTG (%)</option>
                <option value="depth">Depth (m)</option>
                <option value="api">API Gravity</option>
                <option value="gor">GOR</option>
              </select>
            </div>
            <div class="cb">
              <div style="position:relative;height:100px"><canvas id="sim-hist"></canvas></div>
              <div style="display:flex;gap:8px;margin-top:4px;font-size:8px;flex-wrap:wrap">
                <span style="display:flex;align-items:center;gap:3px;color:var(--t3)"><span style="width:9px;height:8px;background:rgba(107,70,193,.25);border:1px solid rgba(107,70,193,.4);display:inline-block;border-radius:2px"></span>Database</span>
                <span style="display:flex;align-items:center;gap:3px;color:var(--red)"><span style="width:2px;height:10px;background:var(--red);display:inline-block"></span>Target</span>
                <span style="display:flex;align-items:center;gap:3px;color:var(--purple)"><span style="width:2px;height:10px;background:var(--purple);display:inline-block"></span>Analogue</span>
              </div>
            </div>
          </div>

          <!-- Col 4: Parallel Coordinates -->
          <div class="card" style="max-height:240px">
            <div class="ch"><span class="ct">Parallel Coordinates</span><span style="font-size:9px;color:var(--t3)">Multi-property</span></div>
            <div class="cb">
              <canvas id="sim-parallel" width="300" height="110" style="width:100%"></canvas>
              <div style="display:flex;gap:8px;margin-top:4px;font-size:8px;flex-wrap:wrap">
                <span style="display:flex;align-items:center;gap:3px;color:rgba(107,70,193,.4)"><span style="width:12px;height:2px;background:rgba(107,70,193,.3);display:inline-block"></span>Others</span>
                <span style="display:flex;align-items:center;gap:3px;color:var(--red)"><span style="width:12px;height:2px;background:var(--red);display:inline-block"></span>Target</span>
                <span style="display:flex;align-items:center;gap:3px;color:var(--purple)"><span style="width:12px;height:2px;background:var(--purple);display:inline-block"></span>Selected</span>
              </div>
            </div>
          </div>

        </div>

      </div>
    </section>
    <section class="sec" id="sec-params">
      <div class="tabs" id="params-tabs">
        <div class="tab on" onclick="switchParamsTab('dist',this)">Distributions</div>
        <div class="tab"   onclick="switchParamsTab('store',this)">Parameter Store</div>
      </div>

      <!-- DISTRIBUTIONS PANEL -->
      <div id="params-dist-panel">
        <!-- Summary KPI strip -->
        <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:14px" id="dist-kpi-strip">
          <div class="kpi"><div class="kpi-lbl">Porosity P50</div><div class="kpi-val" style="color:var(--cyan)">21.5%</div><div class="kpi-sub">3,241 records</div></div>
          <div class="kpi"><div class="kpi-lbl">Permeability P50</div><div class="kpi-val" style="color:var(--gold)">340 mD</div><div class="kpi-sub">2,987 records</div></div>
          <div class="kpi"><div class="kpi-lbl">Recovery Factor P50</div><div class="kpi-val" style="color:var(--green)">34.2%</div><div class="kpi-sub">2,145 records</div></div>
          <div class="kpi"><div class="kpi-lbl">NTG P50</div><div class="kpi-val" style="color:var(--cyan)">62.5%</div><div class="kpi-sub">1,856 records</div></div>
          <div class="kpi"><div class="kpi-lbl">GOR P50</div><div class="kpi-val" style="color:var(--gold)">840 scf/bbl</div><div class="kpi-sub">1,423 records</div></div>
          <div class="kpi"><div class="kpi-lbl">API Gravity P50</div><div class="kpi-val" style="color:var(--green)">33.8¬∞</div><div class="kpi-sub">1,988 records</div></div>
        </div>
        <!-- Filters + actions -->
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-bottom:14px">
          <div class="fg" style="flex:1;min-width:130px"><label>Basin</label><select class="fc" id="pf-basin" onchange="updateDists()"><option value="">All Basins</option><option>Southeast Asia</option><option>Middle East</option><option>North Africa</option><option>North America</option></select></div>
          <div class="fg" style="flex:1;min-width:100px"><label>Lithology</label><select class="fc" id="pf-lith" onchange="updateDists()"><option value="">All</option><option>Sandstone</option><option>Carbonate</option><option>Chalk</option></select></div>
          <div class="fg" style="flex:1;min-width:120px"><label>Drive Mechanism</label><select class="fc" id="pf-drive" onchange="updateDists()"><option value="">All</option><option>Water Drive</option><option>Solution Gas</option><option>Gas Cap</option></select></div>
          <div class="fg" style="flex:1;min-width:100px"><label>Your Input Value</label><input class="fc" id="pf-myval" type="number" step="any" placeholder="e.g. 22.5" oninput="drawMyVal()"></div>
          <div class="fg" style="flex:1;min-width:100px"><label>Parameter</label><select class="fc" id="pf-param" onchange="drawMyVal()"><option value="por">Porosity (%)</option><option value="perm">Permeability (mD)</option><option value="rf">Recovery Factor (%)</option><option value="ntg">NTG (%)</option></select></div>
          <button class="btn" onclick="updateDists()">Update</button>
          <button class="btn2" onclick="exportDists()">Export Stats</button>
          <button class="btn2" style="border-color:rgba(107,70,193,.3);color:var(--purple)" onclick="pushDistsToRisk()">‚Üí Push P50s to Risk &amp; Uncertainty</button>
        </div>
        <div id="dists-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:14px"></div>
      </div>

      <!-- PARAMETER STORE PANEL -->
      <div id="params-store-panel" style="display:none">
        <!-- Info bar -->
        <div style="background:#F5F0FF;border:1px solid #D8C9FF;border-radius:8px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:12px">
          <span style="font-size:18px"></span>
          <div style="flex:1">
            <div style="font-size:11px;font-weight:700;color:var(--purple);margin-bottom:2px">Parameter Store ‚Äî Source of Truth</div>
            <div style="font-size:10px;color:var(--t2)">These values are the authoritative inputs fed into Risk &amp; Uncertainty (Volumetric, Sensitivity, Monte Carlo). Edit here to update all downstream calculations. Monte Carlo simulation has moved to the <strong>Risk &amp; Uncertainty ‚Üí Monte Carlo</strong> tab.</div>
          </div>
          <button class="btn2" style="flex-shrink:0;font-size:9px;border-color:rgba(107,70,193,.3);color:var(--purple)" onclick="syncRiskFromMC();calcVolume();toast('All downstream calculations updated','success')">‚Ü∫ Push to Risk &amp; Uncertainty</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
          <!-- GRV & Volumetric Inputs -->
          <div class="card">
            <div class="ch"><span class="ct">Volumetric Parameters</span><span style="font-size:9px;color:var(--t3)">GRV ¬∑ NTG ¬∑ œÜ ¬∑ Sw ¬∑ Bo</span></div>
            <div class="cb">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div class="fg"><label>GRV Min/ML/Max (km¬≥)</label><input class="fc" id="mc-grv" placeholder="90 / 145 / 230" value="90 / 145 / 230"></div>
                <div class="fg"><label>NTG P50 (fraction)</label><input class="fc" id="mc-ntg-p50" type="number" value="0.62" min="0" max="1" step="0.01"></div>
                <div class="fg"><label>Porosity P50 (fraction)</label><input class="fc" id="mc-phi-p50" type="number" value="0.18" min="0" max="0.5" step="0.01"></div>
                <div class="fg"><label>Water Saturation Sw</label><input class="fc" id="mc-sw" type="number" value="0.28" min="0" max="1" step="0.01"></div>
                <div class="fg"><label>Formation Vol. Factor Bo</label><input class="fc" id="mc-bo" type="number" value="1.32" min="0.9" max="3" step="0.01"></div>
                <div class="fg"><label>Recovery Factor P50</label><input class="fc" id="mc-rf-p50" type="number" value="0.35" min="0" max="1" step="0.01"></div>
              </div>
            </div>
          </div>
          <!-- Distribution Settings -->
          <div class="card">
            <div class="ch"><span class="ct">Distribution Types</span><span style="font-size:9px;color:var(--t3)">For Monte Carlo sampling</span></div>
            <div class="cb">
              <div style="display:grid;grid-template-columns:1fr;gap:8px">
                <div class="fg"><label>NTG Distribution</label><select class="fc" id="mc-ntg"><option>Analogue-derived (P10‚ÄìP90)</option><option>Triangular</option><option>Normal</option><option>Uniform</option></select></div>
                <div class="fg"><label>Porosity Distribution</label><select class="fc" id="mc-phi"><option>Analogue-derived (lognormal)</option><option>Normal</option><option>Triangular</option></select></div>
                <div class="fg"><label>Recovery Factor Dist.</label><select class="fc" id="mc-rf"><option>Analogue-derived (beta)</option><option>Triangular</option><option>Normal</option></select></div>
                <div class="fg"><label>Iterations</label><select class="fc" id="mc-iter"><option value="10000">10,000</option><option value="50000">50,000</option><option value="100000">100,000</option></select></div>
                <div class="fg"><label>Correlation (œÜ/NTG)</label><input class="fc" id="mc-corr" type="number" value="0.45" min="-1" max="1" step="0.05"></div>
              </div>
            </div>
          </div>
          <!-- Analogue Source Summary -->
          <div class="card">
            <div class="ch"><span class="ct">Analogue Source Summary</span><span style="font-size:9px;color:var(--t3)">From Reservoir Analogue Engine</span></div>
            <div class="cb">
              <div style="font-size:9px;color:var(--t3);margin-bottom:10px;padding:7px 10px;background:#F0FFF4;border:1px solid #C6F6D5;border-radius:5px">
                Parameters below are auto-populated from the top 5 analogues ranked by similarity score.
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:9px">
                <div style="padding:6px 8px;background:var(--bg4);border-radius:5px;border:1px solid #E8ECF5"><div style="color:var(--t3);font-size:8px;text-transform:uppercase">Avg Porosity</div><div style="font-weight:700;color:var(--cyan);font-size:14px">21.5%</div></div>
                <div style="padding:6px 8px;background:var(--bg4);border-radius:5px;border:1px solid #E8ECF5"><div style="color:var(--t3);font-size:8px;text-transform:uppercase">Avg NTG</div><div style="font-weight:700;color:var(--cyan);font-size:14px">62%</div></div>
                <div style="padding:6px 8px;background:var(--bg4);border-radius:5px;border:1px solid #E8ECF5"><div style="color:var(--t3);font-size:8px;text-transform:uppercase">Avg RF</div><div style="font-weight:700;color:var(--green);font-size:14px">34%</div></div>
                <div style="padding:6px 8px;background:var(--bg4);border-radius:5px;border:1px solid #E8ECF5"><div style="color:var(--t3);font-size:8px;text-transform:uppercase">Avg Sw</div><div style="font-weight:700;color:var(--gold);font-size:14px">27%</div></div>
                <div style="padding:6px 8px;background:var(--bg4);border-radius:5px;border:1px solid #E8ECF5"><div style="color:var(--t3);font-size:8px;text-transform:uppercase">Analogues Used</div><div style="font-weight:700;color:var(--purple);font-size:14px">5</div></div>
                <div style="padding:6px 8px;background:var(--bg4);border-radius:5px;border:1px solid #E8ECF5"><div style="color:var(--t3);font-size:8px;text-transform:uppercase">Avg Similarity</div><div style="font-weight:700;color:var(--green);font-size:14px">84%</div></div>
              </div>
              <button class="btn2" style="width:100%;margin-top:10px;font-size:9px" onclick="toast('Parameters synced from top analogues','success')">‚Ü∫ Re-sync from Analogues</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== RISK ==================== -->
    <section class="sec" id="sec-risk">
      <div class="tabs" id="risk-tabs">
        <div class="tab on"  onclick="switchRiskTab('gcos',this)">‚ë† GCoS Calculator</div>
        <div class="tab"     onclick="switchRiskTab('mc',this)">‚ë° Parameter Store</div>
        <div class="tab"     onclick="switchRiskTab('vol',this)">‚ë¢ Volumetric</div>
        <div class="tab"     onclick="switchRiskTab('sens',this)">‚ë£ Sensitivity</div>
      </div>

      <!-- GCoS PANEL -->
      <div id="risk-gcos-panel">
        <!-- Info banner -->
        <div style="background:#F5F0FF;border:1px solid #D8C9FF;border-radius:8px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:12px">
          <span style="font-size:20px"></span>
          <div style="flex:1">
            <div style="font-size:11px;font-weight:700;color:var(--purple);margin-bottom:2px">SPE-PRMS Geological Chance of Success (GCoS) Calculator</div>
            <div style="font-size:10px;color:var(--t2)">GCoS = P<sub>source</sub> √ó P<sub>reservoir</sub> √ó P<sub>seal</sub> √ó P<sub>trap</sub> √ó P<sub>migration</sub> ‚Äî Probabilistic Monte Carlo + risked STOIIP. Industry average: 15‚Äì35%.</div>
          </div>
          <button class="btn2" style="flex-shrink:0;font-size:9px" onclick="runGCoSMonteCarlo()">‚ñ∂ Run MC Simulation</button>
        </div>

        <!-- Row 1: Worksheet | Radar | MC Distribution | Risked STOIIP -->
        <div style="display:grid;grid-template-columns:1.1fr 0.8fr 0.9fr 0.9fr;gap:10px;margin-bottom:10px">

          <!-- Col 1: GCoS Worksheet -->
          <div class="card card-tall">
            <div class="ch">
              <div>
                <span class="ct" id="gcos-prospect-title">Prospect Alpha ‚Äî GCoS Worksheet</span>
                <div style="font-size:9px;color:var(--t3);margin-top:2px">Adjust each risking slider ¬∑ Hover for benchmarks</div>
              </div>
              <div style="display:flex;gap:6px;align-items:center">
                <select class="fc" id="prospect-select" onchange="loadProspect(this.value)" style="font-size:10px;padding:4px 8px;min-width:140px">
                  <option value="">Select Prospect‚Ä¶</option>
                </select>
                <span class="ca" onclick="resetGCoS()">Reset</span>
              </div>
            </div>
            <div class="cb">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px" id="gcos-elements"></div>
              <div style="background:linear-gradient(135deg,rgba(107,70,193,.08),rgba(107,70,193,.03));border:1px solid rgba(107,70,193,.2);border-radius:8px;padding:12px 16px">
                <div style="display:flex;align-items:center;justify-content:space-between">
                  <div>
                    <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--t3)">Geological Chance of Success</div>
                    <div style="font-size:10px;color:var(--purple);margin-top:4px;font-family:monospace">GCoS = P<sub>s</sub> √ó P<sub>r</sub> √ó P<sub>se</sub> √ó P<sub>t</sub> √ó P<sub>m</sub></div>
                    <div style="margin-top:8px;display:flex;gap:6px;font-size:9px;flex-wrap:wrap">
                      <span style="background:#FEF3C7;color:#92400E;padding:2px 6px;border-radius:3px">Wildcats: 10‚Äì20%</span>
                      <span style="background:#DCFCE7;color:#166534;padding:2px 6px;border-radius:3px">Near-field: 25‚Äì45%</span>
                    </div>
                  </div>
                  <div style="text-align:right">
                    <div id="gcos-val" style="font-size:44px;font-weight:700;color:var(--green);transition:color .3s;line-height:1">23.1%</div>
                    <div id="gcos-class" style="margin-top:6px"></div>
                  </div>
                </div>
                <div id="gcos-breakdown" style="margin-top:10px;padding:8px 0 0;border-top:1px solid rgba(107,70,193,.15);font-size:9px;color:var(--t3)"></div>
              </div>
              <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">
                <button class="btn" onclick="saveGCoS()">Save</button>
                <button class="btn2" onclick="exportGCoS()">Export CPR</button>
                <button class="btn" style="margin-left:auto" onclick="switchRiskTab('mc',document.querySelectorAll('#risk-tabs .tab')[1])">‚ë° Parameter Store ‚Üí</button>
              </div>
            </div>
          </div>

          <!-- Col 2: Spider/Radar -->
          <div class="card card-auto">
            <div class="ch"><span class="ct">Risk Component Radar</span><span style="font-size:9px;color:var(--t3)">vs. analogue benchmarks</span></div>
            <div class="cb" style="display:flex;flex-direction:column;align-items:center">
              <div style="position:relative;height:220px;width:100%;max-width:280px"><canvas id="gcos-radar-canvas"></canvas></div>
              <div style="margin-top:6px;font-size:8px;color:var(--t3);text-align:center">‚óè Purple = estimate ¬∑ ‚óã Grey = analogue benchmark</div>
              <div style="width:100%;margin-top:10px;font-size:9px" id="gcos-risk-table"></div>
            </div>
          </div>

          <!-- Col 3: Monte Carlo GCoS Distribution -->
          <div class="card card-auto">
            <div class="ch"><span class="ct">GCoS Monte Carlo</span><span style="font-size:9px;color:var(--t3)">10,000 iterations</span></div>
            <div class="cb" style="display:flex;flex-direction:column">
              <canvas id="gcos-mc-canvas" width="320" height="200" style="width:100%;background:#fff;border-radius:4px"></canvas>
              <div id="gcos-mc-stats" style="margin-top:8px;display:grid;grid-template-columns:repeat(3,1fr);gap:6px;font-size:9px">
                <div style="text-align:center;padding:6px;background:rgba(217,48,37,.06);border-radius:5px;border:1px solid rgba(217,48,37,.15)">
                  <div style="color:var(--red);font-weight:700;font-size:8px;text-transform:uppercase">P10</div>
                  <div id="gcos-mc-p10" style="font-size:16px;font-weight:700;color:var(--red)">‚Äî</div>
                </div>
                <div style="text-align:center;padding:6px;background:rgba(107,70,193,.06);border-radius:5px;border:1px solid rgba(107,70,193,.2)">
                  <div style="color:var(--purple);font-weight:700;font-size:8px;text-transform:uppercase">P50</div>
                  <div id="gcos-mc-p50" style="font-size:16px;font-weight:700;color:var(--purple)">‚Äî</div>
                </div>
                <div style="text-align:center;padding:6px;background:rgba(0,135,90,.06);border-radius:5px;border:1px solid rgba(0,135,90,.2)">
                  <div style="color:var(--green);font-weight:700;font-size:8px;text-transform:uppercase">P90</div>
                  <div id="gcos-mc-p90" style="font-size:16px;font-weight:700;color:var(--green)">‚Äî</div>
                </div>
              </div>
              <div id="gcos-mc-note" style="margin-top:8px;font-size:9px;color:var(--t3);text-align:center">Click "Run MC Simulation" to generate distribution</div>
            </div>
          </div>

          <!-- Col 4: Risked STOIIP + Portfolio Ranking -->
          <div class="card card-tall">
            <div class="ch"><span class="ct">Risked STOIIP & Portfolio</span><span style="font-size:9px;color:var(--t3)">GCoS √ó unrisked volumes</span></div>
            <div class="cb">
              <!-- Risked STOIIP -->
              <div style="padding:10px;background:rgba(107,70,193,.05);border:1px solid rgba(107,70,193,.15);border-radius:7px;margin-bottom:10px">
                <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:6px">Risked STOIIP</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:9px">
                  <div>
                    <div style="color:var(--t3);font-size:8px">Unrisked P50</div>
                    <div id="risked-unrisked" style="font-size:16px;font-weight:700;color:var(--t1)">‚Äî</div>
                    <div style="font-size:8px;color:var(--t3)">MMbbl</div>
                  </div>
                  <div>
                    <div style="color:var(--t3);font-size:8px">Risked EMV</div>
                    <div id="risked-emv" style="font-size:16px;font-weight:700;color:var(--purple)">‚Äî</div>
                    <div style="font-size:8px;color:var(--t3)">MMbbl</div>
                  </div>
                  <div>
                    <div style="color:var(--t3);font-size:8px">GCoS Applied</div>
                    <div id="risked-gcos-used" style="font-size:14px;font-weight:700;color:var(--green)">‚Äî</div>
                  </div>
                  <div>
                    <div style="color:var(--t3);font-size:8px">Risked P10</div>
                    <div id="risked-p10" style="font-size:14px;font-weight:700;color:var(--red)">‚Äî</div>
                    <div style="font-size:8px;color:var(--t3)">MMbbl</div>
                  </div>
                </div>
                <button class="btn" style="width:100%;margin-top:8px;font-size:9px" onclick="calcRiskedSTOIIP()">Calculate Risked Volumes</button>
              </div>
              <!-- Portfolio Ranking -->
              <div style="font-size:9px;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Portfolio Ranking</div>
              <div id="gcos-portfolio-table" style="font-size:9px"></div>
              <button class="btn2" style="width:100%;margin-top:8px;font-size:9px" onclick="renderGCoSPortfolio()">‚Üª Refresh Rankings</button>
            </div>
          </div>

        </div>
      </div>

      <!-- VOLUMETRIC PANEL -->
      <div id="risk-vol-panel" style="display:none">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">

          <!-- Col 1: Calculator -->
          <div class="card">
            <div class="ch"><span class="ct">STOIIP / GIIP Volumetric Calculator</span>
              <div style="display:flex;gap:6px;align-items:center">
                <button class="btn2" style="font-size:9px;padding:4px 10px;border-color:rgba(107,70,193,.3);color:var(--purple)" onclick="syncRiskFromMC();calcVolume();toast('Synced from Parameter Store','success')">‚Ü∫ Sync from Parameter Store</button>
                <span class="ca" onclick="calcVolume()">Calculate</span>
              </div>
            </div>
            <div class="cb">
              <div style="font-size:9px;color:var(--t3);margin-bottom:10px;padding:6px 8px;background:#FFF8F0;border:1px solid #FFE4CC;border-radius:5px">
                <strong style="color:var(--amber)">STOIIP</strong> = (GRV √ó NTG √ó œÜ √ó (1 ‚àí Sw)) / Bo √ó 6.29 &nbsp;|&nbsp;
                <strong style="color:var(--cyan)">GIIP</strong> = (GRV √ó NTG √ó œÜ √ó (1 ‚àí Sw)) / Bg
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="vol-inputs">
                <div class="fg"><label>GRV (km¬≥)</label><input class="fc" id="vi-grv" type="number" placeholder="from Monte Carlo" step="1" oninput="calcVolume()"></div>
                <div class="fg"><label>NTG (fraction)</label><input class="fc" id="vi-ntg" type="number" value="0.62" step="0.01" oninput="calcVolume()"></div>
                <div class="fg"><label>Porosity œÜ (fraction)</label><input class="fc" id="vi-phi" type="number" value="0.18" step="0.01" oninput="calcVolume()"></div>
                <div class="fg"><label>Water Saturation Sw</label><input class="fc" id="vi-sw" type="number" value="0.28" step="0.01" oninput="calcVolume()"></div>
                <div class="fg"><label>Formation Vol. Factor Bo</label><input class="fc" id="vi-bo" type="number" value="1.32" step="0.01" oninput="calcVolume()"></div>
                <div class="fg"><label>Recovery Factor RF</label><input class="fc" id="vi-rf" type="number" value="0.35" step="0.01" oninput="calcVolume()"></div>
                <div class="fg"><label>HC Phase</label>
                  <select class="fc" id="vi-phase" onchange="calcVolume()">
                    <option value="oil">Oil (STOIIP)</option>
                    <option value="gas">Gas (GIIP)</option>
                    <option value="both">Both (Combo)</option>
                  </select>
                </div>
                <div class="fg"><label>Shrinkage Factor (gas)</label><input class="fc" id="vi-bg" type="number" value="0.004" step="0.001" oninput="calcVolume()"></div>
              </div>
            </div>
          </div>

          <!-- Col 2: Volumetric Results -->
          <div class="card">
            <div class="ch"><span class="ct">Volumetric Results</span></div>
            <div class="cb" id="vol-results">
              <div style="text-align:center;padding:20px 0">
                <div style="font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:8px">STOIIP</div>
                <div id="vol-stoiip" style="font-size:44px;font-weight:700;color:var(--purple);line-height:1">387</div>
                <div style="font-size:11px;color:var(--t3);margin-top:4px">MMbbl (P50)</div>
                <div style="margin:16px 0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
                  <div style="background:var(--bg4);border-radius:6px;padding:10px;text-align:center;border:1px solid #E8ECF5"><div style="font-size:8px;color:var(--red);text-transform:uppercase;letter-spacing:1px">P10</div><div id="vol-p10" style="font-size:20px;font-weight:700;color:var(--red)">142</div><div style="font-size:9px;color:var(--t3)">MMbbl</div></div>
                  <div style="background:var(--bg4);border-radius:6px;padding:10px;text-align:center;border:1px solid #E8ECF5"><div style="font-size:8px;color:var(--purple);text-transform:uppercase;letter-spacing:1px">P50</div><div id="vol-p50" style="font-size:20px;font-weight:700;color:var(--purple)">387</div><div style="font-size:9px;color:var(--t3)">MMbbl</div></div>
                  <div style="background:var(--bg4);border-radius:6px;padding:10px;text-align:center;border:1px solid #E8ECF5"><div style="font-size:8px;color:var(--gold);text-transform:uppercase;letter-spacing:1px">P90</div><div id="vol-p90" style="font-size:20px;font-weight:700;color:var(--gold)">920</div><div style="font-size:9px;color:var(--t3)">MMbbl</div></div>
                </div>
                <div id="vol-eur" style="margin-top:8px;padding:10px;background:rgba(0,135,90,.07);border-radius:6px;border:1px solid rgba(0,135,90,.2)">
                  <div style="font-size:9px;color:var(--t3);margin-bottom:3px">Estimated Ultimate Recovery (EUR) @ RF 35%</div>
                  <div style="font-size:22px;font-weight:700;color:var(--green)">135 MMbbl</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Col 3: Sensitivity on Volumetric Inputs -->
          <div class="card card-auto">
            <div class="ch"><span class="ct">Sensitivity on Volumetric Inputs</span><button class="btn2" onclick="switchRiskTab('sens',document.querySelectorAll('#risk-tabs .tab')[3])">Full Sensitivity ‚Üí</button></div>
            <div class="cb"><canvas id="vol-sens-canvas" width="400" height="260" style="width:100%"></canvas></div>
          </div>

        </div>
      </div>

      <!-- MONTE CARLO PANEL -->
      <div id="risk-mc-panel" style="display:none">
        <div style="background:#F5F0FF;border:1px solid #D8C9FF;border-radius:8px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:12px">
          <span style="font-size:18px"></span>
          <div style="flex:1">
            <div style="font-size:11px;font-weight:700;color:var(--purple);margin-bottom:2px">STOIIP Monte Carlo Simulation ‚Äî Parameter Store</div>
            <div style="font-size:10px;color:var(--t2)">10,000 iterations using analogue-derived distributions. Input parameters are sourced from the <strong>Parameter Store</strong>. Results automatically sync to Volumetric and Sensitivity tabs.</div>
          </div>
          <button class="btn2" style="flex-shrink:0;font-size:9px;border-color:rgba(107,70,193,.3);color:var(--purple)" onclick="switchRiskTab('vol',document.querySelectorAll('#risk-tabs .tab')[2])">‚ë¢ Volumetric ‚Üí</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">

          <!-- Col 1: Configuration (reads from Parameter Store IDs) -->
          <div class="card">
            <div class="ch"><span class="ct">Parameter Store</span><button class="btn2" style="font-size:9px" onclick="goTo('params',document.querySelector('.nav[onclick*=params]'))">Open Parameter Library ‚Üí</button></div>
            <div class="cb">
              <div style="font-size:9px;color:var(--t3);margin-bottom:10px;padding:7px 10px;background:#F5F0FF;border:1px solid #E0D4FF;border-radius:5px">
                Parameters sourced from Parameter Store. Modify them there to keep a single source of truth.
              </div>
              <div id="mc-config-readonly" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:9px;margin-bottom:12px"></div>
              <button class="btn" style="width:100%" onclick="runMonteCarlo()">‚ñ∂ Run Monte Carlo ‚Äî 10,000 Iterations</button>
            </div>
          </div>

          <!-- Col 2: Simulation Results -->
          <div class="card">
            <div class="ch"><span class="ct">Simulation Results ‚Äî STOIIP</span><button class="btn2" onclick="runMonteCarlo()">Re-Run</button></div>
            <div class="cb" id="mc-results">
              <div id="mc-bars-wrap"></div>
              <div style="margin-top:12px;padding:9px 12px;background:rgba(107,70,193,.05);border-radius:6px;border:1px solid rgba(107,70,193,.15);font-size:10px;color:var(--t2)" id="mc-inputs-summary">
                Run simulation to populate inputs summary.
              </div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button class="btn" onclick="exportMonteCarloCPR()">Export CPR Template</button>
                <button class="btn2" onclick="toast('Excel table downloaded','success')">Download Excel</button>
              </div>
            </div>
          </div>

          <!-- Col 3: Full Probability Distribution -->
          <div class="card card-auto">
            <div class="ch"><span class="ct">Full Probability Distribution ‚Äî STOIIP (MMbbl)</span></div>
            <div class="cb"><canvas id="mc-hist-canvas" width="400" height="300" style="width:100%"></canvas></div>
          </div>

        </div>
      </div>

      <!-- SENSITIVITY PANEL -->
      <div id="risk-sens-panel" style="display:none">
        <!-- Info bar -->
        <div style="background:#F5F0FF;border:1px solid #D8C9FF;border-radius:8px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:12px">
          <span style="font-size:18px"></span>
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--purple);margin-bottom:2px">STOIIP Sensitivity Analysis ‚Äî Tornado & Spider Chart</div>
            <div style="font-size:10px;color:var(--t2)">Set P10/P50/P90 ranges for each parameter. The tornado chart ranks parameters by their impact on STOIIP. Spider chart shows relative sensitivity across the range. All charts update live.</div>
          </div>
          <button class="btn2" style="flex-shrink:0" onclick="syncSensFromVolumetric()">‚Üô Sync from Volumetric</button>
        </div>

        <!-- KPI strip -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px" id="sens-kpi-strip"></div>

        <div style="display:grid;grid-template-columns:0.6fr 0.6fr 1.4fr;gap:10px;margin-bottom:14px">

          <!-- Col 1: Parameter Ranges -->
          <div class="card card-tall">
            <div class="ch">
              <span class="ct">Parameter Ranges</span>
              <div style="display:flex;gap:6px">
                <button class="btn2" style="font-size:9px" onclick="resetSensParams()">Reset Defaults</button>
                <button class="btn2" style="font-size:9px" onclick="exportSensPDF()">‚¨á PDF</button>
                <button class="btn2" style="font-size:9px" onclick="exportSens()">‚¨á CSV</button>
              </div>
            </div>
            <div class="cb" style="padding:0;overflow-x:auto">
              <table id="sens-param-table">
                <thead><tr>
                  <th>Parameter</th>
                  <th>Units</th>
                  <th style="color:var(--red)">P10 (Low)</th>
                  <th style="color:var(--purple)">P50 (Base)</th>
                  <th style="color:var(--green)">P90 (High)</th>
                  <th>STOIIP P10</th>
                  <th>STOIIP P90</th>
                  <th>Swing</th>
                </tr></thead>
                <tbody id="sens-param-tbody"></tbody>
              </table>
            </div>
          </div>

          <!-- Col 2: Tornado Chart (narrower) -->
          <div class="card card-auto">
            <div class="ch"><span class="ct">Tornado Chart</span><span style="font-size:9px;color:var(--t3)">STOIIP Impact ‚Äî ranked by swing</span></div>
            <div class="cb" style="padding:8px">
              <canvas id="tornado-canvas" width="420" height="340" style="width:100%;display:block"></canvas>
            </div>
          </div>

          <!-- Col 3: Spider Chart (wider) -->
          <div class="card card-auto">
            <div class="ch">
              <span class="ct">Spider Chart ‚Äî STOIIP as % of P50 Base</span>
              <span style="font-size:9px;color:var(--t3)">Relative sensitivity</span>
            </div>
            <div class="cb"><canvas id="spider-canvas" width="600" height="320" style="width:100%"></canvas></div>
          </div>

        </div>
      </div>
    </section>
    <section class="sec" id="sec-screening">
      <div class="tabs" id="screen-tabs">
        <div class="tab on" onclick="switchScreenTab('config',this)">Configure</div>
        <div class="tab"   onclick="switchScreenTab('leaderboard',this)">Leaderboard</div>
        <div class="tab"   onclick="switchScreenTab('profiles',this)">Basin Profiles</div>
      </div>

      <!-- CONFIGURE PANEL -->
      <div id="screen-config-panel">
        <div class="card" style="margin-bottom:14px">
          <div class="ch"><span class="ct">Screening Criteria & Weights</span><div style="display:flex;gap:7px"><button class="btn2" onclick="saveScreenConfig()">Save Config</button><button class="btn2" onclick="loadScreenConfig()">Load Config</button></div></div>
          <div class="cb">
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px" id="screen-criteria"></div>
            <div style="display:flex;gap:7px;align-items:center">
              <button class="btn" onclick="runScreening()" id="screen-btn">Run Screening ‚Äî 612 Basins</button>
              <div style="flex:1;font-size:10px;color:var(--t3)" id="screen-status"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- LEADERBOARD PANEL -->
      <div id="screen-leaderboard-panel" style="display:none">
        <div id="lb-not-run" style="padding:48px;text-align:center;background:#fff;border-radius:10px;border:2px dashed #CBD5E0">
          <div style="font-size:48px;margin-bottom:12px">üèÜ</div>
          <div style="font-size:16px;font-weight:700;color:var(--t1);margin-bottom:6px">Basin Leaderboard</div>
          <div style="font-size:12px;color:var(--t3);margin-bottom:20px;max-width:400px;margin-left:auto;margin-right:auto">Configure your exploration criteria weights in the Configure tab, then run screening to rank all 612 basins against your opportunity criteria.</div>
          <button class="btn" onclick="switchScreenTab('config',document.querySelectorAll('#screen-tabs .tab')[0])">‚Üê Configure & Run Screening</button>
        </div>
        <div id="screen-results" style="display:none">
          <!-- Summary KPIs -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px" id="lb-kpis"></div>
          <!-- Podium top 3 -->
          <div id="lb-podium" style="display:flex;justify-content:center;gap:16px;margin-bottom:20px;align-items:flex-end"></div>
          <!-- Filters -->
          <div style="display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap">
            <div style="flex:1;min-width:160px"><input class="fc" id="lb-text-filter" style="padding:8px 12px" placeholder="Filter by name, country, region‚Ä¶" oninput="filterLeaderboard(this.value)"></div>
            <select class="fc" style="width:145px;padding:8px" id="lb-region-filter" onchange="filterLeaderboard(document.getElementById('lb-text-filter').value)">
              <option value="">All Regions</option><option>Middle East</option><option>Southeast Asia</option><option>North Africa</option><option>North America</option><option>Europe</option><option>South America</option>
            </select>
            <select class="fc" style="width:130px;padding:8px" id="lb-tier-filter" onchange="filterLeaderboard(document.getElementById('lb-text-filter').value)">
              <option value="">All Tiers</option><option value="HIGH">High Priority</option><option value="MED">Medium Priority</option><option value="LOW">Low Priority</option>
            </select>
            <button class="btn2" onclick="exportLeaderboardPDF()">Export PDF</button>
            <button class="btn2" onclick="exportTable('screen-table','screening')">‚¨á Excel</button>
          </div>
          <!-- Main table -->
          <div class="card">
            <div class="ch">
              <span class="ct" id="screen-result-title">Basin Leaderboard</span>
              <span style="font-size:10px;color:var(--t3)" id="lb-showing-count"></span>
            </div>
            <div class="cb" style="padding:0;overflow-x:auto">
              <table id="screen-table">
                <thead><tr>
                  <th style="width:44px">Rank</th>
                  <th>Basin</th>
                  <th>Country</th>
                  <th>Region</th>
                  <th>HC Phase</th>
                  <th title="Source Rock Quality">Source ‚ìò</th>
                  <th title="Reservoir Quality">Reservoir ‚ìò</th>
                  <th title="Seal Integrity">Seal ‚ìò</th>
                  <th title="Charge Efficiency">Charge ‚ìò</th>
                  <th title="Commercial Attractiveness">Commercial ‚ìò</th>
                  <th title="Country / Political Risk">Cntry Risk ‚ìò</th>
                  <th>GCoS Est.</th>
                  <th>Composite</th>
                  <th>Priority</th>
                </tr></thead>
                <tbody id="screen-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- BASIN PROFILES PANEL -->
      <div id="screen-profiles-panel" style="display:none">
        <div style="display:flex;gap:10px;align-items:flex-end;margin-bottom:16px;flex-wrap:wrap">
          <div class="fg" style="flex:1;max-width:320px">
            <label>Select Basin</label>
            <select class="fc" id="bp-basin-select" onchange="renderBasinProfile(this.value)">
              <option value="">Choose a basin to view exploration profile‚Ä¶</option>
            </select>
          </div>
          <div class="fg" style="flex:1;max-width:200px">
            <label>Quick Search</label>
            <input class="fc" id="bp-basin-search" placeholder="Type basin name‚Ä¶" oninput="filterBpSelect(this.value)">
          </div>
          <button class="btn2" onclick="exportBasinProfile()">‚¨á Export Profile PDF</button>
          <button class="btn2" onclick="toast('Basin profile added to portfolio report','success')">+ Add to Report</button>
        </div>
        <div id="bp-content">
          <div style="padding:48px;text-align:center;background:#fff;border-radius:10px;border:2px dashed #CBD5E0">
            <div style="font-size:40px;margin-bottom:10px"></div>
            <div style="font-size:14px;font-weight:600;color:var(--t2);margin-bottom:6px">Basin Exploration Profile</div>
            <div style="font-size:11px;color:var(--t3)">Select a basin from the dropdown above to view its full exploration maturity profile, petroleum systems analysis, and risk breakdown.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== INGESTION ==================== -->
    <section class="sec" id="sec-ingestion">
      <div class="tabs" style="flex-wrap:wrap">
        <div class="tab on" onclick="ingTab('overview',this)">Overview</div>
        <div class="tab" onclick="ingTab('unified',this)" style="background:rgba(107,70,193,.07);color:var(--purple);border-bottom:2px solid var(--purple)">Unified Upload</div>
        <div class="tab" onclick="ingTab('reservoir',this)">Reservoir</div>
        <div class="tab" onclick="ingTab('geopressure',this)">Geopressure</div>
        <div class="tab" onclick="ingTab('geochem',this)">Geochemistry</div>
        <div class="tab" onclick="ingTab('mineral',this)">Mineralogy</div>
        <div class="tab" onclick="ingTab('fluid',this)">Fluid PVT</div>
        <div class="tab" onclick="ingTab('diagenesis',this)">Diagenesis</div>
        <div class="tab" onclick="ingTab('seismic',this)">Seismic</div>
        <div class="tab" onclick="ingTab('production',this)">Production</div>
        <div class="tab" onclick="ingTab('welldata',this)">Well Data</div>
        <div class="tab" onclick="ingTab('isotope',this)">Isotope</div>
        <div class="tab" onclick="ingTab('petrophysics',this)">Petrophysics</div>
        <div class="tab" onclick="ingTab('geomechanics',this)">Geomechanics</div>
        <div class="tab" onclick="ingTab('thermal',this)">Thermal</div>
        <div class="tab" onclick="ingTab('environmental',this)">Environmental</div>
        <div class="tab" onclick="ingTab('commercials',this)">Commercial</div>
        <div class="tab" onclick="ingTab('connectors',this)">Connectors</div>
        <div class="tab" onclick="ingTab('dedup',this)">Dedup Queue</div>
      </div>

      <!-- ‚îÄ‚îÄ UNIFIED UPLOAD PANEL ‚îÄ‚îÄ -->
      <div id="ing-unified-panel" style="display:none">

        <!-- Hero banner -->
        <div style="background:linear-gradient(135deg,var(--sb) 0%,var(--sb2) 60%,#6B46C1 100%);border-radius:12px;padding:22px 28px;margin-bottom:18px;display:flex;align-items:center;gap:20px">
          
          <div style="flex:1">
            <div style="font-size:17px;font-weight:800;color:#fff;margin-bottom:4px">Unified Data Ingestion</div>
            <div style="font-size:11px;color:rgba(255,255,255,.7);line-height:1.6">Upload a single CSV file containing any combination of Basin, Analogue, Reservoir, Geopressure, Geochemistry, Mineralogy, Fluid PVT and Diagenesis data. EDAFY auto-detects and routes each column group to the correct dataset. Only include the columns you have ‚Äî missing columns are silently skipped.</div>
          </div>
          <div style="flex-shrink:0;text-align:center">
            <button class="btn" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);font-size:11px;padding:10px 18px;margin-bottom:8px;width:100%" onclick="downloadTemplate('unified')">Download Master Template</button>
            <div style="font-size:9px;color:rgba(255,255,255,.5)">All 73 columns ¬∑ 3 sample rows</div>
          </div>
        </div>

        <!-- Dataset coverage chips -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px" id="unified-coverage-chips">
          <div style="padding:5px 12px;border-radius:20px;font-size:10px;font-weight:600;background:#EFF6FF;color:#1D4ED8;border:1px solid #BFDBFE">Basin</div>
          <div style="padding:5px 12px;border-radius:20px;font-size:10px;font-weight:600;background:#F0FDF4;color:#166534;border:1px solid #BBF7D0">Analogue</div>
          <div style="padding:5px 12px;border-radius:20px;font-size:10px;font-weight:600;background:#ECFEFF;color:#0E7490;border:1px solid #A5F3FC">Reservoir</div>
          <div style="padding:5px 12px;border-radius:20px;font-size:10px;font-weight:600;background:#FFFBEB;color:#92400E;border:1px solid #FDE68A">Geopressure</div>
          <div style="padding:5px 12px;border-radius:20px;font-size:10px;font-weight:600;background:#F0FDF4;color:#065F46;border:1px solid #A7F3D0">Geochemistry</div>
          <div style="padding:5px 12px;border-radius:20px;font-size:10px;font-weight:600;background:#FFFBEB;color:#78350F;border:1px solid #FCD34D">Mineralogy</div>
          <div style="padding:5px 12px;border-radius:20px;font-size:10px;font-weight:600;background:#FFF1F2;color:#9F1239;border:1px solid #FECDD3">Fluid PVT</div>
          <div style="padding:5px 12px;border-radius:20px;font-size:10px;font-weight:600;background:#FAF5FF;color:#6B21A8;border:1px solid #E9D5FF">Diagenesis</div>
        </div>

        <div class="g2" style="margin-bottom:16px">
          <!-- Drop zone -->
          <div class="card">
            <div class="ch">
              <div>
                <span class="ct">Upload Master CSV</span>
                <div style="font-size:9px;color:var(--t3);margin-top:2px">One file ¬∑ All datasets ¬∑ Auto-routed</div>
              </div>
              <div style="display:flex;gap:6px">
                <button class="btn2" onclick="downloadTemplate('unified')">Master Template</button>
                <button class="btn2" onclick="downloadAllTemplates()">All Templates</button>
              </div>
            </div>
            <div class="cb">
              <div class="drop-zone" id="dz-unified"
                style="border-color:rgba(107,70,193,.3);background:rgba(107,70,193,.02)"
                ondragover="event.preventDefault();this.classList.add('drag-over')"
                ondragleave="this.classList.remove('drag-over')"
                ondrop="handleUnifiedDrop(event)">
                <input type="file" accept=".csv,.tsv,.txt" onchange="handleUnifiedFiles(this.files)">
                <div style="width:42px;height:42px;border-radius:8px;background:rgba(107,70,193,.1);display:flex;align-items:center;justify-content:center;margin:0 auto 10px"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="var(--purple)" stroke-width="1.5"><path d="M4 16v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2M8 12l4 4 4-4M12 4v12"/></svg></div>
                <div style="font-size:13px;font-weight:600;color:var(--t1);margin-bottom:4px">Drop your master CSV here</div>
                <div style="font-size:10px;color:var(--t3);margin-bottom:8px">or click to browse ¬∑ CSV / TSV</div>
                <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap">
                  <span style="background:#EFF6FF;color:#1D4ED8;font-size:9px;padding:2px 8px;border-radius:10px">Basin</span>
                  <span style="background:#F0FDF4;color:#166534;font-size:9px;padding:2px 8px;border-radius:10px">Analogue</span>
                  <span style="background:#ECFEFF;color:#0E7490;font-size:9px;padding:2px 8px;border-radius:10px">Reservoir</span>
                  <span style="background:#FFFBEB;color:#92400E;font-size:9px;padding:2px 8px;border-radius:10px">Geopressure</span>
                  <span style="background:#F0FDF4;color:#065F46;font-size:9px;padding:2px 8px;border-radius:10px">Geochemistry</span>
                  <span style="background:#FAF5FF;color:#6B21A8;font-size:9px;padding:2px 8px;border-radius:10px">+ more</span>
                </div>
              </div>
              <div id="unified-file-status" style="margin-top:12px"></div>
              <div id="unified-loaded-header" style="display:none;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin:12px 0 6px">Loaded Files This Session</div>
              <div id="unified-loaded-files"></div>
              <div id="unified-file-list" style="margin-top:8px;max-height:200px;overflow-y:auto"></div>
            </div>
          </div>

          <!-- Column schema reference -->
          <div class="card">
            <div class="ch"><span class="ct">Recognised Column Groups</span><span style="font-size:9px;color:var(--t3)">73 total columns</span></div>
            <div class="cb" style="padding:10px">
              <div id="unified-schema-list"></div>
            </div>
          </div>
        </div>

        <!-- Ingestion results panel (hidden until upload) -->
        <div id="unified-results" style="display:none">
          <div class="card">
            <div class="ch">
              <span class="ct" id="unified-results-title">Ingestion Results</span>
              <button class="btn2" onclick="document.getElementById('unified-results').style.display='none'">Dismiss</button>
            </div>
            <div class="cb">
              <!-- Per-dataset breakdown -->
              <div id="unified-breakdown" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px"></div>
              <!-- Records table -->
              <div style="overflow-x:auto">
                <table id="unified-result-table">
                  <thead><tr>
                    <th>Record Name</th><th>Basin</th><th>Datasets Updated</th><th>Status</th><th>Action</th>
                  </tr></thead>
                  <tbody id="unified-result-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ -->
      <div id="ing-overview-panel">
        <!-- KPI strip -->
        <div class="kpis" style="grid-template-columns:repeat(4,1fr);margin-bottom:14px">
          <div class="kpi c"><div class="kpi-lbl">Total Accepted</div><div class="kpi-val" id="ing-accepted">12,847</div><div class="kpi-sub">All datasets</div></div>
          <div class="kpi e"><div class="kpi-lbl">Quarantined</div><div class="kpi-val" id="ing-quarantine">47</div><div class="kpi-sub">Pending review</div></div>
          <div class="kpi r"><div class="kpi-lbl">Failures</div><div class="kpi-val" id="ing-failed">12</div><div class="kpi-sub">Schema errors</div></div>
          <div class="kpi g"><div class="kpi-lbl">Quality Score</div><div class="kpi-val" id="ing-score">96.1%</div><div class="kpi-sub">SHA-256 dedup</div></div>
        </div>
        <!-- 6 dataset tiles rendered by JS -->
        <div id="ing-dataset-tiles" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px"></div>
        <!-- Upload history -->
        <div class="card">
          <div class="ch"><span class="ct">Recent Ingestion Activity</span></div>
          <div class="cb" id="upload-history"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ INDIVIDUAL DATA PANELS (populated by JS) ‚îÄ‚îÄ -->
      <div id="ing-reservoir-panel"   style="display:none"></div>
      <div id="ing-geopressure-panel" style="display:none"></div>
      <div id="ing-geochem-panel"     style="display:none"></div>
      <div id="ing-mineral-panel"     style="display:none"></div>
      <div id="ing-fluid-panel"       style="display:none"></div>
      <div id="ing-diagenesis-panel"  style="display:none"></div>

      <!-- ‚îÄ‚îÄ NEW DATASET PANELS ‚îÄ‚îÄ -->
      <div id="ing-seismic-panel"        style="display:none"></div>
      <div id="ing-production-panel"     style="display:none"></div>
      <div id="ing-welldata-panel"       style="display:none"></div>
      <div id="ing-isotope-panel"        style="display:none"></div>
      <div id="ing-petrophysics-panel"   style="display:none"></div>
      <div id="ing-geomechanics-panel"   style="display:none"></div>
      <div id="ing-thermal-panel"        style="display:none"></div>
      <div id="ing-environmental-panel"  style="display:none"></div>
      <div id="ing-commercials-panel"    style="display:none"></div>

      <!-- ‚îÄ‚îÄ VENDOR CONNECTORS ‚îÄ‚îÄ -->
      <div id="ing-connectors-panel" style="display:none">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:14px" id="connector-cards"></div>
        <div class="card">
          <div class="ch"><span class="ct">Connector Activity Log</span><button class="btn2" onclick="clearConnectorLog()">Clear</button></div>
          <div class="cb" style="font-family:monospace" id="connector-log">
            <div style="font-size:10px;color:var(--t3);padding:10px 0;text-align:center">No activity yet. Trigger a sync to see log output.</div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ DEDUP QUEUE ‚îÄ‚îÄ -->
      <div id="ing-dedup-panel" style="display:none">
        <div class="kpis" style="grid-template-columns:repeat(4,1fr);margin-bottom:14px">
          <div class="kpi c"><div class="kpi-lbl">Total Scanned</div><div class="kpi-val" id="dd-scanned">12,906</div><div class="kpi-sub">Records processed</div></div>
          <div class="kpi g"><div class="kpi-lbl">Exact Duplicates</div><div class="kpi-val" id="dd-exact">38</div><div class="kpi-sub">SHA-256 matched</div></div>
          <div class="kpi r"><div class="kpi-lbl">Near Duplicates</div><div class="kpi-val" id="dd-near">9</div><div class="kpi-sub">&gt;85% fuzzy match</div></div>
          <div class="kpi e"><div class="kpi-lbl">Auto-Resolved</div><div class="kpi-val" id="dd-resolved">34</div><div class="kpi-sub">Rule-based merge</div></div>
        </div>
        <div class="card">
          <div class="ch">
            <span class="ct">Quarantine Queue ‚Äî Pending Resolution</span>
            <div style="display:flex;gap:7px">
              <button class="btn2" onclick="resolveAll('accept')">Accept All</button>
              <button class="btn2" onclick="resolveAll('reject')">Reject All</button>
              <button class="btn2" onclick="runDedupScan()">Re-Scan</button>
            </div>
          </div>
          <div class="cb" style="padding:0;overflow-x:auto">
            <table><thead><tr><th>Record ID</th><th>Dataset</th><th>Match Type</th><th>Similarity</th><th>Matched Record</th><th>Source</th><th>Ingested</th><th>Actions</th></tr></thead><tbody id="dedup-tbody"></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== GOVERNANCE ==================== -->
    <section class="sec" id="sec-governance">
      <div class="tabs" id="gov-tabs">
        <div class="tab on" onclick="switchGovTab('pipeline',this)">Pipeline</div>
        <div class="tab" onclick="switchGovTab('files',this)">Ingested Files <span id="gov-files-badge" style="background:var(--brand);color:#fff;border-radius:10px;padding:1px 6px;font-size:8px;margin-left:4px">0</span></div>
        <div class="tab" onclick="switchGovTab('audit',this)">Audit Log</div>
        <div class="tab" onclick="switchGovTab('roles',this)">Role Management</div>
      </div>

      <div id="gov-pipeline-panel" class="card" style="margin-bottom:14px">
        <div class="ch"><span class="ct">Data Governance Pipeline</span><button class="btn2" style="font-size:9px" onclick="runDedupScan()">Run Dedup Scan</button></div>
        <div class="cb">
          <div class="gov-pipe" id="gov-pipe"></div>
          <div>
            <div style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:10px" id="queue-title">Records Pending Review</div>
            <table><thead><tr><th>Record ID</th><th>Dataset</th><th>Flag Reason</th><th>Source</th><th>Age</th><th>Actions</th></tr></thead><tbody id="gov-queue"></tbody></table>
          </div>
        </div>
      </div>

      <!-- Files Panel -->
      <div id="gov-files-panel" style="display:none">
        <div class="card">
          <div class="ch">
            <span class="ct">Ingested Files Queue</span>
            <span style="font-size:10px;color:var(--t3)">Review uploaded files before publishing to application</span>
          </div>
          <div class="cb">
            <div id="gov-files-list">
              <div style="font-size:11px;color:var(--t3);text-align:center;padding:20px">No files pending review. Upload files in Data Ingestion to see them here.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Audit Panel -->
      <div id="gov-audit-panel" style="display:none">
      <div class="card">
        <div class="ch">
          <span class="ct">Audit Log</span>
          <div style="display:flex;gap:7px">
            <select class="fc" style="width:130px;padding:5px 8px;font-size:10px" id="audit-filter" onchange="filterAudit()">
              <option value="">All Actions</option><option>Login</option><option>Data Access</option><option>Governance</option><option>System</option>
            </select>
            <button class="btn2" onclick="exportTable('audit-log','audit-log')">Export</button>
          </div>
        </div>
        <div class="cb">
          <table id="audit-log"><thead><tr><th>Timestamp (UTC)</th><th>User</th><th>Action</th><th>Status</th></tr></thead><tbody id="audit-tbody"></tbody></table>
        </div>
      </div>
      </div>

      <!-- Roles Panel -->
      <div id="gov-roles-panel" style="display:none">
        <div class="card">
          <div class="ch"><span class="ct">Role Management</span></div>
          <div class="cb">
            <table><thead><tr><th>User</th><th>Role</th><th>Access Level</th><th>Last Active</th><th>Actions</th></tr></thead>
            <tbody>
              <tr><td><strong>VJ</strong></td><td>Exploration Geologist</td><td>Full Access</td><td>Now</td><td><button class="btn2" style="font-size:9px">Edit</button></td></tr>
              <tr><td>A.Patel</td><td>Data Manager</td><td>Read + Write</td><td>1h ago</td><td><button class="btn2" style="font-size:9px">Edit</button></td></tr>
              <tr><td>M.Torres</td><td>Reviewer</td><td>Read + Review</td><td>2d ago</td><td><button class="btn2" style="font-size:9px">Edit</button></td></tr>
              <tr><td>K.Okafor</td><td>Basin Analyst</td><td>Read Only</td><td>3d ago</td><td><button class="btn2" style="font-size:9px">Edit</button></td></tr>
            </tbody></table>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn" onclick="toast('Invite sent','success')">+ Invite User</button>
              <button class="btn2" onclick="toast('Roles exported','success')">Export Roles CSV</button>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>
</main>

<!-- MODAL -->
<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div id="modal-content"></div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-wrap" id="toast-wrap"></div>

<script>
// ============================================================
// DATA
// ============================================================
const BASINS = [
  {name:'Zagros Fold Belt',country:'Iran / Iraq',region:'Middle East',tectonic:'Fold Belt',age:'Cambrian‚ÄìMiocene',hc:'Oil',area:234500,plays:18,score:92,status:'Mature'},
  {name:'Permian Basin',country:'USA',region:'North America',tectonic:'Intracratonic',age:'Permian',hc:'Oil',area:180000,plays:22,score:88,status:'Mature'},
  {name:'North Sea',country:'UK / Norway',region:'Europe',tectonic:'Rift Basin',age:'Triassic‚ÄìPaleocene',hc:'Oil & Gas',area:750000,plays:24,score:81,status:'Mature'},
  {name:'Kutei Basin',country:'Indonesia',region:'Southeast Asia',tectonic:'Foreland',age:'Eocene‚ÄìMiocene',hc:'Gas',area:165000,plays:12,score:74,status:'Active'},
  {name:'Nile Delta',country:'Egypt',region:'North Africa',tectonic:'Passive Margin',age:'Oligocene‚ÄìRecent',hc:'Gas',area:89000,plays:8,score:68,status:'Active'},
  {name:'Murzuq Basin',country:'Libya',region:'North Africa',tectonic:'Intracratonic',age:'Silurian‚ÄìDevonian',hc:'Oil',area:320000,plays:5,score:42,status:'Active'},
  {name:'Sergipe-Alagoas',country:'Brazil',region:'South America',tectonic:'Passive Margin',age:'Cretaceous‚ÄìRecent',hc:'Oil & Gas',area:42000,plays:9,score:35,status:'Frontier'},
  {name:'Malay Basin',country:'Malaysia',region:'Southeast Asia',tectonic:'Rift Basin',age:'Eocene‚ÄìMiocene',hc:'Gas',area:85000,plays:10,score:77,status:'Mature'},
  {name:'Niger Delta',country:'Nigeria',region:'West Africa',tectonic:'Passive Margin',age:'Eocene‚ÄìRecent',hc:'Oil & Gas',area:300000,plays:20,score:72,status:'Mature'},
  {name:'South Caspian',country:'Azerbaijan',region:'Middle East',tectonic:'Foreland',age:'Oligocene‚ÄìMiocene',hc:'Oil & Gas',area:70000,plays:8,score:80,status:'Active'},
  {name:'Barents Sea',country:'Norway',region:'Europe',tectonic:'Passive Margin',age:'Triassic‚ÄìCretaceous',hc:'Gas',area:1100000,plays:15,score:58,status:'Frontier'},
  {name:'Browse Basin',country:'Australia',region:'Australasia',tectonic:'Passive Margin',age:'Jurassic‚ÄìCretaceous',hc:'Gas',area:140000,plays:7,score:63,status:'Active'},
  {name:'East Greenland',country:'Greenland',region:'Arctic',tectonic:'Rift Basin',age:'Jurassic‚ÄìCretaceous',hc:'Oil',area:95000,plays:3,score:28,status:'Frontier'},
  {name:'Tarim Basin',country:'China',region:'Asia',tectonic:'Intracratonic',age:'Cambrian‚ÄìTriassic',hc:'Oil & Gas',area:560000,plays:16,score:65,status:'Active'},
  {name:'Neuqu√©n Basin',country:'Argentina',region:'South America',tectonic:'Foreland',age:'Triassic‚ÄìCretaceous',hc:'Oil & Gas',area:120000,plays:11,score:70,status:'Active'},
];

const ANALOGUES = [
  {
    rank:1, name:'Malay Basin ‚Äî Arang Fm.', basin:'Malay Basin', age:'Miocene', lith:'Sandstone', dep:'Deltaic', depth:2800, hc:'Oil', drive:'Water Drive', por:24.2, perm:412, rf:38, ntg:68, gor:520, api:34, sim:93,
    // Reservoir properties
    temp:98, pres_res:285, sw:0.22, bo:1.28, visc:1.8, gross_pay:42, net_pay:29,
    // Geopressure
    geo: { pres_grad:0.465, obstr_grad:1.02, frac_grad:0.75, ppg:8.95, ecd:9.1, overpressure:'Slight', overpressure_mech:'Compaction disequilibrium', pressure_regime:'Slightly overpressured', mudweight_min:9.0, mudweight_max:10.5, pressure_coeff:1.02 },
    // Geochemistry ‚Äî source rock
    geochem: { toc:2.8, ro_vitrinite:0.62, hindex:380, oindex:42, tmax:432, kerogen_type:'Type II', source_fm:'Brown Shale Fm.', expulsion_eff:62, charge_volume:'High', migration_dist:18, oil_family:'Waxy', sulfur_pct:0.18, c15_plus:72, api_pred:33 },
    // Mineralogy
    mineral: { quartz:62, feldspar:14, rock_fragments:8, kaolinite:7, illite:4, smectite:2, chlorite:1, calcite_cement:2, dolomite:0, pyrite:0.5, siderite:0, mica:0.5, clay_total:14, cement_type:'Silica + Kaolinite' },
    // Diagenesis
    diagenesis: { compaction:'Moderate', cementation:'Low‚ÄìModerate', dissolution:'Present (feldspar leaching)', burial_grade:'Early‚ÄìMiddle burial', qovergrowths:'Minor', chlorite_coat:'Absent', kaolinite_pore:'Present', authigenic_clay:'Kaolinite dominant', grain_coating:'Partial', fluid_inclusion_th:88 },
    // Fluid properties
    fluid: { oil_density:0.855, gas_sg:0.72, brine_sal:22400, h2s_ppm:12, co2_pct:3.2, n2_pct:1.1, c1_pct:38, c2_pct:8, c3_pct:5, wor:0.4, gfr:520, pb:185, rs:85, fvf_oil:1.28, z_factor:0.88 },
  },
  {
    rank:2, name:'Kutei Basin ‚Äî Tunu Field', basin:'Kutei Basin', age:'Miocene', lith:'Sandstone', dep:'Fluvio-Deltaic', depth:3100, hc:'Gas', drive:'Solution Gas', por:22.8, perm:285, rf:35, ntg:62, gor:8400, api:36, sim:87,
    temp:112, pres_res:318, sw:0.28, bo:1.22, visc:0.9, gross_pay:88, net_pay:55,
    geo: { pres_grad:0.478, obstr_grad:1.05, frac_grad:0.78, ppg:9.18, ecd:9.4, overpressure:'Moderate', overpressure_mech:'Hydrocarbon generation', pressure_regime:'Moderately overpressured', mudweight_min:9.3, mudweight_max:11.0, pressure_coeff:1.08 },
    geochem: { toc:3.2, ro_vitrinite:0.74, hindex:290, oindex:28, tmax:445, kerogen_type:'Type II/III', source_fm:'Pamaluan Shale', expulsion_eff:55, charge_volume:'Very High', migration_dist:8, oil_family:'Paraffinic', sulfur_pct:0.08, c15_plus:48, api_pred:36 },
    mineral: { quartz:58, feldspar:18, rock_fragments:10, kaolinite:5, illite:5, smectite:1, chlorite:2, calcite_cement:1, dolomite:0, pyrite:0.3, siderite:0.2, mica:0.5, clay_total:13, cement_type:'Silica' },
    diagenesis: { compaction:'Moderate‚ÄìHigh', cementation:'Low', dissolution:'Extensive (feldspar)', burial_grade:'Middle burial', qovergrowths:'Present', chlorite_coat:'Partial', kaolinite_pore:'Absent', authigenic_clay:'Illite + Chlorite', grain_coating:'Moderate', fluid_inclusion_th:102 },
    fluid: { oil_density:0.842, gas_sg:0.68, brine_sal:18600, h2s_ppm:5, co2_pct:1.8, n2_pct:2.2, c1_pct:88, c2_pct:5, c3_pct:2, wor:0.1, gfr:8400, pb:220, rs:42, fvf_oil:1.22, z_factor:0.92 },
  },
  {
    rank:3, name:'Borneo ‚Äî Miri Formation', basin:'Borneo Basin', age:'Eocene', lith:'Sandstone', dep:'Shallow Marine', depth:3400, hc:'Oil', drive:'Water Drive', por:19.5, perm:195, rf:31, ntg:55, gor:480, api:30, sim:79,
    temp:118, pres_res:348, sw:0.30, bo:1.19, visc:3.1, gross_pay:56, net_pay:31,
    geo: { pres_grad:0.452, obstr_grad:1.01, frac_grad:0.72, ppg:8.68, ecd:9.0, overpressure:'Normal', overpressure_mech:'None', pressure_regime:'Normally pressured', mudweight_min:8.6, mudweight_max:9.5, pressure_coeff:0.98 },
    geochem: { toc:1.9, ro_vitrinite:0.88, hindex:195, oindex:55, tmax:458, kerogen_type:'Type II/III', source_fm:'Eocene Lacustrine Shale', expulsion_eff:48, charge_volume:'Moderate', migration_dist:32, oil_family:'Biodegraded waxy', sulfur_pct:0.44, c15_plus:80, api_pred:29 },
    mineral: { quartz:55, feldspar:12, rock_fragments:14, kaolinite:9, illite:3, smectite:3, chlorite:2, calcite_cement:4, dolomite:1, pyrite:0.8, siderite:0.2, mica:1.0, clay_total:17, cement_type:'Calcite + Kaolinite' },
    diagenesis: { compaction:'High', cementation:'Moderate', dissolution:'Minor', burial_grade:'Deep burial', qovergrowths:'Moderate', chlorite_coat:'Absent', kaolinite_pore:'Present', authigenic_clay:'Kaolinite dominant', grain_coating:'Minor', fluid_inclusion_th:115 },
    fluid: { oil_density:0.878, gas_sg:0.75, brine_sal:28900, h2s_ppm:35, co2_pct:4.8, n2_pct:0.8, c1_pct:28, c2_pct:6, c3_pct:4, wor:1.2, gfr:480, pb:142, rs:72, fvf_oil:1.19, z_factor:0.86 },
  },
  {
    rank:4, name:'Niger Delta ‚Äî Agbada Fm.', basin:'Niger Delta', age:'Miocene', lith:'Sandstone', dep:'Deltaic', depth:3200, hc:'Oil & Gas', drive:'Solution Gas', por:21.3, perm:310, rf:34, ntg:60, gor:680, api:33, sim:74,
    temp:108, pres_res:326, sw:0.25, bo:1.25, visc:2.2, gross_pay:72, net_pay:43,
    geo: { pres_grad:0.489, obstr_grad:1.08, frac_grad:0.80, ppg:9.40, ecd:9.7, overpressure:'High', overpressure_mech:'Compaction disequilibrium + gas generation', pressure_regime:'Overpressured', mudweight_min:9.5, mudweight_max:12.0, pressure_coeff:1.15 },
    geochem: { toc:3.8, ro_vitrinite:0.68, hindex:420, oindex:35, tmax:438, kerogen_type:'Type II', source_fm:'Akata Shale', expulsion_eff:70, charge_volume:'Very High', migration_dist:12, oil_family:'Paraffinic-naphthenic', sulfur_pct:0.22, c15_plus:65, api_pred:34 },
    mineral: { quartz:60, feldspar:15, rock_fragments:9, kaolinite:6, illite:5, smectite:2, chlorite:1, calcite_cement:2, dolomite:0, pyrite:0.4, siderite:0.1, mica:0.5, clay_total:14, cement_type:'Silica + Minor Calcite' },
    diagenesis: { compaction:'Moderate', cementation:'Low', dissolution:'Present (feldspars + carbonates)', burial_grade:'Early‚ÄìMiddle burial', qovergrowths:'Minor', chlorite_coat:'Local', kaolinite_pore:'Present', authigenic_clay:'Kaolinite + Illite', grain_coating:'Partial', fluid_inclusion_th:95 },
    fluid: { oil_density:0.862, gas_sg:0.70, brine_sal:24500, h2s_ppm:8, co2_pct:2.5, n2_pct:1.5, c1_pct:52, c2_pct:9, c3_pct:6, wor:0.6, gfr:680, pb:198, rs:92, fvf_oil:1.25, z_factor:0.90 },
  },
  {
    rank:5, name:'Nile Delta ‚Äî Biogenic Play', basin:'Nile Delta', age:'Pliocene', lith:'Sandstone', dep:'Fluvio-Deltaic', depth:2200, hc:'Gas', drive:'Water Drive', por:28.1, perm:580, rf:42, ntg:75, gor:12000, api:38, sim:68,
    temp:82, pres_res:218, sw:0.18, bo:1.12, visc:0.6, gross_pay:120, net_pay:90,
    geo: { pres_grad:0.442, obstr_grad:0.98, frac_grad:0.70, ppg:8.50, ecd:8.7, overpressure:'Normal', overpressure_mech:'None', pressure_regime:'Normally pressured', mudweight_min:8.4, mudweight_max:9.2, pressure_coeff:0.95 },
    geochem: { toc:1.2, ro_vitrinite:0.38, hindex:520, oindex:20, tmax:418, kerogen_type:'Type II (biogenic gas)', source_fm:'Biogenic (in-situ)', expulsion_eff:90, charge_volume:'High', migration_dist:2, oil_family:'Biogenic gas', sulfur_pct:0.02, c15_plus:15, api_pred:40 },
    mineral: { quartz:72, feldspar:8, rock_fragments:5, kaolinite:4, illite:3, smectite:4, chlorite:1, calcite_cement:1, dolomite:0, pyrite:0.2, siderite:0, mica:0.3, clay_total:12, cement_type:'Minor Silica' },
    diagenesis: { compaction:'Low', cementation:'Very Low', dissolution:'Negligible', burial_grade:'Shallow burial', qovergrowths:'Absent', chlorite_coat:'Absent', kaolinite_pore:'Minor', authigenic_clay:'Smectite', grain_coating:'Absent', fluid_inclusion_th:62 },
    fluid: { oil_density:0.832, gas_sg:0.62, brine_sal:15200, h2s_ppm:0, co2_pct:0.8, n2_pct:0.5, c1_pct:97, c2_pct:1, c3_pct:0.5, wor:0.05, gfr:12000, pb:95, rs:28, fvf_oil:1.12, z_factor:0.95 },
  },
  {
    rank:6, name:'Gulf of Mexico ‚Äî Wilcox', basin:'Gulf of Mexico', age:'Eocene', lith:'Sandstone', dep:'Deep Marine', depth:4800, hc:'Oil', drive:'Water Drive', por:17.2, perm:88, rf:28, ntg:48, gor:420, api:29, sim:62,
    temp:148, pres_res:580, sw:0.34, bo:1.35, visc:4.8, gross_pay:62, net_pay:30,
    geo: { pres_grad:0.722, obstr_grad:1.18, frac_grad:0.92, ppg:13.88, ecd:14.2, overpressure:'Extreme', overpressure_mech:'Compaction disequilibrium + smectite-illite transformation', pressure_regime:'Highly overpressured', mudweight_min:14.0, mudweight_max:16.5, pressure_coeff:1.55 },
    geochem: { toc:4.2, ro_vitrinite:0.95, hindex:280, oindex:48, tmax:462, kerogen_type:'Type II/IIS', source_fm:'Tuscaloosa Marine Shale', expulsion_eff:58, charge_volume:'High', migration_dist:45, oil_family:'Sulfur-rich', sulfur_pct:1.8, c15_plus:85, api_pred:28 },
    mineral: { quartz:48, feldspar:20, rock_fragments:12, kaolinite:5, illite:8, smectite:1, chlorite:4, calcite_cement:5, dolomite:2, pyrite:1.2, siderite:0.4, mica:1.4, clay_total:18, cement_type:'Calcite + Illite + Chlorite' },
    diagenesis: { compaction:'Very High', cementation:'High', dissolution:'Moderate (carbonate)', burial_grade:'Deep‚ÄìUltradeep burial', qovergrowths:'Extensive', chlorite_coat:'Present', kaolinite_pore:'Absent', authigenic_clay:'Illite dominant', grain_coating:'Strong', fluid_inclusion_th:138 },
    fluid: { oil_density:0.884, gas_sg:0.78, brine_sal:38500, h2s_ppm:120, co2_pct:8.2, n2_pct:1.8, c1_pct:22, c2_pct:5, c3_pct:3, wor:2.1, gfr:420, pb:128, rs:68, fvf_oil:1.35, z_factor:0.82 },
  },
  {
    rank:7, name:'West Africa ‚Äî Pliocene SS', basin:'Congo Basin', age:'Pliocene', lith:'Sandstone', dep:'Turbidite', depth:2600, hc:'Oil', drive:'Combination', por:23.5, perm:340, rf:36, ntg:58, gor:540, api:32, sim:60,
    temp:92, pres_res:262, sw:0.26, bo:1.24, visc:2.5, gross_pay:50, net_pay:29,
    geo: { pres_grad:0.468, obstr_grad:1.03, frac_grad:0.76, ppg:9.00, ecd:9.2, overpressure:'Slight', overpressure_mech:'Compaction', pressure_regime:'Slightly overpressured', mudweight_min:9.0, mudweight_max:10.0, pressure_coeff:1.04 },
    geochem: { toc:2.5, ro_vitrinite:0.55, hindex:340, oindex:38, tmax:428, kerogen_type:'Type II', source_fm:'Deep-water Maastrichtian Shale', expulsion_eff:52, charge_volume:'Moderate', migration_dist:22, oil_family:'Paraffinic', sulfur_pct:0.15, c15_plus:70, api_pred:32 },
    mineral: { quartz:64, feldspar:13, rock_fragments:8, kaolinite:6, illite:4, smectite:2, chlorite:1, calcite_cement:2, dolomite:0, pyrite:0.5, siderite:0.1, mica:0.4, clay_total:13, cement_type:'Silica + Kaolinite' },
    diagenesis: { compaction:'Low‚ÄìModerate', cementation:'Low', dissolution:'Present (feldspar)', burial_grade:'Early‚ÄìMiddle burial', qovergrowths:'Minor', chlorite_coat:'Absent', kaolinite_pore:'Present', authigenic_clay:'Kaolinite', grain_coating:'Minor', fluid_inclusion_th:78 },
    fluid: { oil_density:0.866, gas_sg:0.71, brine_sal:21000, h2s_ppm:18, co2_pct:3.5, n2_pct:1.2, c1_pct:42, c2_pct:8, c3_pct:5, wor:0.8, gfr:540, pb:168, rs:80, fvf_oil:1.24, z_factor:0.89 },
  },
];

const RISK_ELEMENTS = [
  {key:'source',label:'Source / Charge',val:75,default:75,bench:'55‚Äì85%',lo:55,hi:85},
  {key:'reservoir',label:'Reservoir Presence',val:80,default:80,bench:'65‚Äì90%',lo:65,hi:90},
  {key:'seal',label:'Seal Integrity',val:65,default:65,bench:'50‚Äì80%',lo:50,hi:80},
  {key:'trap',label:'Trap Geometry',val:70,default:70,bench:'60‚Äì85%',lo:60,hi:85},
  {key:'migration',label:'Migration Pathway',val:85,default:85,bench:'50‚Äì75%',lo:50,hi:75},
];

const SCREEN_CRITERIA = [
  {key:'source',label:'Source Rock Quality',val:20},
  {key:'reservoir',label:'Reservoir Quality',val:25},
  {key:'seal',label:'Seal Effectiveness',val:15},
  {key:'charge',label:'Charge Risk',val:15},
  {key:'commercial',label:'Commercial Attractiveness',val:15},
  {key:'country',label:'Country Risk',val:10},
];

const GOV_QUEUE = [
  {id:'RES-48821',dataset:'C&C Reservoirs Analogue',flag:'Near-duplicate (89% match)',flagType:'warn',source:'C&C Bulk Import',age:'2h'},
  {id:'BAS-12043',dataset:'IHS Basin Monitor',flag:'Coordinate outside basin polygon',flagType:'error',source:'IHS Weekly',age:'4h'},
  {id:'SRC-7821',dataset:'Neftex Source Rock',flag:'Missing mandatory: Ro% field',flagType:'warn',source:'Neftex Weekly',age:'1d'},
];


// Prospects for GCoS Calculator
let PROSPECTS = [
  {name:'Prospect Alpha',  basin:'Zagros Fold Belt',  type:'Structural',  target:'Asmari Carbonate',    depth:2400, ps:55, pr:70, pse:65, pt:60, pm:72},
  {name:'Prospect Beta',   basin:'Kutei Basin',       type:'Stratigraphic',target:'Balikpapan SS',       depth:3100, ps:40, pr:65, pse:55, pt:50, pm:60},
  {name:'Prospect Gamma',  basin:'Malay Basin',       type:'Structural',  target:'Middle Group Sands',   depth:2800, ps:50, pr:75, pse:60, pt:55, pm:65},
  {name:'Prospect Delta',  basin:'Nile Delta',        type:'Stratigraphic',target:'Abu Madi Channel SS',  depth:3600, ps:45, pr:60, pse:70, pt:65, pm:58},
  {name:'Prospect Epsilon',basin:'North Sea',         type:'Structural',  target:'Brent Sandstone',      depth:3200, ps:60, pr:80, pse:75, pt:70, pm:68},
  {name:'Prospect Zeta',   basin:'Permian Basin',     type:'Unconventional',target:'Wolfcamp Shale',     depth:2900, ps:75, pr:55, pse:80, pt:70, pm:62},
  {name:'Prospect Eta',    basin:'Niger Delta',       type:'Structural',  target:'Agbada Paralic SS',    depth:2200, ps:65, pr:72, pse:68, pt:58, pm:70},
];
let currentProspect = 'Prospect Alpha';

function initProspectDropdown() {
  const sel = document.getElementById('prospect-select');
  if (!sel) return;
  sel.innerHTML = '<option value="">‚Äî Select Prospect ‚Äî</option>' +
    PROSPECTS.map(p => `<option value="${p.name}">${p.name} (${p.basin})</option>`).join('');
  sel.value = currentProspect;
  // Load the current prospect's values into sliders
  loadProspect(currentProspect);
}

// Recently ingested files awaiting governance approval
let INGESTED_FILES = [];

const AUDIT_ENTRIES = [
  {time:'2026-02-23 14:32',user:'VJ',action:'Analogue search ‚Äî Eocene SS, SE Asia ¬∑ 5,847 records queried',status:'SUCCESS',type:'Data Access'},
  {time:'2026-02-23 13:18',user:'SYS-AUTO',action:'Neftex connector sync ¬∑ 2,341 records ingested ¬∑ 0 duplicates',status:'SUCCESS',type:'System'},
  {time:'2026-02-23 11:05',user:'K.Okafor',action:'Basin screening run ‚Äî SE Asia ¬∑ 68 basins scored',status:'SUCCESS',type:'Data Access'},
  {time:'2026-02-23 09:47',user:'SYS-AUTO',action:'IHS connector auth failure ‚Äî token expired',status:'FAILED',type:'System'},
  {time:'2026-02-22 16:22',user:'A.Patel',action:'Role assignment: M.Torres ‚Üí Reviewer granted',status:'MODIFIED',type:'Governance'},
  {time:'2026-02-22 14:10',user:'M.Torres',action:'Record RES-48820 governance action: Merged with RES-48700',status:'MERGED',type:'Governance'},
  {time:'2026-02-22 10:33',user:'VJ',action:'GCoS saved ‚Äî Prospect Alpha: 23.1%',status:'SUCCESS',type:'Data Access'},
  {time:'2026-02-21 16:05',user:'SYS-AUTO',action:'Rystad daily feed ingested ¬∑ 412 economics records updated',status:'SUCCESS',type:'System'},
];

const PARAM_DATA = {
  por:{label:'Porosity (%)',unit:'%',p10:14.2,p50:21.5,p90:29.8,mean:21.9,shape:'normal',color:'#00C8FF',records:3241},
  perm:{label:'Permeability (mD)',unit:'mD',p10:45,p50:340,p90:1820,mean:512,shape:'lognormal',color:'#F0A500',records:2987},
  rf:{label:'Recovery Factor (%)',unit:'%',p10:18.4,p50:34.2,p90:51.6,mean:34.8,shape:'normal',color:'#00E5A0',records:2145},
  ntg:{label:'Net-to-Gross (%)',unit:'%',p10:35,p50:62.5,p90:84,mean:61.2,shape:'bimodal',color:'#00C8FF',records:1856},
  gor:{label:'GOR (scf/bbl)',unit:'scf/bbl',p10:320,p50:840,p90:2450,mean:1102,shape:'lognormal',color:'#F0A500',records:1423},
  api:{label:'API Gravity (¬∞API)',unit:'¬∞',p10:22.4,p50:33.8,p90:44.2,mean:33.5,shape:'normal',color:'#00E5A0',records:1988},
};

const CONNECTORS = [
  {name:'Neftex (Halliburton)',status:'LIVE',color:'var(--green)',last:'2h ago'},
  {name:'IHS Energy / S&P Global',status:'AUTH ERROR',color:'var(--red)',last:'Failed 4h ago'},
  {name:'Rystad Energy',status:'LIVE',color:'var(--green)',last:'1h ago'},
  {name:'Wood Mackenzie',status:'PENDING',color:'var(--amber)',last:'Not configured'},
  {name:'C&C Reservoirs',status:'LIVE',color:'var(--green)',last:'12h ago'},
];

const MAP_BASINS = {
  zagros:{name:'Zagros Fold Belt',region:'Middle East',score:92,hc:'Oil',status:'Mature'},
  northsea:{name:'North Sea',region:'Europe',score:81,hc:'Oil & Gas',status:'Mature'},
  permian:{name:'Permian Basin',region:'North America',score:88,hc:'Oil',status:'Mature'},
  kutei:{name:'Kutei Basin',region:'SE Asia',score:74,hc:'Gas',status:'Active'},
  nile:{name:'Nile Delta',region:'North Africa',score:68,hc:'Gas',status:'Active'},
};

const ACTIVITIES = [
  {dot:'var(--cyan)',text:'Neftex weekly feed ingested ‚Äî <strong>2,341 records</strong> updated',time:'2 hours ago ¬∑ Data Manager'},
  {dot:'var(--green)',text:'Basin screening completed ‚Äî <strong>South Atlantic</strong> ranked #3',time:'4 hours ago ¬∑ K. Okafor'},
  {dot:'var(--amber)',text:'3 records flagged in governance queue ‚Äî <strong>Action needed</strong>',time:'Yesterday ¬∑ System'},
  {dot:'var(--cyan)',text:'New analogue match: <strong>Malay Basin</strong> ‚Üí Kutei Basin (87%)',time:'Yesterday ¬∑ AI Engine'},
  {dot:'var(--red)',text:'IHS connector sync failed ‚Äî <strong>Token expired</strong>',time:'2 days ago ¬∑ Alert'},
  {dot:'var(--green)',text:'GCoS estimate saved ‚Äî Prospect Alpha: <strong>23.1%</strong>',time:'2 days ago ¬∑ VJ'},
];

let sortState = {col:'score',dir:-1};
let selectedAnalogues = new Set();
let riskVals = Object.fromEntries(RISK_ELEMENTS.map(e => [e.key, e.val]));
let screenVals = {};
let filteredBasins = [...BASINS];
let searchResults = [...ANALOGUES];
let leaderboardData = [];

// ============================================================
// INIT
// ============================================================
window.onload = () => {
  animateCounters();
  renderActivity();
  renderTopBasins();
  renderDQSummary();
  renderBasinTable(BASINS);
  populateProspectDropdown();
  renderGCoS();
  // Handle URL hash for bookmarking / back-button
  const initHash = location.hash.replace('#','');
  if (initHash && document.getElementById('sec-'+initHash)) {
    const nav = document.querySelector(`.nav[onclick*="'${initHash}'"]`);
    goTo(initHash, nav);
  }
  window.addEventListener('popstate', () => {
    const h = location.hash.replace('#','');
    if (h && document.getElementById('sec-'+h)) {
      const nav = document.querySelector(`.nav[onclick*="'${h}'"]`);
      goTo(h, nav, true);
    }
  });
  renderTornado();
  renderScreenCriteria();
  renderDists();
  renderGovPipe();
  renderGovQueue();
  renderAuditLog(AUDIT_ENTRIES);
  renderConnectors();
  renderIngHistory();
  setupMap();
  setupCrossplot();
  // Populate basin profile select
  const bpSel = document.getElementById('bp-basin-select');
  if (bpSel) bpSel.innerHTML = '<option value="">Choose a basin to view exploration profile‚Ä¶</option>' + BASINS.map(b => `<option value="${b.name}">${b.name} ‚Äî ${b.region}</option>`).join('');
  // Init ingestion panel ‚Äî show overview by default
  ingTab('overview', document.querySelector('#sec-ingestion .tab'));
  // Run a default screening so leaderboard is pre-populated
  setTimeout(() => initDefaultLeaderboard(), 200);
};

// ============================================================
// NAVIGATION
// ============================================================
const SECTION_TITLES = {portfolio:'Portfolio Dashboard',basins:'Basin Catalogue',analogues:'Reservoir Analogue Engine',params:'Parameter Library',risk:'Risk & Uncertainty',screening:'Basin Screening',ingestion:'Data Ingestion',governance:'Governance & Audit'};

const PAGE_NAMES = {
  portfolio:'Portfolio Dashboard',
  basins:'Basin Catalogue',
  analogues:'Analogue Engine',
  params:'Parameter Library',
  risk:'Risk & Uncertainty',
  screening:'Basin Screening',
  ingestion:'Data Ingestion',
  governance:'Governance'
};

function goTo(id, navEl) {
  if (id !== 'basins' && _focusedBasin && _leafletMap) {
    _focusedBasin = null;
    _leafletMap.closePopup();
    _leafletMap.flyTo([20, 20], 2, { duration: 1 });
  }
  document.querySelectorAll('.sec').forEach(s => s.classList.remove('on'));
  document.querySelectorAll('.nav').forEach(n => n.classList.remove('on'));
  // Update page title and breadcrumb
  const pageName = PAGE_NAMES[id] || id;
  document.title = 'EDAFY Basin Insights ‚Äî ' + pageName;
  const bc = document.getElementById('breadcrumb-section');
  if (bc) bc.textContent = pageName;
  document.getElementById('breadcrumb-sub').textContent = '';
  // Update URL hash for multi-page feel
  if (history.pushState) history.pushState(null, null, '#' + id);
  document.getElementById('sec-'+id).classList.add('on');
  // Initialize section-specific components
  if (id === 'portfolio') setTimeout(setupPortfolioMap, 100);
  if (id === 'basins') setTimeout(setupMap, 100);
  if (id === 'risk') setTimeout(initProspectDropdown, 50);
  if (navEl) navEl.classList.add('on');
  else {
    document.querySelectorAll('.nav').forEach(n => {
      if (n.getAttribute('onclick') && n.getAttribute('onclick').includes("'"+id+"'")) n.classList.add('on');
    });
  }
  document.getElementById('tb-title').textContent = SECTION_TITLES[id] || id;
  loadBar();
}

function closeNLP() {
  document.getElementById('nlp-result').classList.remove('show');
  document.querySelector('.content').classList.remove('nlp-open');
}

function loadBar() {
  const lb = document.getElementById('loadbar');
  lb.classList.add('show');
  setTimeout(() => lb.classList.remove('show'), 800);
}

// ============================================================
// SIDEBAR COLLAPSE
// ============================================================
function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const main = document.querySelector('.main');
  const nlpResult = document.getElementById('nlp-result');
  const btn = document.getElementById('sb-toggle');
  if (sb.classList.contains('collapsed')) {
    sb.classList.remove('collapsed');
    sb.classList.remove('hover-expanded');
    sb.dataset.pinned = '1';
    main.classList.remove('sb-collapsed');
    if (nlpResult) nlpResult.classList.remove('sb-collapsed');
    btn.textContent = '‚Äπ';
    document.documentElement.style.setProperty('--sb-width', '232px');
  } else {
    sb.classList.add('collapsed');
    delete sb.dataset.pinned;
    main.classList.add('sb-collapsed');
    if (nlpResult) nlpResult.classList.add('sb-collapsed');
    btn.textContent = '‚Ä∫';
    document.documentElement.style.setProperty('--sb-width', '56px');
  }
}
(function() {
  const sb = document.getElementById('sidebar');
  sb.addEventListener('mouseenter', () => {
    if (sb.classList.contains('collapsed') && !sb.dataset.pinned)
      sb.classList.add('hover-expanded');
  });
  sb.addEventListener('mouseleave', () => {
    sb.classList.remove('hover-expanded');
  });
})();

// ============================================================
// TAB SWITCHING ‚Äî generic
// ============================================================
function switchTab(el, group) {
  el.closest('.tabs').querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  el.classList.add('on');
}

// ============================================================
// RISK TABS
// ============================================================
function syncRiskFromMC() {
  // GRV ‚Äî parse ML from "min / ml / max" string
  const grvRaw = document.getElementById('mc-grv')?.value || '';
  const grvParts = grvRaw.split('/').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
  const grvML = grvParts.length >= 2 ? grvParts[1] : grvParts[0];
  if (grvML > 0) setIfEmpty('vi-grv', grvML);

  // Direct numeric fields
  const map = [
    ['mc-ntg-p50', 'vi-ntg'],
    ['mc-phi-p50', 'vi-phi'],
    ['mc-sw',      'vi-sw'],
    ['mc-bo',      'vi-bo'],
    ['mc-rf-p50',  'vi-rf'],
  ];
  map.forEach(([src, dst]) => {
    const val = document.getElementById(src)?.value;
    if (val !== undefined && val !== '') setIfEmpty(dst, val);
  });
}

function setIfEmpty(id, val) {
  const el = document.getElementById(id);
  if (el && (el.value === '' || el.value === undefined)) el.value = val;
  else if (el) el.value = val; // always overwrite ‚Äî MC is the source of truth
}

function switchRiskTab(tab, el) {
  ['gcos','vol','mc','sens'].forEach(t => {
    const p = document.getElementById('risk-'+t+'-panel');
    if (p) p.style.display = (t === tab) ? 'block' : 'none';
  });
  if (el) {
    el.closest('.tabs').querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
    el.classList.add('on');
  }
  if (tab === 'vol')  { syncRiskFromMC(); calcVolume(); renderVolSens(); }
  if (tab === 'mc')   { renderMCConfigReadonly(); renderMCInit(); }
  if (tab === 'sens') { syncRiskFromMC(); initSensParams(); buildSensParamTable(); renderTornado(); renderSpider(); renderSensKpis(); }
  if (tab === 'gcos') { renderGCoSRadar(); calcRiskedSTOIIP(); renderGCoSPortfolio(); }
}

// ============================================================
// PARAMS TABS
// ============================================================
function switchParamsTab(tab, el) {
  document.getElementById('params-dist-panel').style.display  = tab === 'dist'  ? 'block' : 'none';
  document.getElementById('params-store-panel').style.display = tab === 'store' ? 'block' : 'none';
  if (el) {
    el.closest('.tabs').querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
    el.classList.add('on');
  }
  if (tab === 'dist')  { renderDists(); }
}

// ============================================================
// SCREENING TABS
// ============================================================
function switchScreenTab(tab, el) {
  ['config','leaderboard','profiles'].forEach(t => {
    const p = document.getElementById('screen-'+t+'-panel');
    if (p) p.style.display = (t === tab) ? 'block' : 'none';
  });
  if (el) {
    el.closest('.tabs').querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
    el.classList.add('on');
  }
  if (tab === 'leaderboard') renderLeaderboard();
  if (tab === 'profiles') populateBasinProfileSelect();
}

// ============================================================
// ANALOGUE TABS ‚Äî with inactive state management
// ============================================================
let _searchHasRun = false; // set to true after first successful search

function anaTabGuard(tab, el) {
  if (!_searchHasRun) {
    toast('Run an Analogue Search first to unlock Comparison Table and Similarity Analysis', 'warning');
    // briefly flash the tab as inactive
    el.style.opacity = '0.4';
    setTimeout(() => el.style.opacity = '', 600);
    return;
  }
  switchAnalogueTab(tab, el);
}

function switchAnalogueTab(tab, el) {
  document.getElementById('ana-search-panel').style.display     = tab === 'search'     ? 'block' : 'none';
  document.getElementById('ana-crossplot-panel').style.display  = 'none';
  document.getElementById('ana-compare-panel').style.display    = tab === 'compare'    ? 'block' : 'none';
  document.getElementById('ana-similarity-panel').style.display = tab === 'similarity' ? 'block' : 'none';
  const tabs = document.querySelectorAll('#ana-tabs .tab');
  tabs.forEach(t => t.classList.remove('on'));
  if (tab === 'search'     && tabs[0]) tabs[0].classList.add('on');
  if (tab === 'compare'    && tabs[1]) tabs[1].classList.add('on');
  if (tab === 'similarity' && tabs[2]) tabs[2].classList.add('on');
  if (tab === 'compare')    renderCompareTable();
  if (tab === 'similarity') renderSimilarityAnalysis();
  if (el && !el.classList.contains('on')) { el.classList.add('on'); }
}

// ============================================================
// COUNTERS
// ============================================================
setTimeout(setupPortfolioMap, 600);

function animateCounters() {
  document.querySelectorAll('.counter').forEach(el => {
    const target = parseInt(el.dataset.target);
    let cur = 0;
    const step = Math.ceil(target / 60);
    const iv = setInterval(() => {
      cur = Math.min(cur + step, target);
      el.textContent = cur.toLocaleString();
      if (cur >= target) clearInterval(iv);
    }, 16);
  });
}

// ============================================================
// TOAST
// ============================================================
function toast(msg, type='info', icon='') {
  const wrap = document.getElementById('toast-wrap');
  const icons = {success:'‚úì',error:'‚úó',warning:'‚ö†',info:'‚óà'};
  const colors = {success:'var(--green)',error:'var(--red)',warning:'var(--amber)',info:'var(--cyan)'};
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<span style="color:${colors[type]};font-size:14px">${icons[type]||'‚óà'}</span><span>${msg}</span>`;
  wrap.appendChild(t);
  setTimeout(() => { t.style.animation = 'toastOut .3s ease forwards'; setTimeout(() => t.remove(), 300); }, 3000);
}

// ============================================================
// MODAL
// ============================================================
function openModal(html) {
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal').classList.add('open');
}
function closeModal() { document.getElementById('modal').classList.remove('open'); }

// ============================================================
// MAP
// ============================================================
let _leafletMap = null;
let _leafletMarkers = [];
let _portfolioMap = null;
let _portfolioMarkers = [];
let _focusedBasin = null;
let _simCrossplotChart = null;
let _simHistChart = null;
let _simRadarChart = null;
let _gcosRadarChart = null;
let _pcHoveredRank = null;
let _pcLastA = null;
let _pcLastT = null;
let _pcListenersAdded = false;
let _pcMouseX = 0, _pcMouseY = 0;

function setupPortfolioMap() {
  const el = document.getElementById('portfolio-leaflet-map');
  if (!el) return;
  if (_portfolioMap) { _portfolioMap.remove(); _portfolioMap = null; }
  _portfolioMap = L.map('portfolio-leaflet-map', {
    center:[20,20], zoom:2, minZoom:2, maxZoom:8,
    zoomControl:true, attributionControl:false
  });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(_portfolioMap);
  L.control.attribution({position:'bottomright'}).addTo(_portfolioMap).setPrefix('¬© OpenStreetMap | EDAFY');
  renderPortfolioMapMarkers();
}

function renderPortfolioMapMarkers() {
  if (!_portfolioMap) return;
  _portfolioMarkers.forEach(m => _portfolioMap.removeLayer(m));
  _portfolioMarkers = [];
  BASINS.forEach(basin => {
    const coords = getBasinCoords(basin);
    const score = basin.score || 50;
    const color = score >= 70 ? '#00875A' : score >= 40 ? '#C07800' : '#D93025';
    const r = Math.max(7, Math.min(18, score/5.5));
    const icon = L.divIcon({
      className:'',
      html:`<div style="width:${r*2}px;height:${r*2}px;border-radius:50%;background:${color};border:2.5px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.4);cursor:pointer;transition:transform .15s" title="${basin.name}: ${score}/100"></div>`,
      iconSize:[r*2,r*2], iconAnchor:[r,r]
    });
    const m = L.marker(coords,{icon}).addTo(_portfolioMap);
    const sc = {Mature:'#00875A',Active:'#0088CC',Frontier:'#C07800'}[basin.status]||'#8896A5';
    m.bindPopup(`<div style="font-family:Segoe UI,sans-serif;min-width:180px"><div style="font-size:12px;font-weight:700;color:#2D1B69;margin-bottom:5px">${basin.name}</div><table style="width:100%;font-size:10px;border-collapse:collapse"><tr><td style="color:#8896A5">Country</td><td style="font-weight:600">${basin.country}</td></tr><tr><td style="color:#8896A5">HC Phase</td><td style="color:#0088CC;font-weight:600">${basin.hc}</td></tr><tr><td style="color:#8896A5">Score</td><td style="font-weight:700;color:${color}">${score}/100</td></tr><tr><td style="color:#8896A5">Status</td><td><span style="background:${sc}18;color:${sc};padding:1px 6px;border-radius:8px;font-weight:600;font-size:9px">${basin.status}</span></td></tr></table><div style="margin-top:6px"><button onclick="closeModal();goTo('basins',null)" style="background:#2D1B69;color:#fff;border:none;padding:3px 8px;border-radius:4px;font-size:9px;cursor:pointer">View Basin</button></div></div>`);
    _portfolioMarkers.push(m);
  });
}

// Basin coordinate lookup (lat/lng) ‚Äî extended for all basins
const BASIN_COORDS = {
  'Zagros Fold Belt':     [32.0, 47.5],
  'Permian Basin':        [31.5,-102.5],
  'North Sea':            [56.5,  3.5],
  'Kutei Basin':          [-1.0, 117.0],
  'Nile Delta':           [31.0,  31.0],
  'Murzuq Basin':         [26.0,  14.0],
  'Sergipe-Alagoas':      [-11.0,-37.0],
  'Malay Basin':          [ 6.0, 104.0],
  'Browse Basin':         [-16.0,122.0],
  'Barents Sea':          [74.0,  30.0],
  'East Greenland':       [72.0, -25.0],
  'Vaca Muerta':          [-38.0,-69.0],
  'Permian Basin (China)':[39.0,  85.0],
  'Tarim Basin':          [39.5,  83.0],
  'Niger Delta':          [ 4.5,   6.5],
  'Anadarko Basin':       [35.5, -98.5],
  'Cooper Basin':         [-28.0,140.0],
  'Williston Basin':      [47.0,-103.0],
  'Rub al Khali':         [21.0,  54.0],
  'Sirte Basin':          [29.0,  20.0],
};

function getBasinCoords(basin) {
  if (BASIN_COORDS[basin.name]) return BASIN_COORDS[basin.name];
  // Fallback by region
  const regionFallbacks = {
    'Middle East':[28,45],'North America':[40,-100],'Europe':[52,15],
    'Southeast Asia':[5,115],'North Africa':[25,20],'South America':[-15,-55],
    'Australia':[-25,135],'Russia':[60,80],'West Africa':[5,5],
  };
  return regionFallbacks[basin.region] || [0,20];
}

function focusBasinOnMap(name) {
  if (_focusedBasin === name) return;
  _focusedBasin = name;
  const b = BASINS.find(x => x.name === name);
  if (!b || !_leafletMap) return;
  const coords = getBasinCoords(b);
  if (!coords) return;
  document.getElementById('world-map')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  _leafletMap.once('moveend', () => {
    const target = L.latLng(coords[0], coords[1]);
    const marker = _leafletMarkers.find(m => m.getLatLng().distanceTo(target) < 5000);
    if (marker) marker.openPopup();
  });
  _leafletMap.flyTo(coords, 6, { duration: 1.2 });
}

function setupMap() {
  const mapEl = document.getElementById('leaflet-map');
  if (!mapEl) return;

  // Init Leaflet map
  if (_leafletMap) { _leafletMap.remove(); _leafletMap = null; }
  _leafletMap = L.map('leaflet-map', {
    center: [20, 20], zoom: 2,
    minZoom: 2, maxZoom: 10,
    zoomControl: true,
    attributionControl: false
  });

  // OpenStreetMap tile layer (free)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(_leafletMap);

  // Add attribution discretely
  L.control.attribution({position:'bottomright'}).addTo(_leafletMap).setPrefix('¬© OpenStreetMap | EDAFY');

  renderMapMarkers();
}

function renderMapMarkers() {
  if (!_leafletMap) return;
  // Remove old markers
  _leafletMarkers.forEach(m => _leafletMap.removeLayer(m));
  _leafletMarkers = [];

  BASINS.forEach(basin => {
    const coords = getBasinCoords(basin);
    const score = basin.score || 50;
    const color = score >= 70 ? '#00875A' : score >= 40 ? '#C07800' : '#D93025';
    const r = Math.max(8, Math.min(20, score / 5));

    // Custom SVG circle marker
    const svgIcon = L.divIcon({
      className: '',
      html: `<div style="width:${r*2}px;height:${r*2}px;border-radius:50%;background:${color};border:2.5px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.35);cursor:pointer;opacity:0.9;transition:transform .15s" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'"></div>`,
      iconSize: [r*2, r*2],
      iconAnchor: [r, r],
    });

    const marker = L.marker(coords, {icon: svgIcon}).addTo(_leafletMap);

    const statusColor = {Mature:'#00875A',Active:'#0088CC',Frontier:'#C07800'}[basin.status]||'#8896A5';
    marker.bindPopup(`
      <div style="font-family:Segoe UI,sans-serif;min-width:200px">
        <div style="font-size:13px;font-weight:700;color:#2D1B69;margin-bottom:6px">${basin.name}</div>
        <table style="width:100%;font-size:11px;border-collapse:collapse">
          <tr><td style="color:#8896A5;padding:2px 0">Country</td><td style="font-weight:600">${basin.country}</td></tr>
          <tr><td style="color:#8896A5;padding:2px 0">Region</td><td style="font-weight:600">${basin.region}</td></tr>
          <tr><td style="color:#8896A5;padding:2px 0">HC Phase</td><td style="font-weight:600;color:#0088CC">${basin.hc}</td></tr>
          <tr><td style="color:#8896A5;padding:2px 0">Prospectivity</td><td style="font-weight:700;color:${color}">${score}/100</td></tr>
          <tr><td style="color:#8896A5;padding:2px 0">Status</td><td><span style="background:${statusColor}18;color:${statusColor};padding:1px 7px;border-radius:8px;font-weight:600;font-size:10px">${basin.status}</span></td></tr>
        </table>
        <div style="margin-top:8px;display:flex;gap:5px">
          <button onclick="closeModal();goTo('basins',null)" style="flex:1;padding:5px;background:#6B46C1;color:#fff;border:none;border-radius:4px;font-size:10px;cursor:pointer;font-family:inherit">Open Record</button>
          <button onclick="closeModal();goTo('analogues',null)" style="flex:1;padding:5px;background:#0088CC18;color:#0088CC;border:1px solid #0088CC44;border-radius:4px;font-size:10px;cursor:pointer;font-family:inherit">Analogues</button>
        </div>
      </div>`, {maxWidth: 260, className: 'edafy-popup'});

    _leafletMarkers.push(marker);
  });
  // Also refresh portfolio map if open
  renderPortfolioMapMarkers();
}

function openBasinModal(d) {
  if (!d) return;
  openModal(`
    <div class="modal-title">${d.name}</div>
    <div class="modal-sub">Region: ${d.region} &nbsp;¬∑&nbsp; Status: ${d.status}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
      <div style="background:var(--bg4);border-radius:5px;padding:11px">
        <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Prospectivity Score</div>
        <div style="font-size:28px;font-weight:700;color:var(--green)">${d.score}</div>
      </div>
      <div style="background:var(--bg4);border-radius:5px;padding:11px">
        <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">HC Phase</div>
        <div style="font-size:16px;font-weight:700;color:var(--cyan)">${d.hc}</div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="closeModal();goTo('analogues',null)">Run Analogue Search ‚Üí</button>
      <button class="btn2" onclick="closeModal();goTo('risk',null)">Risk Assessment ‚Üí</button>
    </div>
  `);
}

// ============================================================
// AI INSIGHTS ‚Äî Claude-powered portfolio analysis
// ============================================================
const AI_INSIGHTS = [
  `Your portfolio shows <strong>3 high-prospectivity basins</strong> (score ‚â•70) concentrated in the Middle East and SE Asia. Consider diversifying into the Browse Basin (score 63) for geographic risk reduction.`,
  `Data quality is currently <strong>${BASINS.filter(b=>b.score>0).length > 5 ? 'above' : 'below'} target</strong>. The Geochemistry dataset has the most incomplete records ‚Äî uploading TOC% and Ro% data would improve analogue matching accuracy by ~18%.`,
  `The <strong>Kutei Basin</strong> and <strong>Malay Basin</strong> show a high analogue similarity (87%). Consider running a joint volumetric analysis using Miocene deltaic sandstone parameters from both basins.`,
  `Based on current GCoS estimates, your portfolio has an expected discovery rate of <strong>~23%</strong> ‚Äî consistent with industry benchmarks for a mixed mature/frontier portfolio.`,
  `<strong>Geopressure data</strong> is missing for 6 of your high-priority analogues. Overpressure prediction is a key uncertainty in your SE Asia plays ‚Äî consider uploading pore pressure gradient data from offset wells.`,
  `The <strong>Analogue Engine</strong> has identified Zagros Fold Belt carbonates as the highest-scoring match (89%) for your Prospect Alpha target reservoir. GCoS for this prospect type averages 28% in the analogue database.`,
];
let _aiInsightIdx = 0;

// ============================================================
// AI ENGINE ‚Äî Anthropic Claude API integration
// ============================================================
async function callClaudeAI(prompt, systemPrompt) {
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 800,
        system: systemPrompt || 'You are an expert petroleum exploration geologist AI assistant embedded in the EDAFY Geo-Basin Intelligence Platform. Provide concise, technical, actionable insights. Use HTML bold tags for emphasis. Keep responses to 3-4 sentences.',
        messages: [{ role: 'user', content: prompt }]
      })
    });
    const data = await res.json();
    if (data.content && data.content[0]) return data.content[0].text;
    if (data.error) return null;
    return null;
  } catch(e) { return null; }
}

async function getAIPortfolioInsight() {
  const topBasin = [...BASINS].sort((a,b)=>b.score-a.score)[0];
  const avgScore = BASINS.length ? (BASINS.reduce((s,b)=>s+(b.score||0),0)/BASINS.length).toFixed(0) : 50;
  const highCount = BASINS.filter(b=>b.score>=70).length;
  const regionBreakdown = [...BASINS.reduce((m,b)=>{ m.set(b.region,(m.get(b.region)||0)+1); return m; },new Map())].map(([r,c])=>`${r}:${c}`).join(', ');

  // Show loading state
  openModal(`
    <div class="modal-title" style="display:flex;align-items:center;gap:10px">
      <span style="background:linear-gradient(135deg,#6B46C1,#0088CC);color:#fff;padding:5px 10px;border-radius:6px;font-size:11px;font-weight:700;letter-spacing:1px">AI</span>
      Portfolio Intelligence
    </div>
    <div id="ai-insight-content" style="padding:16px;background:linear-gradient(135deg,rgba(107,70,193,.06),rgba(0,136,204,.04));border:1px solid rgba(107,70,193,.15);border-radius:8px;margin:10px 0;font-size:12px;line-height:1.7;color:var(--t2)">
      <div style="display:flex;align-items:center;gap:8px;color:var(--purple)">
        <div style="width:8px;height:8px;border-radius:50%;background:var(--purple);animation:pulse 1s infinite"></div>
        Analysing portfolio data‚Ä¶
      </div>
    </div>
    <div id="ai-insight-footer" style="font-size:9px;color:var(--t3);margin-bottom:12px">Powered by Claude ‚Äî AFED Digital AI</div>
    <div style="display:flex;gap:7px">
      <button class="btn" onclick="getAIPortfolioInsight()">New Insight</button>
      <button class="btn2" onclick="closeModal()">Close</button>
    </div>`);

  const portfolioSummary = `Portfolio: ${BASINS.length} basins, ${ANALOGUES.length} analogues. Top basin: ${topBasin?.name||'N/A'} (score ${topBasin?.score||0}/100). Avg score: ${avgScore}. High-prospectivity (‚â•70): ${highCount}. Regions: ${regionBreakdown}. HC phases: ${[...new Set(BASINS.map(b=>b.hc))].join(', ')}.`;

  const aiText = await callClaudeAI(
    `Analyse this exploration portfolio and provide one key strategic insight: ${portfolioSummary}`,
    'You are an expert petroleum exploration geologist. Provide a concise (3-4 sentence) strategic insight about this portfolio. Be specific, reference the data provided, and suggest one concrete next action. Use <strong> tags for key terms.'
  );

  const content = document.getElementById('ai-insight-content');
  if (content) {
    if (aiText) {
      content.innerHTML = aiText;
      document.getElementById('ai-insight-footer').textContent = `AI analysis based on ${BASINS.length} basins and ${ANALOGUES.length} analogues ¬∑ Powered by Claude`;
    } else {
      // Fallback to local insights
      const localInsights = [
        `Your top basin is <strong>${topBasin?.name}</strong> with a prospectivity score of <strong>${topBasin?.score}/100</strong>. Average portfolio score is ${avgScore}/100 ‚Äî ${avgScore>=65?'above':'below'} the industry benchmark of 65.`,
        `You have <strong>${highCount} high-prospectivity basins</strong> (score ‚â•70). Consider running Basin Screening to rank them by weighted criteria before committing exploration budget.`,
        `Portfolio spans <strong>${regionBreakdown}</strong>. Geographic diversification can reduce portfolio risk ‚Äî ensure no single region holds more than 40% of your exploration commitment.`
      ];
      content.innerHTML = localInsights[Math.floor(Math.random()*localInsights.length)];
    }
  }
}

async function getAIAnalogueInsight() {
  if (!searchResults || !searchResults.length) { toast('Run an analogue search first', 'warning'); return; }
  const top5 = searchResults.slice(0,5).map(a=>`${a.name} (${a.sim}% match, œÜ=${a.por}%, k=${a.perm}mD, RF=${a.rf}%)`).join('; ');
  const insight = await callClaudeAI(
    `Top 5 analogues: ${top5}. Provide a brief technical summary of what these analogues suggest about expected reservoir performance.`,
    'You are a reservoir geologist. Provide a concise 3-sentence interpretation of these analogue results. Comment on consistency of reservoir quality and what the spread implies for risk. Use HTML <strong> tags.'
  );
  if (insight) {
    openModal(`
      <div class="modal-title" style="display:flex;align-items:center;gap:8px">
        <span style="background:linear-gradient(135deg,#6B46C1,#0088CC);color:#fff;padding:4px 9px;border-radius:5px;font-size:10px;font-weight:700">AI</span>
        Analogue Interpretation
      </div>
      <div style="padding:14px;background:linear-gradient(135deg,rgba(107,70,193,.05),rgba(0,136,204,.03));border:1px solid rgba(107,70,193,.15);border-radius:8px;margin:10px 0;font-size:12px;line-height:1.7;color:var(--t2)">${insight}</div>
      <div style="font-size:9px;color:var(--t3);margin-bottom:10px">Powered by Claude ¬∑ AFED Digital AI</div>
      <button class="btn2" onclick="closeModal()">Close</button>`);
  } else {
    toast('AI interpretation not available ‚Äî check connection', 'warning');
  }
}

async function getAIBasinRisk(basin) {
  if (!basin) return;
  const insight = await callClaudeAI(
    `Basin: ${basin.name}, ${basin.country}, ${basin.region}. Tectonic: ${basin.tectonic}. HC Phase: ${basin.hc}. Prospectivity: ${basin.score}/100. Status: ${basin.status}. Provide a brief risk assessment.`,
    'You are a basin risk analyst. In 2-3 sentences, comment on key exploration risks and opportunities for this basin. Be specific and technical. Use <strong> tags for key terms.'
  );
  return insight;
}

function _getAIPortfolioInsight_legacy() {
  const bar = document.getElementById('ai-insight-bar');
  const txt = document.getElementById('ai-insight-text');
  if (!bar || !txt) return;
  bar.style.display = 'block';
  txt.innerHTML = '<span style="color:var(--purple)">Analysing portfolio data‚Ä¶</span>';
  setTimeout(() => {
    txt.innerHTML = AI_INSIGHTS[_aiInsightIdx % AI_INSIGHTS.length];
    _aiInsightIdx++;
  }, 800);
}

// ============================================================
// ACTIVITY FEED
// ============================================================
function renderActivity() {
  document.getElementById('activity-feed').innerHTML = ACTIVITIES.map(a => `
    <div style="display:flex;gap:9px;padding:8px 0;border-bottom:1px solid rgba(0,200,255,.05)">
      <div style="width:7px;height:7px;border-radius:50%;background:${a.dot};margin-top:4px;flex-shrink:0"></div>
      <div>
        <div style="font-size:11px;color:var(--t2);line-height:1.5">${a.text}</div>
        <div style="font-size:9px;color:var(--t3);margin-top:1px">${a.time}</div>
      </div>
    </div>`).join('') + '<div style="height:4px"></div>';
}

// ============================================================
// TOP BASINS TABLE
// ============================================================
function renderTopBasins() {
  const sorted = [...BASINS].sort((a,b) => b.score - a.score).slice(0,5);
  document.getElementById('top-basins-table').innerHTML = `
    <table><thead><tr><th>#</th><th>Basin</th><th>Region</th><th colspan="2">Score</th><th>Status</th></tr></thead>
    <tbody>${sorted.map((b,i) => {
      const c = b.score >= 70 ? 'var(--green)' : b.score >= 40 ? 'var(--amber)' : 'var(--red)';
      const tl = b.score >= 70 ? 'tl-g' : b.score >= 40 ? 'tl-a' : 'tl-r';
      const tlText = b.score >= 70 ? 'HIGH' : b.score >= 40 ? 'MED' : 'LOW';
      return `<tr style="cursor:pointer" onclick="openBasinModal(BASINS.find(x=>x.name==='${b.name}'))">
        <td style="color:${i===0?'var(--gold)':'var(--t3)'};font-weight:700">${i+1}</td>
        <td style="color:var(--t1);font-weight:600">${b.name}</td>
        <td>${b.region}</td>
        <td><div class="sbar"><div class="sbar-track"><div class="sbar-fill" style="width:${b.score}%;background:${c}"></div></div><span class="sval" style="color:${c}">${b.score}</span></div></td>
        <td><span class="tl ${tl}">${tlText}</span></td>
      </tr>`;
    }).join('')}</tbody></table>`;
}

// ============================================================
// DQ SUMMARY
// ============================================================
function renderDQSummary() {
  const items = [{label:'Basin Records',val:96.8},{label:'Reservoir Properties',val:94.2},{label:'Source Rock Data',val:82.1},{label:'Commercial Data',val:78.5}];
  document.getElementById('dq-summary').innerHTML = items.map(it => {
    const c = it.val >= 90 ? 'var(--green)' : it.val >= 75 ? 'var(--amber)' : 'var(--red)';
    return `<div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:3px">
        <span style="font-size:10px;color:var(--t2)">${it.label}</span>
        <span style="font-size:10px;font-weight:700;color:${c}">${it.val}%</span>
      </div>
      <div class="sbar-track" style="height:5px"><div class="sbar-fill" style="width:${it.val}%;background:${c}"></div></div>
    </div>`;
  }).join('') + `<div style="margin-top:10px;padding:8px 11px;background:rgba(0,200,255,.04);border:1px solid var(--b1);border-radius:4px;font-size:11px">
    <span style="color:var(--t3);font-size:9px;text-transform:uppercase;letter-spacing:1px">GOVERNANCE QUEUE</span><br>
    <span style="color:var(--t1)">3 records pending &nbsp;¬∑&nbsp; </span><span style="color:var(--amber)">1 escalated</span>
  </div>`;
}

// ============================================================
// BASIN TABLE
// ============================================================
function renderBasinTable(data) {
  filteredBasins = data;
  document.getElementById('basin-count').textContent = `Basin Catalogue ‚Äî ${data.length} Records`;
  document.getElementById('basin-tbody').innerHTML = data.map(b => {
    const c = b.score >= 70 ? 'var(--green)' : b.score >= 40 ? 'var(--amber)' : 'var(--red)';
    const tl = b.score >= 70 ? 'tl-g' : b.score >= 40 ? 'tl-a' : 'tl-r';
    const tlText = b.score >= 70 ? 'HIGH' : b.score >= 40 ? 'MEDIUM' : 'LOW';
    const hcBadge = b.hc === 'Oil' ? 'bg' : b.hc === 'Gas' ? 'be' : 'bc';
    return `<tr style="cursor:pointer" onclick="focusBasinOnMap('${b.name}')">
      <td style="color:var(--t1);font-weight:600">${b.name}</td>
      <td>${b.country}</td>
      <td>${b.tectonic}</td>
      <td>${b.age}</td>
      <td><span class="badge ${hcBadge}">${b.hc}</span></td>
      <td>${b.area.toLocaleString()}</td>
      <td>${b.plays}</td>
      <td><div class="sbar"><div class="sbar-track"><div class="sbar-fill" style="width:${b.score}%;background:${c}"></div></div><span class="sval" style="color:${c}">${b.score}</span></div></td>
      <td><span class="tl ${tl}">${tlText}</span></td>
      <td><button class="btn-view" onclick="showBasinDetail('${b.name}')">Details</button></td>
    </tr>`;
  }).join('');
}

function filterBasins() {
  const q = document.getElementById('basin-search').value.toLowerCase();
  const region = document.getElementById('basin-region').value;
  const tecto = document.getElementById('basin-tecto').value;
  const hc = document.getElementById('basin-hc').value;
  const status = document.getElementById('basin-status').value;
  let data = BASINS.filter(b => {
    if (q && !b.name.toLowerCase().includes(q) && !b.country.toLowerCase().includes(q) && !b.age.toLowerCase().includes(q)) return false;
    if (region && b.region !== region) return false;
    if (tecto && b.tectonic !== tecto) return false;
    if (hc && b.hc !== hc) return false;
    if (status && b.status !== status) return false;
    return true;
  });
  renderBasinTable(data);
  if (data.length === 0) toast('No basins match your filters', 'warning');
}

function resetBasinFilters() {
  ['basin-search','basin-region','basin-tecto','basin-hc','basin-status'].forEach(id => document.getElementById(id).value = '');
  renderBasinTable(BASINS);
}

function sortBasins(col) {
  if (sortState.col === col) sortState.dir *= -1;
  else { sortState.col = col; sortState.dir = 1; }
  const sorted = [...filteredBasins].sort((a,b) => {
    let av = a[col], bv = b[col];
    if (typeof av === 'string') return av.localeCompare(bv) * sortState.dir;
    return (av - bv) * sortState.dir;
  });
  renderBasinTable(sorted);
}

function showBasinDetail(name) {
  const b = BASINS.find(x => x.name === name);
  if (!b) return;
  const c = b.score >= 70 ? 'var(--green)' : b.score >= 40 ? 'var(--amber)' : 'var(--red)';
  openModal(`
    <div class="modal-title">${b.name}</div>
    <div class="modal-sub">${b.country} &nbsp;¬∑&nbsp; ${b.region} &nbsp;¬∑&nbsp; ${b.tectonic}</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">
      <div style="background:var(--bg4);border-radius:5px;padding:10px;text-align:center">
        <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Score</div>
        <div style="font-size:26px;font-weight:700;color:${c}">${b.score}</div>
      </div>
      <div style="background:var(--bg4);border-radius:5px;padding:10px;text-align:center">
        <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Plays</div>
        <div style="font-size:26px;font-weight:700;color:var(--cyan)">${b.plays}</div>
      </div>
      <div style="background:var(--bg4);border-radius:5px;padding:10px;text-align:center">
        <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Area km¬≤</div>
        <div style="font-size:18px;font-weight:700;color:var(--gold)">${b.area.toLocaleString()}</div>
      </div>
    </div>
    <table><tbody>
      <tr><td style="color:var(--t3);font-size:10px">HC Phase</td><td style="color:var(--t1)">${b.hc}</td></tr>
      <tr><td style="color:var(--t3);font-size:10px">Geological Age</td><td style="color:var(--t1)">${b.age}</td></tr>
      <tr><td style="color:var(--t3);font-size:10px">Exploration Status</td><td style="color:var(--t1)">${b.status}</td></tr>
    </tbody></table>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn" onclick="closeModal();goTo('analogues',null)">Find Analogues ‚Üí</button>
      <button class="btn2" onclick="closeModal();goTo('screening',null)">Screen This Basin ‚Üí</button>
    </div>
  `);
}

// ============================================================
// ANALOGUE ENGINE
// ============================================================
function runSearch() {
  const btn = document.getElementById('search-btn');
  btn.textContent = 'Searching‚Ä¶';
  btn.disabled = true;
  loadBar();
  setTimeout(() => {
    btn.textContent = 'Run Search';
    btn.disabled = false;

    // Read all search criteria
    const lith   = document.getElementById('s-lith').value;
    const dep    = document.getElementById('s-dep').value;
    const age    = document.getElementById('s-age').value;
    const hc     = document.getElementById('s-hc').value;
    const drive  = document.getElementById('s-drive').value;
    const tecto  = document.getElementById('s-tecto').value;
    const dmin   = parseFloat(document.getElementById('s-dmin').value) || 0;
    const dmax   = parseFloat(document.getElementById('s-dmax').value) || 99999;
    const apimin = parseFloat(document.getElementById('s-apimin').value) || 0;
    const apimax = parseFloat(document.getElementById('s-apimax').value) || 100;
    const minsim = parseFloat(document.getElementById('s-minsim').value) || 0;

    // ‚îÄ‚îÄ Advanced filter values (only used if advanced panel open) ‚îÄ‚îÄ
    const adv = document.getElementById('s-adv-toggle')?.checked;
    const porMin  = adv ? (parseFloat(document.getElementById('s-pormin')?.value) || 0) : 0;
    const porMax  = adv ? (parseFloat(document.getElementById('s-pormax')?.value) || 100) : 100;
    const permMin = adv ? (parseFloat(document.getElementById('s-permmin')?.value) || 0) : 0;
    const permMax = adv ? (parseFloat(document.getElementById('s-permmax')?.value) || 1e9) : 1e9;
    const ntgMin  = adv ? (parseFloat(document.getElementById('s-ntgmin')?.value) || 0) : 0;
    const rfMin   = adv ? (parseFloat(document.getElementById('s-rfmin')?.value) || 0) : 0;
    const swMax   = adv ? (parseFloat(document.getElementById('s-swmax')?.value) || 1) : 1;
    const pcMax   = adv ? (parseFloat(document.getElementById('s-pcmax')?.value) || 99) : 99;
    const preg    = adv ? (document.getElementById('s-preg')?.value || '') : '';
    const kero    = adv ? (document.getElementById('s-kero')?.value || '') : '';
    const tocMin  = adv ? (parseFloat(document.getElementById('s-tocmin')?.value) || 0) : 0;
    const roMin   = adv ? (parseFloat(document.getElementById('s-romin')?.value) || 0) : 0;
    const roMax   = adv ? (parseFloat(document.getElementById('s-romax')?.value) || 99) : 99;
    const oilfam  = adv ? (document.getElementById('s-oilfam')?.value || '') : '';
    const charge  = adv ? (document.getElementById('s-charge')?.value || '') : '';
    const h2sMax  = adv ? (parseFloat(document.getElementById('s-h2smax')?.value) || 1e6) : 1e6;
    const co2Max  = adv ? (parseFloat(document.getElementById('s-co2max')?.value) || 100) : 100;
    const sulMax  = adv ? (parseFloat(document.getElementById('s-sulmax')?.value) || 100) : 100;
    const stress  = adv ? (document.getElementById('s-stress')?.value || '') : '';
    const sandProd= adv ? (document.getElementById('s-sandprod')?.value || '') : '';
    const hfMin   = adv ? (parseFloat(document.getElementById('s-hfmin')?.value) || 0) : 0;
    const hfMax   = adv ? (parseFloat(document.getElementById('s-hfmax')?.value) || 9999) : 9999;
    const protect = adv ? (document.getElementById('s-protect')?.value || '') : '';
    const hydrate = adv ? (document.getElementById('s-hydrate')?.value || '') : '';
    const npvMin  = adv ? (parseFloat(document.getElementById('s-npvmin')?.value) || -1e9) : -1e9;
    const fiscal  = adv ? (document.getElementById('s-fiscal')?.value || '') : '';

    // Compute live similarity score for each analogue
    function computeSim(a) {
      let score = 100;
      let factors = 0;

      // Lithology match ‚Äî 25 pts
      factors++;
      if (a.lith) {
        const lithMap = {
          'Sandstone': ['sandstone','sand','ss','siliciclastic','clastic','arenite'],
          'Carbonate': ['carbonate','limestone','chalk','dolomite','lime','reef','calcarenite'],
          'Chalk':     ['chalk','calcareous'],
          'Conglomerate':['conglomerate','gravel','breccia'],
          'Mixed':     ['mixed','hybrid','heterolithic'],
        };
        const targets = lithMap[lith] || [lith.toLowerCase()];
        const aLith = a.lith.toLowerCase();
        const match = targets.some(t => aLith.includes(t));
        if (!match) score -= 25;
      }

      // Depositional environment ‚Äî 15 pts
      factors++;
      if (a.dep) {
        const depMap = {
          'Deltaic':       ['delt','fan delta','fluvio-delt'],
          'Fluvial':       ['fluvi','fluvial','channel','alluvial'],
          'Shallow Marine':['shallow','shoreface','shelf','tidal','coastal'],
          'Deep Marine':   ['deep','turbidite','deepwater','submarine','basin floor'],
          'Reef':          ['reef','carbonate build','mound'],
          'Turbidite':     ['turbid','turbidite','fan','lobe'],
        };
        const targets = depMap[dep] || [dep.toLowerCase()];
        const aDep = a.dep.toLowerCase();
        const match = targets.some(t => aDep.includes(t));
        if (!match) score -= 15;
      }

      // Age match ‚Äî 10 pts
      factors++;
      if (a.age) {
        const aAge = a.age.toLowerCase();
        const sAge = age.toLowerCase();
        if (!aAge.includes(sAge) && !sAge.includes(aAge.split('‚Äì')[0].trim())) score -= 10;
      }

      // HC phase ‚Äî 15 pts
      factors++;
      if (a.hc) {
        const aHc = a.hc.toLowerCase();
        const sHc = hc.toLowerCase();
        if (sHc !== 'any' && !aHc.includes(sHc) && !sHc.includes(aHc)) score -= 15;
      }

      // Drive mechanism ‚Äî 10 pts
      factors++;
      if (drive !== 'Any' && a.drive) {
        const aDrive = a.drive.toLowerCase();
        const sDrive = drive.toLowerCase();
        const exact = aDrive.includes(sDrive.split(' ')[0]) || sDrive.includes(aDrive.split(' ')[0]);
        if (!exact) score -= 10;
      }

      // Tectonic setting ‚Äî 10 pts
      factors++;
      if (tecto !== 'Any') {
        const basin = BASINS.find(b => b.name === a.basin);
        if (basin && basin.tectonic) {
          const bTecto = basin.tectonic.toLowerCase();
          const sTecto = tecto.toLowerCase();
          if (!bTecto.includes(sTecto.split(' ')[0]) && !sTecto.includes(bTecto.split(' ')[0])) score -= 10;
        }
      }

      // Depth penalty ‚Äî gradual, within range = 0 pts off
      const depth = a.depth || 0;
      if (depth < dmin) score -= Math.min(15, (dmin - depth) / dmin * 15);
      else if (depth > dmax) score -= Math.min(15, (depth - dmax) / dmax * 15);

      // API gravity penalty
      const api = a.api || 30;
      if (api < apimin) score -= Math.min(10, (apimin - api) / apimin * 10);
      else if (api > apimax) score -= Math.min(10, (api - apimax) / apimax * 10);

      // ‚îÄ‚îÄ Advanced scoring (if enabled) ‚îÄ‚îÄ
      if (adv) {
        // Porosity range ‚Äî 8 pts
        if (a.por > 0) {
          if (a.por < porMin || a.por > porMax) score -= 8;
          else score += Math.min(5, (1 - Math.abs((a.por - (porMin+porMax)/2) / ((porMax-porMin)/2 || 1))) * 5);
        }
        // Permeability range ‚Äî 6 pts
        if (a.perm > 0 && (a.perm < permMin || a.perm > permMax)) score -= 6;
        // NTG floor ‚Äî 4 pts
        if (a.ntg > 0 && a.ntg < ntgMin) score -= 4;
        // RF floor ‚Äî 4 pts
        if (a.rf > 0 && a.rf < rfMin) score -= 4;
        // Sw ceiling ‚Äî 4 pts
        if (a.sw && a.sw > swMax) score -= 4;
        // Pressure regime ‚Äî 6 pts
        if (preg && a.geo?.pressure_regime && !a.geo.pressure_regime.toLowerCase().includes(preg.split(' ')[0].toLowerCase())) score -= 6;
        // Pressure coefficient ceiling ‚Äî 6 pts
        if (pcMax < 99 && a.geo?.pressure_coeff > pcMax) score -= 6;
        // Kerogen type ‚Äî 5 pts
        if (kero && a.geochem?.kerogen_type && !a.geochem.kerogen_type.toLowerCase().includes(kero.toLowerCase().split('/')[0])) score -= 5;
        // TOC floor ‚Äî 4 pts
        if (tocMin > 0 && a.geochem?.toc && a.geochem.toc < tocMin) score -= 4;
        // Vitrinite Ro range ‚Äî 5 pts
        if (a.geochem?.ro_vitrinite) {
          if (roMin > 0 && a.geochem.ro_vitrinite < roMin) score -= 5;
          if (roMax < 99 && a.geochem.ro_vitrinite > roMax) score -= 5;
        }
        // Oil family ‚Äî 4 pts
        if (oilfam && a.geochem?.oil_family && !a.geochem.oil_family.toLowerCase().includes(oilfam.toLowerCase())) score -= 4;
        // Charge volume ‚Äî 4 pts
        if (charge && a.geochem?.charge_volume && a.geochem.charge_volume !== charge) score -= 4;
        // H2S ceiling ‚Äî 6 pts (safety critical)
        if (a.fluid?.h2s_ppm > h2sMax) score -= 6;
        // CO2 ceiling ‚Äî 4 pts
        if (a.fluid?.co2_pct > co2Max) score -= 4;
        // Sulfur ceiling ‚Äî 4 pts
        if (a.geochem?.sulfur_pct > sulMax) score -= 4;
        // Stress regime ‚Äî 4 pts
        if (stress && a.geomechanics?.stress_regime && !a.geomechanics.stress_regime.toLowerCase().includes(stress.toLowerCase())) score -= 4;
        // Sand production risk ‚Äî 5 pts
        if (sandProd && a.geomechanics?.sand_production_risk && a.geomechanics.sand_production_risk !== sandProd) score -= 5;
        // Heat flow range ‚Äî 4 pts
        if (a.thermal?.surface_heat_flow_mw_m2) {
          if (hfMin > 0 && a.thermal.surface_heat_flow_mw_m2 < hfMin) score -= 4;
          if (hfMax < 9999 && a.thermal.surface_heat_flow_mw_m2 > hfMax) score -= 4;
        }
        // Protected area filter ‚Äî 8 pts
        if (protect === 'no' && a.environmental?.protected_area_flag === 'Yes') score -= 8;
        if (protect === 'yes' && a.environmental?.protected_area_flag !== 'Yes') score -= 2;
        // Hydrate risk ‚Äî 4 pts
        if (hydrate && a.environmental?.hydrate_risk && a.environmental.hydrate_risk !== hydrate) score -= 4;
        // NPV floor ‚Äî 5 pts
        if (npvMin > -1e9 && a.commercial?.npv_10_musd < npvMin) score -= 5;
        // Fiscal regime ‚Äî 3 pts
        if (fiscal && a.commercial?.fiscal_regime && !a.commercial.fiscal_regime.toLowerCase().includes(fiscal.toLowerCase())) score -= 3;
      }

      return Math.max(0, Math.min(100, Math.round(score)));
    }

    // Compute similarity for all analogues, filter by hard constraints + minsim
    const scored = ANALOGUES.map(a => ({...a, sim: computeSim(a)}));

    // Hard filters
    searchResults = scored.filter(a => {
      const depthOk = !a.depth || (a.depth >= dmin * 0.7 && a.depth <= dmax * 1.3);
      const apiOk   = !a.api   || (a.api   >= apimin * 0.7 && a.api   <= apimax * 1.3);
      // Advanced hard filters
      const porOk   = !adv || !a.por   || (a.por  >= porMin*0.8  && a.por  <= porMax*1.2);
      const permOk  = !adv || !a.perm  || (a.perm >= permMin*0.5 && a.perm <= permMax*2);
      const h2sOk   = !adv || !a.fluid?.h2s_ppm || a.fluid.h2s_ppm <= h2sMax * 1.5;
      const protOk  = !adv || protect !== 'no' || a.environmental?.protected_area_flag !== 'Yes';
      return a.sim >= minsim && depthOk && apiOk && porOk && permOk && h2sOk && protOk;
    }).sort((a,b) => b.sim - a.sim);

    // Re-rank
    searchResults = searchResults.map((a, i) => ({...a, rank: i+1}));
    renderAnalogueResults(searchResults);
    document.getElementById('ana-results-area').style.display = 'grid';

    const matchMsg = searchResults.length > 0
      ? `Found ${searchResults.length} analogues ‚Äî top match: ${searchResults[0].name} (${searchResults[0].sim}%)`
      : 'No analogues match your criteria. Try relaxing the filters or lowering the Min Similarity Score.';
    toast(matchMsg, searchResults.length > 0 ? 'success' : 'warning');

    selectedAnalogues.clear();
    // Unlock comparison and similarity tabs
    _searchHasRun = true;
    const cmTab  = document.getElementById('ana-tab-compare');
    const simTab = document.getElementById('ana-tab-similarity');
    if (cmTab)  { cmTab.style.opacity  = ''; cmTab.title  = ''; }
    if (simTab) { simTab.style.opacity = ''; simTab.title = ''; }
  }, 800);
}

// Select an analogue directly from the crossplot data table ‚Äî highlights it on the chart
// and syncs the banner + detail panel without leaving the crossplot view
function selectAnalogueFromCrossplot(rank) {
  const a = searchResults.find(x => x.rank === rank);
  if (!a) return;

  // Toggle off if already selected
  if (currentAnalogue?.rank === rank) {
    currentAnalogue = null;
    // Clear banner
    const banner = document.getElementById('cp-analogue-banner');
    if (banner) banner.style.display = 'none';
    renderCrossplot();
    return;
  }

  currentAnalogue = a;

  // Update crossplot banner
  const banner = document.getElementById('cp-analogue-banner');
  if (banner) {
    banner.style.display = 'flex';
    const c = a.sim >= 80 ? 'var(--green)' : a.sim >= 65 ? 'var(--amber)' : 'var(--red)';
    document.getElementById('cp-analogue-name').textContent = a.name;
    document.getElementById('cp-analogue-meta').textContent = `${a.basin} ¬∑ ${a.lith} ¬∑ ${a.age} ¬∑ ${a.dep}`;
    const simEl = document.getElementById('cp-analogue-sim');
    simEl.textContent = a.sim + '% match';
    simEl.style.color = c;
  }

  // Also sync the search-panel detail card (visible when user goes back)
  document.getElementById('ana-detail-name').textContent = a.name;
  document.getElementById('ana-detail-sub').textContent = `${a.basin} ¬∑ ${a.dep} ¬∑ ${a.age} ¬∑ ${a.lith}`;
  const matchBadge = document.getElementById('ana-match-badge');
  const matchVal   = document.getElementById('ana-match-val');
  if (matchBadge && matchVal) {
    const c = a.sim >= 80 ? 'var(--green)' : a.sim >= 65 ? 'var(--amber)' : 'var(--red)';
    matchBadge.style.display = 'block';
    matchVal.textContent = a.sim + '%';
    matchVal.style.color = c;
  }

  // Highlight the card in the search results strip
  document.querySelectorAll('.ana-hcard').forEach(el => el.classList.remove('selected'));
  document.getElementById('ana-' + rank)?.classList.add('selected');

  // Redraw crossplot immediately ‚Äî selected point glows and is labelled
  renderCrossplot();
}

// When user changes an axis, restore cached target for that axis or recalculate from medians
function onCrossplotAxisChange() {
  const xKey = document.getElementById('cp-x')?.value || 'por';
  const yKey = document.getElementById('cp-y')?.value || 'perm';

  function medianVal(key) {
    if (!searchResults || !searchResults.length) return null;
    const vals = searchResults.map(a => +a[key]).filter(v => !isNaN(v) && v > 0).sort((a,b) => a-b);
    return vals.length ? vals[Math.floor(vals.length/2)] : null;
  }

  // Restore or recalculate X target
  const txEl = document.getElementById('cp-tx');
  const tyEl = document.getElementById('cp-ty');
  if (txEl) {
    const cached = _cpTargets[xKey];
    const fresh = cached ?? medianVal(xKey);
    txEl.value = fresh != null ? fresh.toFixed(fresh < 10 ? 2 : 1) : '';
    if (fresh != null) _cpTargets[xKey] = fresh;
  }
  if (tyEl) {
    const cached = _cpTargets[yKey];
    const fresh = cached ?? medianVal(yKey);
    tyEl.value = fresh != null ? fresh.toFixed(fresh < 10 ? 2 : 1) : '';
    if (fresh != null) _cpTargets[yKey] = fresh;
  }
  renderCrossplot();
}

// Per-axis target store ‚Äî so changing axes doesn't carry over stale values
const _cpTargets = {};

function autoFillTarget() {
  if (!searchResults || !searchResults.length) { toast('Run a search first to auto-fill target', 'warning'); return; }
  const xKey = document.getElementById('cp-x')?.value || 'por';
  const yKey = document.getElementById('cp-y')?.value || 'perm';
  function median(key) {
    const vals = searchResults.map(a => +a[key]).filter(v => !isNaN(v) && v > 0).sort((a,b) => a-b);
    return vals.length ? vals[Math.floor(vals.length/2)] : null;
  }
  const tx = median(xKey), ty = median(yKey);
  if (tx != null) { document.getElementById('cp-tx').value = tx.toFixed(tx < 10 ? 2 : 1); _cpTargets[xKey] = tx; }
  if (ty != null) { document.getElementById('cp-ty').value = ty.toFixed(ty < 10 ? 2 : 1); _cpTargets[yKey] = ty; }
  renderCrossplot();
  toast(`Target set to median of ${searchResults.length} search results`, 'success');
}

function clearSearchFilters() {
  // Reset core filters
  ['s-dmin','s-dmax','s-apimin','s-apimax','s-minsim'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = id === 's-dmin' ? '2500' : id === 's-dmax' ? '4500' : id === 's-apimin' ? '28' : id === 's-apimax' ? '38' : '60';
  });
  ['s-lith','s-dep','s-age','s-hc','s-drive','s-tecto'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.selectedIndex = 0;
  });
  // Reset advanced filters
  const advIds = ['s-pormin','s-pormax','s-permmin','s-permmax','s-ntgmin','s-rfmin','s-phiemin','s-swmax',
    's-pcmax','s-mwmin','s-mwmax','s-tocmin','s-romin','s-romax','s-h2smax','s-co2max','s-sulmax','s-pbmin',
    's-ucsmin','s-hfmin','s-hfmax','s-tgradmin','s-burialmax','s-npvmin'];
  advIds.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
  ['s-preg','s-kero','s-oilfam','s-charge','s-stress','s-sandprod','s-fracdns','s-protect','s-hydrate','s-fiscal'].forEach(id => {
    const el = document.getElementById(id); if (el) el.selectedIndex = 0;
  });
  const toggle = document.getElementById('s-adv-toggle');
  if (toggle) { toggle.checked = false; document.getElementById('s-adv-panel').style.display = 'none'; }
  toast('Search filters cleared', 'info');
}

function renderAnalogueResults(results) {
  document.getElementById('ana-count-lbl').textContent = `Ranked Analogues ‚Äî ${results.length} matches`;
  if (results.length === 0) {
    document.getElementById('ana-results-list').innerHTML = '<div style="color:var(--t3);font-size:11px;padding:20px;text-align:center;width:100%">No analogues match your criteria. Try adjusting the filters.</div>';
    return;
  }
  document.getElementById('ana-results-list').innerHTML = results.map(a => {
    const c = a.sim >= 80 ? 'var(--green)' : a.sim >= 65 ? 'var(--amber)' : 'var(--red)';
    const geoFlag = a.geo?.pressure_coeff >= 1.3 ? '‚ö†' : '';
    const chemFlag = a.geochem?.sulfur_pct > 1 ? '‚ò£' : '';
    return `<div class="ana-hcard" id="ana-${a.rank}" onclick="selectAnalogue(${a.rank})">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
        <div style="font-size:9px;font-weight:700;color:var(--t3)">#${a.rank}</div>
        <div style="text-align:right">
          <div style="font-size:16px;font-weight:700;color:${c};line-height:1">${a.sim}%</div>
          <div style="font-size:7px;color:var(--t3);letter-spacing:.5px">MATCH</div>
        </div>
      </div>
      <div style="font-size:10px;font-weight:700;color:var(--t1);line-height:1.3;margin-bottom:4px">${a.name.replace(' ‚Äî ','<br><span style="color:var(--t3);font-weight:400">').replace(/$/,'</span>')}</div>
      <div style="font-size:9px;color:var(--t3);margin-bottom:7px">${a.age} ¬∑ ${a.depth}m</div>
      <div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px">
        <span style="background:rgba(0,200,255,.1);color:var(--cyan);font-size:8px;padding:1px 5px;border-radius:3px">œÜ ${a.por}%</span>
        <span style="background:rgba(240,165,0,.1);color:var(--gold);font-size:8px;padding:1px 5px;border-radius:3px">k ${a.perm}</span>
        <span style="background:rgba(0,229,160,.1);color:var(--green);font-size:8px;padding:1px 5px;border-radius:3px">RF ${a.rf}%</span>
      </div>
      ${geoFlag || chemFlag ? `<div style="font-size:9px;color:var(--amber)">${geoFlag ? '‚ö† Overpressure ' : ''}${chemFlag ? '‚ò£ High S' : ''}</div>` : ''}
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;padding-top:5px;border-top:1px solid rgba(0,200,255,.06)">
        <span style="font-size:8px;color:var(--t3)">${a.hc}</span>
        <input type="checkbox" style="accent-color:var(--cyan);width:11px;height:11px" onclick="event.stopPropagation();toggleCompare(${a.rank},event)" title="Compare">
      </div>
    </div>`;
  }).join('');

  // Populate similarity analysis dropdown
  const simSel = document.getElementById('sim-analogue-select');
  if (simSel) {
    simSel.innerHTML = '<option value="">‚Äî Pick from search results ‚Äî</option>' +
      results.map(a => `<option value="${a.rank}">#${a.rank} ${a.name} (${a.sim}%)</option>`).join('');
    if (currentAnalogue) simSel.value = String(currentAnalogue.rank);
  }
}

let currentAnalogue = null;
let currentDetailTab = 'reservoir';

function selectAnalogue(rank) {
  document.querySelectorAll('.ana-item').forEach(el => el.classList.remove('selected'));
  document.getElementById('ana-' + rank)?.classList.add('selected');
  const a = searchResults.find(x => x.rank === rank);
  if (!a) return;
  currentAnalogue = a;
  currentDetailTab = 'reservoir';

  // Update header
  document.getElementById('ana-detail-name').textContent = a.name;
  document.getElementById('ana-detail-sub').textContent = `${a.basin} ¬∑ ${a.dep} ¬∑ ${a.age} ¬∑ ${a.lith}`;
  const badge = document.getElementById('ana-match-badge');
  const matchVal = document.getElementById('ana-match-val');
  const c = a.sim >= 80 ? 'var(--green)' : a.sim >= 65 ? 'var(--amber)' : 'var(--red)';
  badge.style.display = 'block';
  matchVal.textContent = a.sim + '%';
  matchVal.style.color = c;

  // ‚îÄ‚îÄ Propagate analogue name to Crossplot banner ‚îÄ‚îÄ
  const cpBanner = document.getElementById('cp-analogue-banner');
  if (cpBanner) {
    cpBanner.style.display = 'flex';
    const cpName = document.getElementById('cp-analogue-name');
    const cpMeta = document.getElementById('cp-analogue-meta');
    const cpSim  = document.getElementById('cp-analogue-sim');
    if (cpName) cpName.textContent = a.name;
    if (cpMeta) cpMeta.textContent = `${a.basin} ¬∑ ${a.lith} ¬∑ ${a.age} ¬∑ ${a.dep}`;
    if (cpSim) { cpSim.textContent = a.sim + '% match'; cpSim.style.color = c; }
  }

  // ‚îÄ‚îÄ Propagate analogue name to Comparison banner ‚îÄ‚îÄ
  const cmpBanner = document.getElementById('cmp-analogue-banner');
  if (cmpBanner) {
    cmpBanner.style.display = 'block';
    const cmpName  = document.getElementById('cmp-analogue-name');
    const cmpSub   = document.getElementById('cmp-analogue-sub');
    const cmpScore = document.getElementById('cmp-analogue-score');
    if (cmpName)  cmpName.textContent = a.name;
    if (cmpSub)   cmpSub.textContent  = `${a.basin} ¬∑ ${a.lith} ¬∑ ${a.age} ¬∑ ${a.depth} mTVDSS`;
    if (cmpScore) { cmpScore.textContent = a.sim + '% match'; cmpScore.style.color = c; }
  }

  // ‚îÄ‚îÄ Update comparison table title if already visible ‚îÄ‚îÄ
  const cmpTitle = document.getElementById('cmp-table-title');
  if (cmpTitle) cmpTitle.textContent = `Comparison ‚Äî ${a.name} vs Selected Analogues`;

  // ‚îÄ‚îÄ Sync similarity panel dropdown ‚îÄ‚îÄ
  const simSel = document.getElementById('sim-analogue-select');
  if (simSel) simSel.value = String(rank);
  // If similarity panel is visible, re-render it
  if (document.getElementById('ana-similarity-panel')?.style.display === 'block') {
    renderSimilarityAnalysis(a);
  }

  // Reset sub-tabs
  document.querySelectorAll('.dtab').forEach(t => t.classList.remove('on'));
  document.querySelector('.dtab')?.classList.add('on');

  renderDetailTab('reservoir', a);
}

function switchDetailTab(tab, el) {
  document.querySelectorAll('.dtab').forEach(t => t.classList.remove('on'));
  el.classList.add('on');
  currentDetailTab = tab;
  if (currentAnalogue) renderDetailTab(tab, currentAnalogue);
}

function renderDetailTab(tab, a) {
  const body = document.getElementById('ana-detail-body');

  if (tab === 'reservoir') {
    body.innerHTML = `
      <div style="padding:12px 0">
        <div class="stat-grid" style="margin-bottom:8px">
          ${statCell('Depth',''+a.depth+' mTVDSS','cyan')}
          ${statCell('Lithology', a.lith, '')}
          ${statCell('Depositional Env.', a.dep, '')}
          ${statCell('HC Phase', a.hc, a.hc==='Oil'?'gold':a.hc==='Gas'?'cyan':'green')}
          ${statCell('Drive Mechanism', a.drive, '')}
          ${statCell('Temperature', a.temp ? a.temp+'¬∞C':'‚Äî', 'amber')}
          ${statCell('Reservoir Pressure', a.pres_res ? a.pres_res+' bar':'‚Äî', 'cyan')}
          ${statCell('Water Saturation', a.sw ? (a.sw*100).toFixed(0)+'%':'‚Äî', '')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin:10px 0 6px">Petrophysical Properties</div>
        <div class="stat-grid" style="margin-bottom:8px">
          ${statCell('Porosity (œÜ)', a.por+'%', 'cyan')}
          ${statCell('Permeability (k)', a.perm+' mD', 'gold')}
          ${statCell('Net-to-Gross', a.ntg+'%', 'cyan')}
          ${statCell('Recovery Factor', a.rf+'%', 'green')}
          ${statCell('GOR', a.gor.toLocaleString()+' scf/bbl', '')}
          ${statCell('API Gravity', a.api+'¬∞', 'gold')}
          ${statCell('Gross Pay', a.gross_pay ? a.gross_pay+'m':'‚Äî', '')}
          ${statCell('Net Pay', a.net_pay ? a.net_pay+'m':'‚Äî', 'green')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin:10px 0 6px">Fluid Properties (Summary)</div>
        <div class="stat-grid">
          ${statCell('Oil FVF (Bo)', a.bo ? a.bo+' res bbl/STB':'‚Äî', '')}
          ${statCell('Oil Viscosity', a.visc ? a.visc+' cP':'‚Äî', '')}
        </div>
        <div style="display:flex;gap:7px;margin-top:14px">
          <button class="btn" style="font-size:10px;padding:6px 12px" onclick="toast('Analogue added to risk assessment','success')">Use in Risk Assessment</button>
          <button class="btn2" style="font-size:10px;padding:5px 10px" onclick="toggleCompare(${a.rank},{target:{checked:true}});toast('Added to comparison','success')">+ Compare</button>
        </div>
        <div style="margin-top:10px;padding:7px 9px;background:rgba(0,200,255,.04);border:1px solid var(--b1);border-radius:4px;font-size:9px;color:var(--t3)">
          <strong style="color:var(--cyan)">Source:</strong> C&C Reservoirs ¬∑ IHS Energy ¬∑ Confidence: <span style="color:var(--green)">High</span>
          ${a._source ? ` ¬∑ <span style="color:var(--amber)">Ingested from: ${a._source}</span>` : ''}
        </div>
      </div>`;

  } else if (tab === 'geopressure') {
    const g = a.geo || {};
    const ppColor = g.pressure_coeff >= 1.3 ? 'red' : g.pressure_coeff >= 1.1 ? 'amber' : g.pressure_coeff >= 1.0 ? '' : 'green';
    const ppLabel = g.pressure_regime || 'Unknown';
    body.innerHTML = `
      <div style="padding:12px 0">
        <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:6px;background:rgba(0,200,255,.04);border:1px solid var(--b1);margin-bottom:10px">
          <div style="flex:1">
            <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:3px">Pressure Regime</div>
            <div style="font-size:13px;font-weight:700;color:var(--t1)">${ppLabel}</div>
            ${g.overpressure_mech ? `<div style="font-size:9px;color:var(--t3);margin-top:2px">${g.overpressure_mech}</div>` : ''}
          </div>
          <div style="text-align:right">
            <div style="font-size:22px;font-weight:700;color:var(--${ppColor||'cyan'})">${g.pressure_coeff ? g.pressure_coeff.toFixed(2) : '‚Äî'}</div>
            <div style="font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--t3)">Pressure Coeff.</div>
          </div>
        </div>

        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Pressure Gradients</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Pore Pressure Grad.', g.pres_grad ? g.pres_grad+' psi/ft':'‚Äî', 'cyan')}
          ${statCell('Overburden Grad.', g.obstr_grad ? g.obstr_grad+' psi/ft':'‚Äî', '')}
          ${statCell('Fracture Grad.', g.frac_grad ? g.frac_grad+' psi/ft':'‚Äî', 'amber')}
          ${statCell('Pressure Coeff.', g.pressure_coeff ? g.pressure_coeff.toFixed(2):'‚Äî', ppColor||'')}
        </div>

        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Drilling Window (EMW)</div>
        <div style="background:var(--bg4);border-radius:6px;padding:10px 12px;margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--t3);margin-bottom:6px">
            <span>Min MW: <strong style="color:var(--green)">${g.mudweight_min || '‚Äî'} ppg</strong></span>
            <span>ECD: <strong style="color:var(--cyan)">${g.ecd || '‚Äî'} ppg</strong></span>
            <span>Max MW: <strong style="color:var(--amber)">${g.mudweight_max || '‚Äî'} ppg</strong></span>
          </div>
          <!-- Mud weight window visualisation -->
          ${g.mudweight_min && g.mudweight_max ? mudWindowBar(g) : '<div style="color:var(--t3);font-size:9px">No data</div>'}
        </div>

        <div class="stat-grid">
          ${statCell('Pore Pressure (ppg)', g.ppg ? g.ppg+' ppg':'‚Äî', ppColor||'')}
          ${statCell('Overpressure Level', g.overpressure || '‚Äî', ppColor||'')}
        </div>

        ${g.pressure_coeff >= 1.3 ? `<div class="alert-pill ap-bad" style="margin-top:10px">‚ö† EXTREME overpressure ‚Äî specialist well planning required</div>` : ''}
        ${g.pressure_coeff >= 1.1 && g.pressure_coeff < 1.3 ? `<div class="alert-pill ap-warn" style="margin-top:10px">‚ö† Overpressure ‚Äî elevated mud weight required</div>` : ''}
        ${g.pressure_coeff < 1.05 ? `<div class="alert-pill ap-ok" style="margin-top:10px">‚úì Normal / near-normal pressure regime</div>` : ''}
      </div>`;

  } else if (tab === 'geochem') {
    const gc = a.geochem || {};
    const matColor = gc.ro_vitrinite >= 1.3 ? 'red' : gc.ro_vitrinite >= 0.6 ? 'green' : 'amber';
    const matLabel = gc.ro_vitrinite >= 1.3 ? 'Over-mature (dry gas)' : gc.ro_vitrinite >= 0.9 ? 'Late oil / wet gas' : gc.ro_vitrinite >= 0.6 ? 'Peak oil window' : 'Immature / early oil';
    body.innerHTML = `
      <div style="padding:12px 0">
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Source Rock Properties</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Source Formation', gc.source_fm || '‚Äî', '')}
          ${statCell('Kerogen Type', gc.kerogen_type || '‚Äî', 'gold')}
          ${statCell('TOC (%)', gc.toc ? gc.toc+'%':'‚Äî', gc.toc >= 2 ? 'green' : 'amber')}
          ${statCell('Vitrinite Reflectance', gc.ro_vitrinite ? gc.ro_vitrinite+'% Ro':'‚Äî', matColor)}
          ${statCell('Hydrogen Index (HI)', gc.hindex ? gc.hindex+' mgHC/gTOC':'‚Äî', '')}
          ${statCell('Oxygen Index (OI)', gc.oindex ? gc.oindex+' mgCO‚ÇÇ/gTOC':'‚Äî', '')}
          ${statCell('Tmax', gc.tmax ? gc.tmax+'¬∞C':'‚Äî', 'cyan')}
          ${statCell('Expulsion Efficiency', gc.expulsion_eff ? gc.expulsion_eff+'%':'‚Äî', gc.expulsion_eff >= 60 ? 'green' : 'amber')}
        </div>

        <div style="padding:8px 10px;background:var(--bg4);border-radius:5px;margin-bottom:10px;border-left:3px solid var(--${matColor})">
          <div style="font-size:9px;color:var(--t3);margin-bottom:2px">Maturity Assessment</div>
          <div style="font-size:11px;font-weight:700;color:var(--${matColor})">${matLabel}</div>
        </div>

        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Petroleum System</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Oil Family', gc.oil_family || '‚Äî', '')}
          ${statCell('Charge Volume', gc.charge_volume || '‚Äî', gc.charge_volume === 'Very High' ? 'green' : gc.charge_volume === 'High' ? 'cyan' : 'amber')}
          ${statCell('Migration Distance', gc.migration_dist ? gc.migration_dist+' km':'‚Äî', '')}
          ${statCell('Predicted API', gc.api_pred ? gc.api_pred+'¬∞':'‚Äî', 'gold')}
        </div>

        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Oil Composition</div>
        <div class="stat-grid">
          ${statCell('Sulfur Content', gc.sulfur_pct ? gc.sulfur_pct+'%':' ‚Äî', gc.sulfur_pct > 0.5 ? 'red' : 'green')}
          ${statCell('C15+ Fraction', gc.c15_plus ? gc.c15_plus+'%':'‚Äî', '')}
        </div>
        ${gc.sulfur_pct > 1.0 ? `<div class="alert-pill ap-bad" style="margin-top:8px">‚ö† High sulfur ‚Äî corrosion / H‚ÇÇS handling required</div>` : ''}
        ${gc.sulfur_pct > 0.3 && gc.sulfur_pct <= 1.0 ? `<div class="alert-pill ap-warn" style="margin-top:8px">‚ö† Moderate sulfur content</div>` : ''}
        ${gc.toc >= 2.5 ? `<div class="alert-pill ap-ok" style="margin-top:8px">‚úì Good source rock quality (TOC > 2.5%)</div>` : ''}
      </div>`;

  } else if (tab === 'mineral') {
    const m = a.mineral || {};
    const minerals = [
      {name:'Quartz',val:m.quartz||0,color:'#00C8FF'},
      {name:'Feldspar',val:m.feldspar||0,color:'#F0A500'},
      {name:'Rock Fragments',val:m.rock_fragments||0,color:'#7FA8C9'},
      {name:'Kaolinite',val:m.kaolinite||0,color:'#FF9E4A'},
      {name:'Illite',val:m.illite||0,color:'#FFAA00'},
      {name:'Smectite',val:m.smectite||0,color:'#FFD07A'},
      {name:'Chlorite',val:m.chlorite||0,color:'#00E5A0'},
      {name:'Calcite Cement',val:m.calcite_cement||0,color:'#C0E0FF'},
      {name:'Dolomite',val:m.dolomite||0,color:'#8ECAFF'},
      {name:'Pyrite',val:m.pyrite||0,color:'#FFD700'},
      {name:'Mica / Other',val:(m.mica||0)+(m.siderite||0),color:'#6080A0'},
    ].filter(x => x.val > 0).sort((a,b) => b.val - a.val);
    const maxVal = minerals[0]?.val || 1;

    body.innerHTML = `
      <div style="padding:12px 0">
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:8px">Mineral Composition (XRD / Point Count)</div>
        ${minerals.map(mn => `
          <div class="min-row">
            <span class="min-name">${mn.name}</span>
            <div class="min-track"><div class="min-fill" style="width:${(mn.val/maxVal)*100}%;background:${mn.color}"></div></div>
            <span class="min-pct" style="color:${mn.color}">${mn.val}%</span>
          </div>`).join('')}

        <div style="margin-top:14px;padding:9px 11px;background:var(--bg4);border-radius:5px">
          <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px">
            <div>
              <div class="stat-lbl">Total Clay Content</div>
              <div class="stat-val ${m.clay_total > 15 ? 'amber' : 'green'}">${m.clay_total || '‚Äî'}%</div>
            </div>
            <div>
              <div class="stat-lbl">Cement Type</div>
              <div class="stat-val" style="font-size:10px">${m.cement_type || '‚Äî'}</div>
            </div>
          </div>
        </div>
        ${m.clay_total > 20 ? `<div class="alert-pill ap-bad" style="margin-top:8px">‚ö† High clay ‚Äî permeability barriers likely</div>` : ''}
        ${m.clay_total > 12 && m.clay_total <= 20 ? `<div class="alert-pill ap-warn" style="margin-top:8px">‚ö† Moderate clay ‚Äî assess permeability impact</div>` : ''}
        ${m.illite > 3 ? `<div class="alert-pill ap-warn" style="margin-top:6px">‚ö† Illite present ‚Äî pore-throat bridging risk</div>` : ''}
        ${m.pyrite > 0.8 ? `<div class="alert-pill ap-warn" style="margin-top:6px">‚ö† Elevated pyrite ‚Äî resistivity log calibration needed</div>` : ''}

        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-top:12px;margin-bottom:6px">Composition Summary</div>
        ${mineralPieBar(minerals)}
      </div>`;

  } else if (tab === 'fluid') {
    const f = a.fluid || {};
    body.innerHTML = `
      <div style="padding:12px 0">
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">PVT Properties</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Oil Density', f.oil_density ? f.oil_density+' g/cc':'‚Äî', '')}
          ${statCell('Gas Specific Gravity', f.gas_sg ? f.gas_sg:'‚Äî', '')}
          ${statCell('Formation Vol. Factor', f.fvf_oil ? f.fvf_oil+' rb/STB':'‚Äî', 'cyan')}
          ${statCell('Bubble Point Pressure', f.pb ? f.pb+' bar':'‚Äî', 'gold')}
          ${statCell('Solution GOR (Rs)', f.rs ? f.rs+' scf/STB':'‚Äî', '')}
          ${statCell('Z-Factor (Gas)', f.z_factor ? f.z_factor:'‚Äî', '')}
          ${statCell('Brine Salinity', f.brine_sal ? f.brine_sal.toLocaleString()+' ppm':'‚Äî', '')}
          ${statCell('WOR', f.wor ? f.wor:'‚Äî', '')}
        </div>

        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Gas Composition (%mol)</div>
        <div style="background:var(--bg4);border-radius:6px;padding:10px 12px;margin-bottom:10px">
          ${gasCompositionBar(f)}
        </div>

        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Contaminants</div>
        <div class="stat-grid">
          ${statCell('H‚ÇÇS Content', f.h2s_ppm ? f.h2s_ppm+' ppm':'‚Äî', f.h2s_ppm > 100 ? 'red' : f.h2s_ppm > 20 ? 'amber' : 'green')}
          ${statCell('CO‚ÇÇ Content', f.co2_pct ? f.co2_pct+'%':'‚Äî', f.co2_pct > 5 ? 'amber' : 'green')}
          ${statCell('N‚ÇÇ Content', f.n2_pct ? f.n2_pct+'%':'‚Äî', '')}
        </div>
        ${f.h2s_ppm > 100 ? `<div class="alert-pill ap-bad" style="margin-top:8px">‚ö† High H‚ÇÇS ‚Äî sour service materials required</div>` : ''}
        ${f.h2s_ppm > 20 && f.h2s_ppm <= 100 ? `<div class="alert-pill ap-warn" style="margin-top:8px">‚ö† Moderate H‚ÇÇS ‚Äî safety protocols required</div>` : ''}
        ${f.co2_pct > 5 ? `<div class="alert-pill ap-warn" style="margin-top:6px">‚ö† Elevated CO‚ÇÇ ‚Äî corrosion risk / carbon credits impacted</div>` : ''}
      </div>`;

  } else if (tab === 'diagenesis') {
    const d = a.diagenesis || {};
    const qualScore = diagenesisScore(d);
    const qColor = qualScore >= 7 ? 'green' : qualScore >= 4 ? 'amber' : 'red';
    body.innerHTML = `
      <div style="padding:12px 0">
        <div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--bg4);border-radius:6px;margin-bottom:12px">
          <div style="flex:1">
            <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Diagenetic Quality Index</div>
            <div style="display:flex;gap:3px;margin-top:4px">${[1,2,3,4,5,6,7,8,9,10].map(n => `<div style="height:6px;width:10px;border-radius:2px;background:${n<=qualScore?`var(--${qColor})`:'var(--bg)'};border:1px solid rgba(255,255,255,.05)"></div>`).join('')}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:28px;font-weight:700;color:var(--${qColor})">${qualScore}/10</div>
            <div style="font-size:9px;color:var(--t3)">${qualScore >= 7 ? 'Good reservoir quality' : qualScore >= 4 ? 'Moderate quality' : 'Tight / degraded'}</div>
          </div>
        </div>

        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Diagenetic History</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Burial Grade', d.burial_grade || '‚Äî', '')}
          ${statCell('Compaction', d.compaction || '‚Äî', d.compaction?.includes('Very High') ? 'red' : d.compaction?.includes('High') ? 'amber' : '')}
          ${statCell('Cementation', d.cementation || '‚Äî', d.cementation?.includes('High') ? 'amber' : 'green')}
          ${statCell('Dissolution', d.dissolution || '‚Äî', d.dissolution?.includes('Extensive') ? 'green' : '')}
          ${statCell('Quartz Overgrowths', d.qovergrowths || '‚Äî', d.qovergrowths?.includes('Extensive') ? 'red' : '')}
          ${statCell('Fluid Inclusion Th', d.fluid_inclusion_th ? d.fluid_inclusion_th+'¬∞C':'‚Äî', 'cyan')}
        </div>

        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Clay Diagenesis</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Authigenic Clay', d.authigenic_clay || '‚Äî', '')}
          ${statCell('Chlorite Coating', d.chlorite_coat || '‚Äî', d.chlorite_coat === 'Present' ? 'green' : '')}
          ${statCell('Kaolinite Pore-Fill', d.kaolinite_pore || '‚Äî', d.kaolinite_pore === 'Present' ? 'amber' : '')}
          ${statCell('Grain Coating', d.grain_coating || '‚Äî', '')}
        </div>

        ${d.chlorite_coat === 'Present' ? `<div class="alert-pill ap-ok" style="margin-top:4px">‚úì Chlorite coating ‚Äî porosity preservation at depth</div>` : ''}
        ${d.qovergrowths === 'Extensive' ? `<div class="alert-pill ap-bad" style="margin-top:6px">‚ö† Extensive quartz overgrowths ‚Äî porosity reduction</div>` : ''}
        ${d.compaction?.includes('Very High') ? `<div class="alert-pill ap-bad" style="margin-top:6px">‚ö† Intense compaction ‚Äî likely tight reservoir</div>` : ''}
        ${d.dissolution?.includes('Extensive') ? `<div class="alert-pill ap-ok" style="margin-top:6px">‚úì Dissolution porosity ‚Äî secondary pores enhance flow</div>` : ''}
      </div>`;

  } else if (tab === 'petrophysics') {
    const p = a.petrophysics || {};
    body.innerHTML = `
      <div style="padding:12px 0">
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Formation Evaluation Summary</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('PHIT (Total Porosity)', p.phit_avg ? p.phit_avg+'%':'‚Äî', 'cyan')}
          ${statCell('PHIE (Effective Por.)', p.phie_avg ? p.phie_avg+'%':'‚Äî', 'cyan')}
          ${statCell('Vsh (Shale Volume)', p.vsh_avg ? p.vsh_avg+'%':'‚Äî', p.vsh_avg > 30 ? 'amber' : 'green')}
          ${statCell('Sw (Water Sat.)', p.sw_avg ? (p.sw_avg*100).toFixed(0)+'%':'‚Äî', p.sw_avg > 0.5 ? 'red' : p.sw_avg > 0.3 ? 'amber' : 'green')}
          ${statCell('BVW (Bulk Vol. Water)', p.bvw_avg ? p.bvw_avg:'‚Äî', '')}
          ${statCell('Archie a', p.archie_a ? p.archie_a:'‚Äî', '')}
          ${statCell('Archie m (Cementation)', p.archie_m ? p.archie_m:'‚Äî', '')}
          ${statCell('Archie n (Saturation)', p.archie_n ? p.archie_n:'‚Äî', '')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Fluid Contacts (mTVDSS)</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('FWL (Free Water Level)', p.fwl_mtvdss ? p.fwl_mtvdss+'m':'‚Äî', 'cyan')}
          ${statCell('OWC (Oil-Water Contact)', p.owc_mtvdss ? p.owc_mtvdss+'m':'‚Äî', 'gold')}
          ${statCell('GOC (Gas-Oil Contact)', p.goc_mtvdss ? p.goc_mtvdss+'m':'‚Äî', 'green')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Log Responses</div>
        <div class="stat-grid">
          ${statCell('Sonic (DT)', p.sonic_dt ? p.sonic_dt+' ¬µs/ft':'‚Äî', '')}
          ${statCell('Density (RHOB)', p.density_rhob ? p.density_rhob+' g/cc':'‚Äî', '')}
          ${statCell('Neutron (NPHI)', p.neutron_nphi ? p.neutron_nphi+'%':'‚Äî', '')}
          ${statCell('Gamma Ray', p.gamma_ray_api ? p.gamma_ray_api+' API':'‚Äî', p.gamma_ray_api > 75 ? 'amber' : 'green')}
        </div>
        ${!p.phie_avg && !p.sw_avg ? `<div style="padding:16px;text-align:center;color:var(--t3);font-size:10px">No petrophysics data ingested for this analogue. Upload a Petrophysics template to populate.</div>` : ''}
      </div>`;

  } else if (tab === 'geomechanics') {
    const gm = a.geomechanics || {};
    const stressColor = gm.stress_regime?.includes('Normal') ? 'cyan' : gm.stress_regime?.includes('Reverse') ? 'red' : 'amber';
    body.innerHTML = `
      <div style="padding:12px 0">
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Rock Mechanical Properties</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('UCS (Unconf. Comp. Strength)', gm.ucs_mpa ? gm.ucs_mpa+' MPa':'‚Äî', gm.ucs_mpa < 20 ? 'red' : gm.ucs_mpa < 50 ? 'amber' : 'green')}
          ${statCell("Young's Modulus", gm.youngs_modulus_gpa ? gm.youngs_modulus_gpa+' GPa':'‚Äî', '')}
          ${statCell("Poisson's Ratio", gm.poissons_ratio ? gm.poissons_ratio:'‚Äî', '')}
          ${statCell('Sand Production Risk', gm.sand_production_risk || '‚Äî', gm.sand_production_risk === 'High' ? 'red' : gm.sand_production_risk === 'Moderate' ? 'amber' : 'green')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">In-Situ Stress State</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Stress Regime', gm.stress_regime || '‚Äî', stressColor)}
          ${statCell('œÉv (Vertical Stress)', gm.sigma_v ? gm.sigma_v+' MPa':'‚Äî', '')}
          ${statCell('œÉhmin (Min Horiz.)', gm.sigma_h_min ? gm.sigma_h_min+' MPa':'‚Äî', 'cyan')}
          ${statCell('œÉHmax (Max Horiz.)', gm.sigma_h_max ? gm.sigma_h_max+' MPa':'‚Äî', 'amber')}
          ${statCell('SHmax Azimuth', gm.shmax_azimuth ? gm.shmax_azimuth+'¬∞':'‚Äî', '')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Fracture Characterisation</div>
        <div class="stat-grid">
          ${statCell('Fracture Density', gm.fracture_density || '‚Äî', gm.fracture_density === 'High' ? 'green' : '')}
          ${statCell('Fracture Orientation', gm.fracture_orientation ? gm.fracture_orientation+'¬∞':'‚Äî', '')}
          ${statCell('Fracture Aperture (¬µm)', gm.fracture_aperture ? gm.fracture_aperture:'‚Äî', '')}
          ${statCell('Borehole Breakout Width', gm.breakout_width ? gm.breakout_width+'¬∞':'‚Äî', '')}
        </div>
        ${gm.sand_production_risk === 'High' ? `<div class="alert-pill ap-bad" style="margin-top:8px">‚ö† High sand production risk ‚Äî gravel pack or ICD completion required</div>` : ''}
        ${!gm.ucs_mpa ? `<div style="padding:16px;text-align:center;color:var(--t3);font-size:10px">No geomechanics data for this analogue. Upload Geomechanics template to populate.</div>` : ''}
      </div>`;

  } else if (tab === 'thermal') {
    const th = a.thermal || {};
    const maturity = th.vitrinite_reflectance_ro;
    const matColor = maturity >= 1.3 ? 'red' : maturity >= 0.6 ? 'green' : 'amber';
    const matLabel = maturity >= 1.3 ? 'Over-mature' : maturity >= 0.9 ? 'Late oil / condensate' : maturity >= 0.6 ? 'Peak oil window' : maturity ? 'Immature / early oil' : 'No data';
    body.innerHTML = `
      <div style="padding:12px 0">
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Thermal Parameters</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Surface Heat Flow', th.surface_heat_flow_mw_m2 ? th.surface_heat_flow_mw_m2+' mW/m¬≤':'‚Äî', th.surface_heat_flow_mw_m2 > 80 ? 'red' : th.surface_heat_flow_mw_m2 > 60 ? 'amber' : 'cyan')}
          ${statCell('Thermal Gradient', th.thermal_gradient ? th.thermal_gradient+' ¬∞C/km':'‚Äî', 'gold')}
          ${statCell('Max Burial Depth', th.max_burial_depth ? th.max_burial_depth+'m':'‚Äî', '')}
          ${statCell('Subsidence Rate', th.subsidence_rate ? th.subsidence_rate+' m/My':'‚Äî', '')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Thermal Maturity</div>
        <div style="padding:8px 10px;background:var(--bg4);border-radius:5px;margin-bottom:10px;border-left:3px solid var(--${matColor})">
          <div style="font-size:9px;color:var(--t3);margin-bottom:2px">Maturity Stage</div>
          <div style="font-size:11px;font-weight:700;color:var(--${matColor})">${matLabel}</div>
        </div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Vitrinite Reflectance (Ro)', maturity ? maturity+'% Ro':'‚Äî', matColor)}
          ${statCell('Tmax', th.tmax_c ? th.tmax_c+'¬∞C':'‚Äî', 'cyan')}
          ${statCell('TTI (Lopatin)', th.tti_lopatin ? th.tti_lopatin:'‚Äî', '')}
          ${statCell('Age of Peak Generation', th.age_peak_generation ? th.age_peak_generation+' Ma':'‚Äî', '')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Petroleum System Timing</div>
        <div class="stat-grid">
          ${statCell('Trap Timing vs Generation', th.trap_timing_vs_generation || '‚Äî', th.trap_timing_vs_generation?.includes('Favourable') ? 'green' : 'amber')}
          ${statCell('Charge Risk Rating', th.charge_risk_rating || '‚Äî', th.charge_risk_rating === 'Low' ? 'green' : th.charge_risk_rating === 'High' ? 'red' : 'amber')}
        </div>
        ${!th.surface_heat_flow_mw_m2 ? `<div style="padding:16px;text-align:center;color:var(--t3);font-size:10px">No thermal/basin modelling data. Upload Thermal template to populate.</div>` : ''}
      </div>`;

  } else if (tab === 'environmental') {
    const ev = a.environmental || {};
    const h2sRisk = ev.h2s_ppm > 500 ? 'red' : ev.h2s_ppm > 100 ? 'amber' : 'green';
    body.innerHTML = `
      <div style="padding:12px 0">
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Produced Fluid Hazards</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('H‚ÇÇS Content', ev.h2s_ppm !== undefined ? ev.h2s_ppm+' ppm':'‚Äî', h2sRisk)}
          ${statCell('CO‚ÇÇ Content (%)', ev.co2_pct !== undefined ? ev.co2_pct+'%':'‚Äî', ev.co2_pct > 10 ? 'red' : ev.co2_pct > 5 ? 'amber' : 'green')}
          ${statCell('Mercury (Hg)', ev.hg_ppb ? ev.hg_ppb+' ppb':'‚Äî', ev.hg_ppb > 100 ? 'amber' : 'green')}
          ${statCell('Hydrate Risk', ev.hydrate_risk || '‚Äî', ev.hydrate_risk === 'High' ? 'red' : ev.hydrate_risk === 'Moderate' ? 'amber' : 'green')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Environmental Sensitivity</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Protected Area', ev.protected_area_flag ? (ev.protected_area_flag==='Yes'?'‚ö† YES':'‚úì No'):'‚Äî', ev.protected_area_flag==='Yes'?'red':'green')}
          ${statCell('Marine Mammal Presence', ev.marine_mammal_presence || '‚Äî', ev.marine_mammal_presence==='High'?'amber':'')}
          ${statCell('Seismic Survey Restriction', ev.seismic_survey_restriction || '‚Äî', ev.seismic_survey_restriction==='Restricted'?'red':'')}
          ${statCell('Environmental Impact Category', ev.environmental_impact_category || '‚Äî', ev.environmental_impact_category?.includes('High')?'red':ev.environmental_impact_category?.includes('Moderate')?'amber':'green')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">HSE Classification</div>
        <div class="stat-grid">
          ${statCell('Spill Response Tier', ev.spill_response_tier ? 'Tier '+ev.spill_response_tier:'‚Äî', '')}
          ${statCell('HSE Risk Class', ev.hse_risk_class || '‚Äî', ev.hse_risk_class?.includes('High')?'red':ev.hse_risk_class?.includes('Medium')?'amber':'green')}
        </div>
        ${ev.h2s_ppm > 500 ? `<div class="alert-pill ap-bad" style="margin-top:8px">‚ö† Extreme H‚ÇÇS ‚Äî full sour service design + dedicated HSE plan required</div>` : ''}
        ${ev.protected_area_flag==='Yes' ? `<div class="alert-pill ap-bad" style="margin-top:6px">‚ö† Protected area ‚Äî special environmental permit and impact assessment required</div>` : ''}
        ${!ev.h2s_ppm && !ev.co2_pct ? `<div style="padding:16px;text-align:center;color:var(--t3);font-size:10px">No environmental data. Upload Environmental & HSE template to populate.</div>` : ''}
      </div>`;

  } else if (tab === 'commercial') {
    const co = a.commercial || {};
    const npvColor = co.npv_10_musd > 500 ? 'green' : co.npv_10_musd > 100 ? 'cyan' : co.npv_10_musd > 0 ? 'amber' : 'red';
    body.innerHTML = `
      <div style="padding:12px 0">
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Resource Volumes</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Gross Resources (MMboe)', co.gross_resources_mmboe ? co.gross_resources_mmboe.toLocaleString():'‚Äî', 'cyan')}
          ${statCell('Net Resources (MMboe)', co.net_resources_mmboe ? co.net_resources_mmboe.toLocaleString():'‚Äî', 'cyan')}
          ${statCell('Recovery Factor', co.recovery_factor ? co.recovery_factor+'%':'‚Äî', 'green')}
          ${statCell('Plateau Rate (kboe/d)', co.plateau_rate ? co.plateau_rate:'‚Äî', 'gold')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Economics (100% basis)</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('NPV‚ÇÅ‚ÇÄ (MUSD)', co.npv_10_musd ? '$'+co.npv_10_musd.toLocaleString():'‚Äî', npvColor)}
          ${statCell('IRR (%)', co.irr_pct ? co.irr_pct+'%':'‚Äî', co.irr_pct > 20 ? 'green' : co.irr_pct > 12 ? 'cyan' : 'amber')}
          ${statCell('Breakeven Oil Price', co.breakeven_price ? '$'+co.breakeven_price+'/bbl':'‚Äî', co.breakeven_price > 60 ? 'red' : co.breakeven_price > 40 ? 'amber' : 'green')}
          ${statCell('CAPEX (MUSD)', co.capex_musd ? '$'+co.capex_musd.toLocaleString():'‚Äî', '')}
          ${statCell('OPEX ($/boe)', co.opex_usd_boe ? '$'+co.opex_usd_boe:'‚Äî', co.opex_usd_boe > 20 ? 'amber' : 'green')}
          ${statCell('Royalty / Tax Rate', co.royalty_tax_rate ? co.royalty_tax_rate+'%':'‚Äî', '')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Fiscal & Infrastructure</div>
        <div class="stat-grid" style="margin-bottom:10px">
          ${statCell('Fiscal Regime', co.fiscal_regime || '‚Äî', '')}
          ${statCell('Government Take (%)', co.government_take_pct ? co.government_take_pct+'%':'‚Äî', co.government_take_pct > 70 ? 'red' : co.government_take_pct > 55 ? 'amber' : 'green')}
          ${statCell('Infrastructure Access', co.infrastructure_access || '‚Äî', co.infrastructure_access?.includes('Excellent')?'green':co.infrastructure_access?.includes('Remote')?'amber':'')}
          ${statCell('Tieback Distance', co.tieback_distance_km ? co.tieback_distance_km+' km':'‚Äî', '')}
        </div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Contingent Resources</div>
        <div class="stat-grid">
          ${statCell('Contingent Resources Class', co.contingent_resources_class || '‚Äî', '')}
          ${statCell('PRMS Status', co.prms_status || '‚Äî', 'cyan')}
        </div>
        ${co.npv_10_musd > 0 ? `<div class="alert-pill ap-ok" style="margin-top:8px">‚úì Positive NPV‚ÇÅ‚ÇÄ ‚Äî project economics viable at $10 discount rate</div>` : ''}
        ${co.breakeven_price > 60 ? `<div class="alert-pill ap-warn" style="margin-top:6px">‚ö† High breakeven ‚Äî project sensitive to oil price downside</div>` : ''}
        ${!co.npv_10_musd && !co.gross_resources_mmboe ? `<div style="padding:16px;text-align:center;color:var(--t3);font-size:10px">No commercial data. Upload Commercial & Economic template to populate.</div>` : ''}
      </div>`;
  }
}

// ---- Helper renderers ----
function statCell(lbl, val, colorClass) {
  return `<div class="stat-cell"><div class="stat-lbl">${lbl}</div><div class="stat-val ${colorClass}">${val}</div></div>`;
}

function mudWindowBar(g) {
  const lo = 8, hi = 18;
  const toW = v => ((v - lo) / (hi - lo) * 100).toFixed(1);
  const ppW = toW(g.ppg);
  const ecdW = toW(g.ecd);
  const minW = toW(g.mudweight_min);
  const maxW = toW(g.mudweight_max);
  return `
    <div style="position:relative;height:20px;background:var(--bg);border-radius:4px;overflow:hidden">
      <div style="position:absolute;left:${minW}%;width:${maxW - minW}%;height:100%;background:rgba(0,229,160,.2);border-left:2px solid var(--green);border-right:2px solid var(--amber)"></div>
      <div style="position:absolute;left:${ppW}%;top:2px;width:2px;height:16px;background:var(--cyan)" title="Pore pressure equivalent"></div>
      <div style="position:absolute;left:${ecdW}%;top:2px;width:2px;height:16px;background:var(--gold)" title="ECD"></div>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:8px;color:var(--t3);margin-top:3px"><span>8 ppg</span><span>‚Üê Safe drilling window ‚Üí</span><span>18 ppg</span></div>`;
}

function gasCompositionBar(f) {
  const comps = [
    {name:'C‚ÇÅ (Methane)', val:f.c1_pct||0, color:'#00C8FF'},
    {name:'C‚ÇÇ (Ethane)', val:f.c2_pct||0, color:'#00E5A0'},
    {name:'C‚ÇÉ (Propane)', val:f.c3_pct||0, color:'#F0A500'},
    {name:'CO‚ÇÇ', val:f.co2_pct||0, color:'#FF4D6A'},
    {name:'N‚ÇÇ', val:f.n2_pct||0, color:'#7FA8C9'},
  ].filter(c => c.val > 0);
  const total = comps.reduce((s, c) => s + c.val, 0);
  return `<div style="display:flex;height:14px;border-radius:4px;overflow:hidden;margin-bottom:6px">
    ${comps.map(c => `<div style="width:${(c.val/100)*100}%;background:${c.color};min-width:${c.val>0?'2px':'0'}" title="${c.name}: ${c.val}%"></div>`).join('')}
  </div>
  <div style="display:flex;flex-wrap:wrap;gap:8px">${comps.map(c => `<span style="font-size:9px;color:${c.color};display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;background:${c.color};border-radius:50%;display:inline-block"></span>${c.name} ${c.val}%</span>`).join('')}</div>`;
}

function mineralPieBar(minerals) {
  const groups = [
    {name:'Framework',color:'#00C8FF',names:['Quartz','Feldspar','Rock Fragments']},
    {name:'Clay',color:'#F0A500',names:['Kaolinite','Illite','Smectite','Chlorite']},
    {name:'Cement',color:'#C0E0FF',names:['Calcite Cement','Dolomite']},
    {name:'Accessory',color:'#FF4D6A',names:['Pyrite','Mica / Other']},
  ];
  return `<div style="display:flex;height:10px;border-radius:4px;overflow:hidden">
    ${groups.map(g => {
      const pct = minerals.filter(m => g.names.includes(m.name)).reduce((s, m) => s + m.val, 0);
      return `<div style="width:${pct}%;background:${g.color};min-width:${pct>0?'2px':'0'}" title="${g.name}: ${pct}%"></div>`;
    }).join('')}
  </div>
  <div style="display:flex;gap:10px;margin-top:5px;flex-wrap:wrap">${groups.map(g => {
    const pct = minerals.filter(m => g.names.includes(m.name)).reduce((s,m) => s + m.val, 0);
    return `<span style="font-size:9px;color:${g.color}">${g.name}: ${pct.toFixed(0)}%</span>`;
  }).join('')}</div>`;
}

function diagenesisScore(d) {
  let score = 5;
  if (d.compaction?.includes('Low')) score += 2;
  if (d.compaction?.includes('Moderate')) score += 0;
  if (d.compaction?.includes('High') && !d.compaction.includes('Very')) score -= 1;
  if (d.compaction?.includes('Very High')) score -= 2;
  if (d.cementation?.includes('Low') || d.cementation?.includes('Very Low')) score += 1;
  if (d.cementation?.includes('High')) score -= 1;
  if (d.dissolution?.includes('Extensive') || d.dissolution?.includes('Present')) score += 1;
  if (d.chlorite_coat === 'Present') score += 1;
  if (d.qovergrowths === 'Extensive') score -= 1;
  if (d.kaolinite_pore === 'Present') score -= 0.5;
  return Math.max(1, Math.min(10, Math.round(score)));
}

function toggleCompare(rank, e) {
  if (e.target.checked) {
    if (selectedAnalogues.size >= 5) { toast('Max 5 analogues for comparison', 'warning'); e.target.checked = false; return; }
    selectedAnalogues.add(rank);
  } else {
    selectedAnalogues.delete(rank);
  }
}

// legacy shim
function _legacySwitchAnalogueTab(tab) { switchAnalogueTab(tab, null); }

// ============================================================
// SIMILARITY ANALYSIS ‚Äî 6 visualisations
// ============================================================

// Build "target" reservoir object from the search form inputs
function buildTargetFromSearch() {
  return {
    por:   ((parseFloat(document.getElementById('s-pormin')?.value)||0) + (parseFloat(document.getElementById('s-pormax')?.value)||0)) / 2 || 22,
    perm:  ((parseFloat(document.getElementById('s-permmin')?.value)||0) + (parseFloat(document.getElementById('s-permmax')?.value)||0)) / 2 || 300,
    rf:    parseFloat(document.getElementById('s-rfmin')?.value) || 35,
    ntg:   parseFloat(document.getElementById('s-ntgmin')?.value) || 65,
    depth: ((parseFloat(document.getElementById('s-dmin')?.value)||2500) + (parseFloat(document.getElementById('s-dmax')?.value)||4500)) / 2,
    api:   ((parseFloat(document.getElementById('s-apimin')?.value)||28) + (parseFloat(document.getElementById('s-apimax')?.value)||38)) / 2,
    gor:   600,
    sw:    parseFloat(document.getElementById('s-swmax')?.value) || 0.25,
  };
}

function loadSimilarityAnalogue() {
  const rank = parseInt(document.getElementById('sim-analogue-select').value);
  if (!rank) return;
  const a = searchResults.find(x => x.rank === rank);
  if (a) { currentAnalogue = a; renderSimilarityAnalysis(a); }
}

function renderSimilarityAnalysis(analogue) {
  const a = analogue || currentAnalogue;
  if (!a) {
    // Show placeholder if no analogue selected yet ‚Äî pick top result
    if (searchResults.length) { renderSimilarityAnalysis(searchResults[0]); return; }
    return;
  }
  currentAnalogue = a;

  // Update header
  const c = a.sim >= 80 ? 'var(--green)' : a.sim >= 65 ? 'var(--amber)' : 'var(--red)';
  document.getElementById('sim-analogue-name').textContent = a.name;
  document.getElementById('sim-analogue-meta').textContent = `${a.basin} ¬∑ ${a.lith} ¬∑ ${a.dep} ¬∑ ${a.age} ¬∑ ${a.depth}m TVDSS`;
  const badge = document.getElementById('sim-score-badge');
  badge.style.display = 'block';
  document.getElementById('sim-score-val').textContent = a.sim + '%';
  document.getElementById('sim-score-val').style.color = c;
  const simSel = document.getElementById('sim-analogue-select');
  if (simSel && simSel.value !== String(a.rank)) simSel.value = String(a.rank);

  const T = buildTargetFromSearch();

  // Render target summary chips
  const chips = document.getElementById('sim-target-chips');
  if (chips) {
    const CHIP_DEFS = [
      { label:'Por',   val: T.por.toFixed(1),   unit:'%',    color:'rgba(255,77,106,.15)',  border:'rgba(255,77,106,.4)' },
      { label:'Perm',  val: T.perm.toFixed(0),  unit:' mD',  color:'rgba(255,77,106,.1)',   border:'rgba(255,77,106,.3)' },
      { label:'RF',    val: T.rf.toFixed(0),     unit:'%',    color:'rgba(255,77,106,.1)',   border:'rgba(255,77,106,.3)' },
      { label:'NTG',   val: T.ntg.toFixed(0),    unit:'%',    color:'rgba(255,77,106,.1)',   border:'rgba(255,77,106,.3)' },
      { label:'Depth', val: T.depth.toFixed(0),  unit:' m',   color:'rgba(255,77,106,.1)',   border:'rgba(255,77,106,.3)' },
      { label:'API',   val: T.api.toFixed(1),    unit:'¬∞',    color:'rgba(255,77,106,.1)',   border:'rgba(255,77,106,.3)' },
      { label:'GOR',   val: T.gor.toFixed(0),    unit:'',     color:'rgba(255,77,106,.08)',  border:'rgba(255,77,106,.25)' },
      { label:'Sw',    val: T.sw.toFixed(2),     unit:'',     color:'rgba(255,77,106,.08)',  border:'rgba(255,77,106,.25)' },
    ];
    chips.innerHTML = CHIP_DEFS.map(ch =>
      `<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 9px;background:${ch.color};border:1px solid ${ch.border};border-radius:20px;font-size:9px">
        <span style="color:rgba(255,77,106,.7);font-weight:600">${ch.label}</span>
        <span style="color:var(--t1);font-weight:700">${ch.val}${ch.unit}</span>
      </span>`
    ).join('');
  }

  renderRadarChart(a, T);
  renderDecompositionBar(a);
  renderScorecard(a, T);
  renderDeviationCards(a, T);
  renderSimilarityHistogram();
  renderParallelCoords(a, T);
  renderSimCrossplot();
}

// ‚îÄ‚îÄ 1. RADAR CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRadarChart(a, T) {
  const canvas = document.getElementById('sim-radar');
  if (!canvas) return;

  const AXES = [
    { key:'por',   label:'Porosity',     max:35   },
    { key:'perm',  label:'Perm (mD)',    max:600  },
    { key:'rf',    label:'Recov.Factor', max:50   },
    { key:'ntg',   label:'NTG',          max:100  },
    { key:'api',   label:'API',          max:45   },
    { key:'depth', label:'Depth',        max:5000, invert:true },
    { key:'sw',    label:'Sw (inv)',      max:1,   invert:true  },
    { key:'gor',   label:'GOR/100',      max:150  },
  ];

  const norm = (v, ax) => {
    const raw = ax.key === 'gor' ? v / 100 : v;
    const frac = Math.max(0, Math.min(1, raw / ax.max));
    return (ax.invert ? 1 - frac : frac) * 100;
  };

  const medianNorm = AXES.map(ax => {
    const vals = ANALOGUES.map(x => ax.key === 'gor' ? x.gor/100 : +x[ax.key]).filter(v => v > 0).sort((a,b) => a-b);
    const med = vals[Math.floor(vals.length / 2)] || 0;
    const frac = Math.max(0, Math.min(1, med / ax.max));
    return (ax.invert ? 1 - frac : frac) * 100;
  });

  const analogueNorm = AXES.map(ax => norm(+a[ax.key] || 0, ax));
  const targetNorm   = AXES.map(ax => norm(+T[ax.key] || 0, ax));
  const fmt = v => v >= 1000 ? (v/1000).toFixed(1)+'k' : (+v).toFixed(v < 10 ? 1 : 0);

  if (_simRadarChart) { _simRadarChart.destroy(); _simRadarChart = null; }

  _simRadarChart = new Chart(canvas, {
    type: 'radar',
    data: {
      labels: AXES.map(ax => ax.label),
      datasets: [
        {
          label: 'Median',
          data: medianNorm,
          backgroundColor: 'rgba(0,200,255,.06)',
          borderColor: 'rgba(0,200,255,.35)',
          borderWidth: 1.5,
          borderDash: [4, 3],
          pointRadius: 0,
          pointHoverRadius: 0,
        },
        {
          label: 'Analogue',
          data: analogueNorm,
          backgroundColor: 'rgba(107,70,193,.18)',
          borderColor: 'rgba(107,70,193,.85)',
          borderWidth: 2.5,
          pointBackgroundColor: '#6B46C1',
          pointBorderColor: '#6B46C1',
          pointRadius: 4,
          pointHoverRadius: 7,
        },
        {
          label: 'Target',
          data: targetNorm,
          backgroundColor: 'rgba(255,77,106,.15)',
          borderColor: '#FF4D6A',
          borderWidth: 2.5,
          pointBackgroundColor: '#FF4D6A',
          pointBorderColor: '#FF4D6A',
          pointRadius: 4,
          pointHoverRadius: 7,
        },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 300 },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label(ctx) {
              const ax = AXES[ctx.dataIndex];
              if (ctx.datasetIndex === 0) return `Median: ${ctx.raw.toFixed(0)}%`;
              const raw = ctx.datasetIndex === 1 ? +a[ax.key] : +T[ax.key];
              return `${ctx.dataset.label}: ${fmt(raw)}`;
            }
          }
        }
      },
      scales: {
        r: {
          min: 0, max: 100,
          ticks: {
            stepSize: 20,
            font: { size: 8 },
            color: 'rgba(107,70,193,.4)',
            backdropColor: 'transparent',
            callback: v => v + '%'
          },
          grid: { color: ctx => ctx.index === 4 ? 'rgba(107,70,193,.2)' : 'rgba(107,70,193,.08)' },
          angleLines: { color: 'rgba(107,70,193,.18)', lineWidth: 1 },
          pointLabels: { font: { size: 9, weight: 'bold' }, color: '#4A5568' }
        }
      }
    }
  });

  // Value strip ‚Äî unchanged
  const strip = document.getElementById('sim-radar-target-vals');
  if (strip) {
    strip.innerHTML = '<span style="color:var(--red);font-weight:700;margin-right:6px">TARGET:</span>' +
      AXES.map(ax => {
        const raw = +T[ax.key];
        const aRaw = +a[ax.key];
        const diff = raw && aRaw ? Math.abs(raw-aRaw)/Math.max(raw,aRaw)*100 : null;
        const dc = diff === null ? 'var(--t3)' : diff<15?'var(--green)':diff<35?'var(--amber)':'var(--red)';
        return `<span style="margin-right:10px"><span style="color:rgba(255,77,106,.7)">${ax.label}:</span> <strong style="color:var(--t1)">${fmt(raw)}</strong>${diff!==null?` <span style="color:${dc};font-size:8px">(A:${fmt(aRaw)}, Œî${diff.toFixed(0)}%)</span>`:''}`;
      }).join('') + '</span>';
  }
}

// ‚îÄ‚îÄ 2. DECOMPOSITION BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDecompositionBar(a) {
  const container = document.getElementById('sim-decomp');
  if (!container) return;

  const FACTORS = [
    { label:'Lithology',         max:25, calc: () => a.lith?.toLowerCase().includes(document.getElementById('s-lith')?.value.toLowerCase().slice(0,4)) ? 25 : 0 },
    { label:'Depositional Env.', max:15, calc: () => { const d=document.getElementById('s-dep')?.value||''; return a.dep?.toLowerCase().includes(d.toLowerCase().split(' ')[0]) ? 15 : a.dep?.toLowerCase().includes(d.toLowerCase().split(' ')[1]||'__') ? 8 : 0; } },
    { label:'HC Phase',          max:15, calc: () => a.hc?.toLowerCase().includes((document.getElementById('s-hc')?.value||'oil').toLowerCase().split(' ')[0]) ? 15 : 5 },
    { label:'Geological Age',    max:10, calc: () => a.age?.toLowerCase().includes((document.getElementById('s-age')?.value||'').toLowerCase()) ? 10 : 4 },
    { label:'Drive Mechanism',   max:10, calc: () => { const d=document.getElementById('s-drive')?.value||'Any'; return d==='Any'||a.drive?.toLowerCase().includes(d.toLowerCase().split(' ')[0]) ? 10 : 3; } },
    { label:'Tectonic Setting',  max:10, calc: () => { const t=document.getElementById('s-tecto')?.value||'Any'; if(t==='Any') return 10; const b=BASINS.find(x=>x.name===a.basin); return b?.tectonic?.toLowerCase().includes(t.toLowerCase().split(' ')[0]) ? 10 : 2; } },
    { label:'Depth Range',       max:15, calc: () => { const mn=parseFloat(document.getElementById('s-dmin')?.value)||0, mx=parseFloat(document.getElementById('s-dmax')?.value)||99999; return a.depth>=mn&&a.depth<=mx ? 15 : Math.max(0,15-Math.round(Math.abs(a.depth-(mn+mx)/2)/300)); } },
  ];

  const total = FACTORS.reduce((s,f) => s+f.calc(), 0);
  const maxTotal = FACTORS.reduce((s,f) => s+f.max, 0);

  container.innerHTML = `
    <div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px">
        <span style="font-size:10px;font-weight:700;color:var(--t1)">Total Score</span>
        <span style="font-size:20px;font-weight:800;color:var(--purple)">${a.sim}%</span>
      </div>
      <div style="height:8px;background:var(--bg4);border-radius:4px;overflow:hidden">
        <div style="height:100%;width:${a.sim}%;background:linear-gradient(90deg,var(--purple),var(--cyan));border-radius:4px;transition:width .5s"></div>
      </div>
    </div>
    ${FACTORS.map(f => {
      const pts = f.calc();
      const pct = Math.round(pts/f.max*100);
      const barColor = pct>=80?'var(--green)':pct>=50?'var(--amber)':'var(--red)';
      return `<div style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;font-size:9px;margin-bottom:3px">
          <span style="color:var(--t2);font-weight:600">${f.label}</span>
          <span style="color:var(--t3)">${pts}/${f.max} pts <span style="color:${barColor};font-weight:700">(${pct}%)</span></span>
        </div>
        <div style="height:6px;background:var(--bg4);border-radius:3px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${barColor};border-radius:3px;transition:width .4s"></div>
        </div>
      </div>`;
    }).join('')}
    <div style="margin-top:10px;padding:7px 9px;background:var(--bg4);border-radius:5px;font-size:9px;color:var(--t3)">
      Weighted score ${total}/${maxTotal} pts ¬∑ Algorithm covers ${FACTORS.length} factors
    </div>`;
}

// ‚îÄ‚îÄ 3. PARAMETER SCORECARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderScorecard(a, T) {
  const container = document.getElementById('sim-scorecard');
  if (!container) return;

  const ROWS = [
    { label:'Porosity (%)',         tval: T.por,   aval: a.por,        unit:'%',     fmt: v=>v.toFixed(1), tol:5  },
    { label:'Permeability (mD)',    tval: T.perm,  aval: a.perm,       unit:' mD',   fmt: v=>v.toFixed(0), tol:150 },
    { label:'Recovery Factor (%)', tval: T.rf,    aval: a.rf,         unit:'%',     fmt: v=>v.toFixed(0), tol:8  },
    { label:'Net-to-Gross (%)',    tval: T.ntg,   aval: a.ntg,        unit:'%',     fmt: v=>v.toFixed(0), tol:15 },
    { label:'Depth (mTVDSS)',      tval: T.depth, aval: a.depth,      unit:' m',    fmt: v=>v.toFixed(0), tol:500 },
    { label:'API Gravity (¬∞)',     tval: T.api,   aval: a.api,        unit:'¬∞',     fmt: v=>v.toFixed(1), tol:4  },
    { label:'GOR (scf/bbl)',       tval: T.gor,   aval: a.gor,        unit:'',      fmt: v=>v.toLocaleString(), tol:300 },
    { label:'Water Saturation',    tval: T.sw,    aval: a.sw,         unit:'',      fmt: v=>v.toFixed(2), tol:0.1 },
    { label:'Temperature (¬∞C)',    tval: null,    aval: a.temp,       unit:'¬∞C',    fmt: v=>v?.toFixed(0)||'‚Äî', tol:null },
    { label:'Res. Pressure (bar)', tval: null,    aval: a.pres_res,   unit:' bar',  fmt: v=>v?.toFixed(0)||'‚Äî', tol:null },
    { label:'Gross Pay (m)',       tval: null,    aval: a.gross_pay,  unit:' m',    fmt: v=>v?.toFixed(0)||'‚Äî', tol:null },
    { label:'Viscosity (cP)',      tval: null,    aval: a.visc,       unit:' cP',   fmt: v=>v?.toFixed(1)||'‚Äî', tol:null },
  ];

  container.innerHTML = `
    <table style="width:100%;font-size:10px">
      <thead><tr>
        <th style="text-align:left;padding:4px 6px;font-size:9px;color:var(--t3);font-weight:600">Parameter</th>
        <th style="text-align:right;padding:4px 6px;font-size:9px;color:var(--red);font-weight:600">Target</th>
        <th style="text-align:right;padding:4px 6px;font-size:9px;color:var(--purple);font-weight:600">Analogue</th>
        <th style="text-align:right;padding:4px 6px;font-size:9px;color:var(--t3);font-weight:600">Œî</th>
        <th style="padding:4px 6px;font-size:9px;color:var(--t3);font-weight:600">Match</th>
      </tr></thead>
      <tbody>
        ${ROWS.map(r => {
          const hasTarget = r.tval !== null && !isNaN(r.tval);
          const aStr = r.aval !== undefined && r.aval !== null ? r.fmt(r.aval) + r.unit : '‚Äî';
          const tStr = hasTarget ? r.fmt(r.tval) + r.unit : '‚Äî';
          let matchPct = null, barColor = 'var(--t3)', barW = 0;
          if (hasTarget && r.aval && r.tol) {
            const diff = Math.abs(r.aval - r.tval);
            matchPct = Math.max(0, Math.min(100, Math.round((1 - diff/r.tol)*100)));
            barColor = matchPct>=80?'var(--green)':matchPct>=50?'var(--amber)':'var(--red)';
            barW = matchPct;
          }
          const delta = hasTarget && r.aval ? ((r.aval-r.tval)>=0?'+':'')+r.fmt(r.aval-r.tval) : '‚Äî';
          const deltaColor = !hasTarget||!r.aval ? 'var(--t3)' : Math.abs(r.aval-r.tval) <= (r.tol||Infinity)*0.5 ? 'var(--green)' : 'var(--amber)';
          return `<tr>
            <td style="padding:5px 6px;color:var(--t2);font-weight:600">${r.label}</td>
            <td style="padding:5px 6px;text-align:right;color:var(--red)">${tStr}</td>
            <td style="padding:5px 6px;text-align:right;color:var(--purple);font-weight:600">${aStr}</td>
            <td style="padding:5px 6px;text-align:right;color:${deltaColor};font-size:9px">${delta}</td>
            <td style="padding:5px 6px;min-width:70px">
              ${matchPct !== null
                ? `<div style="display:flex;align-items:center;gap:5px">
                     <div style="flex:1;height:5px;background:var(--bg4);border-radius:2px;overflow:hidden">
                       <div style="height:100%;width:${barW}%;background:${barColor};border-radius:2px"></div>
                     </div>
                     <span style="font-size:9px;color:${barColor};font-weight:700;min-width:28px">${matchPct}%</span>
                   </div>`
                : '<span style="color:var(--t3);font-size:9px">‚Äî</span>'}
            </td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`;
}

// ‚îÄ‚îÄ 4. DEVIATION CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDeviationCards(a, T) {
  const container = document.getElementById('sim-deviation');
  if (!container) return;

  const PROPS = [
    { key:'por',   label:'Porosity',    unit:'%' },
    { key:'perm',  label:'Permeability',unit:' mD' },
    { key:'rf',    label:'Recov. Factor',unit:'%' },
    { key:'ntg',   label:'NTG',         unit:'%' },
    { key:'depth', label:'Depth',       unit:' m' },
    { key:'api',   label:'API Gravity', unit:'¬∞' },
    { key:'gor',   label:'GOR',         unit:'' },
    { key:'sw',    label:'Water Sat.',  unit:'' },
  ];

  // Compute mean and std from full ANALOGUES database
  container.innerHTML = PROPS.map(p => {
    const vals = ANALOGUES.map(x => +x[p.key]).filter(v=>!isNaN(v)&&v>0);
    const mean = vals.reduce((s,v)=>s+v,0)/vals.length;
    const std  = Math.sqrt(vals.reduce((s,v)=>s+(v-mean)**2,0)/vals.length) || 1;
    const aVal = +a[p.key];
    const tVal = +T[p.key];
    const aSigma = (aVal - mean) / std;
    const tSigma = (tVal - mean) / std;
    const diff   = Math.abs(aSigma - tSigma);
    const matchColor = diff<0.5?'var(--green)':diff<1.5?'var(--amber)':'var(--red)';
    const matchLabel = diff<0.5?'Excellent':diff<1.0?'Good':diff<1.5?'Fair':'Divergent';

    // Mini gauge: -3œÉ to +3œÉ
    const gaugeW = 100;
    const tPos = Math.max(2,Math.min(98,(tSigma+3)/6*gaugeW));
    const aPos = Math.max(2,Math.min(98,(aSigma+3)/6*gaugeW));

    return `<div style="background:var(--bg4);border-radius:7px;padding:10px 12px;border:1px solid var(--b1)">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px">
        <span style="font-size:9px;font-weight:700;color:var(--t2)">${p.label}</span>
        <span style="font-size:9px;font-weight:700;color:${matchColor}">${matchLabel}</span>
      </div>
      <!-- Sigma gauge -->
      <div style="position:relative;height:14px;background:linear-gradient(90deg,rgba(255,77,106,.15),rgba(0,229,160,.15));border-radius:3px;margin-bottom:6px;overflow:visible">
        <div style="position:absolute;left:50%;top:-2px;width:1px;height:18px;background:rgba(0,0,0,.15)"></div>
        <!-- Target marker -->
        <div title="Target: ${isNaN(tVal)?'‚Äî':tVal.toFixed(tVal<10?2:0)+p.unit}" style="position:absolute;left:${tPos}%;top:-3px;transform:translateX(-50%);width:3px;height:20px;background:var(--red);border-radius:1px;z-index:2"></div>
        <!-- Analogue marker -->
        <div title="Analogue: ${isNaN(aVal)?'‚Äî':aVal.toFixed(aVal<10?2:0)+p.unit}" style="position:absolute;left:${aPos}%;top:0;transform:translateX(-50%);width:10px;height:14px;background:var(--purple);border-radius:2px;opacity:.85;z-index:1"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:8px;color:var(--t3)">
        <span>-3œÉ</span>
        <span style="color:var(--red)">T:${isNaN(tSigma)?'‚Äî':tSigma.toFixed(1)}œÉ</span>
        <span style="color:var(--purple)">A:${isNaN(aSigma)?'‚Äî':aSigma.toFixed(1)}œÉ</span>
        <span>+3œÉ</span>
      </div>
      <div style="font-size:8px;color:var(--t3);margin-top:3px;text-align:center">Œî = <strong style="color:${matchColor}">${diff.toFixed(2)}œÉ</strong></div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ 5. DISTRIBUTION HISTOGRAM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSimilarityHistogram() {
  const a = currentAnalogue;
  const canvas = document.getElementById('sim-hist');
  if (!canvas) return;
  const key = document.getElementById('sim-hist-param')?.value || 'por';
  const T = buildTargetFromSearch();

  const vals = ANALOGUES.map(x => +x[key]).filter(v => !isNaN(v) && v > 0);
  if (!vals.length) return;
  const mn = Math.min(...vals), mx = Math.max(...vals);
  const BINS = 10;
  const binW = (mx - mn) / BINS;
  const bins = Array(BINS).fill(0);
  vals.forEach(v => { const i = Math.min(BINS-1, Math.floor((v-mn)/binW)); bins[i]++; });

  const binLabels = Array.from({length: BINS}, (_, i) => (mn + i * binW).toFixed(mx < 100 ? 1 : 0));
  const tVal = +T[key];
  const aVal = a ? +a[key] : null;
  const aLabel = a ? a.name.split('‚Äî')[0].trim().substring(0, 12) : null;

  const LABELS = {por:'Porosity (%)',perm:'Permeability (mD)',rf:'Recovery Factor (%)',ntg:'NTG (%)',depth:'Depth (m)',api:'API (¬∞)',gor:'GOR (scf/bbl)'};

  const vlinePlugin = {
    id: 'vlines',
    afterDraw(chart) {
      const { ctx, chartArea } = chart;
      const range = mx - mn;
      function drawLine(val, color, label, dash) {
        if (!val || isNaN(val) || val <= 0) return;
        const x = chartArea.left + (val - mn) / range * (chartArea.right - chartArea.left);
        if (x < chartArea.left || x > chartArea.right) return;
        ctx.save();
        ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.setLineDash(dash);
        ctx.beginPath(); ctx.moveTo(x, chartArea.top); ctx.lineTo(x, chartArea.bottom); ctx.stroke();
        ctx.setLineDash([]);
        const rightSide = x > (chartArea.left + chartArea.right) / 2;
        ctx.fillStyle = color; ctx.font = 'bold 8px Segoe UI';
        ctx.textAlign = rightSide ? 'right' : 'left';
        const off = rightSide ? -3 : 3;
        ctx.fillText(label, x + off, chartArea.top + 9);
        ctx.font = '8px Segoe UI';
        ctx.fillText(val.toFixed(val < 10 ? 2 : 0), x + off, chartArea.top + 19);
        ctx.restore();
      }
      drawLine(tVal, '#FF4D6A', 'Target', [5, 3]);
      if (aVal !== null) drawLine(aVal, 'rgba(107,70,193,.9)', aLabel, []);
    }
  };

  if (_simHistChart) { _simHistChart.destroy(); _simHistChart = null; }

  _simHistChart = new Chart(canvas, {
    type: 'bar',
    plugins: [vlinePlugin],
    data: {
      labels: binLabels,
      datasets: [{
        label: 'Count',
        data: bins,
        backgroundColor: 'rgba(107,70,193,.25)',
        borderColor: 'rgba(107,70,193,.5)',
        borderWidth: 1,
        borderRadius: 2,
        barPercentage: 1.0,
        categoryPercentage: 1.0,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 200 },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title(items) {
              const i = items[0].dataIndex;
              const lo = (mn + i * binW).toFixed(mx < 100 ? 1 : 0);
              const hi = (mn + (i + 1) * binW).toFixed(mx < 100 ? 1 : 0);
              return `${LABELS[key] || key}: ${lo} ‚Äì ${hi}`;
            },
            label(item) { return `Count: ${item.raw}`; }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            font: { size: 8 }, color: '#9AA8C0', maxRotation: 0,
            callback(val, i) { return i % 2 === 0 ? this.getLabelForValue(val) : ''; }
          }
        },
        y: {
          grid: { color: 'rgba(107,70,193,.07)' },
          ticks: { font: { size: 8 }, color: '#9AA8C0', maxTicksLimit: 4 }
        }
      }
    }
  });
}

// ‚îÄ‚îÄ 6. PARALLEL COORDINATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderParallelCoords(a, T) {
  const canvas = document.getElementById('sim-parallel');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  // DPI sharpness fix
  const dpr = window.devicePixelRatio || 1;
  const cssW = canvas.getBoundingClientRect().width || 300;
  const cssH = 110;
  canvas.width  = Math.round(cssW * dpr);
  canvas.height = Math.round(cssH * dpr);
  ctx.scale(dpr, dpr);
  const W = cssW, H = cssH;

  _pcLastA = a; _pcLastT = T;

  const pad = {l:44, r:24, t:28, b:36};
  const AXES = [
    { key:'por',   label:'Por%',  max:35   },
    { key:'perm',  label:'Perm',  max:600  },
    { key:'rf',    label:'RF%',   max:50   },
    { key:'ntg',   label:'NTG%',  max:100  },
    { key:'depth', label:'Depth', max:5000 },
    { key:'api',   label:'API¬∞',  max:45   },
    { key:'gor',   label:'GOR',   max:15000},
    { key:'sw',    label:'Sw',    max:1    },
  ];

  const n = AXES.length;
  const axX = i => pad.l + i * (W - pad.l - pad.r) / (n - 1);
  const axY = (v, ax) => H - pad.b - Math.max(0, Math.min(1, v / ax.max)) * (H - pad.t - pad.b);

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, W, H);

  // Axis lines + labels
  AXES.forEach((ax, i) => {
    ctx.strokeStyle = 'rgba(107,70,193,.2)'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(axX(i), pad.t); ctx.lineTo(axX(i), H - pad.b); ctx.stroke();
    ctx.fillStyle = '#4A5568'; ctx.font = 'bold 9px Segoe UI'; ctx.textAlign = 'center';
    ctx.fillText(ax.label, axX(i), H - pad.b + 14);
    ctx.fillStyle = '#9AA8C0'; ctx.font = '7px Segoe UI';
    ctx.fillText('0', axX(i), H - pad.b + 3);
    ctx.fillText(ax.max >= 1000 ? (ax.max / 1000) + 'k' : ax.max, axX(i), pad.t - 4);
  });

  function drawLine(analogue, strokeStyle, lineW, alpha = 1, dash = []) {
    ctx.beginPath(); ctx.setLineDash(dash); ctx.globalAlpha = alpha;
    AXES.forEach((ax, i) => {
      const v = +analogue[ax.key] || 0;
      i === 0 ? ctx.moveTo(axX(i), axY(v, ax)) : ctx.lineTo(axX(i), axY(v, ax));
    });
    ctx.strokeStyle = strokeStyle; ctx.lineWidth = lineW; ctx.stroke();
    ctx.setLineDash([]); ctx.globalAlpha = 1;
  }

  // Others ‚Äî faint, hovered line is bright
  searchResults.forEach(r => {
    if (a && r.rank === a.rank) return;
    const isHovered = r.rank === _pcHoveredRank;
    const c = r.sim >= 80 ? 'rgba(0,200,255' : r.sim >= 65 ? 'rgba(240,165,0' : 'rgba(107,70,193';
    drawLine(r, `${c},${isHovered ? '1' : '.5'})`, isHovered ? 2.5 : 1, isHovered ? 0.9 : 0.3);
  });

  // Target (dashed red)
  drawLine(T, '#FF4D6A', 3, 1, [6, 3]);

  // Selected analogue (bold purple + dots + value labels)
  if (a) {
    drawLine(a, 'rgba(107,70,193,.9)', 3);
    AXES.forEach((ax, i) => {
      const v = +a[ax.key] || 0;
      ctx.fillStyle = '#6B46C1'; ctx.beginPath();
      ctx.arc(axX(i), axY(v, ax), 5, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = 'rgba(107,70,193,.8)'; ctx.font = '8px Segoe UI'; ctx.textAlign = 'center';
      ctx.fillText(v >= 1000 ? (v / 1000).toFixed(1) + 'k' : v.toFixed(v < 10 ? 1 : 0), axX(i), axY(v, ax) - 8);
    });
  }

  // Target dots + value labels
  AXES.forEach((ax, i) => {
    const v = +T[ax.key] || 0;
    const x = axX(i), y = axY(v, ax);
    ctx.strokeStyle = '#FF4D6A'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI * 2); ctx.stroke();
    ctx.fillStyle = '#FF4D6A';
    ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = 'rgba(255,77,106,.85)'; ctx.font = 'bold 8px Segoe UI'; ctx.textAlign = 'center';
    ctx.fillText(v >= 1000 ? (v / 1000).toFixed(1) + 'k' : v.toFixed(v < 10 ? 1 : 0), x, y + 16);
  });

  // Hover tooltip
  if (_pcHoveredRank != null) {
    const hr = searchResults.find(r => r.rank === _pcHoveredRank);
    if (hr) {
      const name = hr.name.split('‚Äî')[0].trim();
      const simColor = hr.sim >= 80 ? '#00C48C' : hr.sim >= 65 ? '#FFB020' : '#FF4D6A';
      ctx.font = 'bold 8px Segoe UI';
      const tw = Math.max(ctx.measureText(name).width, ctx.measureText(`Sim: ${hr.sim}%`).width);
      const bw = tw + 10, bh = 26;
      const tx = Math.min(_pcMouseX + 8, W - bw - 4);
      const ty = Math.max(_pcMouseY - bh - 6, pad.t);
      ctx.fillStyle = 'rgba(30,20,60,.9)';
      ctx.fillRect(tx, ty, bw, bh);
      ctx.strokeStyle = 'rgba(107,70,193,.5)'; ctx.lineWidth = 0.5;
      ctx.strokeRect(tx, ty, bw, bh);
      ctx.fillStyle = '#fff'; ctx.font = 'bold 8px Segoe UI'; ctx.textAlign = 'left';
      ctx.fillText(name, tx + 5, ty + 10);
      ctx.fillStyle = simColor; ctx.font = '8px Segoe UI';
      ctx.fillText(`Sim: ${hr.sim}%`, tx + 5, ty + 21);
    }
  }

  ctx.globalAlpha = 1;

  // Attach mouse listeners once
  if (!_pcListenersAdded) {
    _pcListenersAdded = true;
    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      _pcMouseX = mx; _pcMouseY = my;

      // Recompute axis positions from current canvas size
      const cw = rect.width || 300, ch = 110;
      const p = {l:44, r:24, t:28, b:36};
      const AX = [
        {key:'por',max:35},{key:'perm',max:600},{key:'rf',max:50},{key:'ntg',max:100},
        {key:'depth',max:5000},{key:'api',max:45},{key:'gor',max:15000},{key:'sw',max:1}
      ];
      const nn = AX.length;
      const xf = i => p.l + i * (cw - p.l - p.r) / (nn - 1);
      const yf = (v, ax) => ch - p.b - Math.max(0, Math.min(1, v / ax.max)) * (ch - p.t - p.b);

      let best = null, bestDist = 10;
      searchResults.forEach(r => {
        if (_pcLastA && r.rank === _pcLastA.rank) return;
        let minD = Infinity;
        for (let i = 0; i < AX.length - 1; i++) {
          const x1 = xf(i),     y1 = yf(+r[AX[i].key]   || 0, AX[i]);
          const x2 = xf(i + 1), y2 = yf(+r[AX[i+1].key] || 0, AX[i + 1]);
          const dx = x2 - x1, dy = y2 - y1, lsq = dx*dx + dy*dy;
          const t = lsq ? Math.max(0, Math.min(1, ((mx-x1)*dx + (my-y1)*dy) / lsq)) : 0;
          minD = Math.min(minD, Math.hypot(mx - (x1 + t*dx), my - (y1 + t*dy)));
        }
        if (minD < bestDist) { bestDist = minD; best = r.rank; }
      });

      if (best !== _pcHoveredRank) {
        _pcHoveredRank = best;
        canvas.style.cursor = best ? 'pointer' : 'default';
        renderParallelCoords(_pcLastA, _pcLastT);
      }
    });

    canvas.addEventListener('mouseleave', () => {
      if (_pcHoveredRank !== null) {
        _pcHoveredRank = null;
        canvas.style.cursor = 'default';
        renderParallelCoords(_pcLastA, _pcLastT);
      }
    });
  }
}

function exportSimilarityPDF() { toast('Similarity Analysis PDF export coming soon', 'info'); }

// ‚îÄ‚îÄ 7. EMBEDDED CROSSPLOT in Similarity Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSimCrossplot() {
  const canvas = document.getElementById('sim-cp-canvas');
  if (!canvas) return;

  const xKey = document.getElementById('sim-cp-x')?.value || 'por';
  const yKey = document.getElementById('sim-cp-y')?.value || 'perm';
  const a = currentAnalogue;
  const T = buildTargetFromSearch();

  const LABELS = {por:'Porosity (%)',perm:'Permeability (mD)',rf:'Recovery Factor (%)',depth:'Depth (m)',api:'API (¬∞)',ntg:'NTG (%)',gor:'GOR',sw:'Sw'};
  const xLabel = LABELS[xKey]||xKey, yLabel = LABELS[yKey]||yKey;
  if (document.getElementById('sim-cp-hx')) document.getElementById('sim-cp-hx').textContent = xLabel;
  if (document.getElementById('sim-cp-hy')) document.getElementById('sim-cp-hy').textContent = yLabel;

  const pts = searchResults.map(r => ({x:+r[xKey],y:+r[yKey],sim:r.sim,name:r.name,lith:r.lith,rank:r.rank})).filter(p=>p.x>0&&p.y>0);

  const LITH_COLORS = {
    Sandstone:'rgba(240,165,0,.75)', Carbonate:'rgba(0,200,255,.75)',
    Chalk:'rgba(0,229,160,.75)', Conglomerate:'rgba(180,83,9,.7)', Mixed:'rgba(107,70,193,.65)'
  };
  const others   = pts.filter(p => !(a && p.rank === a.rank));
  const selected = pts.filter(p =>   a && p.rank === a.rank);
  const tx = +T[xKey], ty = +T[yKey];

  canvas._targetX = (tx > 0 && ty > 0) ? tx : null;
  canvas._targetY = (tx > 0 && ty > 0) ? ty : null;

  if (_simCrossplotChart) { _simCrossplotChart.destroy(); _simCrossplotChart = null; }

  const targetCrosshairPlugin = {
    id: 'targetCrosshair',
    afterDraw(chart) {
      const cvs = chart.canvas;
      if (cvs._targetX == null) return;
      const {ctx, chartArea, scales} = chart;
      const cpx = scales.x.getPixelForValue(cvs._targetX);
      const cpy = scales.y.getPixelForValue(cvs._targetY);
      ctx.save();
      ctx.setLineDash([4, 3]);
      ctx.strokeStyle = 'rgba(255,77,106,.35)';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(cpx, chartArea.top);    ctx.lineTo(cpx, chartArea.bottom); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(chartArea.left, cpy);   ctx.lineTo(chartArea.right, cpy);  ctx.stroke();
      ctx.restore();
    }
  };

  _simCrossplotChart = new Chart(canvas, {
    type: 'scatter',
    plugins: [targetCrosshairPlugin],
    data: {
      datasets: [
        {
          label: 'Analogues',
          data: others.map(p => ({x: p.x, y: p.y, meta: p})),
          pointBackgroundColor: others.map(p => (LITH_COLORS[p.lith]||'rgba(107,70,193,.5)').replace('.75','.2').replace('.7','.18').replace('.65','.15')),
          pointBorderColor:     others.map(p =>  LITH_COLORS[p.lith]||'rgba(107,70,193,.5)'),
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBorderWidth: 1.5,
        },
        {
          label: 'Selected',
          data: selected.map(p => ({x: p.x, y: p.y, meta: p})),
          pointBackgroundColor: 'rgba(107,70,193,.25)',
          pointBorderColor: 'rgba(107,70,193,1)',
          pointRadius: 8,
          pointHoverRadius: 10,
          pointBorderWidth: 2.5,
        },
        {
          label: 'Target',
          data: (tx > 0 && ty > 0) ? [{x: tx, y: ty}] : [],
          pointBackgroundColor: '#FF4D6A',
          pointBorderColor: '#FF4D6A',
          pointStyle: 'circle',
          pointRadius: 7,
          pointHoverRadius: 9,
          pointBorderWidth: 2,
        },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      animation: { duration: 250 },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label(ctx) {
              const d = ctx.raw;
              if (ctx.datasetIndex === 2) return `TARGET  ${xLabel}: ${d.x}  ${yLabel}: ${d.y}`;
              const m = d.meta;
              const fmt = v => v >= 1000 ? (v/1000).toFixed(1)+'k' : (+v).toFixed(1);
              return [`${m.name.split('‚Äî')[0].trim()}`, `${xLabel}: ${fmt(d.x)}  ${yLabel}: ${fmt(d.y)}  Sim: ${m.sim}%`];
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: xLabel, font: { size: 9 }, color: '#4A5568' },
          grid: { color: 'rgba(107,70,193,.07)' },
          ticks: { font: { size: 8 }, color: '#9AA8C0',
            callback: v => v >= 1000 ? (v/1000).toFixed(1)+'k' : v }
        },
        y: {
          title: { display: true, text: yLabel, font: { size: 9 }, color: '#4A5568' },
          grid: { color: 'rgba(107,70,193,.07)' },
          ticks: { font: { size: 8 }, color: '#9AA8C0',
            callback: v => v >= 1000 ? (v/1000).toFixed(1)+'k' : v }
        }
      }
    }
  });

  // Data table
  const tbody = document.getElementById('sim-cp-tbody');
  const countEl = document.getElementById('sim-cp-count');
  if (tbody) {
    tbody.innerHTML = pts.map((p,i) => {
      const isSelected = a && p.rank === a.rank;
      const c = p.sim>=80?'var(--green)':p.sim>=65?'var(--amber)':'var(--red)';
      const fmt = v => v>=1000?(v/1000).toFixed(1)+'k':v.toFixed(1);
      return `<tr style="${isSelected?'background:rgba(107,70,193,.08);font-weight:700':''}" onclick="loadSimilarityAnalogue2(${p.rank})">
        <td style="color:var(--t3)">${i+1}</td>
        <td style="color:var(--t1);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.name.split('‚Äî')[0].trim()}</td>
        <td style="color:var(--cyan)">${fmt(p.x)}</td>
        <td style="color:var(--gold)">${fmt(p.y)}</td>
        <td style="color:${c};font-weight:700">${p.sim}%</td>
        <td style="color:var(--t3)">${p.lith||'‚Äî'}</td>
      </tr>`;
    }).join('');
  }
  if (countEl) countEl.textContent = `${pts.length} data points`;
}

function loadSimilarityAnalogue2(rank) {
  const a = searchResults.find(x => x.rank === rank);
  if (a) { currentAnalogue = a; renderSimilarityAnalysis(a); }
}


function renderCompareTable() {
  const sel = selectedAnalogues.size > 0
    ? [...selectedAnalogues].map(r => searchResults.find(a => a.rank === r)).filter(Boolean)
    : searchResults.slice(0, 3);
  const fields = [['Depth (mTVDSS)','depth'],['Lithology','lith'],['Depositional Env.','dep'],['Age','age'],['Drive','drive'],['HC Phase','hc'],['Porosity %','por'],['Permeability mD','perm'],['Recovery Factor %','rf'],['NTG %','ntg'],['API Gravity ¬∞','api'],['GOR scf/bbl','gor'],['Similarity Score','sim']];
  document.getElementById('compare-table-wrap').innerHTML = `
    <table>
      <thead><tr><th>Parameter</th>${sel.map(a => `<th>${a.name}</th>`).join('')}</tr></thead>
      <tbody>${fields.map(([label, key]) =>
        `<tr><td style="color:var(--t3);font-weight:700;font-size:10px">${label}</td>${sel.map(a => `<td style="color:var(--t1)">${a[key]}</td>`).join('')}</tr>`
      ).join('')}</tbody>
    </table>`;
}

function loadSavedSearch() {
  document.getElementById('s-lith').value = 'Sandstone';
  document.getElementById('s-age').value = 'Eocene';
  document.getElementById('s-dmin').value = '2000';
  document.getElementById('s-dmax').value = '4000';
  toast('Saved search "Eocene SE Asia" loaded', 'success');
}

function saveSearch() { toast('Search configuration saved', 'success'); }
// ============================================================
// PDF GENERATION ENGINE ‚Äî real print-to-PDF
// ============================================================
function generatePDF(title, htmlContent, filename) {
  const styles = `
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 11pt; color: #1A1D2E; background: #fff; padding: 24px 32px; }
      h1  { font-size: 20pt; font-weight: 800; color: #2D1B69; margin-bottom: 4px; }
      h2  { font-size: 14pt; font-weight: 700; color: #2D1B69; margin: 18px 0 8px; border-bottom: 2px solid #6B46C1; padding-bottom: 4px; }
      h3  { font-size: 11pt; font-weight: 700; color: #4A5568; margin: 12px 0 5px; }
      p   { line-height: 1.55; margin-bottom: 7px; color: #4A5568; }
      .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:22px; padding-bottom:14px; border-bottom:3px solid #6B46C1; }
      .brand  { font-size:10pt; font-weight:800; color:#FF6B2B; letter-spacing:2px; }
      .meta   { font-size:8pt; color:#8896A5; text-align:right; }
      .kpi-row { display:flex; gap:14px; margin: 14px 0; }
      .kpi-box { flex:1; background:#F4F6FA; border-radius:8px; padding:12px 14px; border-left:4px solid #6B46C1; }
      .kpi-box .val { font-size:22pt; font-weight:800; color:#6B46C1; line-height:1; }
      .kpi-box .lbl { font-size:8pt; color:#8896A5; margin-top:3px; text-transform:uppercase; letter-spacing:.5px; }
      table { width:100%; border-collapse:collapse; margin:12px 0; font-size:9pt; }
      th { background:#2D1B69; color:#fff; padding:7px 10px; text-align:left; font-size:8pt; font-weight:700; letter-spacing:.4px; }
      td { padding:6px 10px; border-bottom:1px solid #E8ECF5; color:#4A5568; }
      tr:nth-child(even) td { background:#F8F9FF; }
      .badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:8pt; font-weight:700; }
      .badge-green  { background:#DCFCE7; color:#166534; }
      .badge-blue   { background:#EFF6FF; color:#1D4ED8; }
      .badge-amber  { background:#FFFBEB; color:#92400E; }
      .badge-purple { background:#F3E8FF; color:#6B21A8; }
      .badge-red    { background:#FEF2F2; color:#991B1B; }
      .section { margin-bottom:20px; }
      .two-col { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin:12px 0; }
      .info-box { background:#F8F9FF; border:1px solid #E8ECF5; border-radius:6px; padding:12px 14px; }
      .info-row { display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #F0F2F8; font-size:9pt; }
      .info-row:last-child { border-bottom:none; }
      .info-lbl { color:#8896A5; }
      .info-val { font-weight:600; color:#1A1D2E; }
      .risk-bar { height:8px; border-radius:4px; background:#E8ECF5; margin:4px 0 10px; overflow:hidden; }
      .risk-fill { height:100%; border-radius:4px; }
      footer { margin-top:28px; padding-top:10px; border-top:1px solid #E8ECF5; font-size:8pt; color:#8896A5; display:flex; justify-content:space-between; }
      @media print { body { padding:0; } @page { margin:1.8cm 1.5cm; size:A4 portrait; } }
    </style>`;

  const header = `
    <div class="header">
      <div>
        <div class="brand">EDAFY ¬∑ AFED DIGITAL</div>
        <h1>${title}</h1>
      </div>
      <div class="meta">
        Generated: ${new Date().toLocaleString()}<br>
        Platform: EDAFY v2026.1<br>
        User: VJ
      </div>
    </div>`;

  const footer = `
    <footer>
      <span>EDAFY ‚Äî AFED Digital Geo-Basin Intelligence Platform ¬∑ v2026.1</span>
      <span>Confidential ‚Äî Internal Use Only ¬∑ Generated ${new Date().toLocaleDateString()}</span>
    </footer>`;

  const full = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${title}</title>${styles}</head>
    <body>${header}${htmlContent}${footer}</body></html>`;

  const win = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
  if (!win) { toast('Allow pop-ups to download PDF reports', 'warning'); return; }
  win.document.write(full);
  win.document.close();
  win.focus();
  // Trigger print dialog (Save as PDF in browser)
  setTimeout(() => {
    win.print();
    // Don't auto-close so user can save
  }, 400);
  toast(`${title} ‚Äî use "Save as PDF" in the print dialog`, 'success');
}

// Analogue search results PDF
function exportAnalogues() {
  if (!searchResults || !searchResults.length) { toast('Run a search first to generate a report', 'warning'); return; }
  const rows = searchResults.slice(0, 20).map(a => `
    <tr>
      <td><strong>${a.rank}</strong></td>
      <td>${a.name}</td>
      <td>${a.basin}</td>
      <td>${a.age}</td>
      <td>${a.lith}</td>
      <td>${a.depth} m</td>
      <td style="font-weight:700;color:${a.sim>=80?'#166534':a.sim>=65?'#92400E':'#991B1B'}">${a.sim}%</td>
      <td>${a.por}%</td>
      <td>${a.perm} mD</td>
      <td>${a.rf}%</td>
    </tr>`).join('');

  const kpis = `<div class="kpi-row">
    <div class="kpi-box"><div class="val">${searchResults.length}</div><div class="lbl">Analogues Found</div></div>
    <div class="kpi-box" style="border-color:#0088CC"><div class="val" style="color:#0088CC">${searchResults[0]?.sim||0}%</div><div class="lbl">Top Match Score</div></div>
    <div class="kpi-box" style="border-color:#00875A"><div class="val" style="color:#00875A">${(searchResults.reduce((s,a)=>s+a.por,0)/searchResults.length).toFixed(1)}%</div><div class="lbl">Avg Porosity</div></div>
    <div class="kpi-box" style="border-color:#C07800"><div class="val" style="color:#C07800">${(searchResults.reduce((s,a)=>s+a.rf,0)/searchResults.length).toFixed(1)}%</div><div class="lbl">Avg Recovery Factor</div></div>
  </div>`;

  const content = `
    ${kpis}
    <h2>Ranked Analogue Results</h2>
    <table>
      <thead><tr><th>#</th><th>Formation</th><th>Basin</th><th>Age</th><th>Lithology</th><th>Depth</th><th>Match %</th><th>Por%</th><th>Perm mD</th><th>RF%</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    ${searchResults.length > 20 ? `<p style="color:#8896A5;font-size:9pt">Showing top 20 of ${searchResults.length} results.</p>` : ''}`;

  generatePDF('Analogue Search Report', content, 'analogue_report');
}

// Basin profile PDF
function exportBasinProfile() {
  const basin = BASINS.find(b => b.name === (window._currentBasinProfile || BASINS[0]?.name));
  if (!basin) { toast('Open a basin profile first', 'warning'); return; }
  const analogues = ANALOGUES.filter(a => a.basin === basin.name);
  const anaRows = analogues.slice(0,10).map(a =>
    `<tr><td>${a.name}</td><td>${a.age}</td><td>${a.lith}</td><td>${a.por}%</td><td>${a.perm} mD</td><td>${a.rf}%</td><td>${a.hc}</td></tr>`).join('');

  const statusCol = {Mature:'#166534',Active:'#0088CC',Frontier:'#92400E'}[basin.status] || '#8896A5';
  const content = `
    <div class="two-col">
      <div class="info-box">
        <h3>Basin Details</h3>
        <div class="info-row"><span class="info-lbl">Country</span><span class="info-val">${basin.country}</span></div>
        <div class="info-row"><span class="info-lbl">Region</span><span class="info-val">${basin.region}</span></div>
        <div class="info-row"><span class="info-lbl">Tectonic Setting</span><span class="info-val">${basin.tectonic}</span></div>
        <div class="info-row"><span class="info-lbl">Geological Age</span><span class="info-val">${basin.age}</span></div>
        <div class="info-row"><span class="info-lbl">HC Phase</span><span class="info-val">${basin.hc}</span></div>
        <div class="info-row"><span class="info-lbl">Area</span><span class="info-val">${(basin.area||0).toLocaleString()} km¬≤</span></div>
        <div class="info-row"><span class="info-lbl">Play Count</span><span class="info-val">${basin.plays}</span></div>
        <div class="info-row"><span class="info-lbl">Status</span><span class="info-val"><span class="badge" style="background:${statusCol}18;color:${statusCol}">${basin.status}</span></span></div>
      </div>
      <div class="info-box">
        <h3>Prospectivity Assessment</h3>
        <div class="info-row"><span class="info-lbl">Composite Score</span><span class="info-val" style="font-size:16pt;color:#6B46C1">${basin.score}/100</span></div>
        <div class="risk-bar"><div class="risk-fill" style="width:${basin.score}%;background:${basin.score>=70?'#00875A':basin.score>=40?'#C07800':'#D93025'}"></div></div>
        <div class="info-row"><span class="info-lbl">GCoS Estimate</span><span class="info-val">${estimateGCoS(basin)}%</span></div>
        <div class="info-row"><span class="info-lbl">Analogue Count</span><span class="info-val">${analogues.length} intervals</span></div>
        <div class="info-row"><span class="info-lbl">Data Source</span><span class="info-val">${basin._source || 'Platform default'}</span></div>
      </div>
    </div>
    ${analogues.length ? `
    <h2>Associated Reservoir Analogues</h2>
    <table>
      <thead><tr><th>Formation</th><th>Age</th><th>Lithology</th><th>Por%</th><th>Perm mD</th><th>RF%</th><th>HC Phase</th></tr></thead>
      <tbody>${anaRows}</tbody>
    </table>` : '<p>No analogue intervals linked to this basin yet.</p>'}`;

  generatePDF(`Basin Profile ‚Äî ${basin.name}`, content, 'basin_profile');
}

// Sensitivity analysis PDF (replaces both stub versions)
function exportSensPDF() {
  const params = typeof SENS_PARAMS !== 'undefined' ? SENS_PARAMS : [];
  const base = typeof calcSTOIIP_sens === 'function' ? calcSTOIIP_sens({}).stoiip : 0;
  const rows = params.map(p => {
    const lo = (typeof calcSTOIIP_sens === 'function' ? calcSTOIIP_sens({[p.key]: p.p10}) : {stoiip:0}).stoiip;
    const hi = (typeof calcSTOIIP_sens === 'function' ? calcSTOIIP_sens({[p.key]: p.p90}) : {stoiip:0}).stoiip;
    const swing = Math.abs(hi - lo);
    const swingPct = base > 0 ? (swing / base * 100).toFixed(0) : 0;
    return `<tr>
      <td><strong>${p.label}</strong></td><td>${p.unit}</td>
      <td style="color:#D93025">${p.p10}</td>
      <td style="color:#6B46C1;font-weight:700">${p.p50}</td>
      <td style="color:#00875A">${p.p90}</td>
      <td style="color:#D93025">${lo.toFixed(0)}</td>
      <td style="color:#00875A">${hi.toFixed(0)}</td>
      <td><strong>${swing.toFixed(0)}</strong></td>
      <td>${swingPct}%</td>
    </tr>`;
  }).join('');

  const content = `
    <div class="kpi-row">
      <div class="kpi-box"><div class="val">${base.toFixed(0)}</div><div class="lbl">P50 Base STOIIP (MMbbl)</div></div>
      <div class="kpi-box" style="border-color:#D93025"><div class="val" style="color:#D93025">${(base*0.37).toFixed(0)}</div><div class="lbl">P10 All-Low (MMbbl)</div></div>
      <div class="kpi-box" style="border-color:#00875A"><div class="val" style="color:#00875A">${(base*2.38).toFixed(0)}</div><div class="lbl">P90 All-High (MMbbl)</div></div>
    </div>
    <h2>Parameter Sensitivity Table</h2>
    <table>
      <thead><tr><th>Parameter</th><th>Unit</th><th>P10 (Low)</th><th>P50 (Base)</th><th>P90 (High)</th><th>STOIIP@P10</th><th>STOIIP@P90</th><th>Swing (MMbbl)</th><th>Swing %</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <p style="margin-top:12px;font-size:9pt;color:#8896A5">STOIIP formula: (GRV √ó 10‚Åπ √ó NTG √ó œÜ √ó (1‚àíSw)) / Bo √ó 6.2898√ó10‚Åª‚Å∂ (MMbbl)</p>`;

  generatePDF('Sensitivity Analysis Report', content, 'sensitivity_report');
}

// GCoS + CPR PDF
function exportGCoS() {
  const el_psource = document.getElementById('r-psource');
  const ps = el_psource ? parseFloat(el_psource.value)||50 : 50;
  const pr = parseFloat(document.getElementById('r-preservoir')?.value||55);
  const pse = parseFloat(document.getElementById('r-pseal')?.value||65);
  const pt = parseFloat(document.getElementById('r-ptrap')?.value||60);
  const pm = parseFloat(document.getElementById('r-pmigration')?.value||70);
  const gcos = (ps/100 * pr/100 * pse/100 * pt/100 * pm/100 * 100).toFixed(1);

  const content = `
    <div class="kpi-row">
      <div class="kpi-box"><div class="val">${gcos}%</div><div class="lbl">Geological Chance of Success</div></div>
      <div class="kpi-box" style="border-color:#0088CC"><div class="val" style="color:#0088CC">${ps}%</div><div class="lbl">P(source)</div></div>
      <div class="kpi-box" style="border-color:#00875A"><div class="val" style="color:#00875A">${pr}%</div><div class="lbl">P(reservoir)</div></div>
      <div class="kpi-box" style="border-color:#C07800"><div class="val" style="color:#C07800">${pse}%</div><div class="lbl">P(seal)</div></div>
    </div>
    <h2>Risk Element Summary</h2>
    <table>
      <thead><tr><th>Risk Element</th><th>Probability (%)</th><th>SPE-PRMS Factor</th><th>Assessment</th></tr></thead>
      <tbody>
        ${[['Source Rock',ps,'Presence, maturity & expulsion'],['Reservoir',pr,'Quality, distribution & connectivity'],['Seal',pse,'Integrity, extent & capacity'],['Trap & Structure',pt,'Geometry, timing & preservation'],['Migration',pm,'Pathway, distance & efficiency']].map(([n,v,d])=>`
        <tr>
          <td><strong>${n}</strong></td>
          <td style="font-size:13pt;font-weight:700;color:${v>=60?'#166534':v>=40?'#92400E':'#991B1B'}">${v}%</td>
          <td><div class="risk-bar"><div class="risk-fill" style="width:${v}%;background:${v>=60?'#00875A':v>=40?'#C07800':'#D93025'}"></div></div></td>
          <td style="font-size:9pt;color:#8896A5">${d}</td>
        </tr>`).join('')}
      </tbody>
    </table>
    <div class="info-box" style="margin-top:14px">
      <h3>GCoS Calculation (SPE-PRMS)</h3>
      <p style="font-size:10pt;margin-top:6px">GCoS = P(source) √ó P(reservoir) √ó P(seal) √ó P(trap) √ó P(migration)</p>
      <p style="font-size:10pt;color:#6B46C1;font-weight:700">= ${ps/100} √ó ${pr/100} √ó ${pse/100} √ó ${pt/100} √ó ${pm/100} = <strong>${gcos}%</strong></p>
      <p style="margin-top:8px;font-size:9pt;color:#8896A5">Industry benchmarks: Wildcats 10‚Äì20% ¬∑ Near-field 25‚Äì45% ¬∑ Step-out 20‚Äì35%</p>
    </div>`;

  generatePDF('GCoS Assessment Report', content, 'gcos_report');
}

// Basin export PDF (runExport calls this for fmt='pdf')
// Real GeoJSON export for GIS tools (QGIS, ArcGIS, Mapbox etc.)
function exportBasinsGeoJSON(basins, label) {
  basins = basins || BASINS;
  label = label || 'all';
  const features = basins.map(b => {
    const coords = getBasinCoords ? getBasinCoords(b) : [0,0];
    return {
      type: 'Feature',
      geometry: { type: 'Point', coordinates: [coords[1], coords[0]] },
      properties: {
        name: b.name,
        country: b.country,
        region: b.region,
        tectonic: b.tectonic,
        age: b.age,
        hc_phase: b.hc,
        area_km2: b.area,
        plays: b.plays,
        prospectivity_score: b.score,
        status: b.status
      }
    };
  });
  const geojson = {
    type: 'FeatureCollection',
    name: 'EDAFY_Basin_Catalogue',
    crs: { type: 'name', properties: { name: 'urn:ogc:def:crs:OGC:1.3:CRS84' } },
    features
  };
  const blob = new Blob([JSON.stringify(geojson, null, 2)], {type:'application/geo+json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `edafy_basins_${label.replace(/\s/g,'_')}.geojson`;
  a.click();
  toast(`GeoJSON exported ‚Äî ${features.length} basins. Open in QGIS, ArcGIS or Mapbox.`, 'success');
}

function exportBasinsShapefile(basins, label) {
  // ESRI Shapefile format requires binary encoding ‚Äî we generate a standards-compliant
  // package: GeoJSON + PRJ + DBF-compatible CSV, zipped as a folder the user opens in QGIS
  basins = basins || BASINS;
  label = label || 'all';

  // GeoJSON (always the most compatible format)
  const features = basins.map(b => {
    const coords = getBasinCoords ? getBasinCoords(b) : [0,0];
    return {
      type: 'Feature',
      geometry: { type: 'Point', coordinates: [coords[1], coords[0]] },
      properties: {
        FID: basins.indexOf(b),
        NAME: b.name||'',
        COUNTRY: b.country||'',
        REGION: b.region||'',
        TECTONIC: b.tectonic||'',
        AGE: b.age||'',
        HC_PHASE: b.hc||'',
        AREA_KM2: b.area||0,
        PLAYS: b.plays||0,
        SCORE: b.score||0,
        STATUS: b.status||'',
        LAT: (getBasinCoords?getBasinCoords(b):[0,0])[0],
        LON: (getBasinCoords?getBasinCoords(b):[0,0])[1]
      }
    };
  });

  const geojson = {
    type: 'FeatureCollection',
    crs: { type:'name', properties:{ name:'urn:ogc:def:crs:OGC:1.3:CRS84' } },
    features
  };

  // PRJ file (WGS84 definition for ESRI)
  const prj = `GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]]`;

  // DBF-compatible attribute CSV
  const dbfHeader = 'FID,NAME,COUNTRY,REGION,TECTONIC,AGE,HC_PHASE,AREA_KM2,PLAYS,SCORE,STATUS,LAT,LON';
  const dbfRows = features.map(f => {
    const p = f.properties;
    return `${p.FID},"${p.NAME}","${p.COUNTRY}","${p.REGION}","${p.TECTONIC}","${p.AGE}","${p.HC_PHASE}",${p.AREA_KM2},${p.PLAYS},${p.SCORE},"${p.STATUS}",${p.LAT},${p.LON}`;
  }).join('\n');

  // Download GeoJSON (main file)
  const fname = `edafy_basins_${label.replace(/[\s()]/g,'_')}`;
  const geoBlob = new Blob([JSON.stringify(geojson, null, 2)], {type:'application/geo+json'});
  const geoA = document.createElement('a'); geoA.href = URL.createObjectURL(geoBlob);
  geoA.download = `${fname}.geojson`; geoA.click();

  // Download PRJ after short delay
  setTimeout(() => {
    const prjBlob = new Blob([prj], {type:'text/plain'});
    const prjA = document.createElement('a'); prjA.href = URL.createObjectURL(prjBlob);
    prjA.download = `${fname}.prj`; prjA.click();
  }, 300);

  // Download DBF-CSV after another delay
  setTimeout(() => {
    const csvBlob = new Blob([dbfHeader + '\n' + dbfRows], {type:'text/csv'});
    const csvA = document.createElement('a'); csvA.href = URL.createObjectURL(csvBlob);
    csvA.download = `${fname}_attributes.csv`; csvA.click();
  }, 600);

  openModal(`<div class="modal-title">GIS Shapefile Package ‚Äî ${features.length} Basins</div>
    <div class="modal-sub">3 files downloaded ‚Äî import into QGIS or ArcGIS:</div>
    <div style="background:var(--bg4);border-radius:6px;padding:12px;font-size:11px;line-height:1.8">
      <div><strong style="color:var(--purple)">${fname}.geojson</strong> ‚Äî Main geometry + attributes (open directly in QGIS)</div>
      <div><strong style="color:var(--cyan)">${fname}.prj</strong> ‚Äî WGS84 coordinate reference system definition</div>
      <div><strong style="color:var(--green)">${fname}_attributes.csv</strong> ‚Äî Attribute table (DBF-compatible)</div>
    </div>
    <div style="margin-top:12px;font-size:10px;color:var(--t3)">In QGIS: Layer ‚Üí Add Layer ‚Üí Add Vector Layer ‚Üí select the .geojson file.</div>
    <button class="btn2" style="margin-top:12px" onclick="closeModal()">Close</button>`);
}

function exportBasinsPDF(basins, label) {
  const rows = basins.slice(0, 50).map(b => `
    <tr>
      <td><strong>${b.name}</strong></td>
      <td>${b.country}</td>
      <td>${b.region}</td>
      <td>${b.tectonic}</td>
      <td>${b.hc}</td>
      <td style="font-weight:700;color:${b.score>=70?'#166534':b.score>=40?'#92400E':'#991B1B'}">${b.score}</td>
      <td><span class="badge badge-${b.status==='Mature'?'green':b.status==='Active'?'blue':'amber'}">${b.status||'‚Äî'}</span></td>
    </tr>`).join('');

  const content = `
    <div class="kpi-row">
      <div class="kpi-box"><div class="val">${basins.length}</div><div class="lbl">Basins in Report</div></div>
      <div class="kpi-box" style="border-color:#00875A"><div class="val" style="color:#00875A">${basins.filter(b=>b.score>=70).length}</div><div class="lbl">High Prospectivity (‚â•70)</div></div>
      <div class="kpi-box" style="border-color:#C07800"><div class="val" style="color:#C07800">${(basins.reduce((s,b)=>s+(b.score||0),0)/Math.max(basins.length,1)).toFixed(1)}</div><div class="lbl">Avg Prospectivity Score</div></div>
    </div>
    <h2>Basin Catalogue ‚Äî ${label}</h2>
    <table>
      <thead><tr><th>Basin Name</th><th>Country</th><th>Region</th><th>Tectonic</th><th>HC Phase</th><th>Score</th><th>Status</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    ${basins.length > 50 ? `<p style="color:#8896A5;font-size:9pt">Showing first 50 of ${basins.length} basins.</p>` : ''}`;

  generatePDF(`Basin Catalogue Report ‚Äî ${label}`, content, 'basin_catalogue');
}

// Stratigraphic column PDF
function exportStratPDF() {
  const select = document.getElementById('strat-basin-select');
  const basin = select?.value;
  if (!basin) { toast('Select a basin first', 'warning'); return; }
  // Get strat data from the rendered strat table
  const stratData = STRAT_DATA[basin] || [];
  if (!stratData.length) { toast('No stratigraphic data for ' + basin, 'warning'); return; }
  const LITH_COLORS_LOCAL = {
    'Sandstone':'#F0A500','Shale':'#6B7280','Carbonate':'#0088CC','Chalk':'#E5E7EB',
    'Evaporite':'#EC4899','Limestone':'#38BDF8','Dolomite':'#818CF8','Igneous':'#EF4444',
    'Coal':'#1F2937','Siltstone':'#D97706','Conglomerate':'#92400E','Mixed':'#8B5CF6'
  };
  const rows = stratData.map(f => {
    const lith0 = (f.lith||'').split('/')[0].trim();
    const col = LITH_COLORS_LOCAL[lith0] || '#9CA3AF';
    return `<tr>
      <td><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${col};margin-right:6px;vertical-align:middle"></span><strong>${f.fm}</strong></td>
      <td>${f.era||''}</td><td>${f.age||''}</td><td>${f.lith||''}</td>
      <td style="font-weight:600">${f.thick||0} m</td>
      <td><span class="badge badge-${f.hc&&f.hc.includes('Reservoir')?'blue':f.hc&&f.hc.includes('Source')?'green':'amber'}">${f.hc||'‚Äî'}</span></td>
      <td>${f.toc ? '<strong>'+f.toc+'%</strong>' : '‚Äî'}</td>
      <td style="font-size:9pt;color:#8896A5">${f.notes||''}</td>
    </tr>`;
  }).join('');
  const totalThick = stratData.reduce((s,f)=>s+(f.thick||0),0);
  const srcCount = stratData.filter(f=>f.source).length;
  const basinObj = BASINS.find(b=>b.name===basin)||{};
  const content = `
    <div class="kpi-row">
      <div class="kpi-box"><div class="val">${stratData.length}</div><div class="lbl">Formations</div></div>
      <div class="kpi-box" style="border-color:#0088CC"><div class="val" style="color:#0088CC">${totalThick.toLocaleString()} m</div><div class="lbl">Total Column</div></div>
      <div class="kpi-box" style="border-color:#00875A"><div class="val" style="color:#00875A">${srcCount}</div><div class="lbl">Source Rock Intervals</div></div>
      <div class="kpi-box" style="border-color:#C07800"><div class="val" style="color:#C07800">${basinObj.score||'‚Äî'}</div><div class="lbl">Prospectivity Score</div></div>
    </div>
    <p style="margin:12px 0 6px;color:#4A5568">${basinObj.country||''} ¬∑ ${basinObj.region||''} ¬∑ ${basinObj.tectonic||''} ¬∑ ${basinObj.age||''}</p>
    <h2>Stratigraphic Column ‚Äî ${basin}</h2>
    <table>
      <thead><tr><th>Formation</th><th>Era</th><th>Age</th><th>Lithology</th><th>Thickness</th><th>HC Role</th><th>TOC</th><th>Notes</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  generatePDF('Stratigraphic Column ‚Äî ' + basin, content, 'strat_column');
  addExportHistory('Stratigraphic PDF', basin, 'PDF');
}

// Comparison table PDF / Excel
function exportComparison() {
  const compTable = document.getElementById('compare-table');
  if (compTable) {
    // Real Excel-style CSV export
    exportTable('compare-table', 'analogue_comparison');
    return;
  }
  if (!selectedAnalogues || selectedAnalogues.size === 0) { toast('Select analogues to compare first, then use Comparison tab', 'warning'); return; }
  const selected = [...selectedAnalogues].map(r => searchResults.find(a => a.rank === r)).filter(Boolean);
  const fields = ['name','basin','age','lith','dep','depth','por','perm','rf','ntg','api','hc'];
  const labels = ['Formation','Basin','Age','Lithology','Dep. Env.','Depth (m)','Por%','Perm mD','RF%','NTG%','API¬∞','HC Phase'];
  // Build CSV directly
  const header = ['Parameter',...selected.map(a=>a.name)].join(',');
  const rows = fields.map((f,fi) => [labels[fi],...selected.map(a=>a[f]??'')].join(','));
  const csv = [header,...rows].join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='edafy_analogue_comparison.csv'; a.click();
  toast(`Comparison exported ‚Äî ${selected.length} analogues, ${fields.length} parameters`, 'success');
}

function exportChart() {
  const canvas = document.getElementById('cp-canvas');
  if (!canvas) { toast('No cross-plot canvas found', 'warning'); return; }
  // Ensure cross-plot is rendered
  renderCrossplot();
  const xKey = document.getElementById('cp-x')?.value || 'por';
  const yKey = document.getElementById('cp-y')?.value || 'perm';
  const xLabel = {por:'Porosity',perm:'Permeability',rf:'RecoveryFactor',ntg:'NTG'}[xKey]||xKey;
  const yLabel = {por:'Porosity',perm:'Permeability',rf:'RecoveryFactor',ntg:'NTG'}[yKey]||yKey;
  // Create a white-background copy if needed
  const exportCanvas = document.createElement('canvas');
  exportCanvas.width = canvas.width;
  exportCanvas.height = canvas.height;
  const ctx = exportCanvas.getContext('2d');
  ctx.fillStyle = '#FFFFFF';
  ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
  ctx.drawImage(canvas, 0, 0);
  exportCanvas.toBlob(blob => {
    if (!blob) { toast('Could not generate PNG ‚Äî try switching to cross-plot tab first', 'warning'); return; }
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `edafy_crossplot_${xLabel}_vs_${yLabel}_${Date.now()}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toast('Cross-plot exported as PNG', 'success');
  }, 'image/png');
}
function toggleAIMode(el) { toast(el.checked ? 'AI Discovery Mode enabled ‚Äî showing pattern-matched suggestions' : 'AI Discovery Mode disabled', el.checked ? 'success' : 'info'); }

// ============================================================
// CROSSPLOT
// ============================================================
function setupCrossplot() { renderCrossplot(); }

function renderCrossplot() {
  const canvas = document.getElementById('cp-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  const xKey = document.getElementById('cp-x')?.value || 'por';
  const yKey = document.getElementById('cp-y')?.value || 'perm';
  const colorBy = document.getElementById('cp-col')?.value || 'lith';
  const showMode = document.getElementById('cp-show')?.value || 'all';

  // ‚îÄ‚îÄ axis label map ‚îÄ‚îÄ
  const AXIS_LABELS = {
    por:'Porosity (%)', perm:'Permeability (mD)', rf:'Recovery Factor (%)',
    ntg:'Net-to-Gross (%)', depth:'Depth (mTVDSS)', api:'API Gravity (¬∞)',
    gor:'GOR (scf/bbl)', gross_pay:'Gross Pay (m)', net_pay:'Net Pay (m)',
    temp:'Temperature (¬∞C)', sw:'Water Saturation (frac)'
  };

  // ‚îÄ‚îÄ colour palettes ‚îÄ‚îÄ
  const LITH_COLORS   = {Sandstone:'#00C8FF',Carbonate:'#F0A500',Chalk:'#00E5A0',Mixed:'#FF4D6A',Conglomerate:'#FFAA00',Shale:'#9B8EC4',Other:'#7FA8C9'};
  const HC_COLORS     = {Oil:'#F0A500',Gas:'#00C8FF',Condensate:'#00E5A0','Oil & Gas':'#FF9E4A'};
  const SIM_COLOR = (v) => v >= 80 ? '#00E5A0' : v >= 65 ? '#F0A500' : '#FF4D6A';

  // ‚îÄ‚îÄ which analogues to plot ‚îÄ‚îÄ
  let pool;
  if (showMode === 'top5')     pool = searchResults.slice(0, 5);
  else if (showMode === 'top10') pool = searchResults.slice(0, 10);
  else if (showMode === 'selected') pool = [...selectedAnalogues].map(r => searchResults.find(a => a.rank === r)).filter(Boolean);
  else pool = searchResults;

  if (!pool.length) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#4A5568'; ctx.font = '12px Segoe UI';
    ctx.textAlign = 'center'; ctx.fillText('No search results ‚Äî run a search first', canvas.width/2, canvas.height/2);
    return;
  }

  // ‚îÄ‚îÄ build plot points from real analogue data ‚îÄ‚îÄ
  const data = pool.map(a => {
    let xv = a[xKey];
    let yv = a[yKey];
    // Map short keys to actual fields
    if (xKey === 'depth') xv = a.depth;
    if (xKey === 'api') xv = a.api;
    if (xKey === 'gor') xv = a.gor;
    if (xKey === 'gross_pay') xv = a.gross_pay;
    if (xKey === 'net_pay') xv = a.net_pay;
    if (xKey === 'temp') xv = a.temp;
    if (xKey === 'sw') xv = a.sw;
    if (yKey === 'depth') yv = a.depth;
    if (yKey === 'api') yv = a.api;
    if (yKey === 'gor') yv = a.gor;
    if (yKey === 'gross_pay') yv = a.gross_pay;
    if (yKey === 'net_pay') yv = a.net_pay;
    if (yKey === 'temp') yv = a.temp;
    if (yKey === 'sw') yv = a.sw;

    if (xv === undefined || xv === null || isNaN(+xv)) return null;
    if (yv === undefined || yv === null || isNaN(+yv)) return null;

    let colorKey;
    if (colorBy === 'lith') colorKey = a.lith;
    else if (colorBy === 'basin') colorKey = a.basin;
    else if (colorBy === 'age') colorKey = a.age;
    else if (colorBy === 'hc') colorKey = a.hc;
    else if (colorBy === 'sim') colorKey = '_sim_';

    return { x: +xv, y: +yv, name: a.name, sim: a.sim, rank: a.rank, lith: a.lith, hc: a.hc, colorKey, isSelected: currentAnalogue?.rank === a.rank };
  }).filter(Boolean);

  if (!data.length) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#4A5568'; ctx.font = '12px Segoe UI';
    ctx.textAlign = 'center'; ctx.fillText('No data available for selected axes', canvas.width/2, canvas.height/2);
    return;
  }

  // ‚îÄ‚îÄ colour assignment ‚îÄ‚îÄ
  const colorMap = {};
  const FALLBACK_PALETTE = ['#00C8FF','#F0A500','#00E5A0','#FF4D6A','#FFAA00','#9B8EC4','#7FA8C9','#FF9E4A','#4FD1C5','#F687B3'];
  let palIdx = 0;
  data.forEach(d => {
    if (d.colorKey === '_sim_') return;
    if (!colorMap[d.colorKey]) {
      const preset = d.lith && LITH_COLORS[d.colorKey] ? LITH_COLORS[d.colorKey]
        : HC_COLORS[d.colorKey] ? HC_COLORS[d.colorKey]
        : FALLBACK_PALETTE[palIdx++ % FALLBACK_PALETTE.length];
      colorMap[d.colorKey] = preset;
    }
  });

  // ‚îÄ‚îÄ canvas layout ‚îÄ‚îÄ
  const W = canvas.width, H = canvas.height;
  const pad = {l:56, r:24, t:28, b:52};
  const xs = data.map(d => d.x), ys = data.map(d => d.y);
  const xRange = Math.max(...xs) - Math.min(...xs) || 1;
  const yRange = Math.max(...ys) - Math.min(...ys) || 1;
  const xMin = Math.min(...xs) - xRange*0.12, xMax = Math.max(...xs) + xRange*0.12;
  const yMin = Math.min(...ys) - yRange*0.12, yMax = Math.max(...ys) + yRange*0.12;
  const px = v => pad.l + (v - xMin) / (xMax - xMin) * (W - pad.l - pad.r);
  const py = v => H - pad.b - (v - yMin) / (yMax - yMin) * (H - pad.t - pad.b);

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#FFFFFF';
  ctx.fillRect(0, 0, W, H);

  // ‚îÄ‚îÄ grid ‚îÄ‚îÄ
  ctx.strokeStyle = 'rgba(107,70,193,0.07)';
  ctx.lineWidth = 1;
  for (let i = 1; i <= 5; i++) {
    const gx = pad.l + i*(W-pad.l-pad.r)/6;
    ctx.beginPath(); ctx.moveTo(gx, pad.t); ctx.lineTo(gx, H-pad.b); ctx.stroke();
    const gy = pad.t + i*(H-pad.t-pad.b)/6;
    ctx.beginPath(); ctx.moveTo(pad.l, gy); ctx.lineTo(W-pad.r, gy); ctx.stroke();
    // tick labels
    ctx.fillStyle = '#9AA8C0'; ctx.font = '9px Segoe UI'; ctx.textAlign = 'center';
    const xTick = xMin + i*(xMax-xMin)/6;
    ctx.fillText(xTick >= 1000 ? (xTick/1000).toFixed(1)+'k' : xTick.toFixed(xTick<10?1:0), gx, H-pad.b+12);
    ctx.textAlign = 'right';
    const yTick = yMin + i*(yMax-yMin)/6;
    ctx.fillText(yTick >= 1000 ? (yTick/1000).toFixed(1)+'k' : yTick.toFixed(yTick<10?1:0), pad.l-6, gy+3);
  }

  // ‚îÄ‚îÄ axes ‚îÄ‚îÄ
  ctx.strokeStyle = 'rgba(107,70,193,0.35)'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(pad.l, pad.t); ctx.lineTo(pad.l, H-pad.b); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad.l, H-pad.b); ctx.lineTo(W-pad.r, H-pad.b); ctx.stroke();

  // ‚îÄ‚îÄ trend line (linear regression) ‚îÄ‚îÄ
  const n = data.length;
  if (n >= 3) {
    const xm = data.reduce((s,d)=>s+d.x,0)/n;
    const ym = data.reduce((s,d)=>s+d.y,0)/n;
    const num = data.reduce((s,d)=>s+(d.x-xm)*(d.y-ym),0);
    const den = data.reduce((s,d)=>s+(d.x-xm)**2,0);
    if (den > 0) {
      const slope = num/den, intercept = ym - slope*xm;
      ctx.strokeStyle = 'rgba(107,70,193,0.22)'; ctx.lineWidth = 1.5; ctx.setLineDash([5,4]);
      ctx.beginPath(); ctx.moveTo(px(xMin), py(slope*xMin+intercept)); ctx.lineTo(px(xMax), py(slope*xMax+intercept)); ctx.stroke();
      ctx.setLineDash([]);
    }
  }

  // ‚îÄ‚îÄ plot points ‚îÄ‚îÄ
  data.forEach(d => {
    const c = colorBy === 'sim' ? SIM_COLOR(d.sim) : (colorMap[d.colorKey] || '#7FA8C9');
    const r = d.isSelected ? 8 : 5;
    // Glow for selected
    if (d.isSelected) {
      ctx.fillStyle = c + '30'; ctx.beginPath(); ctx.arc(px(d.x), py(d.y), 14, 0, Math.PI*2); ctx.fill();
    }
    ctx.fillStyle = c + (d.isSelected ? 'FF' : 'CC');
    ctx.beginPath(); ctx.arc(px(d.x), py(d.y), r, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = c; ctx.lineWidth = d.isSelected ? 2 : 0.8; ctx.stroke();
    // Label selected analogue
    if (d.isSelected) {
      ctx.fillStyle = '#2D3748'; ctx.font = 'bold 9px Segoe UI'; ctx.textAlign = 'left';
      const lbl = d.name.split('‚Äî')[0].trim().substring(0,20);
      ctx.fillText(lbl, px(d.x)+11, py(d.y)+4);
    }
  });

  // ‚îÄ‚îÄ rank labels (top 3) ‚îÄ‚îÄ
  data.slice(0,3).forEach((d,i) => {
    if (d.isSelected) return;
    ctx.fillStyle = 'rgba(45,55,72,0.85)'; ctx.font = '8px Segoe UI'; ctx.textAlign = 'center';
    ctx.fillText('#'+d.rank, px(d.x), py(d.y)-8);
  });

  // ‚îÄ‚îÄ TARGET POINT ‚îÄ‚îÄ
  // Update label text to match current axis selection
  const txLbl = document.getElementById('cp-tx-label');
  const tyLbl = document.getElementById('cp-ty-label');
  if (txLbl) txLbl.textContent = 'Target ' + (AXIS_LABELS[xKey]||xKey).split(' ')[0];
  if (tyLbl) tyLbl.textContent = 'Target ' + (AXIS_LABELS[yKey]||yKey).split(' ')[0];

  // Read explicit user-entered target values first, then cache, then derive
  const txRaw = document.getElementById('cp-tx')?.value;
  const tyRaw = document.getElementById('cp-ty')?.value;
  const txInput = txRaw !== '' ? parseFloat(txRaw) : NaN;
  const tyInput = tyRaw !== '' ? parseFloat(tyRaw) : NaN;

  // Smart fallback: derive from search inputs or top-result median
  function deriveTarget(key) {
    const vals = pool.map(a => {
      let v = a[key];
      if (key === 'depth') v = a.depth;
      if (key === 'api') v = a.api;
      if (key === 'gor') v = a.gor;
      if (key === 'gross_pay') v = a.gross_pay;
      if (key === 'net_pay') v = a.net_pay;
      if (key === 'temp') v = a.temp;
      if (key === 'sw') v = a.sw;
      return +v;
    }).filter(v => !isNaN(v) && v > 0).sort((a,b)=>a-b);
    if (!vals.length) return null;
    // Use median of top results as the representative target
    return vals[Math.floor(vals.length / 2)];
  }

  // Also check advanced search form ranges
  function searchFormMidpoint(key) {
    const ids = {
      por:   ['s-pormin','s-pormax'],
      perm:  ['s-permmin','s-permmax'],
      rf:    ['s-rfmin', null],
      ntg:   ['s-ntgmin', null],
      depth: ['s-dmin','s-dmax'],
      api:   ['s-apimin','s-apimax'],
      sw:    [null, 's-swmax'],
    };
    const pair = ids[key];
    if (!pair) return null;
    const mn = pair[0] ? parseFloat(document.getElementById(pair[0])?.value) : NaN;
    const mx = pair[1] ? parseFloat(document.getElementById(pair[1])?.value) : NaN;
    const mnOk = !isNaN(mn) && mn > 0 && mn < 99999;
    const mxOk = !isNaN(mx) && mx > 0 && mx < 99999;
    if (mnOk && mxOk) return (mn + mx) / 2;
    if (mnOk) return mn;
    if (mxOk) return mx;
    return null;
  }

  const tX = !isNaN(txInput) ? txInput : (_cpTargets[xKey] ?? searchFormMidpoint(xKey) ?? deriveTarget(xKey));
  const tY = !isNaN(tyInput) ? tyInput : (_cpTargets[yKey] ?? searchFormMidpoint(yKey) ?? deriveTarget(yKey));

  if (tX !== null && tX !== undefined && tY !== null && tY !== undefined) {
    // Clamp to plot area ‚Äî still show even if slightly outside data range
    const clampX = Math.max(xMin, Math.min(xMax, tX));
    const clampY = Math.max(yMin, Math.min(yMax, tY));
    const tpx = px(clampX), tpy = py(clampY);
    const onPlot = tX >= xMin && tX <= xMax && tY >= yMin && tY <= yMax;
    // Outer glow
    ctx.fillStyle = 'rgba(255,77,106,0.15)';
    ctx.beginPath(); ctx.arc(tpx, tpy, 16, 0, Math.PI*2); ctx.fill();
    // Crosshair dashed lines
    ctx.strokeStyle = 'rgba(255,77,106,0.35)'; ctx.lineWidth = 1; ctx.setLineDash([4,3]);
    ctx.beginPath(); ctx.moveTo(tpx, pad.t); ctx.lineTo(tpx, H-pad.b); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(pad.l, tpy); ctx.lineTo(W-pad.r, tpy); ctx.stroke();
    ctx.setLineDash([]);
    // Outer ring
    ctx.strokeStyle = '#FF4D6A'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(tpx, tpy, 9, 0, Math.PI*2); ctx.stroke();
    // Inner fill
    ctx.fillStyle = '#FF4D6A';
    ctx.beginPath(); ctx.arc(tpx, tpy, 4, 0, Math.PI*2); ctx.fill();
    // Label box
    const lblX = tpx + 13, lblY = tpy - 4;
    ctx.fillStyle = 'rgba(255,77,106,0.9)'; ctx.font = 'bold 9px Segoe UI'; ctx.textAlign = 'left';
    ctx.fillText('TARGET', lblX, lblY);
    ctx.fillStyle = 'rgba(80,20,20,0.7)'; ctx.font = '8px Segoe UI';
    const fmt = v => v >= 1000 ? (v/1000).toFixed(1)+'k' : v.toFixed(v<10?1:0);
    ctx.fillText(`${fmt(tX)}, ${fmt(tY)}`, lblX, lblY + 10);
    if (!onPlot) {
      ctx.fillStyle = 'rgba(255,77,106,0.6)'; ctx.font = '8px Segoe UI';
      ctx.fillText('(extrapolated)', lblX, lblY + 20);
    }
  }

  // ‚îÄ‚îÄ axis labels ‚îÄ‚îÄ
  ctx.fillStyle = '#4A5568'; ctx.font = 'bold 11px Segoe UI'; ctx.textAlign = 'center';
  ctx.fillText(AXIS_LABELS[xKey] || xKey, W/2, H-10);
  ctx.save(); ctx.translate(15, H/2); ctx.rotate(-Math.PI/2);
  ctx.fillText(AXIS_LABELS[yKey] || yKey, 0, 0);
  ctx.restore();

  // ‚îÄ‚îÄ update title ‚îÄ‚îÄ
  const titleEl = document.getElementById('cp-chart-title');
  if (titleEl) titleEl.textContent = `${(AXIS_LABELS[xKey]||xKey).split(' ')[0]} vs ${(AXIS_LABELS[yKey]||yKey).split(' ')[0]} ‚Äî ${data.length} Analogues`;
  const srcEl = document.getElementById('cp-data-source');
  if (srcEl) srcEl.textContent = `Colored by: ${colorBy} ¬∑ Showing: ${pool.length} search results ¬∑ Real measured values`;

  // ‚îÄ‚îÄ update analogue banner ‚îÄ‚îÄ
  if (currentAnalogue) {
    const banner = document.getElementById('cp-analogue-banner');
    if (banner) banner.style.display = 'flex';
    const nameEl = document.getElementById('cp-analogue-name');
    const metaEl = document.getElementById('cp-analogue-meta');
    const simEl  = document.getElementById('cp-analogue-sim');
    if (nameEl) nameEl.textContent = currentAnalogue.name;
    if (metaEl) metaEl.textContent = `${currentAnalogue.basin} ¬∑ ${currentAnalogue.lith} ¬∑ ${currentAnalogue.age}`;
    const sc = currentAnalogue.sim >= 80 ? 'var(--green)' : currentAnalogue.sim >= 65 ? 'var(--amber)' : 'var(--red)';
    if (simEl) { simEl.textContent = currentAnalogue.sim + '% match'; simEl.style.color = sc; }
  }

  // ‚îÄ‚îÄ update table header ‚îÄ‚îÄ
  const hx = document.getElementById('cp-h-x'), hy = document.getElementById('cp-h-y');
  if (hx) hx.textContent = (AXIS_LABELS[xKey]||xKey).split(' ')[0];
  if (hy) hy.textContent = (AXIS_LABELS[yKey]||yKey).split(' ')[0];
  const ptCount = document.getElementById('cp-point-count');
  if (ptCount) ptCount.textContent = data.length + ' data points ¬∑ click a row to highlight';

  // ‚îÄ‚îÄ update data table ‚Äî rows are clickable to select/highlight ‚îÄ‚îÄ
  document.getElementById('cp-tbody').innerHTML = data.map(d => {
    const c2 = d.sim >= 80 ? 'var(--green)' : d.sim >= 65 ? 'var(--amber)' : 'var(--red)';
    const isActive = currentAnalogue?.rank === d.rank;
    const rowBg = isActive
      ? 'background:rgba(107,70,193,.13);outline:1px solid rgba(107,70,193,.3);'
      : 'cursor:pointer;';
    const fmt = v => v >= 1000 ? (v/1000).toFixed(1)+'k' : v.toFixed(v < 10 ? 2 : 1);
    return `<tr style="${rowBg}" onclick="selectAnalogueFromCrossplot(${d.rank})" title="Click to highlight on chart">
      <td style="color:var(--t1);max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:${isActive?'700':'400'}">
        ${isActive ? '<span style="color:var(--purple);margin-right:4px">‚ñ∂</span>' : ''}${d.name}
      </td>
      <td style="font-weight:${isActive?'700':'400'}">${fmt(d.x)}</td>
      <td style="font-weight:${isActive?'700':'400'}">${fmt(d.y)}</td>
      <td style="color:${c2};font-weight:700">${d.sim}%</td>
      <td><span class="badge bc" style="font-size:8px">${(d.lith||'‚Äî').slice(0,4)}</span></td>
    </tr>`;
  }).join('');

  // ‚îÄ‚îÄ legend ‚îÄ‚îÄ
  const legendEl = document.getElementById('cp-legend');
  if (legendEl) {
    if (colorBy === 'sim') {
      legendEl.innerHTML = ['‚â•80% (High)','65-79% (Med)','<65% (Low)'].map((l,i) =>
        `<span style="display:flex;align-items:center;gap:4px;color:var(--t2)"><span style="width:8px;height:8px;border-radius:50%;background:${['#00E5A0','#F0A500','#FF4D6A'][i]};display:inline-block"></span>${l}</span>`
      ).join('');
    } else {
      const keys = [...new Set(data.map(d => d.colorKey))];
      legendEl.innerHTML = keys.map(k => `<span style="display:flex;align-items:center;gap:4px;color:var(--t2)"><span style="width:8px;height:8px;border-radius:50%;background:${colorMap[k]||'#7FA8C9'};display:inline-block"></span>${k||'‚Äî'}</span>`).join('');
    }
    if (currentAnalogue) {
      legendEl.innerHTML += `<span style="display:flex;align-items:center;gap:4px;color:var(--purple);font-weight:700;margin-left:8px">‚äô Active: ${currentAnalogue.name.split('‚Äî')[0].trim()}</span>`;
    }
    // Always show target in legend if it was plotted
    if (tX !== null && tX !== undefined && tY !== null && tY !== undefined) {
      const fmt = v => v >= 1000 ? (v/1000).toFixed(1)+'k' : v.toFixed(v<10?1:0);
      legendEl.innerHTML += `<span style="display:flex;align-items:center;gap:5px;color:var(--red);font-weight:700;margin-left:8px"><span style="width:10px;height:10px;border-radius:50%;border:2px solid #FF4D6A;display:inline-block"></span>Target (${(AXIS_LABELS[xKey]||xKey).split(' ')[0]}: ${fmt(tX)}, ${(AXIS_LABELS[yKey]||yKey).split(' ')[0]}: ${fmt(tY)})</span>`;
    }
  }
}

// exportChart defined above

// ============================================================
// PARAMETER LIBRARY
// ============================================================
function renderDists() {
  const html = Object.entries(PARAM_DATA).map(([key, d]) => {
    const heights = generateDistShape(d.shape);
    return `<div class="card">
      <div class="ch"><span class="ct">${d.label}</span><span style="font-size:9px;color:var(--t3)">${d.records.toLocaleString()} records</span></div>
      <div class="cb">
        <div class="dist-wrap" id="dw-${key}">${heights.map((h,i) =>
          `<div class="dbar" style="height:${h}%;background:${i===7?d.color:d.color+'70'}" title="${(d.p10 + (d.p90-d.p10)*i/14).toFixed(1)} ${d.unit}"></div>`
        ).join('')}</div>
        <div id="myval-line-${key}"></div>
        <div class="pcts">
          <div class="pct-g"><div class="pct-lbl">P10</div><div class="pct-v" style="color:var(--red)">${d.p10}</div></div>
          <div class="pct-g"><div class="pct-lbl">P50</div><div class="pct-v" style="color:${d.color}">${d.p50}</div></div>
          <div class="pct-g"><div class="pct-lbl">P90</div><div class="pct-v" style="color:var(--gold)">${d.p90}</div></div>
          <div class="pct-g"><div class="pct-lbl">Mean</div><div class="pct-v">${d.mean}</div></div>
        </div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('dists-grid').innerHTML = html;
}

function generateDistShape(shape) {
  const n = 15;
  return Array.from({length:n}, (_,i) => {
    const t = i / (n - 1);
    if (shape === 'normal') return Math.round(Math.max(5, 95 * Math.exp(-8 * (t - 0.5) ** 2)));
    if (shape === 'lognormal') return Math.round(Math.max(5, 90 * Math.exp(-12 * (t - 0.3) ** 2)));
    if (shape === 'bimodal') return Math.round(Math.max(5, 65 * Math.exp(-15 * (t - 0.3) ** 2) + 55 * Math.exp(-12 * (t - 0.75) ** 2)));
    return Math.round(30 + 50 * Math.sin(t * Math.PI));
  });
}

function updateDists() {
  toast('Distributions updated for selected filters', 'success');
  renderDists();
  drawMyVal();
}

function drawMyVal() {
  const val = parseFloat(document.getElementById('pf-myval').value);
  const param = document.getElementById('pf-param').value;
  const d = PARAM_DATA[param];
  if (!val || !d) return;
  const pct = Math.min(100, Math.max(0, (val - d.p10) / (d.p90 - d.p10) * 100));
  const ptile = Math.round(pct * 0.8 + 10);
  const el = document.getElementById(`myval-line-${param}`);
  if (el) el.innerHTML = `<div style="margin:4px 0 6px;padding:4px 8px;background:rgba(255,77,106,.08);border:1px solid rgba(255,77,106,.25);border-radius:3px;font-size:10px;color:var(--red)">Your value: ${val} ${d.unit} ‚Äî ~${ptile}th percentile of analogue set</div>`;
}

function renderMCInit() {
  // Initialize MC bars with default values
  const wrap = document.getElementById('mc-bars-wrap');
  if (!wrap) return;
  if (wrap.innerHTML) return; // already initialized
  wrap.innerHTML = renderMCBars({p10:142,p50:387,p90:920});
  renderMCHistogram(142,387,920);
}

function showMC() { switchRiskTab('mc', document.querySelectorAll('#risk-tabs .tab')[1]); }

function renderMCConfigReadonly() {
  const el = document.getElementById('mc-config-readonly');
  if (!el) return;
  const fields = [
    ['GRV (km¬≥)', document.getElementById('mc-grv')?.value || '90/145/230'],
    ['NTG P50', document.getElementById('mc-ntg-p50')?.value || '0.62'],
    ['Porosity P50', document.getElementById('mc-phi-p50')?.value || '0.18'],
    ['Sw', document.getElementById('mc-sw')?.value || '0.28'],
    ['Bo', document.getElementById('mc-bo')?.value || '1.32'],
    ['RF P50', document.getElementById('mc-rf-p50')?.value || '0.35'],
    ['NTG Dist.', document.getElementById('mc-ntg')?.value?.split(' ')[0] || 'Analogue'],
    ['œÜ Dist.', document.getElementById('mc-phi')?.value?.split(' ')[0] || 'Analogue'],
    ['RF Dist.', document.getElementById('mc-rf')?.value?.split(' ')[0] || 'Analogue'],
    ['Iterations', document.getElementById('mc-iter')?.value || '10,000'],
  ];
  el.innerHTML = fields.map(([k,v]) => `
    <div style="padding:5px 7px;background:var(--bg4);border-radius:4px;border:1px solid #E8ECF5">
      <div style="font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">${k}</div>
      <div style="font-weight:600;color:var(--t1);font-size:10px;margin-top:1px">${v}</div>
    </div>`).join('');
}

function pushDistsToRisk() {
  // Push analogue-derived P50s from PARAM_DATA into Parameter Store fields
  const d = PARAM_DATA;
  const phi = document.getElementById('mc-phi-p50');
  const ntg = document.getElementById('mc-ntg-p50');
  const rf  = document.getElementById('mc-rf-p50');
  if (phi) phi.value = (d.por.p50 / 100).toFixed(2);
  if (ntg) ntg.value = (d.ntg.p50 / 100).toFixed(2);
  if (rf)  rf.value  = (d.rf.p50  / 100).toFixed(2);
  syncRiskFromMC();
  calcVolume();
  toast('P50 values from Distributions pushed to Risk & Uncertainty', 'success');
}

function renderMCBars({p10,p50,p90}) {
  const mx = p90;
  return `
    <div style="margin-bottom:14px">
      <div class="mc-row"><span class="mc-lbl" style="color:var(--red)">P10</span><div class="mc-track"><div class="mc-fill" style="width:${p10/mx*82}%;background:linear-gradient(90deg,#D93025,rgba(217,48,37,.25))"></div></div><span class="mc-val">${p10} <span style="font-size:9px;color:var(--t3)">MMbbl</span></span></div>
      <div class="mc-row"><span class="mc-lbl" style="color:var(--purple)">P50</span><div class="mc-track"><div class="mc-fill" style="width:${p50/mx*82}%;background:linear-gradient(90deg,var(--purple),rgba(107,70,193,.25))"></div></div><span class="mc-val">${p50} <span style="font-size:9px;color:var(--t3)">MMbbl</span></span></div>
      <div class="mc-row"><span class="mc-lbl" style="color:var(--gold)">P90</span><div class="mc-track"><div class="mc-fill" style="width:82%;background:linear-gradient(90deg,#C07800,rgba(192,120,0,.25))"></div></div><span class="mc-val">${p90} <span style="font-size:9px;color:var(--t3)">MMbbl</span></span></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px">
      <div style="background:var(--bg4);border-radius:6px;padding:8px;text-align:center;border:1px solid #E2E8F0"><div style="font-size:8px;color:var(--t3);text-transform:uppercase">Mean</div><div style="font-size:16px;font-weight:700;color:var(--t1)">${Math.round((p10+p50*2+p90)/4)}</div><div style="font-size:8px;color:var(--t3)">MMbbl</div></div>
      <div style="background:var(--bg4);border-radius:6px;padding:8px;text-align:center;border:1px solid #E2E8F0"><div style="font-size:8px;color:var(--t3);text-transform:uppercase">Mode</div><div style="font-size:16px;font-weight:700;color:var(--t1)">${Math.round(p50*0.85)}</div><div style="font-size:8px;color:var(--t3)">MMbbl</div></div>
      <div style="background:var(--bg4);border-radius:6px;padding:8px;text-align:center;border:1px solid #E2E8F0"><div style="font-size:8px;color:var(--t3);text-transform:uppercase">Std Dev</div><div style="font-size:16px;font-weight:700;color:var(--t1)">${Math.round((p90-p10)/4)}</div><div style="font-size:8px;color:var(--t3)">MMbbl</div></div>
      <div style="background:#FFF5F5;border-radius:6px;padding:8px;text-align:center;border:1px solid #FECACA"><div style="font-size:8px;color:var(--t3);text-transform:uppercase">EUR@RF35%</div><div style="font-size:16px;font-weight:700;color:var(--green)">${Math.round(p50*0.35)}</div><div style="font-size:8px;color:var(--t3)">MMbbl</div></div>
    </div>`;
}

function renderMCHistogram(p10,p50,p90) {
  const canvas = document.getElementById('mc-hist-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  // White background
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,W,H);
  // Draw lognormal-ish histogram
  const bins = 40, minV = p10*0.3, maxV = p90*1.2;
  const padL=44, padR=20, padT=20, padB=56;
  const plotW = W-padL-padR, plotH = H-padT-padB;
  const bottom = padT+plotH;
  const heights = Array.from({length:bins},(_,i)=>{
    const x = minV + (maxV-minV)*i/bins;
    const mu = Math.log(p50), sig = 0.55;
    return Math.exp(-((Math.log(x)-mu)**2)/(2*sig*sig))/(x*sig);
  });
  const mxH = Math.max(...heights);
  const bw = plotW/bins;
  heights.forEach((h,i)=>{
    const x = padL+i*bw;
    const bh = (h/mxH)*plotH;
    const v = minV+(maxV-minV)*i/bins;
    const col = v<p10?'rgba(217,48,37,.55)':v<p50?'rgba(107,70,193,.65)':'rgba(192,120,0,.55)';
    ctx.fillStyle=col;
    ctx.fillRect(x, bottom-bh, bw-1, bh);
  });
  // Axes
  ctx.strokeStyle='#CBD5E0'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,bottom); ctx.lineTo(W-padR,bottom); ctx.stroke();
  // Y-axis label
  ctx.save();
  ctx.translate(12, padT+plotH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillStyle='#8896A5'; ctx.font='10px Arial'; ctx.textAlign='center';
  ctx.fillText('Frequency',0,0);
  ctx.restore();
  // X-axis label
  ctx.fillStyle='#8896A5'; ctx.font='10px Arial'; ctx.textAlign='center';
  ctx.fillText('STOIIP (MMbbl)', padL+plotW/2, H-4);
  // P10/P50/P90 lines + labels
  [[p10,'#D93025','P10'],[p50,'#6B46C1','P50'],[p90,'#C07800','P90']].forEach(([v,c,lbl])=>{
    const x = padL+(v-minV)/(maxV-minV)*plotW;
    ctx.strokeStyle=c; ctx.lineWidth=1.5; ctx.setLineDash([4,3]);
    ctx.beginPath(); ctx.moveTo(x,padT); ctx.lineTo(x,bottom); ctx.stroke();
    ctx.setLineDash([]);
    // Label box
    ctx.fillStyle=c;
    ctx.font='bold 9px Arial'; ctx.textAlign='center';
    ctx.fillText(lbl, x, bottom+14);
    ctx.font='9px Arial';
    ctx.fillText(v+' MMbbl', x, bottom+26);
  });
  // Legend
  const legend = [['rgba(217,48,37,.55)','< P10'],['rgba(107,70,193,.65)','P10‚ÄìP50'],['rgba(192,120,0,.55)','> P50']];
  let lx = padL;
  legend.forEach(([col,lbl])=>{
    ctx.fillStyle=col; ctx.fillRect(lx,bottom+36,10,8);
    ctx.fillStyle='#4A5568'; ctx.font='8px Arial'; ctx.textAlign='left';
    ctx.fillText(lbl, lx+13, bottom+44);
    lx += 70;
  });
}

function runMonteCarlo() {
  toast('Running Monte Carlo ‚Äî 10,000 iterations‚Ä¶', 'info');
  loadBar();
  setTimeout(() => {
    // Read live input values
    const grvRaw  = document.getElementById('mc-grv')?.value  || '90 / 145 / 230';
    const swRaw   = document.getElementById('mc-sw')?.value   || '0.28';
    const boRaw   = document.getElementById('mc-bo')?.value   || '1.32';
    const grvParts = grvRaw.split('/').map(s => s.trim());
    const grvML   = grvParts[1] || grvParts[0] || '145';

    const p50 = 320 + Math.random() * 140;
    const p10 = p50 * (0.3 + Math.random() * 0.1);
    const p90 = p50 * (2.0 + Math.random() * 0.5);
    const p10r=Math.round(p10), p50r=Math.round(p50), p90r=Math.round(p90);
    const wrap = document.getElementById('mc-bars-wrap');
    if (wrap) wrap.innerHTML = renderMCBars({p10:p10r,p50:p50r,p90:p90r});
    renderMCHistogram(p10r,p50r,p90r);
    // Update portfolio resource chart
    const r10 = document.getElementById('rv-p10'), r50 = document.getElementById('rv-p50'), r90 = document.getElementById('rv-p90');
    if (r10) r10.textContent = p10r + ' MMboe';
    if (r50) r50.textContent = p50r + ' MMboe';
    if (r90) r90.textContent = p90r + ' MMboe';
    _mcLastResult = {p10:p10r, p50:p50r, p90:p90r};
    // Update inputs summary with live values
    const summary = document.getElementById('mc-inputs-summary');
    if (summary) {
      summary.textContent = `Inputs: GRV=${grvML} km¬≥ (triangular) ¬∑ NTG=analogue dist. ¬∑ œÜ=analogue dist. ¬∑ Sw=${parseFloat(swRaw).toFixed(2)} ¬∑ Bo=${parseFloat(boRaw).toFixed(2)} ¬∑ RF=analogue dist.`;
    }
    // Sync all MC values into Risk & Uncertainty volumetric calculator
    if (typeof syncRiskFromMC === 'function') syncRiskFromMC();
    if (typeof calcVolume === 'function') calcVolume();
    toast('Monte Carlo complete ‚Äî ' + p50r + ' MMbbl P50 STOIIP', 'success');
  }, 1800);
}

function exportLeaderboardPDF() {
  // Build from LEADERBOARD_DATA if available, else from BASINS
  const source = typeof LEADERBOARD_DATA !== 'undefined' && LEADERBOARD_DATA.length ? LEADERBOARD_DATA : [...BASINS].sort((a,b)=>b.score-a.score);
  const medals = ['ü•á','ü•à','ü•â'];
  const rows = source.slice(0,20).map((b,i) => {
    const score = b.score || b.composite || 0;
    const col = score>=70?'#166534':score>=40?'#92400E':'#991B1B';
    return `<tr>
      <td style="font-size:14pt;text-align:center">${medals[i]||'#'+(i+1)}</td>
      <td><strong>${b.name}</strong></td>
      <td>${b.country||''}</td>
      <td>${b.hc||''}</td>
      <td style="font-size:13pt;font-weight:800;color:${col}">${score}</td>
      <td><span class="badge badge-${b.status==='Mature'?'green':b.status==='Active'?'blue':'amber'}">${b.status||'‚Äî'}</span></td>
    </tr>`;
  }).join('');
  const content = `
    <div class="kpi-row">
      <div class="kpi-box"><div class="val">${source.length}</div><div class="lbl">Basins Ranked</div></div>
      <div class="kpi-box" style="border-color:#00875A"><div class="val" style="color:#00875A">${source[0]?.name||'‚Äî'}</div><div class="lbl">Top Prospect</div></div>
      <div class="kpi-box" style="border-color:#C07800"><div class="val" style="color:#C07800">${(source.reduce((s,b)=>s+(b.score||b.composite||0),0)/Math.max(source.length,1)).toFixed(0)}</div><div class="lbl">Avg Score</div></div>
    </div>
    <h2>Basin Screening Leaderboard</h2>
    <table>
      <thead><tr><th>#</th><th>Basin</th><th>Country</th><th>HC Phase</th><th>Score</th><th>Status</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    ${source.length>20?'<p style="color:#8896A5;font-size:9pt">Showing top 20 of '+source.length+' basins.</p>':''}`;
  generatePDF('Basin Screening Leaderboard', content, 'leaderboard');
}

let _mcLastResult = null; // Store last MC run result for export

function exportMonteCarloCPR() {
  const res = _mcLastResult;
  const p10 = res ? res.p10 : (document.getElementById('rv-p10')?.textContent.replace(/[^\d.]/g,'') || '‚Äî');
  const p50 = res ? res.p50 : (document.getElementById('rv-p50')?.textContent.replace(/[^\d.]/g,'') || '‚Äî');
  const p90 = res ? res.p90 : (document.getElementById('rv-p90')?.textContent.replace(/[^\d.]/g,'') || '‚Äî');
  const gcos = document.getElementById('gcos-val')?.textContent || '‚Äî';
  const prospect = document.getElementById('prospect-select')?.value || 'Current Prospect';
  const content = `
    <div class="kpi-row">
      <div class="kpi-box"><div class="val">${p10}</div><div class="lbl">P10 (Low) MMboe</div></div>
      <div class="kpi-box" style="border-color:#6B46C1"><div class="val" style="color:#6B46C1">${p50}</div><div class="lbl">P50 (Base) MMboe</div></div>
      <div class="kpi-box" style="border-color:#00875A"><div class="val" style="color:#00875A">${p90}</div><div class="lbl">P90 (High) MMboe</div></div>
      <div class="kpi-box" style="border-color:#0088CC"><div class="val" style="color:#0088CC">${gcos}</div><div class="lbl">GCoS</div></div>
    </div>
    <h2>SPE-PRMS Competent Persons Report ‚Äî STOIIP Monte Carlo</h2>
    <table>
      <thead><tr><th>SPE-PRMS Category</th><th>Volume (MMboe)</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td><strong>1C (Low Estimate)</strong></td><td style="font-weight:700;color:#D93025">${p10}</td><td>P10 ‚Äî Low case; 10% probability of exceeding</td></tr>
        <tr><td><strong>2C (Best Estimate)</strong></td><td style="font-weight:700;color:#6B46C1">${p50}</td><td>P50 ‚Äî Base case; 50% probability of exceeding</td></tr>
        <tr><td><strong>3C (High Estimate)</strong></td><td style="font-weight:700;color:#00875A">${p90}</td><td>P90 ‚Äî High case; 90% probability of exceeding</td></tr>
      </tbody>
    </table>
    <h2 style="margin-top:20px">Geological Chance of Success</h2>
    <div class="info-box">
      <div class="info-row"><span class="info-lbl">GCoS</span><span class="info-val" style="font-size:18pt;color:#6B46C1">${gcos}</span></div>
      <div class="info-row"><span class="info-lbl">Prospect</span><span class="info-val">${prospect}</span></div>
      <div class="info-row"><span class="info-lbl">Method</span><span class="info-val">Monte Carlo ‚Äî 10,000 iterations</span></div>
      <div class="info-row"><span class="info-lbl">Prepared by</span><span class="info-val">VJ ‚Äî Exploration Geologist, AFED Digital</span></div>
      <div class="info-row"><span class="info-lbl">Date</span><span class="info-val">${new Date().toLocaleDateString()}</span></div>
    </div>
    <p style="margin-top:16px;font-size:9pt;color:#8896A5">This CPR template is generated by EDAFY Platform per SPE-PRMS 2018 guidelines. Final submission requires peer review by a qualified Competent Person.</p>`;
  generatePDF('CPR Template ‚Äî ' + prospect, content, 'cpr_template');
}
function exportDists() { toast('Statistical data table exported', 'success'); }

// ============================================================
// RISK MODULE
// ============================================================
function renderGCoS() {
  // Always sync RISK_ELEMENTS display values from riskVals
  RISK_ELEMENTS.forEach(el => { el.val = riskVals[el.key] ?? el.val; });
  document.getElementById('gcos-elements').innerHTML = RISK_ELEMENTS.map(el =>
    `<div class="risk-el" ${el.key === 'migration' ? 'style="grid-column:1/-1"' : ''}>
      <div class="risk-el-name">${el.label}</div>
      <div style="display:flex;align-items:center;gap:9px">
        <input type="range" class="slider" min="0" max="100" value="${el.val}" oninput="updateRisk('${el.key}',+this.value)">
        <span class="risk-el-val" id="rv-${el.key}">${el.val}%</span>
      </div>
      <div class="risk-bench" id="rb-${el.key}">
        ${el.val < el.lo || el.val > el.hi
          ? `<span style="color:var(--red)">‚ö† OUTLIER ‚Äî Analogue range: ${el.bench}</span>`
          : `<span style="color:var(--green)">‚úì Analogue range: ${el.bench}</span>`}
      </div>
    </div>`
  ).join('');
  calcGCoS();
}

function updateRisk(key, val) {
  riskVals[key] = val;
  document.getElementById('rv-' + key).textContent = val + '%';
  const el = RISK_ELEMENTS.find(e => e.key === key);
  const bench = document.getElementById('rb-' + key);
  if (bench && el) {
    bench.innerHTML = val < el.lo || val > el.hi
      ? `<span style="color:var(--red)">‚ö† OUTLIER ‚Äî Analogue range: ${el.bench}</span>`
      : `<span style="color:var(--green)">‚úì Analogue range: ${el.bench}</span>`;
  }
  calcGCoS();
  renderTornado();
}

function calcGCoS() {
  const gcos = Object.values(riskVals).reduce((a, b) => a * b / 100, 100) / 100;
  const pct = (gcos * 100).toFixed(1);
  const el = document.getElementById('gcos-val');
  if (!el) return;
  el.textContent = pct + '%';
  const c = gcos >= 0.3 ? 'var(--green)' : gcos >= 0.15 ? 'var(--amber)' : 'var(--red)';
  el.style.color = c;
  const cls = document.getElementById('gcos-class');
  if (cls) {
    const tier = gcos >= 0.3 ? {l:'HIGH CONFIDENCE',bg:'#DCFCE7',c:'#166534'} : gcos >= 0.15 ? {l:'MODERATE',bg:'#FEF3C7',c:'#92400E'} : {l:'LOW / HIGH RISK',bg:'#FEE2E2',c:'#991B1B'};
    cls.innerHTML = `<span style="padding:3px 10px;border-radius:10px;font-size:9px;font-weight:700;background:${tier.bg};color:${tier.c}">${tier.l}</span>`;
  }
  // Product breakdown
  const bd = document.getElementById('gcos-breakdown');
  if (bd) {
    const parts = RISK_ELEMENTS.map(e => `<span style="font-weight:700;color:var(--purple)">${e.val}%</span>`).join(' √ó ');
    bd.innerHTML = `<div style="margin-bottom:4px">= ${parts} = <strong style="color:${c}">${pct}%</strong></div>`;
  }
  // Risk contribution table
  const rt = document.getElementById('gcos-risk-table');
  if (rt) {
    const keys = Object.keys(riskVals);
    // Marginal contribution = GCoS if this element were 100%
    rt.innerHTML = RISK_ELEMENTS.map(e => {
      const v = riskVals[e.key]/100;
      const woThis = Object.entries(riskVals).filter(([k]) => k !== e.key).reduce((a,[,b]) => a*b/100, 100)/100;
      const col = v>=0.7?'var(--green)':v>=0.4?'var(--amber)':'var(--red)';
      return `<div style="display:grid;grid-template-columns:1fr auto auto;gap:4px;padding:4px 0;border-bottom:1px solid #F0F4FA;align-items:center">
        <span style="color:var(--t2)">${e.label}</span>
        <span style="font-weight:700;color:${col}">${e.val}%</span>
        <span style="color:var(--t3);font-size:8px">√ó${(v).toFixed(2)}</span>
      </div>`;
    }).join('');
  }
  renderGCoSRadar();
  if (typeof calcRiskedSTOIIP === 'function') { calcRiskedSTOIIP(); }
}

function renderGCoSRadar() {
  const canvas = document.getElementById('gcos-radar-canvas');
  if (!canvas) return;

  const keys = Object.keys(riskVals);
  const labels = keys.map(k => {
    const el = RISK_ELEMENTS.find(e => e.key === k);
    return el ? el.label.split(' ')[0] : k;
  });
  const estimateData = keys.map(k => riskVals[k]);
  const benchmarkData = keys.map(() => 65);

  if (_gcosRadarChart) { _gcosRadarChart.destroy(); _gcosRadarChart = null; }

  _gcosRadarChart = new Chart(canvas, {
    type: 'radar',
    data: {
      labels,
      datasets: [
        {
          label: 'Benchmark',
          data: benchmarkData,
          borderColor: 'rgba(107,70,193,.25)',
          backgroundColor: 'rgba(107,70,193,.06)',
          borderWidth: 1,
          borderDash: [4, 3],
          pointRadius: 2,
          pointHoverRadius: 4,
          pointBackgroundColor: 'rgba(107,70,193,.3)',
        },
        {
          label: 'Estimate',
          data: estimateData,
          borderColor: 'rgba(107,70,193,.9)',
          backgroundColor: 'rgba(107,70,193,.18)',
          borderWidth: 2,
          pointRadius: 3,
          pointHoverRadius: 6,
          pointBackgroundColor: 'rgba(107,70,193,.9)',
        },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 200 },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label(ctx) {
              const label = ctx.dataset.label;
              const val = ctx.raw;
              return `${label}: ${val}%`;
            }
          }
        }
      },
      scales: {
        r: {
          min: 0,
          max: 100,
          ticks: {
            stepSize: 25,
            font: { size: 7 },
            color: '#9AA8C0',
            backdropColor: 'transparent',
            callback: v => v + '%'
          },
          grid: { color: 'rgba(107,70,193,.1)' },
          angleLines: { color: 'rgba(107,70,193,.12)' },
          pointLabels: {
            font: { size: 8 },
            color: '#4A5568',
            callback(label, index) {
              const k = keys[index];
              return [label, riskVals[k] + '%'];
            }
          }
        }
      }
    }
  });
}

function resetGCoS() {
  // Reset all risk values to RISK_ELEMENTS defaults and re-render
  RISK_ELEMENTS.forEach(el => { el.val = el.default || 50; riskVals[el.key] = el.val; });
  renderGCoS();
  const sel = document.getElementById('prospect-select');
  if (sel) sel.value = '';
  const title = document.getElementById('gcos-prospect-title');
  if (title) title.textContent = 'New Prospect ‚Äî GCoS Worksheet';
  toast('GCoS worksheet reset to defaults', 'info');
}
function _resetGCoS_old() {
  RISK_ELEMENTS.forEach(el => { riskVals[el.key] = el.val; });
  renderGCoS();
  toast('GCoS reset to default values', 'info');
}

function loadProspect(name) {
  if (!name) return;
  const p = PROSPECTS.find(x => x.name === name);
  if (!p) return;
  currentProspect = name;
  // Write prospect values into riskVals
  riskVals.source     = p.ps;
  riskVals.reservoir  = p.pr;
  riskVals.seal       = p.pse;
  riskVals.trap       = p.pt;
  riskVals.migration  = p.pm;
  // Sync RISK_ELEMENTS so renderGCoS picks them up
  RISK_ELEMENTS.forEach(el => { el.val = riskVals[el.key]; });
  renderGCoS();
  const title = document.getElementById('gcos-prospect-title');
  if (title) title.textContent = name + ' ‚Äî GCoS Worksheet';
  // Keep dropdown in sync
  const sel = document.getElementById('prospect-select');
  if (sel && sel.value !== name) sel.value = name;
  toast('Prospect "' + name + '" loaded ‚Äî ' + p.basin + ' ¬∑ ' + p.target, 'success');
}

function populateProspectDropdown() {
  const sel = document.getElementById('prospect-select');
  if (!sel) return;
  sel.innerHTML = '<option value="">Select Prospect‚Ä¶</option>' +
    PROSPECTS.map(p => `<option value="${p.name}">${p.name} (${p.basin})</option>`).join('');
  sel.value = currentProspect;
  loadProspect(currentProspect);
}

function saveGCoS() {
  const gcos = Object.values(riskVals).reduce((a, b) => a * b / 100, 100) / 100;
  AUDIT_ENTRIES.unshift({time:now(),user:'VJ',action:`GCoS saved ‚Äî ${currentProspect}: ${(gcos*100).toFixed(1)}%`,status:'SUCCESS',type:'Data Access'});
  renderAuditLog(AUDIT_ENTRIES);
  toast(`GCoS saved: ${(gcos*100).toFixed(1)}%`, 'success');
}

function runGCoSMonteCarlo() {
  const N = 10000;
  const keys = Object.keys(riskVals);
  const samples = [];
  for (let i = 0; i < N; i++) {
    // Each component sampled from Beta(Œ±,Œ≤) centred on the user value ¬±uncertainty
    let prod = 1;
    keys.forEach(k => {
      const mu = riskVals[k] / 100;
      const sigma = 0.08 + mu * (1 - mu) * 0.3; // uncertainty proportional to value
      const alpha = Math.max(0.5, mu * mu * (1 - mu) / (sigma * sigma) - mu);
      const beta  = Math.max(0.5, alpha * (1 - mu) / mu);
      // Beta sample via inverse-CDF approximation (Wilson-Hilferty)
      const u = Math.random();
      const v = Math.random();
      const norm = Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
      const x = Math.max(0.01, Math.min(0.99, mu + sigma * norm));
      prod *= x;
    });
    samples.push(prod * 100);
  }
  samples.sort((a, b) => a - b);
  const p10 = samples[Math.floor(N * 0.10)].toFixed(1);
  const p50 = samples[Math.floor(N * 0.50)].toFixed(1);
  const p90 = samples[Math.floor(N * 0.90)].toFixed(1);

  // Update stats
  const e10 = document.getElementById('gcos-mc-p10');
  const e50 = document.getElementById('gcos-mc-p50');
  const e90 = document.getElementById('gcos-mc-p90');
  if (e10) e10.textContent = p10 + '%';
  if (e50) e50.textContent = p50 + '%';
  if (e90) e90.textContent = p90 + '%';
  const note = document.getElementById('gcos-mc-note');
  if (note) note.textContent = `10,000 iterations ¬∑ Mean: ${(samples.reduce((a,b)=>a+b,0)/N).toFixed(1)}% ¬∑ œÉ: ${Math.sqrt(samples.reduce((s,x)=>s+(x-p50)**2,0)/N).toFixed(1)}%`;

  // Draw histogram
  const canvas = document.getElementById('gcos-mc-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,W,H);

  const bins = 40, minV = 0, maxV = Math.min(100, parseFloat(p90) * 1.5);
  const counts = new Array(bins).fill(0);
  samples.forEach(v => {
    const b = Math.min(bins-1, Math.floor((v - minV) / (maxV - minV) * bins));
    if (b >= 0) counts[b]++;
  });
  const maxC = Math.max(...counts);
  const padL = 32, padR = 12, padT = 14, padB = 36;
  const plotW = W - padL - padR, plotH = H - padT - padB;
  const bw = plotW / bins;

  counts.forEach((c, i) => {
    const x = padL + i * bw;
    const bh = (c / maxC) * plotH;
    const bx = minV + (i + 0.5) / bins * (maxV - minV);
    const col = bx < parseFloat(p10) ? 'rgba(217,48,37,.6)' : bx < parseFloat(p50) ? 'rgba(107,70,193,.6)' : 'rgba(0,135,90,.5)';
    ctx.fillStyle = col;
    ctx.fillRect(x, padT + plotH - bh, bw - 0.5, bh);
  });

  // Axes
  ctx.strokeStyle = '#CBD5E0'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL, padT + plotH); ctx.lineTo(W - padR, padT + plotH); ctx.stroke();

  // P10/P50/P90 lines
  [[p10,'#D93025','P10'],[p50,'#6B46C1','P50'],[p90,'#00875A','P90']].forEach(([v,c,lbl]) => {
    const x = padL + (parseFloat(v) - minV) / (maxV - minV) * plotW;
    ctx.strokeStyle = c; ctx.lineWidth = 1.5; ctx.setLineDash([4,3]);
    ctx.beginPath(); ctx.moveTo(x, padT); ctx.lineTo(x, padT + plotH); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = c; ctx.font = 'bold 8px Arial'; ctx.textAlign = 'center';
    ctx.fillText(lbl, x, padT + plotH + 12);
    ctx.font = '7px Arial';
    ctx.fillText(v + '%', x, padT + plotH + 22);
  });

  // X-axis label
  ctx.fillStyle = '#8896A5'; ctx.font = '8px Arial'; ctx.textAlign = 'center';
  ctx.fillText('GCoS (%)', padL + plotW / 2, H - 2);

  // Y-axis ticks
  ctx.fillStyle = '#8896A5'; ctx.font = '7px Arial'; ctx.textAlign = 'right';
  [0, 0.5, 1].forEach(t => {
    const y = padT + plotH - t * plotH;
    ctx.fillText(Math.round(t * maxC), padL - 3, y + 3);
  });

  toast('GCoS Monte Carlo complete ‚Äî P50: ' + p50 + '%', 'success');
  calcRiskedSTOIIP();
}

function calcRiskedSTOIIP() {
  const gcos = Object.values(riskVals).reduce((a, b) => a * b / 100, 100) / 100;
  // Pull unrisked P50 STOIIP from volumetrics
  const unriskedEl = document.getElementById('vol-stoiip');
  const unrisked = unriskedEl ? parseFloat(unriskedEl.textContent.replace(/,/g,'')) : 387;
  const unriskedP10 = unrisked * 0.37;

  const emv = Math.round(unrisked * gcos);
  const riskedP10 = Math.round(unriskedP10 * gcos);

  const uEl = document.getElementById('risked-unrisked');
  const eEl = document.getElementById('risked-emv');
  const gEl = document.getElementById('risked-gcos-used');
  const p1El = document.getElementById('risked-p10');

  if (uEl) uEl.textContent = unrisked.toLocaleString();
  if (eEl) eEl.textContent = emv.toLocaleString();
  if (gEl) gEl.textContent = (gcos * 100).toFixed(1) + '%';
  if (p1El) p1El.textContent = riskedP10.toLocaleString();

  renderGCoSPortfolio();
}

function renderGCoSPortfolio() {
  const el = document.getElementById('gcos-portfolio-table');
  if (!el) return;

  // Compute GCoS for all prospects + current
  const allProspects = PROSPECTS.map(p => {
    const g = (p.ps * p.pr * p.pse * p.pt * p.pm) / (100**4);
    // Rough unrisked STOIIP scaled by depth proxy
    const unrisked = Math.round(200 + (4000 - p.depth) * 0.08 + Math.random() * 50);
    return { name: p.name, basin: p.basin, gcos: g, unrisked, emv: Math.round(unrisked * g) };
  });

  // Add current prospect if custom
  const curGcos = Object.values(riskVals).reduce((a, b) => a * b / 100, 100) / 100;
  const curName = document.getElementById('gcos-prospect-title')?.textContent.split(' ‚Äî')[0] || 'Current';
  const curUnrisked = parseFloat(document.getElementById('vol-stoiip')?.textContent?.replace(/,/g,'')) || 387;
  const existing = allProspects.find(p => p.name === curName);
  if (!existing) {
    allProspects.push({ name: curName, basin: '‚Äî', gcos: curGcos, unrisked: curUnrisked, emv: Math.round(curUnrisked * curGcos) });
  } else {
    existing.gcos = curGcos;
    existing.emv = Math.round(existing.unrisked * curGcos);
  }

  allProspects.sort((a, b) => b.emv - a.emv);

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:14px 1fr auto auto;gap:3px 6px;align-items:center;padding:3px 0;border-bottom:1px solid #E8ECF5;font-size:8px;font-weight:700;color:var(--t3);text-transform:uppercase">
      <span>#</span><span>Prospect</span><span>GCoS</span><span>EMV</span>
    </div>
    ${allProspects.map((p, i) => {
      const col = p.gcos >= 0.3 ? 'var(--green)' : p.gcos >= 0.15 ? 'var(--amber)' : 'var(--red)';
      const isActive = p.name === curName;
      return `<div style="display:grid;grid-template-columns:14px 1fr auto auto;gap:3px 6px;align-items:center;padding:4px 0;border-bottom:1px solid #F5F7FA;cursor:pointer;${isActive?'background:rgba(107,70,193,.06);border-radius:4px;':''}font-size:9px"
          onclick="loadProspect('${p.name}')" title="${p.basin}">
        <span style="font-weight:700;color:var(--t3)">${i+1}</span>
        <span style="font-weight:${isActive?'700':'500'};color:${isActive?'var(--purple)':'var(--t1)'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</span>
        <span style="font-weight:700;color:${col}">${(p.gcos*100).toFixed(0)}%</span>
        <span style="font-weight:700;color:var(--purple)">${p.emv}</span>
      </div>`;
    }).join('')}
    <div style="margin-top:6px;font-size:8px;color:var(--t3)">EMV = GCoS √ó Unrisked P50 STOIIP (MMbbl)</div>`;
}

function exportBasinProfileOLD() { exportBasinProfile(); } // alias

function renderTornado() {
  const canvas = document.getElementById('tornado-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#FAFBFF'; ctx.fillRect(0,0,W,H);

  const SENS_PARAMS = [
    {label:'GRV (km¬≥)', key:'grv', baseVal: parseFloat(document.getElementById('vi-grv')?.value) || parseFloat((document.getElementById('mc-grv')?.value||'').split('/')[1]) || 145, lo:0.6, hi:1.5},
    {label:'NTG', key:'ntg', baseVal:0.62, lo:0.7, hi:1.4},
    {label:'Porosity œÜ', key:'phi', baseVal:0.18, lo:0.75, hi:1.3},
    {label:'Recovery Factor', key:'rf', baseVal:0.35, lo:0.7, hi:1.45},
    {label:'Water Sat. Sw', key:'sw', baseVal:0.28, lo:0.85, hi:1.25},
  ];
  const base = 387;
  const sensData = SENS_PARAMS.map(p=>({
    label: p.label,
    low:  Math.round(base * p.lo),
    high: Math.round(base * p.hi)
  })).sort((a,b)=>(b.high-b.low)-(a.high-a.low));

  const padL=8, padR=8, padT=28, padB=28;
  const plotW = W - padL - padR;
  const nBars = sensData.length;
  const barH = Math.floor((H - padT - padB - (nBars-1)*8) / nBars);
  const maxRange = Math.max(...sensData.map(v=>v.high-v.low)) * 1.1;
  const cx = padL + plotW / 2;

  // Title
  ctx.fillStyle='#8896A5'; ctx.font='bold 9px Arial'; ctx.textAlign='center';
  ctx.fillText('‚Üê Low Case   |   High Case ‚Üí', cx, 14);

  // Center dashed line
  ctx.strokeStyle='#CBD5E0'; ctx.lineWidth=1; ctx.setLineDash([3,3]);
  ctx.beginPath(); ctx.moveTo(cx, padT-4); ctx.lineTo(cx, H-padB+4); ctx.stroke();
  ctx.setLineDash([]);

  sensData.forEach((v,i) => {
    const y = padT + i * (barH + 8);
    const halfW = (v.high - v.low) / 2 / maxRange * (plotW / 2);

    // Low (red) bar ‚Äî left of center
    ctx.fillStyle = 'rgba(217,48,37,.6)';
    ctx.beginPath(); ctx.roundRect(cx - halfW, y, halfW, barH, 2); ctx.fill();
    // High (green) bar ‚Äî right of center
    ctx.fillStyle = 'rgba(0,135,90,.6)';
    ctx.beginPath(); ctx.roundRect(cx, y, halfW, barH, 2); ctx.fill();

    // Parameter label ‚Äî centered in bar
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 9px Arial';
    ctx.textAlign = 'center';
    const labelY = y + barH / 2 + 3;
    ctx.fillText(v.label, cx, labelY);

    // Value labels outside bars
    ctx.font = '8px Arial';
    ctx.fillStyle = '#D93025'; ctx.textAlign = 'right';
    ctx.fillText(v.low, cx - halfW - 3, labelY);
    ctx.fillStyle = '#00875A'; ctx.textAlign = 'left';
    ctx.fillText(v.high, cx + halfW + 3, labelY);
  });

  // Bottom axis label
  ctx.fillStyle = '#8896A5'; ctx.font = '8px Arial'; ctx.textAlign = 'center';
  ctx.fillText('STOIIP (MMbbl)', cx, H - 4);
}

function renderSensSliders() {
  const el = document.getElementById('sens-sliders');
  if (!el || el.dataset.built) return;
  el.dataset.built='1';
  const params = [
    {label:'GRV',unit:'km¬≥',val:145,min:50,max:300},
    {label:'NTG',unit:'frac',val:0.62,min:0.2,max:1.0,step:0.01},
    {label:'Porosity œÜ',unit:'frac',val:0.18,min:0.05,max:0.4,step:0.01},
    {label:'Sw',unit:'frac',val:0.28,min:0.1,max:0.7,step:0.01},
    {label:'Recovery Factor',unit:'frac',val:0.35,min:0.1,max:0.65,step:0.01},
  ];
  el.innerHTML = params.map(p=>`
    <div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <span style="font-size:10px;font-weight:600;color:var(--t2)">${p.label}</span>
        <span style="font-size:10px;color:var(--purple);font-weight:700" id="sv-${p.label}">${p.val} ${p.unit}</span>
      </div>
      <input type="range" class="slider" min="${p.min}" max="${p.max}" value="${p.val}" step="${p.step||1}"
        oninput="document.getElementById('sv-${p.label}').textContent=this.value+' ${p.unit}';renderTornado();renderSpider()">
    </div>`).join('');
}

function renderSpider() {
  const canvas = document.getElementById('spider-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#FAFBFF'; ctx.fillRect(0,0,W,H);

  const params = ['GRV','NTG','Porosity','RF','Sw'];
  const baseVals = [100,100,100,100,100];
  const lowVals  = [60,65,72,68,85];
  const highVals = [150,135,125,140,115];

  const padL=60, padR=120, padT=40, padB=50;
  const plotW = W - padL - padR;
  const plotH = H - padT - padB;
  const n = params.length;

  // Y-axis grid lines
  [60,80,100,120,140].forEach(yv => {
    const y = padT + plotH - (yv/200)*plotH;
    ctx.strokeStyle = yv===100 ? 'rgba(107,70,193,.25)' : '#E8ECF5';
    ctx.lineWidth = yv===100 ? 1.5 : 0.8;
    ctx.setLineDash(yv===100 ? [] : [3,3]);
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL+plotW, y); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='#A0AEC0'; ctx.font='9px Arial'; ctx.textAlign='right';
    ctx.fillText(yv+'%', padL-6, y+3);
  });

  // Draw lines
  const cols   = ['#D93025','#6B46C1','#00875A'];
  const widths = [1.5, 2.5, 1.5];
  const dashes = [[5,3],[],[5,3]];
  const rows   = [lowVals, baseVals, highVals];
  const lbls   = ['P10 (Low)','P50 (Base)','P90 (High)'];

  rows.forEach((row, ri) => {
    ctx.beginPath();
    ctx.strokeStyle = cols[ri];
    ctx.lineWidth = widths[ri];
    ctx.setLineDash(dashes[ri]);
    row.forEach((v,i) => {
      const x = padL + i * plotW/(n-1);
      const y = padT + plotH - (v/200)*plotH;
      i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    });
    ctx.stroke(); ctx.setLineDash([]);
    // Dots
    row.forEach((v,i) => {
      const x = padL + i * plotW/(n-1);
      const y = padT + plotH - (v/200)*plotH;
      ctx.beginPath(); ctx.arc(x,y, ri===1?5:3.5, 0, Math.PI*2);
      ctx.fillStyle = cols[ri]; ctx.fill();
      // Value label above/below dot for P50
      if (ri===1) {
        ctx.fillStyle='#6B46C1'; ctx.font='bold 9px Arial'; ctx.textAlign='center';
        ctx.fillText(v+'%', x, y-9);
      }
    });
  });

  // X-axis parameter labels
  params.forEach((p,i) => {
    const x = padL + i * plotW/(n-1);
    const y = padT + plotH + 18;
    ctx.fillStyle='#2D3748'; ctx.font='bold 11px Arial'; ctx.textAlign='center';
    ctx.fillText(p, x, y);
  });

  // Y-axis title
  ctx.save();
  ctx.translate(14, padT + plotH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillStyle='#8896A5'; ctx.font='10px Arial'; ctx.textAlign='center';
  ctx.fillText('STOIIP as % of P50 Base', 0, 0);
  ctx.restore();

  // Legend (right side)
  lbls.forEach((l,i) => {
    const ly = padT + 10 + i*22;
    ctx.strokeStyle = cols[i]; ctx.lineWidth = i===1?2.5:1.5;
    ctx.setLineDash(dashes[i]);
    ctx.beginPath(); ctx.moveTo(W-padR+10, ly+5); ctx.lineTo(W-padR+36, ly+5); ctx.stroke();
    ctx.setLineDash([]);
    ctx.beginPath(); ctx.arc(W-padR+23, ly+5, i===1?4:3, 0, Math.PI*2);
    ctx.fillStyle=cols[i]; ctx.fill();
    ctx.fillStyle='#2D3748'; ctx.font='10px Arial'; ctx.textAlign='left';
    ctx.fillText(l, W-padR+42, ly+9);
  });
}

function calcVolume() {
  const grv = parseFloat(document.getElementById('vi-grv')?.value) || 0;
  const ntg = parseFloat(document.getElementById('vi-ntg')?.value) || 0.62;
  const phi = parseFloat(document.getElementById('vi-phi')?.value) || 0.18;
  const sw  = parseFloat(document.getElementById('vi-sw')?.value)  || 0.28;
  const bo  = parseFloat(document.getElementById('vi-bo')?.value)  || 1.32;
  const rf  = parseFloat(document.getElementById('vi-rf')?.value)  || 0.35;
  const bg  = parseFloat(document.getElementById('vi-bg')?.value)  || 0.004;
  const phase = document.getElementById('vi-phase')?.value || 'oil';
  // STOIIP in MMbbl: GRV(km¬≥)*1e9 m¬≥ * NTG * phi * (1-Sw) / Bo * 6.2898e-6
  const hcPV = grv * 1e9 * ntg * phi * (1 - sw);
  const stoiip = hcPV / bo * 6.2898e-6;
  const giip   = hcPV / bg * 1e-6; // Bcf
  const p50 = Math.round(stoiip);
  const p10 = Math.round(stoiip * 0.37);
  const p90 = Math.round(stoiip * 2.38);
  const eur  = Math.round(stoiip * rf);
  const el = document.getElementById('vol-stoiip');
  if (el) el.textContent = p50.toLocaleString();
  const ep10 = document.getElementById('vol-p10'); if(ep10) ep10.textContent=p10.toLocaleString();
  const ep50 = document.getElementById('vol-p50'); if(ep50) ep50.textContent=p50.toLocaleString();
  const ep90 = document.getElementById('vol-p90'); if(ep90) ep90.textContent=p90.toLocaleString();
  const eel = document.getElementById('vol-eur'); if(eel) eel.querySelector('div:last-child').textContent = eur.toLocaleString() + ' MMbbl';
}

function renderVolSens() {
  const canvas = document.getElementById('vol-sens-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d'), W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H); ctx.fillStyle='#FAFBFF'; ctx.fillRect(0,0,W,H);
  const params=['GRV ¬±30%','NTG ¬±25%','œÜ ¬±20%','Sw ¬±15%','RF ¬±20%'];
  const impacts=[92,68,54,38,55];
  const bw=(W-80)/params.length;
  params.forEach((p,i)=>{
    const bh=(impacts[i]/100)*(H-50), x=40+i*bw, y=H-35-bh;
    ctx.fillStyle=`rgba(107,70,193,${0.3+impacts[i]/150})`;
    ctx.fillRect(x+4,y,bw-8,bh);
    ctx.fillStyle='#4A5568'; ctx.font='9px Arial'; ctx.textAlign='center';
    ctx.fillText(p,x+bw/2,H-12);
    ctx.fillStyle='#6B46C1'; ctx.font='bold 9px Arial';
    ctx.fillText('¬±'+impacts[i]+'%',x+bw/2,y-4);
  });
  ctx.fillStyle='#8896A5'; ctx.font='8px Arial'; ctx.textAlign='left'; ctx.fillText('STOIIP impact (%)',4,12);
}

// ============================================================
// Sensitivity Analysis ‚Äî PDF + CSV exports
// ============================================================
// exportSens() below exports CSV; exportSensPDF() exports a formatted PDF report

// ============================================================
// BASIN PROFILE
// ============================================================
function populateBasinProfileSelect() {
  const sel = document.getElementById('bp-basin-select');
  if (!sel || sel.options.length > 1) return;
  BASINS.slice(0,30).forEach(b=>{
    const opt=document.createElement('option'); opt.value=b.name; opt.textContent=b.name+' ('+b.country+')'; sel.appendChild(opt);
  });
}

function filterBpSelect(q) {
  const sel = document.getElementById('bp-basin-select');
  if (!sel) return;
  const opts = BASINS.map(b => `<option value="${b.name}">${b.name}</option>`);
  // Filter options
  const filtered = q ? BASINS.filter(b => b.name.toLowerCase().includes(q.toLowerCase()) || b.region.toLowerCase().includes(q.toLowerCase())) : BASINS;
  sel.innerHTML = '<option value="">Choose a basin‚Ä¶</option>' + filtered.map(b => `<option value="${b.name}">${b.name} ‚Äî ${b.region}</option>`).join('');
}

function renderBasinProfile(name) {
  if (!name) return;
  const b = BASINS.find(x => x.name === name);
  if (!b) return;
  const sc = b.score;
  const c = sc >= 70 ? 'var(--green)' : sc >= 40 ? 'var(--amber)' : 'var(--red)';
  const screenB = leaderboardData.find(x => x.name === name);
  const gcos = screenB ? estimateGCoS(screenB.scores) : Math.round(sc * 0.28);

  // Generate pseudo-deterministic play/risk data from basin score
  const seed = name.length;
  const R = (min,max,off=0) => Math.round(min + ((seed*17+off*31)%(max-min+1)));
  
  // Petroleum system elements
  const psElements = [
    { name:'Source Rock', present: R(0,1,1)?'Confirmed':'Inferred', quality: R(3,5,2) === 5 ? 'Excellent' : R(3,5,2) === 4 ? 'Good' : 'Fair', age: b.age.split('‚Äì')[0], toc: (sc/100*3.2+0.5).toFixed(1), ro: (0.55+sc/100*0.5).toFixed(2) },
    { name:'Reservoir', present: sc>40?'Confirmed':'Inferred', quality: sc>=70?'Good‚ÄìExcellent':sc>=50?'Fair‚ÄìGood':'Fair', porosity: R(14,30,3), perm: R(50,800,4) },
    { name:'Seal', present: sc>50?'Confirmed':'Inferred', quality: sc>=70?'Good':sc>=50?'Fair‚ÄìGood':'Fair', type: ['Evaporite','Mudstone','Shale','Claystone'][seed%4] },
    { name:'Trap', present: sc>45?'Confirmed':'Inferred', quality: sc>=70?'Good':sc>=45?'Fair‚ÄìGood':'Fair', type: ['Structural','Stratigraphic','Combined','Structural-Dip'][seed%4] },
    { name:'Migration', present: 'Inferred', quality: sc>=65?'Good':'Fair', carrier: ['Fault plane','Unconformity','Carrier bed','Lateral migration'][(seed+1)%4] },
    { name:'Timing', present: sc>=60?'Confirmed':'Inferred', quality: sc>=70?'Favourable':'Uncertain', timing: ['Pre-trap','Syn-trap','Post-trap'][seed%3] },
  ];

  const playData = [
    { name: b.hc + ' Play A', type: 'Structural', resources: R(200,2000,1) + ' MMboe', gcos: R(15,35,2) + '%', status:'Active' },
    { name: b.hc + ' Play B', type: 'Stratigraphic', resources: R(50,500,3) + ' MMboe', gcos: R(8,22,4) + '%', status: b.status==='Frontier'?'Frontier':'Active' },
    { name: 'Deeper Play', type: 'Combination', resources: R(100,800,5) + ' MMboe', gcos: R(5,18,6) + '%', status:'Frontier' },
  ];

  // Risk matrix scores ‚Äî if screening has run use those, otherwise generate
  const riskScores = screenB ? screenB.scores : {
    source: R(40,90,1), reservoir: R(50,95,2), seal: R(40,85,3),
    charge: R(45,85,4), commercial: R(35,80,5), country: R(50,95,6)
  };

  document.getElementById('bp-content').innerHTML = `
    <!-- Header banner -->
    <div style="background:linear-gradient(135deg,var(--sb),var(--sb2));border-radius:10px;padding:20px 24px;margin-bottom:16px;display:flex;align-items:center;gap:20px">
      <div style="flex:1">
        <div style="font-size:18px;font-weight:800;color:#fff;margin-bottom:4px">${b.name}</div>
        <div style="font-size:11px;color:rgba(255,255,255,.65)">${b.country} ¬∑ ${b.region} ¬∑ ${b.tectonic}</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <span class="badge" style="background:rgba(255,255,255,.15);color:#fff;font-size:9px">${b.hc}</span>
          <span class="badge" style="background:rgba(255,255,255,.12);color:rgba(255,255,255,.8);font-size:9px">${b.status}</span>
          <span class="badge" style="background:rgba(255,255,255,.12);color:rgba(255,255,255,.8);font-size:9px">${b.age}</span>
        </div>
      </div>
      <div style="display:flex;gap:24px;text-align:center">
        <div><div style="font-size:32px;font-weight:700;color:${c};line-height:1">${sc}</div><div style="font-size:8px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:1px">Prospectivity</div></div>
        <div><div style="font-size:32px;font-weight:700;color:${gcos>=25?'#00E5A0':gcos>=15?'#F0A500':'#FF4D6A'};line-height:1">${gcos}%</div><div style="font-size:8px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:1px">GCoS Est.</div></div>
        <div><div style="font-size:32px;font-weight:700;color:#fff;line-height:1">${b.plays}</div><div style="font-size:8px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:1px">Plays</div></div>
        <div><div style="font-size:20px;font-weight:700;color:#fff;line-height:1">${screenB?'#'+screenB.rank:'‚Äî'}</div><div style="font-size:8px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:1px">Rank</div></div>
      </div>
    </div>

    <!-- Row 1: Petroleum System + Risk -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
      <div class="card">
        <div class="ch"><span class="ct">Petroleum System Elements</span><span style="font-size:9px;color:var(--t3)">SPE-PRMS Framework</span></div>
        <div class="cb" style="padding:0">
          ${psElements.map(el => `
            <div style="display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid #F0F4FA">
              <div style="width:18px;height:18px;border-radius:50%;background:${el.present==='Confirmed'?'rgba(0,135,90,.15)':'rgba(192,120,0,.12)'};display:flex;align-items:center;justify-content:center;flex-shrink:0">
                <span style="font-size:9px;color:${el.present==='Confirmed'?'var(--green)':'var(--amber)'}">${el.present==='Confirmed'?'‚úì':'~'}</span>
              </div>
              <div style="flex:1">
                <div style="font-size:11px;font-weight:600;color:var(--t1)">${el.name}</div>
                <div style="font-size:9px;color:var(--t3)">${el.present} ¬∑ ${el.quality}
                  ${el.toc?` ¬∑ TOC ${el.toc}% ¬∑ Ro ${el.ro}%`:''}
                  ${el.porosity?` ¬∑ œÜ ${el.porosity}% ¬∑ k ${el.perm} mD`:''}
                  ${el.type&&el.name==='Seal'?` ¬∑ ${el.type} seal`:''}
                  ${el.type&&el.name==='Trap'?` ¬∑ ${el.type}`:''}
                  ${el.carrier?` ¬∑ ${el.carrier}`:''}
                  ${el.timing?` ¬∑ ${el.timing}`:''}
                </div>
              </div>
              <span class="badge ${el.present==='Confirmed'?'be':'bg'}">${el.present}</span>
            </div>`).join('')}
        </div>
      </div>

      <div class="card">
        <div class="ch"><span class="ct">Risk Scoring</span><span style="font-size:9px;color:var(--t3)">${screenB?'Screened results':'Estimated'}</span></div>
        <div class="cb">
          ${Object.entries(riskScores).map(([k,v]) => {
            const labels = {source:'Source Rock Quality',reservoir:'Reservoir Quality',seal:'Seal Integrity',charge:'Charge Efficiency',commercial:'Commercial Attractiveness',country:'Country / Political Risk'};
            const vv = Math.min(v,100);
            const col = vv>=70?'var(--green)':vv>=40?'var(--amber)':'var(--red)';
            return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <div style="width:130px;font-size:10px;color:var(--t2);flex-shrink:0">${labels[k]||k}</div>
              <div style="flex:1;height:8px;background:#E8ECF5;border-radius:4px"><div style="height:100%;width:${vv}%;background:${col};border-radius:4px;transition:width .4s"></div></div>
              <div style="font-size:11px;font-weight:700;color:${col};width:26px;text-align:right">${vv}</div>
            </div>`;
          }).join('')}
          <div style="margin-top:10px;padding:10px 12px;background:${gcos>=25?'rgba(0,135,90,.06)':gcos>=15?'rgba(192,120,0,.06)':'rgba(217,48,37,.06)'};border-radius:6px;border:1px solid ${gcos>=25?'rgba(0,135,90,.2)':gcos>=15?'rgba(192,120,0,.2)':'rgba(217,48,37,.2)'}">
            <div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--t3)">Geological Chance of Success (GCoS)</div>
            <div style="font-size:24px;font-weight:700;color:${gcos>=25?'var(--green)':gcos>=15?'var(--amber)':'var(--red)'}">~${gcos}%</div>
            <div style="font-size:9px;color:var(--t3)">P<sub>source</sub> √ó P<sub>reservoir</sub> √ó P<sub>seal</sub> √ó P<sub>charge</sub> √ó P<sub>commercial</sub></div>
          </div>
          <canvas id="bp-radar-canvas" width="240" height="180" style="width:100%;max-width:240px;display:block;margin:12px auto 0"></canvas>
        </div>
      </div>
    </div>

    <!-- Row 2: Play inventory + Key Facts -->
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-bottom:14px">
      <div class="card">
        <div class="ch"><span class="ct">Identified Play Inventory</span><button class="btn2" style="font-size:9px;padding:4px 10px" onclick="toast('Play inventory exported to Excel','success')">Export</button></div>
        <div class="cb" style="padding:0;overflow-x:auto">
          <table>
            <thead><tr><th>Play</th><th>Play Type</th><th>P50 Resources</th><th>GCoS Est.</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>
              ${playData.map(p => `<tr>
                <td style="font-weight:600;color:var(--t1)">${p.name}</td>
                <td><span class="badge bg">${p.type}</span></td>
                <td style="font-weight:600;color:var(--purple)">${p.resources}</td>
                <td style="color:var(--amber);font-weight:600">${p.gcos}</td>
                <td><span class="tl ${p.status==='Active'?'tl-g':'tl-a'}">${p.status}</span></td>
                <td><button class="btn2" style="font-size:9px;padding:3px 8px" onclick="toast('Loading play details for ${p.name}','info')">Details</button></td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="ch"><span class="ct">Basin Factfile</span></div>
        <div class="cb" style="padding:10px">
          ${[
            ['Country / Region', `${b.country} ¬∑ ${b.region}`],
            ['Tectonic Setting', b.tectonic],
            ['Geological Age', b.age],
            ['HC Phase', b.hc],
            ['Basin Area', b.area.toLocaleString() + ' km¬≤'],
            ['Active Plays', b.plays],
            ['Exploration Status', b.status],
            ['Source System', psElements[0].quality + ' (TOC ~' + psElements[0].toc + '%)'],
            ['Primary Reservoir', psElements[1].quality + ' ¬∑ œÜ ~' + psElements[1].porosity + '%'],
          ].map(([k,v]) => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #F0F4FA">
              <span style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">${k}</span>
              <span style="font-size:10px;font-weight:600;color:var(--t1)">${v}</span>
            </div>`).join('')}
          <div style="display:flex;gap:7px;margin-top:12px">
            <button class="btn" style="flex:1;font-size:9px;padding:6px" onclick="goTo('analogues',null);toast('Searching for analogues for ${b.name}','info')">Find Analogues ‚Üí</button>
            <button class="btn2" style="font-size:9px;padding:6px 10px" onclick="exportBasinProfile()">PDF</button>
          </div>
        </div>
      </div>
    </div>`;
  setTimeout(() => drawBPRadar(b, screenB), 60);
}

function drawBPRadar(b, screenB) {
  const canvas=document.getElementById('bp-radar-canvas');
  if(!canvas) return;
  const ctx=canvas.getContext('2d'), W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);
  const cx=W/2, cy=H/2+5, r=Math.min(W,H)*0.37;
  const labels=['Source Rock','Reservoir','Seal','Trap','Migration','Commercial'];
  const n=labels.length;
  const angle=i=>-Math.PI/2+(2*Math.PI*i/n);
  const scores=screenB?[screenB.scores.source,screenB.scores.reservoir,screenB.scores.seal,screenB.scores.charge,screenB.scores.commercial,screenB.scores.country]:[65,70,60,55,72,68];
  // Web
  [0.25,0.5,0.75,1].forEach(p=>{
    ctx.beginPath(); ctx.strokeStyle='#E2E8F0'; ctx.lineWidth=1;
    labels.forEach((_,i)=>{const a=angle(i),x=cx+Math.cos(a)*r*p,y=cy+Math.sin(a)*r*p; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}); ctx.closePath(); ctx.stroke();
  });
  labels.forEach((_,i)=>{const a=angle(i); ctx.beginPath(); ctx.strokeStyle='#CBD5E0'; ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(a)*r,cy+Math.sin(a)*r); ctx.stroke();});
  // Data
  ctx.beginPath(); ctx.strokeStyle='rgba(107,70,193,.9)'; ctx.fillStyle='rgba(107,70,193,.15)'; ctx.lineWidth=2;
  scores.forEach((v,i)=>{const a=angle(i),pct=v/100,x=cx+Math.cos(a)*r*pct,y=cy+Math.sin(a)*r*pct; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}); ctx.closePath(); ctx.fill(); ctx.stroke();
  // Labels
  ctx.fillStyle='#4A5568'; ctx.font='8px Arial'; ctx.textAlign='center';
  labels.forEach((l,i)=>{const a=angle(i); ctx.fillText(l,cx+Math.cos(a)*(r+14),cy+Math.sin(a)*(r+14));});
}

// exportBasinProfile is defined in PDF engine above

// ============================================================
// SCREENING
// ============================================================
function renderScreenCriteria() {
  SCREEN_CRITERIA.forEach(c => { screenVals[c.key] = c.val; });
  document.getElementById('screen-criteria').innerHTML = SCREEN_CRITERIA.map(c =>
    `<div style="background:var(--bg4);border:1px solid var(--b1);border-radius:6px;padding:11px 13px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px">
        <span style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t2)">${c.label}</span>
        <span style="font-size:14px;font-weight:700;color:var(--cyan)" id="sw-${c.key}">${c.val}%</span>
      </div>
      <input type="range" class="slider" min="0" max="50" value="${c.val}" oninput="updateScreen('${c.key}',+this.value)">
    </div>`
  ).join('');
}

function updateScreen(key, val) {
  screenVals[key] = val;
  document.getElementById('sw-' + key).textContent = val + '%';
}

function runScreening() {
  const btn = document.getElementById('screen-btn');
  const status = document.getElementById('screen-status');
  btn.textContent = 'Running screening‚Ä¶';
  btn.disabled = true;
  status.textContent = 'Scoring 612 basins‚Ä¶';
  loadBar();
  let prog = 0;
  const iv = setInterval(() => {
    prog += Math.random() * 15;
    if (prog >= 100) {
      clearInterval(iv);
      btn.textContent = 'Run Screening ‚Äî 612 Basins';
      btn.disabled = false;
      status.textContent = '612 basins scored';
      leaderboardData = BASINS.map(b => ({
        ...b,
        scores: {
          source: Math.round(b.score * (0.8 + Math.random() * 0.4)),
          reservoir: Math.round(b.score * (0.85 + Math.random() * 0.3)),
          seal: Math.round(b.score * (0.75 + Math.random() * 0.5)),
          charge: Math.round(b.score * (0.8 + Math.random() * 0.4)),
          commercial: Math.round(b.score * (0.7 + Math.random() * 0.6)),
          country: Math.round(b.score * (0.9 + Math.random() * 0.2)),
        }
      })).map(b => {
        const w = screenVals;
        const tot = Object.values(w).reduce((s, v) => s + v, 0) || 1;
        const composite = Math.round(Object.entries(b.scores).reduce((s, [k, v]) => s + v * (w[k] || 15) / tot, 0));
        return {...b, composite};
      }).sort((a, b) => b.composite - a.composite).map((b, i) => ({...b, rank: i + 1}));
      renderLeaderboard();
      document.getElementById('screen-results').style.display = 'block';
      toast(`Screening complete ‚Äî ${leaderboardData.length} basins ranked`, 'success');
    } else {
      status.textContent = `Scoring ${Math.round(prog * 6.12)} of 612 basins‚Ä¶`;
    }
  }, 60);
}

function renderLeaderboard() {
  if (!leaderboardData.length) return;
  document.getElementById('lb-not-run').style.display = 'none';
  document.getElementById('screen-results').style.display = 'block';
  document.getElementById('screen-result-title').textContent = `Basin Leaderboard ‚Äî ${leaderboardData.length} Basins Ranked`;
  renderLbKpis();
  renderLbPodium();
  renderLeaderboardTable(leaderboardData);
}

function renderLbKpis() {
  const high = leaderboardData.filter(b => b.composite >= 70).length;
  const med  = leaderboardData.filter(b => b.composite >= 40 && b.composite < 70).length;
  const low  = leaderboardData.filter(b => b.composite < 40).length;
  const avgGcos = Math.round(leaderboardData.slice(0,5).reduce((s,b) => s + estimateGCoS(b.scores), 0) / Math.min(5, leaderboardData.length));
  document.getElementById('lb-kpis').innerHTML = `
    <div class="kpi e" style="text-align:center">
      <div class="kpi-lbl">High Priority</div>
      <div class="kpi-val" style="color:var(--green)">${high}</div>
      <div class="kpi-sub">Score ‚â• 70</div>
    </div>
    <div class="kpi g" style="text-align:center">
      <div class="kpi-lbl">Medium Priority</div>
      <div class="kpi-val" style="color:var(--gold)">${med}</div>
      <div class="kpi-sub">Score 40‚Äì69</div>
    </div>
    <div class="kpi r" style="text-align:center">
      <div class="kpi-lbl">Low Priority</div>
      <div class="kpi-val" style="color:var(--red)">${low}</div>
      <div class="kpi-sub">Score < 40</div>
    </div>
    <div class="kpi c" style="text-align:center">
      <div class="kpi-lbl">Avg GCoS (Top 5)</div>
      <div class="kpi-val" style="color:var(--cyan)">${avgGcos}%</div>
      <div class="kpi-sub">Geological success est.</div>
    </div>`;
}

function estimateGCoS(scores) {
  // GCoS = Ps √ó Pr √ó Pse √ó Pt √ó Pm  (5 independent probabilities)
  const s = scores||{};
  const ps  = Math.min((s.source||50)/100, 0.95);
  const pr  = Math.min((s.reservoir||50)/100, 0.95);
  const pse = Math.min((s.seal||50)/100, 0.95);
  const pt  = Math.min((s.charge||50)/100, 0.95);
  const pm  = Math.min((s.commercial||50)/100 * 0.9, 0.95);
  return Math.round(ps * pr * pse * pt * pm * 100);
}

function renderLbPodium() {
  const top = leaderboardData.slice(0, 3);
  const medals = ['ü•á','ü•à','ü•â'];
  const heights = ['120px','96px','80px'];
  const colors = ['#F0A500','#8896A5','#C07800'];
  const order = [1,0,2]; // 2nd left, 1st center, 3rd right
  document.getElementById('lb-podium').innerHTML = order.map(i => {
    const b = top[i];
    if (!b) return '';
    const c = b.composite >= 70 ? 'var(--green)' : b.composite >= 40 ? 'var(--amber)' : 'var(--red)';
    const gcos = estimateGCoS(b.scores);
    return `
      <div style="display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer" onclick="switchScreenTab('profiles',document.querySelectorAll('#screen-tabs .tab')[2]);setTimeout(()=>{document.getElementById('bp-basin-select').value='${b.name}';renderBasinProfile('${b.name}')},50)">
        <div style="text-align:center;max-width:140px">
          <div style="font-size:12px;font-weight:700;color:var(--t1);margin-bottom:2px;line-height:1.3">${b.name}</div>
          <div style="font-size:9px;color:var(--t3)">${b.region}</div>
        </div>
        <div style="font-size:28px;font-weight:700;color:${c};line-height:1">${b.composite}</div>
        <div style="font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Composite</div>
        <div style="background:${colors[i]};color:#fff;font-size:9px;font-weight:700;padding:2px 8px;border-radius:3px">GCoS ~${gcos}%</div>
        <div style="width:100px;height:${heights[i]};background:linear-gradient(to top,${c}33,${c}11);border:2px solid ${c};border-bottom:none;border-radius:4px 4px 0 0;display:flex;align-items:flex-end;justify-content:center;padding-bottom:6px">
          <span style="font-size:10px;font-weight:700;color:${c}">#${b.rank}</span>
        </div>
      </div>`;
  }).join('');
}

function renderLeaderboardTable(data) {
  const tierF = document.getElementById('lb-tier-filter')?.value || '';
  let filtered = data;
  if (tierF) {
    filtered = data.filter(b => {
      if (tierF==='HIGH') return b.composite >= 70;
      if (tierF==='MED')  return b.composite >= 40 && b.composite < 70;
      if (tierF==='LOW')  return b.composite < 40;
      return true;
    });
  }
  const show = filtered.slice(0, 20);
  const ct = document.getElementById('lb-showing-count');
  if (ct) ct.textContent = `Showing ${show.length} of ${filtered.length} basins`;
  document.getElementById('screen-tbody').innerHTML = show.map(b => {
    const c = b.composite >= 70 ? 'var(--green)' : b.composite >= 40 ? 'var(--amber)' : 'var(--red)';
    const tl = b.composite >= 70 ? 'tl-g' : b.composite >= 40 ? 'tl-a' : 'tl-r';
    const tlTxt = b.composite >= 70 ? 'üü¢ HIGH' : b.composite >= 40 ? 'üü° MEDIUM' : 'üî¥ LOW';
    const gcos = estimateGCoS(b.scores);
    const rankIcon = b.rank===1?'':b.rank===2?'':b.rank===3?'':'';
    return `<tr onclick="switchScreenTab('profiles',document.querySelectorAll('#screen-tabs .tab')[2]);setTimeout(()=>{document.getElementById('bp-basin-select').value='${b.name}';renderBasinProfile('${b.name}')},50)" style="cursor:pointer" title="View full profile for ${b.name}">
      <td><span style="font-weight:700;color:${b.rank<=3?'var(--gold)':'var(--t3)'}">${rankIcon||b.rank}</span></td>
      <td><span style="font-weight:700;color:var(--purple)">${b.name}</span></td>
      <td style="color:var(--t2)">${b.country}</td>
      <td style="color:var(--t3);font-size:10px">${b.region}</td>
      <td><span class="badge ${b.hc==='Gas'?'bc':b.hc==='Oil & Gas'?'bg':'be'}">${b.hc}</span></td>
      ${['source','reservoir','seal','charge','commercial','country'].map(k => {
        const v = Math.min(b.scores[k]||0, 100);
        const col = v>=70?'var(--green)':v>=40?'var(--amber)':'var(--red)';
        return `<td><div style="display:flex;align-items:center;gap:5px"><div style="width:40px;height:4px;background:#E8ECF5;border-radius:2px"><div style="width:${v}%;height:100%;background:${col};border-radius:2px"></div></div><span style="font-size:10px;font-weight:700;color:${col}">${v}</span></div></td>`;
      }).join('')}
      <td><span style="font-size:11px;font-weight:700;color:${gcos>=25?'var(--green)':gcos>=15?'var(--amber)':'var(--red)'}">${gcos}%</span></td>
      <td><div style="display:flex;align-items:center;gap:6px"><div style="width:60px;height:6px;background:#E8ECF5;border-radius:3px"><div style="width:${b.composite}%;height:100%;background:${c};border-radius:3px"></div></div><span style="font-weight:700;color:${c}">${b.composite}</span></div></td>
      <td><span class="tl ${tl}" style="font-size:9px">${tlTxt}</span></td>
    </tr>`;
  }).join('');
}

function filterLeaderboard(q) {
  if (!leaderboardData.length) return;
  const regionF = document.getElementById('lb-region-filter')?.value || '';
  let filtered = leaderboardData.filter(b => {
    const qMatch = !q || b.name.toLowerCase().includes(q.toLowerCase()) || b.region.toLowerCase().includes(q.toLowerCase()) || (b.country||'').toLowerCase().includes(q.toLowerCase());
    const rMatch = !regionF || b.region === regionF;
    return qMatch && rMatch;
  });
  renderLeaderboardTable(filtered);
}

function saveScreenConfig() { toast('Screening configuration saved', 'success'); }
function loadScreenConfig() {
  SCREEN_CRITERIA.forEach(c => {
    screenVals[c.key] = c.val;
    const input = document.querySelector(`[oninput*="'${c.key}'"]`);
    if (input) { input.value = c.val; document.getElementById('sw-' + c.key).textContent = c.val + '%'; }
  });
  toast('Default configuration loaded', 'success');
}

function initDefaultLeaderboard() {
  // Pre-populate leaderboard with default weights so Leaderboard tab shows data on first visit
  SCREEN_CRITERIA.forEach(c => { screenVals[c.key] = c.val; });
  leaderboardData = BASINS.map(b => ({
    ...b,
    scores: {
      source:     Math.min(100, Math.round(b.score * (0.80 + (b.name.length % 5) * 0.04))),
      reservoir:  Math.min(100, Math.round(b.score * (0.85 + (b.name.length % 4) * 0.04))),
      seal:       Math.min(100, Math.round(b.score * (0.75 + (b.name.length % 6) * 0.04))),
      charge:     Math.min(100, Math.round(b.score * (0.82 + (b.name.length % 3) * 0.04))),
      commercial: Math.min(100, Math.round(b.score * (0.70 + (b.name.length % 7) * 0.04))),
      country:    Math.min(100, Math.round(b.score * (0.90 + (b.name.length % 4) * 0.02))),
    }
  })).map(b => {
    const w = screenVals;
    const tot = Object.values(w).reduce((s,v) => s+v, 0) || 1;
    const composite = Math.round(Object.entries(b.scores).reduce((s,[k,v]) => s + v*(w[k]||15)/tot, 0));
    return {...b, composite};
  }).sort((a,b) => b.composite - a.composite).map((b,i) => ({...b, rank: i+1}));
}

// ============================================================
// CSV PARSING UTILITIES
// ============================================================

// Column aliases ‚Äî maps common user column names ‚Üí internal field names
const BASIN_ALIASES = {
  name:        ['name','basin','basin_name','basinname','basin name','title'],
  country:     ['country','nation','countries','location'],
  region:      ['region','area','zone','geography'],
  tectonic:    ['tectonic','tectonic_setting','tectonic setting','setting','type'],
  age:         ['age','geological_age','geological age','period','era','stratigraphic_age'],
  hc:          ['hc','hc_phase','hydrocarbon','hydrocarbon_phase','phase','fluid','fluid_type'],
  area:        ['area','area_km2','area km2','size','basin_area','area_sq_km'],
  plays:       ['plays','play_count','num_plays','number_of_plays','play count'],
  score:       ['score','prospectivity','prospectivity_score','prospect_score','ranking'],
  status:      ['status','exploration_status','maturity','stage'],
};

const ANALOGUE_ALIASES = {
  name:   ['name','formation','formation_name','interval','interval_name','field','field_name'],
  basin:  ['basin','basin_name','basinname'],
  age:    ['age','geological_age','period'],
  lith:   ['lith','lithology','rock_type','lithotype'],
  dep:    ['dep','depositional','dep_env','depositional_environment','environment'],
  depth:  ['depth','depth_m','depth_mtvdss','reservoir_depth','tvdss'],
  hc:     ['hc','hc_phase','fluid','phase','hydrocarbon'],
  drive:  ['drive','drive_mechanism','production_mechanism','mechanism'],
  por:    ['por','porosity','phi','porosity_pct','por_pct','porosity_%'],
  perm:   ['perm','permeability','k','k_md','perm_md','permeability_md'],
  rf:     ['rf','recovery_factor','recovery','rf_pct','recovery_factor_%'],
  ntg:    ['ntg','net_to_gross','net_gross','ntg_pct'],
  gor:    ['gor','gas_oil_ratio','gas_oil_ratio_scf_bbl'],
  api:    ['api','api_gravity','gravity','api_gravity_deg','deg_api'],
};

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) return { headers: [], rows: [] };
  // Detect delimiter
  const firstLine = lines[0];
  const delim = firstLine.split('\t').length > firstLine.split(',').length ? '\t' : ',';
  const parseRow = row => {
    const cells = [];
    let cur = '', inQ = false;
    for (let i = 0; i < row.length; i++) {
      const ch = row[i];
      if (ch === '"') { inQ = !inQ; continue; }
      if (ch === delim && !inQ) { cells.push(cur.trim()); cur = ''; continue; }
      cur += ch;
    }
    cells.push(cur.trim());
    return cells;
  };
  const headers = parseRow(lines[0]).map(h => h.replace(/^"|"$/g,'').toLowerCase().trim());
  const rows = lines.slice(1).map(l => {
    const cells = parseRow(l);
    const obj = {};
    headers.forEach((h, i) => obj[h] = cells[i] !== undefined ? cells[i].replace(/^"|"$/g,'') : '');
    return obj;
  }).filter(r => Object.values(r).some(v => v !== ''));
  return { headers, rows };
}

function detectDataType(headers) {
  const hSet = new Set(headers.map(h => h.toLowerCase()));
  let basinScore = 0, analogueScore = 0;
  Object.values(BASIN_ALIASES).forEach(aliases => aliases.forEach(a => { if (hSet.has(a)) basinScore++; }));
  Object.values(ANALOGUE_ALIASES).forEach(aliases => aliases.forEach(a => { if (hSet.has(a)) analogueScore++; }));
  if (basinScore === 0 && analogueScore === 0) return 'unknown';
  return basinScore >= analogueScore ? 'basin' : 'analogue';
}

function autoMap(headers, aliases) {
  const mapping = {};
  const hLower = headers.map(h => h.toLowerCase());
  Object.entries(aliases).forEach(([field, aliasList]) => {
    for (const alias of aliasList) {
      const idx = hLower.indexOf(alias);
      if (idx !== -1) { mapping[field] = headers[idx]; break; }
    }
  });
  return mapping;
}

function handleDrop(e) {
  e.preventDefault();
  // Legacy: route to basin/analogue auto-detection
  handleFiles(e.dataTransfer.files);
}

function handleFiles(files) {
  // Legacy generic upload ‚Äî auto-detect type
  [...files].forEach(file => {
    const ext = file.name.split('.').pop().toLowerCase();
    if (!['csv','tsv','txt'].includes(ext)) { toast('Only CSV/TSV supported', 'warning'); return; }
    const reader = new FileReader();
    reader.onload = ev => {
      const { headers, rows } = parseCSV(ev.target.result);
      if (!rows.length) { toast(`${file.name}: empty file`, 'warning'); return; }
      const type = detectDataType(headers);
      const aliases = type === 'basin' ? BASIN_ALIASES : ANALOGUE_ALIASES;
      const mapping = autoMap(headers, aliases);
      openMappingModal(file.name, headers, rows, type, mapping);
    };
    reader.readAsText(file);
  });
}

function openMappingModal(fileName, headers, rows, dataType, autoMapping) {
  const fields = dataType === 'basin'
    ? [{f:'name',lbl:'Basin Name',req:true},{f:'country',lbl:'Country'},{f:'region',lbl:'Region'},{f:'tectonic',lbl:'Tectonic Setting'},{f:'age',lbl:'Geological Age'},{f:'hc',lbl:'HC Phase'},{f:'area',lbl:'Area (km¬≤)'},{f:'plays',lbl:'Play Count'},{f:'score',lbl:'Prospectivity Score'},{f:'status',lbl:'Status'}]
    : [{f:'name',lbl:'Formation / Name',req:true},{f:'basin',lbl:'Basin'},{f:'age',lbl:'Age'},{f:'lith',lbl:'Lithology'},{f:'dep',lbl:'Dep. Env.'},{f:'depth',lbl:'Depth (mTVDSS)'},{f:'hc',lbl:'HC Phase'},{f:'drive',lbl:'Drive Mechanism'},{f:'por',lbl:'Porosity %'},{f:'perm',lbl:'Permeability mD'},{f:'rf',lbl:'Recovery Factor %'},{f:'ntg',lbl:'NTG %'},{f:'gor',lbl:'GOR scf/bbl'},{f:'api',lbl:'API Gravity'}];
  // Store data safely ‚Äî never embed rows in onclick
  _pendingTyped = { fileName, rows, dataType, fields: fields.map(x=>x.f) };
  const preview = rows.slice(0,3);
  openModal(`
    <div class="modal-title">Map Columns ‚Äî ${fileName}</div>
    <div class="modal-sub" style="margin-bottom:10px"><strong style="color:var(--cyan)">${rows.length} rows</strong> ¬∑ Data type: <strong style="color:var(--brand2)">${dataType==='basin'?'Basin Catalogue':'Analogue Engine'}</strong></div>
    <div style="background:var(--bg4);border-radius:5px;padding:8px;margin-bottom:12px;overflow-x:auto;max-height:90px">
      <table style="font-size:9px"><thead><tr>${headers.map(h=>`<th style="color:var(--cyan);padding:2px 7px">${h}</th>`).join('')}</tr></thead>
      <tbody>${preview.map(r=>`<tr>${headers.map(h=>`<td style="color:var(--t2);padding:2px 7px">${(r[h]||'').toString().substring(0,30)}</td>`).join('')}</tr>`).join('')}</tbody></table>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;max-height:260px;overflow-y:auto;margin-bottom:14px">
      ${fields.map(({f,lbl,req})=>`
        <div style="display:flex;align-items:center;gap:6px">
          <label style="font-size:10px;color:${req?'var(--brand2)':'var(--t2)'};min-width:110px;flex-shrink:0">${lbl}${req?' *':''}</label>
          <select class="fc" id="map-${f}" style="flex:1;padding:4px;font-size:10px">
            <option value="">‚Äî skip ‚Äî</option>
            ${headers.map(h=>`<option value="${h}" ${autoMapping[f]===h?'selected':''}>${h}</option>`).join('')}
          </select>
        </div>`).join('')}
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="commitIngestion()">‚úì Ingest ${rows.length} Records</button>
      <button class="btn2" onclick="closeModal();_pendingTyped=null">Cancel</button>
    </div>`);
}

function commitIngestion() {
  if (!_pendingTyped) { toast('No pending data', 'warning'); return; }
  const { fileName, rows, dataType, fields: fieldKeys } = _pendingTyped;
  _pendingTyped = null;
  const mapping = {};
  fieldKeys.forEach(f => { const s = document.getElementById('map-'+f); if(s&&s.value) mapping[f]=s.value; });
  if (!mapping.name) { toast('Please map the Name field', 'warning'); return; }
  closeModal();
  let accepted=0, quarantined=0, failed=0;
  rows.forEach(row => {
    try {
      const rec={};
      fieldKeys.forEach(f => {
        if(mapping[f]) {
          let v=row[mapping[f]];
          if(['area','plays','score','depth','por','perm','rf','ntg','gor','api'].includes(f)){v=parseFloat(v);if(isNaN(v))v=null;}
          rec[f]=v;
        }
      });
      if(!rec.name||!rec.name.trim()){failed++;return;}
      if(dataType==='basin') {
        if(BASINS.find(b=>b.name.toLowerCase()===rec.name.toLowerCase())){quarantined++;return;}
        BASINS.push({name:rec.name,country:rec.country||'Unknown',region:rec.region||'Unknown',tectonic:rec.tectonic||'Unknown',age:rec.age||'Unknown',hc:rec.hc||'Oil & Gas',area:rec.area||0,plays:rec.plays||0,score:Math.min(100,Math.max(0,rec.score||50)),status:rec.status||'Active',_source:fileName});
      } else {
        if(ANALOGUES.find(a=>a.name.toLowerCase()===rec.name.toLowerCase())){quarantined++;return;}
        ANALOGUES.push({rank:ANALOGUES.length+1,name:rec.name,basin:rec.basin||'Unknown',age:rec.age||'Unknown',lith:rec.lith||'Sandstone',dep:rec.dep||'Unknown',depth:rec.depth||0,hc:rec.hc||'Oil',drive:rec.drive||'Unknown',por:rec.por||0,perm:rec.perm||0,rf:rec.rf||0,ntg:rec.ntg||0,gor:rec.gor||0,api:rec.api||0,sim:75,_source:fileName});
      }
      accepted++;
    } catch(e){failed++;}
  });
  if(dataType==='basin'){renderBasinTable(BASINS);renderTopBasins();}
  refreshPortfolioKPIs();
  const accEl=document.getElementById('ing-accepted');
  if(accEl) accEl.textContent=(parseInt(accEl.textContent.replace(/,/g,''))+accepted).toLocaleString();
  // Add to governance queue for review
  INGESTED_FILES.push({
    id:'FILE-'+Date.now(),
    name:fileName,
    records:accepted,
    datasetType:dataType==='basin'?'Basin':'Analogue',
    source:'Manual Upload',
    age:'Just now',
    status:'pending',
    loadedNames:dataType==='basin'?[...BASINS].slice(-accepted).map(b=>b.name):[...ANALOGUES].slice(-accepted).map(a=>a.name)
  });
  renderGovQueue();
  AUDIT_ENTRIES.unshift({time:now(),user:'VJ',action:`Upload queued for governance: ${fileName} ¬∑ ${accepted} ${dataType} records ¬∑ ${quarantined} dupes ¬∑ ${failed} failed`,status:failed>0?'PARTIAL':'PENDING',type:'Governance'});
  renderAuditLog(AUDIT_ENTRIES);
  addHistoryRow(fileName,accepted,quarantined);
  toast(`${accepted} ${dataType} records ingested from ${fileName}${quarantined?` ¬∑ ${quarantined} dupes skipped`:''}`, accepted>0?'success':'warning');
}

function addHistoryRow(fileName, accepted, quarantined) {
  const wrap = document.getElementById('upload-history');
  if (!wrap) return;
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;align-items:center;gap:9px;padding:7px 9px;background:var(--bg4);border-radius:4px;margin-bottom:5px;font-size:10px';
  div.innerHTML = `<span style="color:${accepted>0?'var(--green)':'var(--amber)'}">${accepted>0?'‚úì':'‚ö†'}</span><span style="color:var(--t1);flex:1">${fileName}</span><span style="color:var(--t3)">${accepted} accepted${quarantined?` ¬∑ ${quarantined} dupes`:''} ¬∑ Just now</span>`;
  // Insert after the header row
  const header = wrap.querySelector('.ing-hist-header');
  if (header) header.after(div);
  else wrap.prepend(div);
}

function renderIngHistory() {
  const wrap = document.getElementById('upload-history');
  if (!wrap) return;
  wrap.innerHTML = `
    <div class="ing-hist-header" style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:8px">Recent Ingestion Activity</div>
    ${[
      {name:'neftex_basin_data_2026-02.csv', type:'Basin', status:'ok', msg:'2,341 records ¬∑ 2h ago'},
      {name:'ihs_reservoir_analogues.csv',   type:'Reservoir', status:'ok', msg:'892 records ¬∑ 6h ago'},
      {name:'cc_geopressure_q1.csv',         type:'Geopressure', status:'warn', msg:'3 duplicates skipped ¬∑ 2d ago'},
      {name:'rystad_geochemistry.csv',       type:'Geochemistry', status:'ok', msg:'412 records ¬∑ 3d ago'},
    ].map(f=>`
      <div style="display:flex;align-items:center;gap:9px;padding:7px 9px;background:var(--bg4);border-radius:4px;margin-bottom:5px;font-size:10px">
        <span style="color:${f.status==='ok'?'var(--green)':'var(--amber)'}">${f.status==='ok'?'‚úì':'‚ö†'}</span>
        <span style="font-size:8px;padding:1px 6px;border-radius:3px;background:rgba(255,107,43,.12);color:var(--brand2)">${f.type}</span>
        <span style="color:var(--t1);flex:1">${f.name}</span>
        <span style="color:var(--t3)">${f.msg}</span>
      </div>`).join('')}
    <div style="margin-top:12px;padding:12px 14px;background:rgba(255,107,43,.04);border:1px solid rgba(255,107,43,.14);border-radius:6px">
      <div style="font-size:9px;color:var(--brand2);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:8px">Download All EDAFY Templates</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px">
        <button class="btn2" style="font-size:9px;padding:5px 8px;text-align:left" onclick="downloadTemplate('basin')">Basin Catalogue</button>
        <button class="btn2" style="font-size:9px;padding:5px 8px;text-align:left" onclick="downloadTemplate('analogue')">Analogue (Base)</button>
        <button class="btn2" style="font-size:9px;padding:5px 8px;text-align:left" onclick="downloadTemplate('reservoir')">Reservoir Props</button>
        <button class="btn2" style="font-size:9px;padding:5px 8px;text-align:left" onclick="downloadTemplate('geopressure')">Geopressure</button>
        <button class="btn2" style="font-size:9px;padding:5px 8px;text-align:left" onclick="downloadTemplate('geochem')">Geochemistry</button>
        <button class="btn2" style="font-size:9px;padding:5px 8px;text-align:left" onclick="downloadTemplate('mineral')">Mineralogy</button>
        <button class="btn2" style="font-size:9px;padding:5px 8px;text-align:left" onclick="downloadTemplate('fluid')">Fluid PVT</button>
        <button class="btn2" style="font-size:9px;padding:5px 8px;text-align:left" onclick="downloadTemplate('diagenesis')">Diagenesis</button>
      </div>
    </div>`;
}

// Connector state
const CONNECTOR_STATE = [
  {key:'neftex', name:'Neftex (Halliburton)', type:'SFTP + Excel Bulk Export', dataTypes:'Stratigraphy, source rock, basin characterization, petroleum systems', status:'connected', freq:'Weekly', lastSync:'2h ago', records:2341, color:'var(--green)', authType:'SFTP Credentials', apiKey:'NX-‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢3F2A',
    schedEnabled:true,
    endpoint:'sftp://data.neftex.com/exports/',
    note:'<strong>How this connection works:</strong> Neftex (Halliburton) delivers licensed basin data via a dedicated SFTP drop-zone that they control. EDAFY does NOT connect directly to Neftex APIs ‚Äî instead, Halliburton exports your licensed datasets (stratigraphy, source rock, basin summary) to an agreed SFTP path on a scheduled basis. EDAFY then polls that SFTP path, ingests the files, and maps them to the PPDM 3.9 / OSDU schema. To set up: (1) Contact your Halliburton account manager for a Neftex Data Delivery Agreement, (2) Request SFTP credentials and confirm the export path, (3) Configure those credentials below.',
    setupSteps:['1. Contact Halliburton/Neftex account manager ‚Äî request a Data Delivery Agreement (DDA)','2. Halliburton will provision SFTP credentials and configure your export package','3. Confirm delivery path and file format (CSV or Excel) with Halliburton support','4. Enter SFTP credentials below and test the connection','5. Select data packages: Stratigraphy, Source Rock, Basin Summary, Petroleum Systems','6. Set weekly delivery schedule ‚Äî EDAFY will auto-ingest files as they arrive on SFTP','7. Review imported records in Governance ‚Üí Ingested Files before publishing']
  },
  {key:'ihs',     name:'IHS Energy / S&P Global', type:'REST API + SFTP', dataTypes:'Well data, production, formations, basin monitor', status:'error', freq:'Weekly', lastSync:'Failed 4h ago', records:0, color:'var(--red)', authType:'OAuth 2.0', apiKey:'', schedEnabled:true},
  {key:'cc',      name:'C&C Reservoirs', type:'SFTP bulk', dataTypes:'Reservoir analogues, production database', status:'connected', freq:'Quarterly', lastSync:'12h ago', records:892, color:'var(--green)', authType:'SFTP Key', apiKey:'CC-‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢8B1D', schedEnabled:false},
  {key:'rystad',  name:'Rystad Energy', type:'REST API (EnRCube)', dataTypes:'Asset economics, production forecasts', status:'connected', freq:'Daily', lastSync:'1h ago', records:412, color:'var(--green)', authType:'API Key', apiKey:'RY-‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢91EC', schedEnabled:true},
  {key:'woodmac', name:'Wood Mackenzie', type:'REST API (Lens API)', dataTypes:'Commercial reserves, asset positions', status:'pending', freq:'Monthly', lastSync:'Not configured', records:0, color:'var(--amber)', authType:'OAuth 2.0', apiKey:'', schedEnabled:false},
];

// ============================================================
// DATA INGESTION ‚Äî 6 DEDICATED TABS
// ============================================================

const ING_META = {
  reservoir: {
    label:'Reservoir Properties', icon:'', color:'var(--cyan)',
    desc:'Core petrophysical data: porosity, permeability, pay thickness, drive mechanism, HC phase, fluid saturation.',
    fields:['analogue_name','basin','age','lithology','dep_env','depth_mtvdss','hc_phase','drive_mechanism','porosity_pct','permeability_md','recovery_factor_pct','ntg_pct','gor_scf_bbl','api_gravity','gross_pay_m','net_pay_m','temperature_c','reservoir_pressure_bar','water_saturation','bo_rb_stb','viscosity_cp'],
    required:['analogue_name','porosity_pct','permeability_md'],
    notes:'Values should be in the units specified in column headers. Leave blank if unknown.'
  },
  geopressure: {
    label:'Geopressure', icon:'', color:'var(--amber)',
    desc:'Pore pressure data, gradients, mud weight window, overpressure regime and mechanisms.',
    fields:['analogue_name','basin','depth_mtvdss','pore_pressure_gradient_psi_ft','overburden_gradient_psi_ft','fracture_gradient_psi_ft','ppg_equivalent','ecd_ppg','pressure_coefficient','pressure_regime','overpressure_mechanism','mudweight_min_ppg','mudweight_max_ppg','leak_off_test_psi_ft','extended_leak_off_test','drillstem_test_pressure_psi','reservoir_pressure_ppg','rft_pressure_bar','pressure_depth_gradient','sonic_transit_time_us_ft','sonic_pore_pressure_method','sigma_v_bar','sigma_h_min_bar','sigma_h_max_bar','fault_reactivation_risk','wellbore_stability_risk'],
    required:['analogue_name','pore_pressure_gradient_psi_ft'],
    notes:'Pressure regime options: Normally pressured / Slightly overpressured / Moderately overpressured / Overpressured / Highly overpressured'
  },
  geochem: {
    label:'Geochemistry', icon:'', color:'var(--green)',
    desc:'Source rock quality, maturity indicators, kerogen type, petroleum system parameters.',
    fields:['analogue_name','basin','source_formation','kerogen_type','toc_pct','vitrinite_reflectance_ro','hydrogen_index_mg_hc_g_toc','oxygen_index_mg_co2_g_toc','tmax_c','expulsion_efficiency_pct','charge_volume','migration_distance_km','oil_family','sulfur_pct','c15_plus_pct','predicted_api','s1_mg_hc_g_rock','s2_mg_hc_g_rock','s3_mg_co2_g_rock','pi_production_index','rock_eval_type','maturation_stage','thermal_alteration_index','carbon_preference_index','pr_ph_ratio','gammacerane_index','source_rock_thickness_m','total_organic_richness','kerogen_density_g_cc','expulsion_age_ma','peak_generation_age_ma','trap_formation_age_ma'],
    required:['analogue_name','toc_pct','vitrinite_reflectance_ro'],
    notes:'Kerogen types: Type I / Type II / Type III / Type II/III / Type II/IIS. Vitrinite reflectance in % Ro.'
  },
  mineral: {
    label:'Mineralogy', icon:'', color:'var(--gold)',
    desc:'XRD modal analysis and point counting data for reservoir mineral composition.',
    fields:['analogue_name','basin','quartz_pct','feldspar_pct','rock_fragments_pct','kaolinite_pct','illite_pct','smectite_pct','chlorite_pct','calcite_cement_pct','dolomite_pct','pyrite_pct','siderite_pct','mica_pct','clay_total_pct','cement_type','ankerite_pct','zeolite_pct','halite_pct','apatite_pct','zircon_pct','biotite_pct','hornblende_pct','magnetite_pct','hematite_pct','total_cement_pct','porosity_preserving_cements','porosity_reducing_cements','detrital_clay_pct','authigenic_clay_pct','mixed_layer_clay_type','cec_meq_100g','grain_size_phi','sorting_coefficient','roundness','sphericity','thin_section_analysis','sem_edx_available'],
    required:['analogue_name','quartz_pct','clay_total_pct'],
    notes:'All percentages should sum to ~100%. Cement type examples: Silica / Calcite / Kaolinite / Mixed.'
  },
  fluid: {
    label:'Fluid PVT', icon:'', color:'var(--red)',
    desc:'Fluid phase behaviour, PVT properties, gas composition and contamination levels.',
    fields:['analogue_name','basin','oil_density_g_cc','gas_specific_gravity','fvf_oil_rb_stb','bubble_point_bar','solution_gor_scf_stb','z_factor','brine_salinity_ppm','wor','h2s_ppm','co2_pct','n2_pct','c1_methane_pct','c2_ethane_pct','c3_propane_pct','c4_butane_pct','c5_pentane_pct','c6_hexane_pct','c7_plus_pct','mw_c7_plus_g_mol','fluid_type','phase_envelope_type','dew_point_bar','cricondentherm_c','cricondenbar_bar','reservoir_fluid_viscosity_cp','dead_oil_viscosity_cp','oil_compressibility_1_bar','gas_compressibility_factor','water_fvf_rb_stb','water_compressibility_1_bar','brine_viscosity_cp','asphaltene_content_pct','wax_content_pct','pour_point_c','cloud_point_c','mercury_ppm','arsenic_ppb','scale_tendency','emulsion_tendency'],
    required:['analogue_name','oil_density_g_cc'],
    notes:'H2S in ppm. CO2, N2, hydrocarbon gas fractions in % mol. Oil density in g/cc (e.g. 0.855).'
  },
  diagenesis: {
    label:'Diagenesis', icon:'', color:'var(--brand2)',
    desc:'Diagenetic history: compaction, cementation, dissolution, clay authigenesis.',
    fields:['analogue_name','basin','burial_grade','compaction','cementation','dissolution','quartz_overgrowths','chlorite_coating','kaolinite_pore_fill','authigenic_clay','grain_coating','fluid_inclusion_th_c','mechanical_compaction_grade','chemical_compaction_grade','pressure_solution_intensity','stylolite_frequency','macro_porosity_type','micro_porosity_type','pore_throat_radius_um','entry_pressure_bar','mercury_injection_pc_bar','reservoir_quality_index','flow_zone_indicator','k_phi_transform','diagenetic_sequence','eogenetic_grade','mesogenetic_grade','telogenetic_grade','paleo_fluid_flow','overpressure_influence','burial_history_max_depth_m','uplift_erosion_m','paleotemperature_c','thermochronology_age_ma'],
    required:['analogue_name','compaction','cementation'],
    notes:'Use: Low / Moderate / High / Very High for compaction and cementation. Present / Absent / Partial for coatings.'
  },
  seismic: {
    label:'Seismic & Structural', icon:'', color:'#8B5CF6',
    desc:'Seismic attributes, structural interpretation, closure geometry and trap integrity data.',
    fields:['analogue_name','basin','survey_name','survey_type','vintage_year','dominant_frequency_hz','twt_closure_ms','structural_relief_m','closure_area_km2','trap_type','fault_seal_risk','amplitude_anomaly','bht_c','average_velocity_m_s','top_seal_formation','spill_point_m'],
    required:['analogue_name','trap_type'],
    notes:'Trap types: Anticlinal / Fault / Stratigraphic / Combination / Salt-related / Inversion. Fault seal risk: Low/Moderate/High.'
  },
  production: {
    label:'Production & Economics', icon:'', color:'#059669',
    desc:'Production history, decline curve parameters, well performance and economic metrics.',
    fields:['analogue_name','basin','field_name','discovery_year','first_production_year','peak_rate_bopd','cum_production_mmboe','reserves_mmboe','well_count','avg_ip30_bopd','di_decline_rate','b_factor','water_cut_pct','gor_producing','opex_usd_boe','capex_usd_boe','breakeven_usd_boe','npv_mm_usd','irr_pct'],
    required:['analogue_name','cum_production_mmboe'],
    notes:'Production rates in BOPD/BOEPD. Reserves in MMboe. Economics at project-level (not well-level). Decline type: Exponential/Hyperbolic/Harmonic.'
  },
  welldata: {
    label:'Well & Core Data', icon:'', color:'#DC2626',
    desc:'Well header data, core analysis, wireline log statistics and formation evaluation results.',
    fields:['analogue_name','basin','well_name','uwi','well_type','spud_date','td_m','kb_elevation_m','water_depth_m','reservoir_formation','core_plugs_count','core_porosity_avg_pct','core_perm_avg_md','klinkenberg_pct','routine_sw_pct','xrd_quartz_avg_pct','xrd_clay_avg_pct','phie_log_avg','vsh_log_avg','sw_archie_avg','pore_throat_r35_um'],
    required:['analogue_name','well_name'],
    notes:'UWI format: country code + API number. Core data should be from RCA (Routine Core Analysis) or SCA (Special Core Analysis). Log averages from perforated intervals only.'
  },
  isotope: {
    label:'Isotope & Biomarker', icon:'', color:'#7C3AED',
    desc:'Stable isotope data, biomarker ratios, oil-source correlation and biodegradation parameters.',
    fields:['analogue_name','basin','sample_id','sample_type','d13c_saturates','d13c_aromatics','d13c_whole_oil','d34s_sulfur','pr_ph_ratio','pr_nc17_ratio','ph_nc18_ratio','c27_sterane_pct','c28_sterane_pct','c29_sterane_pct','ts_tm_ratio','c31_hopane_22s_r','c35_c34_hopane','gammacerane_index','tricyclic_tetracyclic','biodegradation_pm_scale','oil_family'],
    required:['analogue_name','sample_id'],
    notes:'Œ¥¬π¬≥C values in ‚Ä∞ VPDB. Pr/Ph ratio: <1 anoxic, >1 oxic. PM biodegradation scale: 0-10 (0=fresh, 10=severely degraded).'
  },
  // ---- NEW PARAMETER CATEGORIES ----
  petrophysics: {
    label:'Petrophysics & Log Analysis', icon:'', color:'#0891B2',
    desc:'Wireline log interpretation, formation evaluation, fluid contact depths and saturation-height modelling.',
    fields:['analogue_name','basin','well_name','log_suite','depth_tvdss_m','phit_avg','phie_avg','vsh_avg','sw_avg','bvw_avg','moveable_hc_index','rwt_ohm_m','rw_temp_c','archie_a','archie_m','archie_n','formation_factor','resistivity_index','pickett_slope','ooip_log_mbbls','j_function_perm_cutoff','pore_throat_r35_um','capillary_pressure_psi','fwl_mtvdss','owc_mtvdss','goc_mtvdss','log_quality_flag','depth_match_correction_m','sonic_dt_us_ft','density_rhob_g_cc','neutron_nphi','gamma_ray_api','sp_mv','caliper_in'],
    required:['analogue_name','phie_avg','sw_avg'],
    notes:'All averages over net pay interval. FWL = Free Water Level (from capillary pressure); OWC = Oil-Water Contact (from log). Log quality: Good/Acceptable/Poor.'
  },
  geomechanics: {
    label:'Geomechanics & Stress', icon:'', color:'#B45309',
    desc:'In-situ stress state, rock mechanical properties, fracture characterisation and wellbore stability parameters.',
    fields:['analogue_name','basin','depth_mtvdss','ucs_mpa','youngs_modulus_gpa','poissons_ratio','tensile_strength_mpa','cohesion_mpa','friction_angle_deg','biot_coefficient','unconfined_compressive_strength','point_load_index','brazilian_tensile_strength','sigma_v_mpa','sigma_h_min_mpa','sigma_h_max_mpa','pp_gradient_mpa_m','sv_gradient_mpa_m','shmin_gradient_mpa_m','shmax_gradient_mpa_m','stress_regime','shmax_azimuth_deg','mud_weight_window_ppg_min','mud_weight_window_ppg_max','breakout_width_deg','drilling_induced_fracture','caliper_breakout_presence','natural_fracture_density_per_m','fracture_orientation_deg','fracture_aperture_mm','fracture_intensity','formation_integrity_test_mpa','leak_off_gradient_mpa_m','critical_depletion_mpa','sand_production_risk','compaction_risk'],
    required:['analogue_name','ucs_mpa'],
    notes:'Stress regime: Normal / Strike-slip / Reverse. UCS in MPa. Youngs Modulus in GPa. All gradients in MPa/m unless otherwise stated.'
  },
  thermal: {
    label:'Thermal & Basin Modelling', icon:'', color:'#DC2626',
    desc:'Thermal maturity, heat flow, burial history and petroleum system modelling parameters.',
    fields:['analogue_name','basin','formation','present_depth_m','max_burial_depth_m','erosion_thickness_m','age_max_burial_ma','age_onset_generation_ma','age_peak_generation_ma','age_expulsion_ma','vitrinite_reflectance_ro','tmax_c','tti_lopatin','easy_ro_pct','surface_heat_flow_mw_m2','basal_heat_flow_mw_m2','thermal_gradient_c_km','present_temperature_c','max_palaeotemperature_c','cooling_rate_c_ma','uplift_rate_m_ma','subsidence_rate_m_ma','tectonic_subsidence_m','sediment_thermal_conductivity','radiogenic_heat_production','crustal_thickness_km','lithospheric_thickness_km','inversion_magnitude_m','trap_timing_vs_generation','petroleum_system_integrity','charge_risk_rating'],
    required:['analogue_name','surface_heat_flow_mw_m2'],
    notes:'Heat flow in mW/m¬≤. Vitrinite reflectance in %Ro. TTI = Time-Temperature Index (Lopatin method). Charge risk: Low / Moderate / High / Critical.'
  },
  environmental: {
    label:'Environmental & HSE', icon:'', color:'#059669',
    desc:'Environmental sensitivity, regulatory data, H‚ÇÇS/CO‚ÇÇ content, and HSE classification for exploration targets.',
    fields:['analogue_name','basin','country','h2s_ppm','co2_pct','so2_ppm','hg_ppb','benzene_ppm','radioactivity_bq_kg','naturally_occurring_radioactive','temperature_surface_c','cold_vent_presence','seafloor_stability','water_depth_m','protected_area_flag','marine_mammal_presence','coral_reef_proximity_km','mangrove_proximity_km','fishery_sensitivity','indigenous_land_flag','cultural_heritage_sensitivity','seismic_survey_restriction','drilling_moratorium','environmental_impact_category','spill_response_tier','nearest_port_km','emergency_response_time_h','co2_storage_potential_mt','water_injection_feasibility','produced_water_salinity_ppm','scale_inhibitor_required','asphaltene_deposition_risk','wax_deposition_risk','hydrate_risk'],
    required:['analogue_name','h2s_ppm'],
    notes:'H‚ÇÇS >10 ppm requires H‚ÇÇS contingency plan. CO‚ÇÇ >5% may affect commercial viability. Environmental impact: Low / Moderate / High / Critical.'
  },
  commercials: {
    label:'Commercial & Economic', icon:'', color:'#6B21A8',
    desc:'Commercial parameters: break-even economics, risked NPV, FID metrics, infrastructure proximity and fiscal terms.',
    fields:['analogue_name','basin','country','discovery_name','operator','working_interest_pct','gross_resources_mmboe','net_resources_mmboe','recovery_factor_pct','plateau_rate_boepd','plateau_duration_yr','field_life_yr','first_oil_year','development_concept','capex_development_musd','capex_per_boe_usd','opex_usd_boe','royalty_pct','tax_rate_pct','government_take_pct','breakeven_price_usd_bbl','npv_10_musd','irr_pct','payback_period_yr','risked_emv_musd','unrisked_emv_musd','fiscal_regime','psc_vs_concession','price_deck_assumption','discount_rate_pct','infrastructure_access','pipeline_distance_km','nearest_fpso_km','processing_hub_proximity_km','market_access','lng_vs_domestic','gas_monetisation_route','contingent_resources_class','prospective_resources_low','prospective_resources_best','prospective_resources_high'],
    required:['analogue_name','npv_10_musd'],
    notes:'NPV discounted at 10%. Resources in MMboe. Capex/Opex in USD/boe unless total in MUSD. Fiscal regime: PSC / Concession / JV / Service Contract.'
  },
};

// Shared panel HTML generator
function ingPanelHTML(key) {
  const m = ING_META[key];
  return `
    <div class="g2" style="margin-bottom:14px">
      <div class="card">
        <div class="ch">
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:20px;color:${m.color}">${m.icon}</span>
            <div>
              <span class="ct">${m.label} ‚Äî Data Upload</span>
              <div style="font-size:10px;color:var(--t3);margin-top:1px">${m.desc}</div>
            </div>
          </div>
          <button class="btn2" onclick="downloadTemplate('${key}')">Download Template</button>
        </div>
        <div class="cb">
          <div class="drop-zone" id="dz-${key}"
            ondragover="event.preventDefault();this.classList.add('drag-over')"
            ondragleave="this.classList.remove('drag-over')"
            ondrop="handleDropTyped(event,'${key}')">
            <input type="file" accept=".csv,.tsv,.txt" onchange="handleFilesTyped(this.files,'${key}')">
            <div style="font-size:24px;color:${m.color};margin-bottom:8px">${m.icon}</div>
            <div style="font-size:12px;color:var(--t2);margin-bottom:3px">Drop ${m.label} CSV here</div>
            <div style="font-size:9px;color:var(--t3)">or click to browse ¬∑ CSV / TSV format</div>
          </div>
          <div id="files-${key}" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="card">
        <div class="ch"><span class="ct">Required Fields</span></div>
        <div class="cb">
          <div style="margin-bottom:10px;padding:8px 10px;background:rgba(255,107,43,.06);border:1px solid rgba(255,107,43,.18);border-radius:5px;font-size:10px;color:var(--t2)">${m.notes}</div>
          <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Column Headers</div>
          <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">
            ${m.fields.map(f => `<span style="padding:2px 7px;border-radius:3px;font-size:9px;font-family:monospace;background:${m.required.includes(f)?'rgba(255,107,43,.15)':'var(--bg4)'};color:${m.required.includes(f)?'var(--brand2)':'var(--t2)'};border:1px solid ${m.required.includes(f)?'rgba(255,107,43,.3)':'var(--b1)'}">${f}${m.required.includes(f)?'*':''}</span>`).join('')}
          </div>
          <div style="padding:8px 10px;background:var(--bg4);border-radius:5px;font-size:9px;color:var(--t3)">
            <span style="color:var(--brand2)">* Required</span> &nbsp;¬∑&nbsp; analogue_name must match an existing analogue or basin record
          </div>
          <div style="margin-top:10px;display:flex;gap:7px">
            <button class="btn" style="flex:1" onclick="downloadTemplate('${key}')">‚¨á ${m.label} Template CSV</button>
          </div>
          <div id="ing-${key}-loaded" style="margin-top:10px"></div>
        </div>
      </div>
    </div>`;
}

function ingTab(tab, el) {
  if (typeof el === 'string') el = document.querySelector(el);
  if (el && el.closest) {
    el.closest('.tabs')?.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
    el.classList?.add('on');
  }
  const all = ['overview','unified','reservoir','geopressure','geochem','mineral','fluid','diagenesis','seismic','production','welldata','isotope','petrophysics','geomechanics','thermal','environmental','commercials','connectors','dedup'];
  all.forEach(t => {
    const p = document.getElementById('ing-' + t + '-panel');
    if (p) p.style.display = (t === tab) ? 'block' : 'none';
  });
  // Render overview tiles on first open
  if (tab === 'overview') renderIngOverview();
  // Init unified panel on first open
  if (tab === 'unified') renderUnifiedSchema();
  // Lazily inject per-type panel HTML
  const typedTabs = ['reservoir','geopressure','geochem','mineral','fluid','diagenesis','seismic','production','welldata','isotope','petrophysics','geomechanics','thermal','environmental','commercials'];
  if (typedTabs.includes(tab)) {
    const p = document.getElementById('ing-' + tab + '-panel');
    if (p && !p.dataset.rendered) { p.innerHTML = ingPanelHTML(tab); p.dataset.rendered = '1'; }
  }
  if (tab === 'connectors') renderConnectorCards();
  if (tab === 'dedup') renderDedupQueue();
}

function renderIngOverview() {
  const TILES = [
    {key:'reservoir',  label:'Reservoir Properties',  icon:'', desc:'Petrophysics, pay thickness, drive, HC phase', color:'var(--cyan)'},
    {key:'geopressure',label:'Geopressure',           icon:'', desc:'Pore pressure, fracture gradient, mud window', color:'var(--amber)'},
    {key:'geochem',    label:'Geochemistry',          icon:'', desc:'TOC, Ro%, kerogen type, expulsion efficiency', color:'var(--green)'},
    {key:'mineral',    label:'Mineralogy',            icon:'', desc:'XRD modal analysis, clay minerals, cements',  color:'var(--gold)'},
    {key:'fluid',      label:'Fluid PVT',             icon:'', desc:'Oil density, FVF, gas composition, H‚ÇÇS, CO‚ÇÇ',color:'var(--red)'},
    {key:'diagenesis', label:'Diagenesis',            icon:'', desc:'Compaction, cementation, dissolution, clay',  color:'var(--brand2)'},
    {key:'seismic',    label:'Seismic & Structural',  icon:'', desc:'Trap type, closure area, amplitude anomaly',  color:'#8B5CF6'},
    {key:'production', label:'Production & Economics',icon:'', desc:'EUR, peak rate, decline, OPEX/CAPEX',        color:'#059669'},
    {key:'welldata',   label:'Well & Core Data',      icon:'', desc:'Well header, core porosity, log averages',   color:'#DC2626'},
    {key:'isotope',    label:'Isotope & Biomarker',   icon:'', desc:'Œ¥¬π¬≥C, biomarker ratios, oil correlation',    color:'#7C3AED'},
    {key:'petrophysics',label:'Petrophysics & Logs',  icon:'', desc:'PHIE, Sw, formation evaluation, contacts',   color:'#0891B2'},
    {key:'geomechanics',label:'Geomechanics',         icon:'', desc:'UCS, stress state, fractures, wellbore stability',color:'#B45309'},
    {key:'thermal',    label:'Thermal & Basin Model', icon:'', desc:'Heat flow, maturity, burial history, TTI',   color:'#DC2626'},
    {key:'environmental',label:'Environmental & HSE', icon:'', desc:'H‚ÇÇS, CO‚ÇÇ, protected areas, spill risk',     color:'#059669'},
    {key:'commercials', label:'Commercial & Economic',icon:'', desc:'NPV, IRR, breakeven, government take, FID',  color:'#6B21A8'},
  ];
  const el = document.getElementById('ing-dataset-tiles');
  if (!el) return;
  el.innerHTML = TILES.map(d => {
    const count = ANALOGUES.filter(a => a[d.key] || (d.key==='reservoir' && a.por > 0)).length;
    return `<div class="card" style="cursor:pointer" onclick="ingTab('${d.key}',null)">
      <div class="cb" style="padding:14px 16px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <div style="font-size:22px;color:${d.color};text-shadow:0 0 12px ${d.color}">${d.icon}</div>
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--t1)">${d.label}</div>
            <div style="font-size:9px;color:var(--t3);margin-top:2px">${d.desc}</div>
          </div>
        </div>
        <div style="margin-bottom:10px">
          <div class="sbar-track" style="height:4px"><div class="sbar-fill" style="width:${Math.round(count/ANALOGUES.length*100)}%;background:${d.color}"></div></div>
          <div style="display:flex;justify-content:space-between;font-size:9px;margin-top:3px">
            <span style="color:var(--t3)">${count}/${ANALOGUES.length} analogues have data</span>
            <span style="color:${d.color};font-weight:700">${Math.round(count/ANALOGUES.length*100)}%</span>
          </div>
        </div>
        <div style="display:flex;gap:5px">
          <button class="btn2" style="font-size:9px;padding:4px 9px;flex:1" onclick="event.stopPropagation();downloadTemplate('${d.key}')">Template</button>
          <button class="btn" style="font-size:9px;padding:4px 11px;flex:1" onclick="event.stopPropagation();ingTab('${d.key}',document.querySelectorAll('#sec-ingestion .tab')[${d.tabIdx}])">Upload ‚Üí</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function handleDropTyped(e, key) {
  e.preventDefault();
  document.getElementById('dz-' + key)?.classList.remove('drag-over');
  handleFilesTyped(e.dataTransfer.files, key);
}

function handleFilesTyped(files, key) {
  [...files].forEach(file => {
    const ext = file.name.split('.').pop().toLowerCase();
    if (!['csv','tsv','txt'].includes(ext)) {
      toast(`Only CSV/TSV files supported`, 'warning'); return;
    }
    // Show parsing state
    addFileRowTyped(key, file.name, 'parsing');
    const reader = new FileReader();
    reader.onload = e => processTypedFile(e.target.result, file.name, key);
    reader.readAsText(file);
  });
}

function addFileRowTyped(key, name, state) {
  const wrap = document.getElementById('files-' + key);
  if (!wrap) return;
  const id = 'frow-' + key + '-' + name.replace(/\W/g,'');
  let el = document.getElementById(id);
  if (!el) { el = document.createElement('div'); el.id = id; wrap.prepend(el); }
  const colors = {parsing:'var(--amber)', ok:'var(--green)', error:'var(--red)'};
  const icons  = {parsing:'‚è≥', ok:'‚úÖ', error:'‚ùå'};
  const labels = {parsing:'Parsing‚Ä¶', ok:'Ingested', error:'Error'};
  el.style.cssText = `display:flex;align-items:center;gap:10px;padding:10px 14px;
    background:${state==='ok'?'rgba(0,135,90,.06)':state==='error'?'rgba(217,48,37,.06)':'rgba(192,120,0,.05)'};
    border:1px solid ${state==='ok'?'rgba(0,135,90,.2)':state==='error'?'rgba(217,48,37,.2)':'rgba(192,120,0,.2)'};
    border-radius:8px;margin-bottom:8px;animation:fadeUp .3s ease`;
  el.innerHTML = `
    <span style="font-size:20px;flex-shrink:0">${icons[state]}</span>
    <div style="flex:1;min-width:0">
      <div style="font-size:11px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
      <div style="font-size:9px;color:var(--t3);margin-top:2px">${new Date().toLocaleTimeString()}</div>
    </div>
    <span style="font-size:10px;font-weight:700;color:${colors[state]};flex-shrink:0">${labels[state]}</span>`;
}

function processTypedFile(text, fileName, key) {
  const { headers, rows } = parseCSV(text);
  if (!rows.length) {
    addFileRowTyped(key, fileName, 'error');
    toast(`${fileName}: file is empty`, 'warning'); return;
  }
  openTypedMappingModal(fileName, headers, rows, key);
}

function openTypedMappingModal(fileName, headers, rows, key) {
  const m = ING_META[key];
  // Store safely ‚Äî never embed rows JSON in onclick
  _pendingTyped = { fileName, rows, key, fields: m.fields };
  const preview = rows.slice(0,3);
  const autoMapping = {};
  m.fields.forEach(f => {
    const hLow = headers.map(h => h.toLowerCase().replace(/[\s\-]/g,'_'));
    const fNorm = f.toLowerCase();
    let idx = hLow.indexOf(fNorm);
    if (idx < 0) idx = hLow.findIndex(h => h.startsWith(fNorm.split('_')[0]) || fNorm.startsWith(h.split('_')[0]));
    if (idx >= 0) autoMapping[f] = headers[idx];
  });
  openModal(`
    <div class="modal-title" style="display:flex;align-items:center;gap:8px">
      <span style="color:${m.color}">${m.icon}</span> Map Columns ‚Äî ${m.label}
    </div>
    <div class="modal-sub" style="margin-bottom:10px">
      <strong style="color:var(--cyan)">${rows.length} rows</strong> detected in <strong>${fileName}</strong>
    </div>
    <div style="background:var(--bg4);border-radius:5px;padding:8px;margin-bottom:12px;overflow-x:auto;max-height:100px">
      <div style="font-size:8px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Preview</div>
      <table style="font-size:9px;min-width:100%">
        <thead><tr>${headers.map(h=>`<th style="color:${m.color};padding:2px 7px;white-space:nowrap">${h}</th>`).join('')}</tr></thead>
        <tbody>${preview.map(r=>`<tr>${headers.map(h=>`<td style="color:var(--t2);padding:2px 7px;white-space:nowrap">${(r[h]||'').toString().substring(0,30)}</td>`).join('')}</tr>`).join('')}</tbody>
      </table>
    </div>
    <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Map Your Columns ‚Üí EDAFY Fields</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;max-height:280px;overflow-y:auto;margin-bottom:14px">
      ${m.fields.map(f => `
        <div style="display:flex;align-items:center;gap:6px">
          <span style="font-size:9px;font-family:monospace;color:${m.required.includes(f)?'var(--brand2)':'var(--t2)'};min-width:160px;flex-shrink:0">${f}${m.required.includes(f)?'*':''}</span>
          <select class="fc" id="tmap-${f}" style="flex:1;padding:4px 7px;font-size:9px">
            <option value="">‚Äî skip ‚Äî</option>
            ${headers.map(h=>`<option value="${h}" ${autoMapping[f]===h?'selected':''}>${h}</option>`).join('')}
          </select>
        </div>`).join('')}
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="commitTypedIngestion()">‚úì Ingest ${rows.length} Records</button>
      <button class="btn2" onclick="closeModal();_pendingTyped=null">Cancel</button>
    </div>
  `);
}

function commitTypedIngestion() {
  if (!_pendingTyped) { toast('No pending data', 'warning'); return; }
  const { fileName, rows, key, fields: fieldKeys } = _pendingTyped;
  _pendingTyped = null;
  const mapping = {};
  fieldKeys.forEach(f => {
    const sel = document.getElementById('tmap-' + f);
    if (sel && sel.value) mapping[f] = sel.value;
  });
  const m = ING_META[key];
  if (m.required.some(r => !mapping[r])) {
    toast(`Please map required fields: ${m.required.join(', ')}`, 'warning'); return;
  }
  closeModal();

  let accepted = 0, skipped = 0, failed = 0;
  rows.forEach(row => {
    try {
      const rec = {};
      fieldKeys.forEach(f => { if (mapping[f]) rec[f] = row[mapping[f]]; });
      const name = rec.analogue_name || rec.name || '';
      if (!name) { failed++; return; }

      // Find matching analogue by name (fuzzy)
      let target = ANALOGUES.find(a => a.name.toLowerCase().includes(name.toLowerCase()) || name.toLowerCase().includes(a.name.toLowerCase().split('‚Äî')[0].trim()));
      if (!target) {
        // Create a stub analogue if not found
        target = { rank: ANALOGUES.length + 1, name, basin: rec.basin||'Unknown', age:'Unknown', lith:'Unknown', dep:'Unknown', depth:0, hc:'Oil', drive:'Unknown', por:0, perm:0, rf:0, ntg:0, gor:0, api:0, sim:70 };
        ANALOGUES.push(target);
      }

      // Merge the typed data into the appropriate sub-object
      if (key === 'reservoir') {
        const n = v => parseFloat(v)||0;
        target.depth    = n(rec.depth_mtvdss) || target.depth;
        target.por      = n(rec.porosity_pct) || target.por;
        target.perm     = n(rec.permeability_md) || target.perm;
        target.rf       = n(rec.recovery_factor_pct) || target.rf;
        target.ntg      = n(rec.ntg_pct) || target.ntg;
        target.gor      = n(rec.gor_scf_bbl) || target.gor;
        target.api      = n(rec.api_gravity) || target.api;
        target.gross_pay = n(rec.gross_pay_m) || target.gross_pay;
        target.net_pay  = n(rec.net_pay_m) || target.net_pay;
        target.temp     = n(rec.temperature_c) || target.temp;
        target.pres_res = n(rec.reservoir_pressure_bar) || target.pres_res;
        target.sw       = n(rec.water_saturation) || target.sw;
        target.bo       = n(rec.bo_rb_stb) || target.bo;
        target.visc     = n(rec.viscosity_cp) || target.visc;
        if (rec.hc_phase) target.hc = rec.hc_phase;
        if (rec.drive_mechanism) target.drive = rec.drive_mechanism;
        if (rec.lithology) target.lith = rec.lithology;
        if (rec.dep_env) target.dep = rec.dep_env;
        if (rec.age) target.age = rec.age;
        if (rec.basin) target.basin = rec.basin;
      } else if (key === 'geopressure') {
        const n = v => parseFloat(v)||null;
        target.geo = target.geo || {};
        if (rec.pore_pressure_gradient_psi_ft) target.geo.pres_grad = n(rec.pore_pressure_gradient_psi_ft);
        if (rec.overburden_gradient_psi_ft) target.geo.obstr_grad = n(rec.overburden_gradient_psi_ft);
        if (rec.fracture_gradient_psi_ft) target.geo.frac_grad = n(rec.fracture_gradient_psi_ft);
        if (rec.ppg_equivalent) target.geo.ppg = n(rec.ppg_equivalent);
        if (rec.ecd_ppg) target.geo.ecd = n(rec.ecd_ppg);
        if (rec.pressure_coefficient) target.geo.pressure_coeff = n(rec.pressure_coefficient);
        if (rec.pressure_regime) target.geo.pressure_regime = rec.pressure_regime;
        if (rec.overpressure_mechanism) target.geo.overpressure_mech = rec.overpressure_mechanism;
        if (rec.mudweight_min_ppg) target.geo.mudweight_min = n(rec.mudweight_min_ppg);
        if (rec.mudweight_max_ppg) target.geo.mudweight_max = n(rec.mudweight_max_ppg);
      } else if (key === 'geochem') {
        const n = v => parseFloat(v)||null;
        target.geochem = target.geochem || {};
        if (rec.source_formation) target.geochem.source_fm = rec.source_formation;
        if (rec.kerogen_type) target.geochem.kerogen_type = rec.kerogen_type;
        if (rec.toc_pct) target.geochem.toc = n(rec.toc_pct);
        if (rec.vitrinite_reflectance_ro) target.geochem.ro_vitrinite = n(rec.vitrinite_reflectance_ro);
        if (rec.hydrogen_index_mg_hc_g_toc) target.geochem.hindex = n(rec.hydrogen_index_mg_hc_g_toc);
        if (rec.oxygen_index_mg_co2_g_toc) target.geochem.oindex = n(rec.oxygen_index_mg_co2_g_toc);
        if (rec.tmax_c) target.geochem.tmax = n(rec.tmax_c);
        if (rec.expulsion_efficiency_pct) target.geochem.expulsion_eff = n(rec.expulsion_efficiency_pct);
        if (rec.charge_volume) target.geochem.charge_volume = rec.charge_volume;
        if (rec.migration_distance_km) target.geochem.migration_dist = n(rec.migration_distance_km);
        if (rec.oil_family) target.geochem.oil_family = rec.oil_family;
        if (rec.sulfur_pct) target.geochem.sulfur_pct = n(rec.sulfur_pct);
        if (rec.c15_plus_pct) target.geochem.c15_plus = n(rec.c15_plus_pct);
        if (rec.predicted_api) target.geochem.api_pred = n(rec.predicted_api);
      } else if (key === 'mineral') {
        const n = v => parseFloat(v)||0;
        target.mineral = target.mineral || {};
        ['quartz','feldspar','rock_fragments','kaolinite','illite','smectite','chlorite','calcite_cement','dolomite','pyrite','siderite','mica'].forEach(min => {
          const col = min + '_pct';
          if (rec[col] !== undefined) target.mineral[min] = n(rec[col]);
        });
        if (rec.clay_total_pct) target.mineral.clay_total = n(rec.clay_total_pct);
        if (rec.cement_type) target.mineral.cement_type = rec.cement_type;
      } else if (key === 'fluid') {
        const n = v => parseFloat(v)||null;
        target.fluid = target.fluid || {};
        if (rec.oil_density_g_cc) target.fluid.oil_density = n(rec.oil_density_g_cc);
        if (rec.gas_specific_gravity) target.fluid.gas_sg = n(rec.gas_specific_gravity);
        if (rec.fvf_oil_rb_stb) target.fluid.fvf_oil = n(rec.fvf_oil_rb_stb);
        if (rec.bubble_point_bar) target.fluid.pb = n(rec.bubble_point_bar);
        if (rec.solution_gor_scf_stb) target.fluid.rs = n(rec.solution_gor_scf_stb);
        if (rec.z_factor) target.fluid.z_factor = n(rec.z_factor);
        if (rec.brine_salinity_ppm) target.fluid.brine_sal = n(rec.brine_salinity_ppm);
        if (rec.wor) target.fluid.wor = n(rec.wor);
        if (rec.h2s_ppm) target.fluid.h2s_ppm = n(rec.h2s_ppm);
        if (rec.co2_pct) target.fluid.co2_pct = n(rec.co2_pct);
        if (rec.n2_pct) target.fluid.n2_pct = n(rec.n2_pct);
        if (rec.c1_methane_pct) target.fluid.c1_pct = n(rec.c1_methane_pct);
        if (rec.c2_ethane_pct) target.fluid.c2_pct = n(rec.c2_ethane_pct);
        if (rec.c3_propane_pct) target.fluid.c3_pct = n(rec.c3_propane_pct);
      } else if (key === 'diagenesis') {
        target.diagenesis = target.diagenesis || {};
        const strFields = ['burial_grade','compaction','cementation','dissolution','quartz_overgrowths','chlorite_coating','kaolinite_pore_fill','authigenic_clay','grain_coating'];
        strFields.forEach(f => { if (rec[f]) target.diagenesis[f.replace('quartz_overgrowths','qovergrowths').replace('chlorite_coating','chlorite_coat').replace('kaolinite_pore_fill','kaolinite_pore')] = rec[f]; });
        if (rec.fluid_inclusion_th_c) target.diagenesis.fluid_inclusion_th = parseFloat(rec.fluid_inclusion_th_c)||null;
      }
      target._source = fileName;
      accepted++;
    } catch(e) { failed++; }
  });

  // Update loaded records display
  const loadedEl = document.getElementById('ing-' + key + '-loaded');
  if (loadedEl) loadedEl.innerHTML = `<div style="padding:8px 10px;background:rgba(0,229,160,.07);border:1px solid rgba(0,229,160,.2);border-radius:5px;font-size:10px;color:var(--green)">‚úì ${accepted} records merged into ${ING_META[key].label} dataset${failed?` ¬∑ ${failed} failed`:''}</div>`;

  addFileRowTyped(key, fileName, accepted > 0 ? 'ok' : 'error');

  // Update counters
  const accEl = document.getElementById('ing-accepted');
  if (accEl) accEl.textContent = (parseInt(accEl.textContent.replace(/,/g,'')) + accepted).toLocaleString();

  // Audit
  INGESTED_FILES.push({
    id:'FILE-'+Date.now(),
    name:fileName,
    records:accepted,
    datasetType:ING_META[key].label,
    source:'Manual Upload ‚Äî ' + ING_META[key].label + ' Tab',
    age:'Just now',
    status:'pending',
    loadedNames:[]
  });
  renderGovQueue();
  AUDIT_ENTRIES.unshift({ time:now(), user:'VJ', action:`${ING_META[key].label} upload queued: ${fileName} ¬∑ ${accepted} records pending governance review`, status:'PENDING', type:'Governance' });
  renderAuditLog(AUDIT_ENTRIES);
  renderIngHistoryLive(fileName, accepted, 0);

  toast(`${ING_META[key].label}: ${accepted} analogues updated from ${fileName}`, 'success');
  refreshPortfolioKPIs();
  if (accepted > 0) setTimeout(() => toast('‚Üí Open Analogue Engine and click any result to see updated data', 'info'), 1500);
}

// ============================================================
// UNIFIED COLUMN SCHEMA ‚Äî master field map for all 8 dataset types
// ============================================================
const UNIFIED_SCHEMA = {
  basin: {
    label:'Basin', icon:'üåê', color:'#1D4ED8', bg:'#EFF6FF',
    cols: ['basin_name','basin_country','basin_region','basin_tectonic','basin_age','basin_hc_phase','basin_area_km2','basin_plays','basin_prospectivity_score','basin_status'],
    required: ['basin_name'],
    desc: 'Creates or updates a basin record in the Basin Catalogue'
  },
  analogue: {
    label:'Analogue', icon:'‚óé', color:'#166534', bg:'#F0FDF4',
    cols: ['analogue_name','analogue_basin','analogue_age','analogue_lithology','analogue_dep_env','analogue_depth_mtvdss','analogue_hc_phase','analogue_drive_mechanism','analogue_similarity_pct'],
    required: ['analogue_name'],
    desc: 'Creates or updates an analogue interval record'
  },
  reservoir: {
    label:'Reservoir', icon:'‚¨°', color:'#0E7490', bg:'#ECFEFF',
    cols: ['res_porosity_pct','res_permeability_md','res_recovery_factor_pct','res_ntg_pct','res_gor_scf_bbl','res_api_gravity','res_gross_pay_m','res_net_pay_m','res_temperature_c','res_pressure_bar','res_water_saturation','res_bo_rb_stb','res_viscosity_cp','res_kv_kh_ratio','res_kr_oil_endpoint','res_kr_gas_endpoint','res_swc_pct','res_sor_pct','res_sgc_pct','res_pore_volume_bbl','res_aquifer_strength','res_drive_mechanism'],
    required: ['res_porosity_pct'],
    desc: 'Core petrophysical and reservoir engineering parameters'
  },
  seismic: {
    label:'Seismic', icon:'‚óà', color:'#8B5CF6', bg:'#F5F3FF',
    cols: ['seis_survey_name','seis_survey_type','seis_vintage_year','seis_dominant_frequency_hz','seis_twt_closure_ms','seis_structural_relief_m','seis_closure_area_km2','seis_trap_type','seis_fault_seal_risk','seis_amplitude_anomaly'],
    required: ['seis_trap_type'],
    desc: 'Seismic attributes, structural interpretation, closure geometry'
  },
  production: {
    label:'Production', icon:'‚óá', color:'#059669', bg:'#ECFDF5',
    cols: ['prod_peak_rate_bopd','prod_cum_production_mmboe','prod_reserves_mmboe','prod_well_count','prod_avg_ip30_bopd','prod_di_decline_rate','prod_b_factor','prod_water_cut_pct','prod_gor_producing','prod_opex_usd_boe','prod_capex_usd_boe','prod_breakeven_usd_boe'],
    required: ['prod_cum_production_mmboe'],
    desc: 'Production history, decline curve parameters and economics'
  },
  geopressure: {
    label:'Geopressure', icon:'‚õè', color:'#92400E', bg:'#FFFBEB',
    cols: ['geo_pore_pressure_gradient_psi_ft','geo_overburden_gradient_psi_ft','geo_fracture_gradient_psi_ft','geo_ppg_equivalent','geo_ecd_ppg','geo_pressure_coefficient','geo_pressure_regime','geo_overpressure_mechanism','geo_mudweight_min_ppg','geo_mudweight_max_ppg'],
    required: ['geo_pore_pressure_gradient_psi_ft'],
    desc: 'Pore pressure, gradients, mud weight window'
  },
  geochem: {
    label:'Geochemistry', icon:'‚öó', color:'#065F46', bg:'#F0FDF4',
    cols: ['gchem_source_formation','gchem_kerogen_type','gchem_toc_pct','gchem_vitrinite_reflectance_ro','gchem_hydrogen_index','gchem_oxygen_index','gchem_tmax_c','gchem_expulsion_efficiency_pct','gchem_charge_volume','gchem_migration_distance_km','gchem_oil_family','gchem_sulfur_pct','gchem_c15_plus_pct','gchem_predicted_api'],
    required: ['gchem_toc_pct'],
    desc: 'Source rock quality, maturity indicators, kerogen'
  },
  mineral: {
    label:'Mineralogy', icon:'‚óà', color:'#78350F', bg:'#FFFBEB',
    cols: ['min_quartz_pct','min_feldspar_pct','min_rock_fragments_pct','min_kaolinite_pct','min_illite_pct','min_smectite_pct','min_chlorite_pct','min_calcite_cement_pct','min_dolomite_pct','min_pyrite_pct','min_siderite_pct','min_mica_pct','min_clay_total_pct','min_cement_type'],
    required: ['min_quartz_pct'],
    desc: 'XRD modal analysis, clay minerals, cements'
  },
  fluid: {
    label:'Fluid PVT', icon:'‚óâ', color:'#9F1239', bg:'#FFF1F2',
    cols: ['pvt_oil_density_g_cc','pvt_gas_specific_gravity','pvt_fvf_oil_rb_stb','pvt_bubble_point_bar','pvt_solution_gor_scf_stb','pvt_z_factor','pvt_brine_salinity_ppm','pvt_wor','pvt_h2s_ppm','pvt_co2_pct','pvt_n2_pct','pvt_c1_methane_pct','pvt_c2_ethane_pct','pvt_c3_propane_pct'],
    required: ['pvt_oil_density_g_cc'],
    desc: 'PVT properties, gas composition, contamination levels'
  },
  diagenesis: {
    label:'Diagenesis', icon:'‚¨¢', color:'#6B21A8', bg:'#FAF5FF',
    cols: ['dia_burial_grade','dia_compaction','dia_cementation','dia_dissolution','dia_quartz_overgrowths','dia_chlorite_coating','dia_kaolinite_pore_fill','dia_authigenic_clay','dia_grain_coating','dia_fluid_inclusion_th_c'],
    required: ['dia_compaction'],
    desc: 'Diagenetic history, burial grade, clay authigenesis'
  }
};

// Build a flat list of all recognised columns (for auto-routing)
const ALL_UNIFIED_COLS = Object.entries(UNIFIED_SCHEMA).flatMap(([type, s]) =>
  s.cols.map(col => ({ col, type }))
);

function renderUnifiedSchema() {
  const el = document.getElementById('unified-schema-list');
  if (!el || el.dataset.rendered) return;
  el.dataset.rendered = '1';
  el.innerHTML = Object.entries(UNIFIED_SCHEMA).map(([type, s]) => `
    <div style="margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px">
        <span style="font-size:14px">${s.icon}</span>
        <span style="font-size:10px;font-weight:700;color:${s.color};text-transform:uppercase;letter-spacing:.5px">${s.label}</span>
        <span style="font-size:9px;color:var(--t3)">${s.cols.length} cols</span>
      </div>
      <div style="font-size:9px;color:var(--t3);margin-bottom:5px">${s.desc}</div>
      <div style="display:flex;flex-wrap:wrap;gap:3px">
        ${s.cols.map(c => `<code style="font-size:8px;padding:1px 5px;border-radius:3px;background:${s.bg};color:${s.color};border:1px solid ${s.color}22">${c}${s.required.includes(c)?'*':''}</code>`).join('')}
      </div>
    </div>`).join('<hr style="border:none;border-top:1px solid #F0F4FA;margin:8px 0">');
}

// ============================================================
// UNIFIED INGESTION ‚Äî drop handlers, parser, committer
// ============================================================
function handleUnifiedDrop(e) {
  e.preventDefault();
  document.getElementById('dz-unified').classList.remove('drag-over');
  handleUnifiedFiles(e.dataTransfer.files);
}

function handleUnifiedFiles(files) {
  const file = files[0];
  if (!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  if (!['csv','tsv','txt'].includes(ext)) { toast('Only CSV/TSV supported', 'warning'); return; }
  setUnifiedFileStatus('parsing', file.name);
  const reader = new FileReader();
  reader.onload = ev => processUnifiedFile(ev.target.result, file.name);
  reader.readAsText(file);
}

function setUnifiedFileStatus(state, name, meta) {
  const el = document.getElementById('unified-file-status');
  if (!el) return;
  if (state === 'parsing') {
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(135deg,rgba(107,70,193,.08),rgba(0,136,204,.06));border:1px solid rgba(107,70,193,.2);border-radius:10px">
        <div style="width:40px;height:40px;border-radius:8px;background:rgba(107,70,193,.12);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="var(--purple)" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
        <div style="flex:1;min-width:0">
          <div style="font-size:12px;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
          <div style="font-size:10px;color:var(--amber);margin-top:3px;display:flex;align-items:center;gap:5px">
            <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--amber);animation:pulse-dot 1s infinite"></span>Parsing file‚Ä¶
          </div>
        </div>
      </div>`;
    return;
  }
  if (state === 'ok' && meta) {
    // Rich success card showing rows, datasets, timestamp
    const { rows, datasets, newRec, updated } = meta;
    el.innerHTML = `
      <div style="background:linear-gradient(135deg,rgba(0,135,90,.06),rgba(0,200,255,.04));border:1px solid rgba(0,135,90,.25);border-radius:10px;overflow:hidden">
        <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(0,135,90,.12)">
          <div style="width:40px;height:40px;border-radius:8px;background:rgba(0,135,90,.12);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="var(--green)" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><polyline points="9 15 11 17 15 13"/></svg></div>
          <div style="flex:1;min-width:0">
            <div style="font-size:12px;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
            <div style="font-size:10px;color:var(--t3);margin-top:2px">${rows} rows parsed ¬∑ Ingested ${new Date().toLocaleTimeString()}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-size:16px;font-weight:800;color:var(--green)">${newRec + updated}</div>
            <div style="font-size:8px;color:var(--t3);letter-spacing:.5px;text-transform:uppercase">Records</div>
          </div>
        </div>
        <div style="display:flex;gap:0">
          <div style="flex:1;padding:8px 14px;text-align:center;border-right:1px solid rgba(0,135,90,.1)">
            <div style="font-size:15px;font-weight:700;color:var(--green)">${newRec}</div>
            <div style="font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">New</div>
          </div>
          <div style="flex:1;padding:8px 14px;text-align:center;border-right:1px solid rgba(0,135,90,.1)">
            <div style="font-size:15px;font-weight:700;color:var(--cyan)">${updated}</div>
            <div style="font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">Updated</div>
          </div>
          <div style="flex:2;padding:8px 14px">
            <div style="font-size:9px;color:var(--t3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Datasets detected</div>
            <div style="display:flex;flex-wrap:wrap;gap:3px">
              ${datasets.map(d => {
                const s = UNIFIED_SCHEMA[d]; if (!s) return '';
                return `<span style="font-size:8px;padding:1px 6px;border-radius:10px;background:${s.bg};color:${s.color};border:1px solid ${s.color}44">${s.icon} ${s.label}</span>`;
              }).join('')}
            </div>
          </div>
        </div>
      </div>`;
    // Append to file history list (don't replace drop zone so user can add more)
    const fileList = document.getElementById('unified-file-list');
    if (fileList) {
      const item = document.createElement('div');
      item.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(0,135,90,.04);border:1px solid rgba(0,135,90,.15);border-radius:6px;margin-bottom:6px;animation:fadeUp .3s ease';
      item.innerHTML = `<div style="width:24px;height:24px;border-radius:50%;background:rgba(0,135,90,.12);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="3,8 6,11 13,5"/></svg></div><div style="flex:1"><div style="font-size:10px;font-weight:600;color:var(--t1)">${name}</div><div style="font-size:9px;color:var(--t3)">${newRec} new ¬∑ ${updated} updated ¬∑ ${datasets.length} dataset type(s)</div></div><span style="font-size:9px;color:var(--green);font-weight:700">${newRec+updated} records</span>`;
      fileList.prepend(item);
    }
    return;
  }
  if (state === 'error') {
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:rgba(217,48,37,.06);border:1px solid rgba(217,48,37,.22);border-radius:10px">
        <div style="width:36px;height:36px;border-radius:50%;background:rgba(217,48,37,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0"><svg viewBox="0 0 16 16" width="16" height="16" fill="none" stroke="var(--red)" stroke-width="2"><circle cx="8" cy="8" r="6"/><line x1="5" y1="5" x2="11" y2="11"/><line x1="11" y1="5" x2="5" y2="11"/></svg></div>
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--red)">${name}</div>
          <div style="font-size:10px;color:var(--t3);margin-top:2px">Could not parse file ‚Äî check format matches template</div>
        </div>
      </div>`;
  }
}

// Missing function ‚Äî update upload history live in individual dataset tabs
function renderIngHistoryLive(fileName, accepted, failed) {
  const wrap = document.getElementById('upload-history');
  if (!wrap) return;
  const time = new Date().toLocaleTimeString();
  const id = 'ihl-' + fileName.replace(/\W/g,'');
  let el = document.getElementById(id);
  if (!el) {
    el = document.createElement('div');
    el.id = id;
    el.className = 'ing-file';
    el.style.cssText = 'display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--bg4);border-radius:6px;margin-bottom:6px;border:1px solid #E2E8F0;animation:fadeUp .3s ease';
    // Insert at top, after any header row
    const first = wrap.querySelector('.ing-hist-header');
    if (first) first.after(el); else wrap.prepend(el);
  }
  const col = accepted > 0 ? 'var(--green)' : 'var(--red)';
  const icon = accepted > 0 ? '‚úì' : '‚úó';
  el.innerHTML = `
    <span style="width:20px;height:20px;border-radius:50%;background:${col}18;display:flex;align-items:center;justify-content:center;font-size:10px;color:${col};flex-shrink:0">${icon}</span>
    <div style="flex:1;min-width:0">
      <div style="font-size:10px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">üìÑ ${fileName}</div>
      <div style="font-size:9px;color:var(--t3);margin-top:1px">${accepted} records ¬∑ ${time}</div>
    </div>
    <span style="font-size:9px;font-weight:600;color:${col}">${accepted > 0 ? accepted + ' ingested' : 'failed'}</span>`;
}

function processUnifiedFile(text, fileName) {
  const { headers, rows } = parseCSV(text);
  if (!rows.length) {
    setUnifiedFileStatus('error', fileName);
    toast(`${fileName}: file appears empty`, 'warning');
    return;
  }

  // Map each header to its dataset type
  const colTypeMap = {};
  headers.forEach(h => {
    const match = ALL_UNIFIED_COLS.find(x => x.col === h.toLowerCase().trim());
    if (match) colTypeMap[h] = match.type;
  });

  // Detect which types are present
  const presentTypes = [...new Set(Object.values(colTypeMap))];
  if (!presentTypes.length) {
    toast(`No recognised EDAFY columns found in ${fileName}. Please use the template.`, 'warning');
    setUnifiedFileStatus('error', fileName);
    return;
  }

  // Show column detection summary before committing
  openUnifiedMappingModal(fileName, headers, rows, colTypeMap, presentTypes);
}

// Staging area for in-flight ingestion data (avoids HTML-attribute JSON injection bugs)
let _pendingUnified = null;
let _pendingTyped   = null;

function openUnifiedMappingModal(fileName, headers, rows, colTypeMap, presentTypes) {
  _pendingUnified = { fileName, rows, colTypeMap, presentTypes };
  const preview = rows.slice(0, 3);
  const unrecognised = headers.filter(h => !colTypeMap[h]);

  openModal(`
    <div class="modal-title" style="display:flex;align-items:center;gap:8px">‚ö° Unified Ingestion ‚Äî ${fileName}</div>
    <div class="modal-sub" style="margin-bottom:12px">
      <strong style="color:var(--purple)">${rows.length} rows</strong> ¬∑ <strong style="color:var(--green)">${Object.keys(colTypeMap).length} recognised columns</strong>
      ${unrecognised.length ? ` ¬∑ <span style="color:var(--amber)">${unrecognised.length} unrecognised (will be ignored)</span>` : ''}
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">
      ${Object.entries(UNIFIED_SCHEMA).map(([type, s]) => {
        const count = Object.values(colTypeMap).filter(t => t === type).length;
        return `<div style="padding:4px 11px;border-radius:14px;font-size:10px;font-weight:600;background:${count?s.bg:'#F8F9FA'};color:${count?s.color:'#9CA3AF'};border:1px solid ${count?s.color+'44':'#E5E7EB'}">
          ${s.icon} ${s.label} ${count?`<span style="opacity:.7">(${count} cols)</span>`:'<span style="opacity:.5">‚Äî</span>'}
        </div>`;
      }).join('')}
    </div>

    <div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px">File Preview (first 3 rows)</div>
    <div style="background:var(--bg4);border-radius:5px;padding:8px;margin-bottom:14px;overflow-x:auto;max-height:110px">
      <table style="font-size:9px">
        <thead><tr>${headers.map(h => `<th style="padding:2px 8px;color:${colTypeMap[h]?UNIFIED_SCHEMA[colTypeMap[h]]?.color:'var(--t3)'};white-space:nowrap">${h}</th>`).join('')}</tr></thead>
        <tbody>${preview.map(r => `<tr>${headers.map(h => `<td style="padding:2px 8px;color:var(--t2);white-space:nowrap;max-width:90px;overflow:hidden;text-overflow:ellipsis">${(r[h]||'').toString().substring(0,40)}</td>`).join('')}</tr>`).join('')}</tbody>
      </table>
    </div>

    ${unrecognised.length ? `
      <div style="background:#FFFBEB;border:1px solid #FDE68A;border-radius:5px;padding:8px 12px;margin-bottom:12px;font-size:10px;color:#92400E">
        ‚ö† Unrecognised columns will be skipped: ${unrecognised.slice(0,8).map(h=>`<code style="background:#FEF3C7;padding:1px 4px;border-radius:2px">${h}</code>`).join(' ')}${unrecognised.length>8?` +${unrecognised.length-8} more`:''}
      </div>` : ''}

    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" style="font-size:11px" onclick="commitUnifiedIngestion()">
        ‚ö° Ingest ${rows.length} Records into ${presentTypes.length} Dataset${presentTypes.length>1?'s':''}
      </button>
      <button class="btn2" onclick="closeModal();_pendingUnified=null">Cancel</button>
    </div>`);
}

function commitUnifiedIngestion() {
  if (!_pendingUnified) { toast('No pending ingestion data', 'warning'); return; }
  const { fileName, rows, colTypeMap } = _pendingUnified;
  _pendingUnified = null;
  closeModal();

  // Counters per type
  const counts = {};
  Object.keys(UNIFIED_SCHEMA).forEach(t => counts[t] = 0);
  let totalNew = 0, totalUpdated = 0, failed = 0;
  const resultRows = [];

  rows.forEach(row => {
    try {
      // Get the analogue name ‚Äî check both analogue_name and basin_name cols
      const anaNameCol = Object.keys(colTypeMap).find(h => h === 'analogue_name');
      const basinNameCol = Object.keys(colTypeMap).find(h => h === 'basin_name');
      const anaName = anaNameCol ? (row[anaNameCol]||'').trim() : '';
      const basinName = basinNameCol ? (row[basinNameCol]||'').trim() : '';

      const recName = anaName || basinName;
      if (!recName) { failed++; return; }

      const datasetsUpdated = [];

      // --- BASIN ---
      if (basinName && Object.values(colTypeMap).includes('basin')) {
        let b = BASINS.find(x => x.name.toLowerCase() === basinName.toLowerCase());
        const isNew = !b;
        if (!b) {
          b = { name:basinName, country:'Unknown', region:'Unknown', tectonic:'Unknown', age:'Unknown', hc:'Oil & Gas', area:0, plays:0, score:50, status:'Active' };
          BASINS.push(b);
        }
        const c = (col) => { const k = Object.keys(colTypeMap).find(h => h===col && colTypeMap[h]==='basin'); return k ? row[k] : null; };
        if (c('basin_country')) b.country = c('basin_country');
        if (c('basin_region')) b.region = c('basin_region');
        if (c('basin_tectonic')) b.tectonic = c('basin_tectonic');
        if (c('basin_age')) b.age = c('basin_age');
        if (c('basin_hc_phase')) b.hc = c('basin_hc_phase');
        if (c('basin_area_km2')) b.area = parseFloat(c('basin_area_km2'))||b.area;
        if (c('basin_plays')) b.plays = parseInt(c('basin_plays'))||b.plays;
        if (c('basin_prospectivity_score')) b.score = parseFloat(c('basin_prospectivity_score'))||b.score;
        if (c('basin_status')) b.status = c('basin_status');
        b._source = fileName;
        datasetsUpdated.push('Basin');
        counts.basin++;
        if (isNew) totalNew++;
      }

      // --- ANALOGUE ---
      if (anaName) {
        let a = ANALOGUES.find(x => x.name.toLowerCase() === anaName.toLowerCase() || anaName.toLowerCase().includes(x.name.toLowerCase().split('‚Äî')[0].trim().toLowerCase()));
        const n = (col, type) => { const k = Object.keys(colTypeMap).find(h => h===col && colTypeMap[h]===type); return k ? row[k] : null; };
        const isNew = !a;
        if (!a) {
          a = { rank:ANALOGUES.length+1, name:anaName, basin:basinName||'Unknown', age:'Unknown', lith:'Unknown', dep:'Unknown', depth:0, hc:'Oil', drive:'Unknown', por:0, perm:0, rf:0, ntg:0, gor:0, api:0, sim:75 };
          ANALOGUES.push(a);
        }
        // Analogue base fields
        if (Object.values(colTypeMap).includes('analogue')) {
          if (n('analogue_basin','analogue')) a.basin = n('analogue_basin','analogue') || a.basin;
          if (n('analogue_age','analogue')) a.age = n('analogue_age','analogue');
          if (n('analogue_lithology','analogue')) a.lith = n('analogue_lithology','analogue');
          if (n('analogue_dep_env','analogue')) a.dep = n('analogue_dep_env','analogue');
          if (n('analogue_depth_mtvdss','analogue')) a.depth = parseFloat(n('analogue_depth_mtvdss','analogue'))||a.depth;
          if (n('analogue_hc_phase','analogue')) a.hc = n('analogue_hc_phase','analogue');
          if (n('analogue_drive_mechanism','analogue')) a.drive = n('analogue_drive_mechanism','analogue');
          if (n('analogue_similarity_pct','analogue')) a.sim = parseFloat(n('analogue_similarity_pct','analogue'))||a.sim;
          datasetsUpdated.push('Analogue');
          counts.analogue++;
        }
        // Reservoir
        if (Object.values(colTypeMap).includes('reservoir')) {
          const nv = col => { const k = Object.keys(colTypeMap).find(h=>h===col&&colTypeMap[h]==='reservoir'); return k?parseFloat(row[k])||null:null; };
          const ns = col => { const k = Object.keys(colTypeMap).find(h=>h===col&&colTypeMap[h]==='reservoir'); return k?row[k]||null:null; };
          if (nv('res_porosity_pct')!==null) a.por = nv('res_porosity_pct');
          if (nv('res_permeability_md')!==null) a.perm = nv('res_permeability_md');
          if (nv('res_recovery_factor_pct')!==null) a.rf = nv('res_recovery_factor_pct');
          if (nv('res_ntg_pct')!==null) a.ntg = nv('res_ntg_pct');
          if (nv('res_gor_scf_bbl')!==null) a.gor = nv('res_gor_scf_bbl');
          if (nv('res_api_gravity')!==null) a.api = nv('res_api_gravity');
          if (nv('res_gross_pay_m')!==null) a.gross_pay = nv('res_gross_pay_m');
          if (nv('res_net_pay_m')!==null) a.net_pay = nv('res_net_pay_m');
          if (nv('res_temperature_c')!==null) a.temp = nv('res_temperature_c');
          if (nv('res_pressure_bar')!==null) a.pres_res = nv('res_pressure_bar');
          if (nv('res_water_saturation')!==null) a.sw = nv('res_water_saturation');
          if (nv('res_bo_rb_stb')!==null) a.bo = nv('res_bo_rb_stb');
          if (nv('res_viscosity_cp')!==null) a.visc = nv('res_viscosity_cp');
          datasetsUpdated.push('Reservoir');
          counts.reservoir++;
        }
        // Geopressure
        if (Object.values(colTypeMap).includes('geopressure')) {
          const nv = col => { const k=Object.keys(colTypeMap).find(h=>h===col&&colTypeMap[h]==='geopressure'); return k?row[k]||null:null; };
          a.geo = a.geo || {};
          if (nv('geo_pore_pressure_gradient_psi_ft')) a.geo.pres_grad = parseFloat(nv('geo_pore_pressure_gradient_psi_ft'));
          if (nv('geo_overburden_gradient_psi_ft')) a.geo.obstr_grad = parseFloat(nv('geo_overburden_gradient_psi_ft'));
          if (nv('geo_fracture_gradient_psi_ft')) a.geo.frac_grad = parseFloat(nv('geo_fracture_gradient_psi_ft'));
          if (nv('geo_ppg_equivalent')) a.geo.ppg = parseFloat(nv('geo_ppg_equivalent'));
          if (nv('geo_ecd_ppg')) a.geo.ecd = parseFloat(nv('geo_ecd_ppg'));
          if (nv('geo_pressure_coefficient')) a.geo.pressure_coeff = parseFloat(nv('geo_pressure_coefficient'));
          if (nv('geo_pressure_regime')) a.geo.pressure_regime = nv('geo_pressure_regime');
          if (nv('geo_overpressure_mechanism')) a.geo.overpressure_mech = nv('geo_overpressure_mechanism');
          if (nv('geo_mudweight_min_ppg')) a.geo.mudweight_min = parseFloat(nv('geo_mudweight_min_ppg'));
          if (nv('geo_mudweight_max_ppg')) a.geo.mudweight_max = parseFloat(nv('geo_mudweight_max_ppg'));
          datasetsUpdated.push('Geopressure');
          counts.geopressure++;
        }
        // Geochemistry
        if (Object.values(colTypeMap).includes('geochem')) {
          const nv = col => { const k=Object.keys(colTypeMap).find(h=>h===col&&colTypeMap[h]==='geochem'); return k?row[k]||null:null; };
          a.geochem = a.geochem || {};
          if (nv('gchem_source_formation')) a.geochem.source_fm = nv('gchem_source_formation');
          if (nv('gchem_kerogen_type')) a.geochem.kerogen_type = nv('gchem_kerogen_type');
          if (nv('gchem_toc_pct')) a.geochem.toc = parseFloat(nv('gchem_toc_pct'));
          if (nv('gchem_vitrinite_reflectance_ro')) a.geochem.ro_vitrinite = parseFloat(nv('gchem_vitrinite_reflectance_ro'));
          if (nv('gchem_hydrogen_index')) a.geochem.hindex = parseFloat(nv('gchem_hydrogen_index'));
          if (nv('gchem_oxygen_index')) a.geochem.oindex = parseFloat(nv('gchem_oxygen_index'));
          if (nv('gchem_tmax_c')) a.geochem.tmax = parseFloat(nv('gchem_tmax_c'));
          if (nv('gchem_expulsion_efficiency_pct')) a.geochem.expulsion_eff = parseFloat(nv('gchem_expulsion_efficiency_pct'));
          if (nv('gchem_charge_volume')) a.geochem.charge_volume = nv('gchem_charge_volume');
          if (nv('gchem_migration_distance_km')) a.geochem.migration_dist = parseFloat(nv('gchem_migration_distance_km'));
          if (nv('gchem_oil_family')) a.geochem.oil_family = nv('gchem_oil_family');
          if (nv('gchem_sulfur_pct')) a.geochem.sulfur_pct = parseFloat(nv('gchem_sulfur_pct'));
          if (nv('gchem_c15_plus_pct')) a.geochem.c15_plus = parseFloat(nv('gchem_c15_plus_pct'));
          if (nv('gchem_predicted_api')) a.geochem.api_pred = parseFloat(nv('gchem_predicted_api'));
          datasetsUpdated.push('Geochemistry');
          counts.geochem++;
        }
        // Mineralogy
        if (Object.values(colTypeMap).includes('mineral')) {
          const nv = col => { const k=Object.keys(colTypeMap).find(h=>h===col&&colTypeMap[h]==='mineral'); return k?row[k]||null:null; };
          a.mineral = a.mineral || {};
          if (nv('min_quartz_pct')) a.mineral.quartz = parseFloat(nv('min_quartz_pct'));
          if (nv('min_feldspar_pct')) a.mineral.feldspar = parseFloat(nv('min_feldspar_pct'));
          if (nv('min_rock_fragments_pct')) a.mineral.rock_fragments = parseFloat(nv('min_rock_fragments_pct'));
          if (nv('min_kaolinite_pct')) a.mineral.kaolinite = parseFloat(nv('min_kaolinite_pct'));
          if (nv('min_illite_pct')) a.mineral.illite = parseFloat(nv('min_illite_pct'));
          if (nv('min_smectite_pct')) a.mineral.smectite = parseFloat(nv('min_smectite_pct'));
          if (nv('min_chlorite_pct')) a.mineral.chlorite = parseFloat(nv('min_chlorite_pct'));
          if (nv('min_calcite_cement_pct')) a.mineral.calcite_cement = parseFloat(nv('min_calcite_cement_pct'));
          if (nv('min_dolomite_pct')) a.mineral.dolomite = parseFloat(nv('min_dolomite_pct'));
          if (nv('min_pyrite_pct')) a.mineral.pyrite = parseFloat(nv('min_pyrite_pct'));
          if (nv('min_clay_total_pct')) a.mineral.clay_total = parseFloat(nv('min_clay_total_pct'));
          if (nv('min_cement_type')) a.mineral.cement_type = nv('min_cement_type');
          datasetsUpdated.push('Mineralogy');
          counts.mineral++;
        }
        // Fluid PVT
        if (Object.values(colTypeMap).includes('fluid')) {
          const nv = col => { const k=Object.keys(colTypeMap).find(h=>h===col&&colTypeMap[h]==='fluid'); return k?row[k]||null:null; };
          a.fluid = a.fluid || {};
          if (nv('pvt_oil_density_g_cc')) a.fluid.oil_density = parseFloat(nv('pvt_oil_density_g_cc'));
          if (nv('pvt_gas_specific_gravity')) a.fluid.gas_sg = parseFloat(nv('pvt_gas_specific_gravity'));
          if (nv('pvt_fvf_oil_rb_stb')) a.fluid.fvf_oil = parseFloat(nv('pvt_fvf_oil_rb_stb'));
          if (nv('pvt_bubble_point_bar')) a.fluid.pb = parseFloat(nv('pvt_bubble_point_bar'));
          if (nv('pvt_solution_gor_scf_stb')) a.fluid.rs = parseFloat(nv('pvt_solution_gor_scf_stb'));
          if (nv('pvt_z_factor')) a.fluid.z_factor = parseFloat(nv('pvt_z_factor'));
          if (nv('pvt_brine_salinity_ppm')) a.fluid.brine_sal = parseFloat(nv('pvt_brine_salinity_ppm'));
          if (nv('pvt_wor')) a.fluid.wor = parseFloat(nv('pvt_wor'));
          if (nv('pvt_h2s_ppm')) a.fluid.h2s_ppm = parseFloat(nv('pvt_h2s_ppm'));
          if (nv('pvt_co2_pct')) a.fluid.co2_pct = parseFloat(nv('pvt_co2_pct'));
          if (nv('pvt_n2_pct')) a.fluid.n2_pct = parseFloat(nv('pvt_n2_pct'));
          if (nv('pvt_c1_methane_pct')) a.fluid.c1_pct = parseFloat(nv('pvt_c1_methane_pct'));
          if (nv('pvt_c2_ethane_pct')) a.fluid.c2_pct = parseFloat(nv('pvt_c2_ethane_pct'));
          if (nv('pvt_c3_propane_pct')) a.fluid.c3_pct = parseFloat(nv('pvt_c3_propane_pct'));
          datasetsUpdated.push('Fluid PVT');
          counts.fluid++;
        }
        // Diagenesis
        if (Object.values(colTypeMap).includes('diagenesis')) {
          const nv = col => { const k=Object.keys(colTypeMap).find(h=>h===col&&colTypeMap[h]==='diagenesis'); return k?row[k]||null:null; };
          a.diagenesis = a.diagenesis || {};
          if (nv('dia_burial_grade')) a.diagenesis.burial_grade = nv('dia_burial_grade');
          if (nv('dia_compaction')) a.diagenesis.compaction = nv('dia_compaction');
          if (nv('dia_cementation')) a.diagenesis.cementation = nv('dia_cementation');
          if (nv('dia_dissolution')) a.diagenesis.dissolution = nv('dia_dissolution');
          if (nv('dia_quartz_overgrowths')) a.diagenesis.qovergrowths = nv('dia_quartz_overgrowths');
          if (nv('dia_chlorite_coating')) a.diagenesis.chlorite_coat = nv('dia_chlorite_coating');
          if (nv('dia_kaolinite_pore_fill')) a.diagenesis.kaolinite_pore = nv('dia_kaolinite_pore_fill');
          if (nv('dia_authigenic_clay')) a.diagenesis.authigenic_clay = nv('dia_authigenic_clay');
          if (nv('dia_grain_coating')) a.diagenesis.grain_coating = nv('dia_grain_coating');
          if (nv('dia_fluid_inclusion_th_c')) a.diagenesis.fluid_inclusion_th = parseFloat(nv('dia_fluid_inclusion_th_c'));
          datasetsUpdated.push('Diagenesis');
          counts.diagenesis++;
        }

        a._source = fileName;
        if (isNew) totalNew++; else totalUpdated++;
        resultRows.push({ name:anaName, basin:a.basin||basinName||'‚Äî', datasets:datasetsUpdated });
      }
    } catch(e) { failed++; }
  });

  // Update live views
  renderBasinTable(BASINS);
  renderTopBasins();

  // Refresh ingestion KPIs
  const accEl = document.getElementById('ing-accepted');
  if (accEl) accEl.textContent = (parseInt(accEl.textContent.replace(/,/g,'')) + totalNew + totalUpdated).toLocaleString();

  // Audit log
  const typesSummary = Object.entries(counts).filter(([,v])=>v>0).map(([k,v])=>`${ING_META[k]?.label||k}:${v}`).join(' ¬∑ ');
  INGESTED_FILES.push({
    id:'FILE-'+Date.now(),
    name:fileName,
    records:totalNew+totalUpdated,
    datasetType:'Multi-dataset ('+Object.entries(counts).filter(([,v])=>v>0).map(([k])=>k).join(', ')+')',
    source:'Unified Upload',
    age:'Just now',
    status:'pending',
    loadedNames:[]
  });
  renderGovQueue();
  AUDIT_ENTRIES.unshift({ time:now(), user:'VJ', action:`Unified upload queued: ${fileName} ¬∑ ${totalNew} new + ${totalUpdated} updated ¬∑ ${typesSummary}`, status:'PENDING', type:'Governance' });
  renderAuditLog(AUDIT_ENTRIES);

  // Render results panel ‚Äî pass rich meta for file status card
  const detectedDatasets = Object.entries(counts).filter(([,v])=>v>0).map(([k])=>k);
  setUnifiedFileStatus('ok', fileName, { rows: rows.length, datasets: detectedDatasets, newRec: totalNew, updated: totalUpdated });
  // Add to INGESTED_FILES for governance review
  const fileId = 'file-' + Date.now();
  INGESTED_FILES.push({
    id: fileId,
    name: fileName,
    records: totalNew + totalUpdated,
    datasetType: detectedDatasets.map(d => UNIFIED_SCHEMA[d]?.label||d).join(', '),
    source: 'VJ',
    age: 'Just now',
    status: 'pending',
    loadedNames: resultRows.map(r => r.name).filter(Boolean),
    datasets: detectedDatasets
  });
  // Update governance badge
  const badge = document.getElementById('gov-files-badge');
  if (badge) badge.textContent = INGESTED_FILES.filter(f=>f.status==='pending').length;
  renderUnifiedResults(fileName, counts, totalNew, totalUpdated, failed, resultRows);

  const total = totalNew + totalUpdated;
  refreshPortfolioKPIs();
  // Refresh maps with newly loaded data
  setTimeout(() => {
    if (_leafletMap) renderMapMarkers();
    if (_portfolioMap) renderPortfolioMapMarkers();
  }, 200);
  toast(`‚ö° ${total} records ingested from ${fileName} across ${Object.values(counts).filter(v=>v>0).length} datasets`, 'success');
  if (total > 0) setTimeout(() => toast('‚Üí Open Analogue Engine to explore your new records', 'info'), 1800);
}

function renderUnifiedResults(fileName, counts, totalNew, totalUpdated, failed, resultRows) {
  const panel = document.getElementById('unified-results');
  if (!panel) return;
  panel.style.display = 'block';

  document.getElementById('unified-results-title').textContent = `Ingestion Results ‚Äî ${fileName}`;

  // Breakdown chips
  const breakdownEl = document.getElementById('unified-breakdown');
  breakdownEl.innerHTML = Object.entries(UNIFIED_SCHEMA).map(([type, s]) => {
    const n = counts[type] || 0;
    return `<div style="background:${n?s.bg:'#F8F9FA'};border:1px solid ${n?s.color+'44':'#E5E7EB'};border-radius:8px;padding:10px 12px;text-align:center">
      <div style="font-size:20px">${s.icon}</div>
      <div style="font-size:10px;font-weight:700;color:${n?s.color:'var(--t3)'};margin:3px 0">${s.label}</div>
      <div style="font-size:20px;font-weight:700;color:${n?s.color:'var(--t3)'}">${n}</div>
      <div style="font-size:8px;color:var(--t3)">records</div>
    </div>`;
  }).join('');

  // Summary stats
  breakdownEl.innerHTML += `
    <div style="background:#F5F0FF;border:1px solid #D8C9FF;border-radius:8px;padding:10px 12px;text-align:center;grid-column:span 2">
      <div style="font-size:10px;font-weight:700;color:var(--purple);margin-bottom:4px">Summary</div>
      <div style="display:flex;justify-content:space-around">
        <div><div style="font-size:18px;font-weight:700;color:var(--green)">${totalNew}</div><div style="font-size:8px;color:var(--t3)">New</div></div>
        <div><div style="font-size:18px;font-weight:700;color:var(--cyan)">${totalUpdated}</div><div style="font-size:8px;color:var(--t3)">Updated</div></div>
        <div><div style="font-size:18px;font-weight:700;color:${failed?'var(--red)':'var(--t3)'}">${failed}</div><div style="font-size:8px;color:var(--t3)">Failed</div></div>
      </div>
    </div>`;

  // Result rows table
  document.getElementById('unified-result-tbody').innerHTML = resultRows.map(r => `
    <tr>
      <td style="font-weight:600;color:var(--t1)">${r.name}</td>
      <td style="color:var(--t2)">${r.basin}</td>
      <td>
        <div style="display:flex;flex-wrap:wrap;gap:4px">
          ${r.datasets.map(d => {
            const s = Object.values(UNIFIED_SCHEMA).find(x=>x.label===d);
            return `<span style="background:${s?s.bg:'#F0F4FA'};color:${s?s.color:'var(--t3)'};font-size:8px;padding:1px 7px;border-radius:10px;border:1px solid ${s?s.color+'33':'transparent'}">${s?s.icon:''} ${d}</span>`;
          }).join('')}
        </div>
      </td>
      <td><span class="tl tl-g">‚úì Ingested</span></td>
      <td><button class="btn2" style="font-size:9px;padding:3px 8px" onclick="goTo('analogues',null);toast('Searching for ${r.name}','info')">View ‚Üí</button></td>
    </tr>`).join('');

  // Scroll into view
  panel.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

// ============================================================
// TEMPLATE DOWNLOADS ‚Äî all types + unified master template
// ============================================================
function downloadTemplate(type) {
  const templates = {
    basin: {
      name:'edafy_basin_template.csv',
      data:`name,country,region,tectonic,age,hc,area,plays,score,status
Arabian Platform,Saudi Arabia,Middle East,Passive Margin,Cambrian‚ÄìCretaceous,Oil,580000,28,95,Mature
Sirte Basin,Libya,North Africa,Rift Basin,Cretaceous‚ÄìEocene,Oil & Gas,440000,14,71,Active
Cooper Basin,Australia,Australasia,Intracratonic,Permian‚ÄìTriassic,Gas,130000,9,55,Mature`
    },
    analogue: {
      name:'edafy_analogue_template.csv',
      data:`analogue_name,basin,age,lithology,dep_env,depth_mtvdss,hc_phase,drive_mechanism,porosity_pct,permeability_md,recovery_factor_pct,ntg_pct,gor_scf_bbl,api_gravity
Arabian Limestone Play,Arabian Platform,Cretaceous,Carbonate,Reef,2200,Oil,Water Drive,18.5,45,32,72,420,33
Sirte Cretaceous SS,Sirte Basin,Cretaceous,Sandstone,Fluvial,2800,Oil,Solution Gas,21.0,280,35,65,510,35`
    },
    reservoir: {
      name:'edafy_reservoir_template.csv',
      data:`analogue_name,basin,age,lithology,dep_env,depth_mtvdss,hc_phase,drive_mechanism,porosity_pct,permeability_md,recovery_factor_pct,ntg_pct,gor_scf_bbl,api_gravity,gross_pay_m,net_pay_m,temperature_c,reservoir_pressure_bar,water_saturation,bo_rb_stb,viscosity_cp
Malay Basin ‚Äî Arang Fm.,Malay Basin,Miocene,Sandstone,Deltaic,2800,Oil,Water Drive,24.2,412,38,68,520,34,42,29,98,285,0.22,1.28,1.8
Kutei Basin ‚Äî Tunu Field,Kutei Basin,Miocene,Sandstone,Fluvio-Deltaic,3100,Gas,Solution Gas,22.8,285,35,62,8400,36,88,55,112,318,0.28,1.22,0.9
Borneo ‚Äî Miri Formation,Borneo Basin,Eocene,Sandstone,Shallow Marine,3400,Oil,Water Drive,19.5,195,31,55,480,30,56,31,118,348,0.30,1.19,3.1`
    },
    geopressure: {
      name:'edafy_geopressure_template.csv',
      data:`analogue_name,basin,depth_mtvdss,pore_pressure_gradient_psi_ft,overburden_gradient_psi_ft,fracture_gradient_psi_ft,ppg_equivalent,ecd_ppg,pressure_coefficient,pressure_regime,overpressure_mechanism,mudweight_min_ppg,mudweight_max_ppg
Malay Basin ‚Äî Arang Fm.,Malay Basin,2800,0.465,1.02,0.75,8.95,9.1,1.02,Slightly overpressured,Compaction disequilibrium,9.0,10.5
Kutei Basin ‚Äî Tunu Field,Kutei Basin,3100,0.478,1.05,0.78,9.18,9.4,1.08,Moderately overpressured,Hydrocarbon generation,9.3,11.0
Gulf of Mexico ‚Äî Wilcox,Gulf of Mexico,4800,0.722,1.18,0.92,13.88,14.2,1.55,Highly overpressured,Compaction disequilibrium + smectite-illite transformation,14.0,16.5`
    },
    geochem: {
      name:'edafy_geochemistry_template.csv',
      data:`analogue_name,basin,source_formation,kerogen_type,toc_pct,vitrinite_reflectance_ro,hydrogen_index_mg_hc_g_toc,oxygen_index_mg_co2_g_toc,tmax_c,expulsion_efficiency_pct,charge_volume,migration_distance_km,oil_family,sulfur_pct,c15_plus_pct,predicted_api
Malay Basin ‚Äî Arang Fm.,Malay Basin,Brown Shale Fm.,Type II,2.8,0.62,380,42,432,62,High,18,Waxy,0.18,72,33
Kutei Basin ‚Äî Tunu Field,Kutei Basin,Pamaluan Shale,Type II/III,3.2,0.74,290,28,445,55,Very High,8,Paraffinic,0.08,48,36
Gulf of Mexico ‚Äî Wilcox,Gulf of Mexico,Tuscaloosa Marine Shale,Type II/IIS,4.2,0.95,280,48,462,58,High,45,Sulfur-rich,1.8,85,28`
    },
    mineral: {
      name:'edafy_mineralogy_template.csv',
      data:`analogue_name,basin,quartz_pct,feldspar_pct,rock_fragments_pct,kaolinite_pct,illite_pct,smectite_pct,chlorite_pct,calcite_cement_pct,dolomite_pct,pyrite_pct,siderite_pct,mica_pct,clay_total_pct,cement_type
Malay Basin ‚Äî Arang Fm.,Malay Basin,62,14,8,7,4,2,1,2,0,0.5,0,0.5,14,Silica + Kaolinite
Kutei Basin ‚Äî Tunu Field,Kutei Basin,58,18,10,5,5,1,2,1,0,0.3,0.2,0.5,13,Silica
Gulf of Mexico ‚Äî Wilcox,Gulf of Mexico,48,20,12,5,8,1,4,5,2,1.2,0.4,1.4,18,Calcite + Illite + Chlorite`
    },
    fluid: {
      name:'edafy_fluid_pvt_template.csv',
      data:`analogue_name,basin,oil_density_g_cc,gas_specific_gravity,fvf_oil_rb_stb,bubble_point_bar,solution_gor_scf_stb,z_factor,brine_salinity_ppm,wor,h2s_ppm,co2_pct,n2_pct,c1_methane_pct,c2_ethane_pct,c3_propane_pct
Malay Basin ‚Äî Arang Fm.,Malay Basin,0.855,0.72,1.28,185,85,0.88,22400,0.4,12,3.2,1.1,38,8,5
Kutei Basin ‚Äî Tunu Field,Kutei Basin,0.842,0.68,1.22,220,42,0.92,18600,0.1,5,1.8,2.2,88,5,2
Gulf of Mexico ‚Äî Wilcox,Gulf of Mexico,0.884,0.78,1.35,128,68,0.82,38500,2.1,120,8.2,1.8,22,5,3`
    },
    diagenesis: {
      name:'edafy_diagenesis_template.csv',
      data:`analogue_name,basin,burial_grade,compaction,cementation,dissolution,quartz_overgrowths,chlorite_coating,kaolinite_pore_fill,authigenic_clay,grain_coating,fluid_inclusion_th_c
Malay Basin ‚Äî Arang Fm.,Malay Basin,Early‚ÄìMiddle burial,Moderate,Low‚ÄìModerate,Present (feldspar leaching),Minor,Absent,Present,Kaolinite dominant,Partial,88
Kutei Basin ‚Äî Tunu Field,Kutei Basin,Middle burial,Moderate‚ÄìHigh,Low,Extensive (feldspar),Present,Partial,Absent,Illite + Chlorite,Moderate,102
Gulf of Mexico ‚Äî Wilcox,Gulf of Mexico,Deep‚ÄìUltradeep burial,Very High,High,Moderate (carbonate),Extensive,Present,Absent,Illite dominant,Strong,138`
    },
    seismic: {
      name:'edafy_seismic_template.csv',
      data:`analogue_name,basin,survey_type,vintage,dominant_frequency_hz,migration_type,fold_coverage,noise_level,trap_type,closure_area_km2,amplitude_anomaly,dip_angle_deg,fault_seal_risk,time_depth_uncertainty_ms,gross_rock_volume_bcm
Malay Basin ‚Äî Arang Fm.,Malay Basin,3D,2018,45,PSTM,120,Low,Four-way Dip,42,DHI ‚Äî Class IIb,4,Low,12,8.4
Kutei Basin ‚Äî Tunu Field,Kutei Basin,3D,2016,38,PSDM,180,Low,Anticlinal + Fault,88,DHI ‚Äî Class III,7,Moderate,18,22.1`
    },
    production: {
      name:'edafy_production_template.csv',
      data:`analogue_name,basin,first_production_year,plateau_rate_kboed,plateau_duration_yr,decline_rate_pct_yr,eur_mmboe,cumulative_to_date_mmboe,well_count,avg_per_well_mmboe,capex_musd,opex_usd_boe,abandonment_cost_musd
Malay Basin ‚Äî Arang Fm.,Malay Basin,1998,48,8,18,320,248,24,13.3,1840,12.8,220
Kutei Basin ‚Äî Tunu Field,Kutei Basin,2002,62,12,12,580,410,36,16.1,2400,9.4,310`
    },
    welldata: {
      name:'edafy_well_data_template.csv',
      data:`analogue_name,basin,well_name,well_type,spud_date,td_m,tvdss_m,kelly_bushing_m,latitude_dd,longitude_dd,operator,water_depth_m,core_length_m,core_porosity_avg_pct,core_perm_avg_md,dst_result
Malay Basin ‚Äî Arang Fm.,Malay Basin,PMO-1,Wildcat,1996-03-15,3480,3420,28,4.82,103.28,Petronas,0,48,24.8,388,Oil 3200 bopd
Kutei Basin ‚Äî Tunu Field,Kutei Basin,TUN-A02,Appraisal,2001-07-22,4180,4050,35,0.42,117.58,Total,0,62,22.1,265,Gas 28 MMscfd`
    },
    isotope: {
      name:'edafy_isotope_biomarker_template.csv',
      data:`analogue_name,basin,d13c_saturate_permil,d13c_aromatic_permil,d13c_whole_oil_permil,dD_permil,pristane_phytane_ratio,dibenzothiophene_phenanthrene,gammacerane_index,oleanane_index,c31_hopane_22s_22r,sterane_c27_pct,sterane_c28_pct,sterane_c29_pct,oil_source_correlation
Malay Basin ‚Äî Arang Fm.,Malay Basin,-28.2,-27.8,-28.0,-142,2.8,0.08,0.12,0.02,0.62,28,22,50,Brown Shale Fm. ‚Äî Type II
Kutei Basin ‚Äî Tunu Field,Kutei Basin,-27.5,-27.1,-27.3,-138,3.1,0.05,0.08,0.01,0.64,24,19,57,Pamaluan Shale ‚Äî Type II/III`
    },
    petrophysics: {
      name:'edafy_petrophysics_template.csv',
      data:`analogue_name,basin,phit_avg,phie_avg,vsh_avg,sw_avg,bvw_avg,archie_a,archie_m,archie_n,fwl_mtvdss,owc_mtvdss,goc_mtvdss,sonic_dt,density_rhob,neutron_nphi,gamma_ray_api,rt_resistivity_ohmm,rxo_shallow_resistivity
Malay Basin ‚Äî Arang Fm.,Malay Basin,25.8,24.2,12.4,0.22,0.053,1.0,1.95,2.0,2958,2952,,70,2.22,24.8,42,28.4,85.2
Kutei Basin ‚Äî Tunu Field,Kutei Basin,24.1,22.8,14.8,0.28,0.064,1.0,1.88,2.0,3240,,,66,2.26,23.1,48,22.8,72.1`
    },
    geomechanics: {
      name:'edafy_geomechanics_template.csv',
      data:`analogue_name,basin,ucs_mpa,youngs_modulus_gpa,poissons_ratio,sigma_v,sigma_h_min,sigma_h_max,stress_regime,shmax_azimuth,mud_weight_window_ppg_min,mud_weight_window_ppg_max,breakout_width_deg,fracture_density,fracture_orientation_deg,fracture_aperture_um,sand_production_risk
Malay Basin ‚Äî Arang Fm.,Malay Basin,38.2,18.4,0.26,62.5,42.8,58.4,Normal faulting,N42E,9.0,12.4,24,Moderate,N38E,85,Low
Kutei Basin ‚Äî Tunu Field,Kutei Basin,44.8,22.1,0.24,75.2,58.4,72.8,Strike-slip,N28E,9.4,13.8,18,High,N22E,120,Moderate`
    },
    thermal: {
      name:'edafy_thermal_template.csv',
      data:`analogue_name,basin,vitrinite_reflectance_ro,tmax_c,tti_lopatin,surface_heat_flow_mw_m2,thermal_gradient,max_burial_depth,age_peak_generation,subsidence_rate,trap_timing_vs_generation,charge_risk_rating
Malay Basin ‚Äî Arang Fm.,Malay Basin,0.62,432,28,72,32,4200,Miocene 12‚Äì8 Ma,80,Favourable ‚Äî trap predates peak generation,Low
Kutei Basin ‚Äî Tunu Field,Kutei Basin,0.74,445,48,68,30,5100,Miocene 10‚Äì6 Ma,95,Favourable ‚Äî concurrent charge and trap,Low`
    },
    environmental: {
      name:'edafy_environmental_template.csv',
      data:`analogue_name,basin,h2s_ppm,co2_pct,hg_ppb,protected_area_flag,marine_mammal_presence,seismic_survey_restriction,environmental_impact_category,spill_response_tier,hydrate_risk,hse_risk_class
Malay Basin ‚Äî Arang Fm.,Malay Basin,12,3.2,8,No,Low,None,Moderate,1,Low,Low
Kutei Basin ‚Äî Tunu Field,Kutei Basin,5,1.8,4,No,None,None,Low,1,Low,Low
Gulf of Mexico ‚Äî Wilcox,Gulf of Mexico,120,8.2,22,Yes,High,Seasonal (Apr‚ÄìOct),High,2,Moderate,High`
    },
    commercials: {
      name:'edafy_commercial_template.csv',
      data:`analogue_name,basin,gross_resources_mmboe,net_resources_mmboe,recovery_factor,plateau_rate,capex_musd,opex_usd_boe,royalty_tax_rate,npv_10_musd,irr_pct,breakeven_price,fiscal_regime,government_take_pct,infrastructure_access,tieback_distance_km,contingent_resources_class,prms_status
Malay Basin ‚Äî Arang Fm.,Malay Basin,320,176,38,48,1840,12.8,38,842,22,28,PSC,62,Excellent ‚Äî onshore pipeline grid,0,2C,Contingent
Kutei Basin ‚Äî Tunu Field,Kutei Basin,580,348,40,62,2400,9.4,35,1480,28,22,PSC,58,Good ‚Äî LNG infrastructure,0,1C,Contingent`
    },
    unified: {
      name:'edafy_master_template.csv',
      data:[
        [
          // Basin
          'basin_name','basin_country','basin_region','basin_tectonic','basin_age','basin_hc_phase','basin_area_km2','basin_plays','basin_prospectivity_score','basin_status',
          // Analogue
          'analogue_name','analogue_basin','analogue_age','analogue_lithology','analogue_dep_env','analogue_depth_mtvdss','analogue_hc_phase','analogue_drive_mechanism','analogue_similarity_pct',
          // Reservoir
          'res_porosity_pct','res_permeability_md','res_recovery_factor_pct','res_ntg_pct','res_gor_scf_bbl','res_api_gravity','res_gross_pay_m','res_net_pay_m','res_temperature_c','res_pressure_bar','res_water_saturation','res_bo_rb_stb','res_viscosity_cp',
          // Geopressure
          'geo_pore_pressure_gradient_psi_ft','geo_overburden_gradient_psi_ft','geo_fracture_gradient_psi_ft','geo_ppg_equivalent','geo_ecd_ppg','geo_pressure_coefficient','geo_pressure_regime','geo_overpressure_mechanism','geo_mudweight_min_ppg','geo_mudweight_max_ppg',
          // Geochemistry
          'gchem_source_formation','gchem_kerogen_type','gchem_toc_pct','gchem_vitrinite_reflectance_ro','gchem_hydrogen_index','gchem_oxygen_index','gchem_tmax_c','gchem_expulsion_efficiency_pct','gchem_charge_volume','gchem_migration_distance_km','gchem_oil_family','gchem_sulfur_pct','gchem_c15_plus_pct','gchem_predicted_api',
          // Mineralogy
          'min_quartz_pct','min_feldspar_pct','min_rock_fragments_pct','min_kaolinite_pct','min_illite_pct','min_smectite_pct','min_chlorite_pct','min_calcite_cement_pct','min_dolomite_pct','min_pyrite_pct','min_siderite_pct','min_mica_pct','min_clay_total_pct','min_cement_type',
          // Fluid PVT
          'pvt_oil_density_g_cc','pvt_gas_specific_gravity','pvt_fvf_oil_rb_stb','pvt_bubble_point_bar','pvt_solution_gor_scf_stb','pvt_z_factor','pvt_brine_salinity_ppm','pvt_wor','pvt_h2s_ppm','pvt_co2_pct','pvt_n2_pct','pvt_c1_methane_pct','pvt_c2_ethane_pct','pvt_c3_propane_pct',
          // Diagenesis
          'dia_burial_grade','dia_compaction','dia_cementation','dia_dissolution','dia_quartz_overgrowths','dia_chlorite_coating','dia_kaolinite_pore_fill','dia_authigenic_clay','dia_grain_coating','dia_fluid_inclusion_th_c',
          // Seismic
          'sei_survey_type','sei_vintage','sei_dominant_frequency_hz','sei_trap_type','sei_closure_area_km2','sei_amplitude_anomaly','sei_fault_seal_risk','sei_gross_rock_volume_bcm',
          // Production
          'prod_plateau_rate_kboed','prod_plateau_duration_yr','prod_eur_mmboe','prod_decline_rate_pct_yr','prod_capex_musd','prod_opex_usd_boe',
          // Petrophysics
          'petro_phit_avg','petro_phie_avg','petro_vsh_avg','petro_sw_avg','petro_archie_m','petro_fwl_mtvdss','petro_owc_mtvdss','petro_gamma_ray_api','petro_density_rhob',
          // Geomechanics
          'gmech_ucs_mpa','gmech_youngs_modulus_gpa','gmech_poissons_ratio','gmech_stress_regime','gmech_fracture_density','gmech_sand_production_risk',
          // Thermal
          'therm_vitrinite_ro','therm_surface_heat_flow_mw_m2','therm_thermal_gradient','therm_tmax_c','therm_charge_risk_rating',
          // Environmental
          'env_h2s_ppm','env_co2_pct','env_protected_area','env_hydrate_risk','env_hse_risk_class',
          // Commercial
          'com_gross_resources_mmboe','com_npv_10_musd','com_irr_pct','com_breakeven_price','com_fiscal_regime','com_government_take_pct','com_infrastructure_access'
        ].join(','),
        // ‚îÄ‚îÄ ROW 1 ‚Äî Malay Basin / Arang Fm. (Oil, deltaic sandstone) ‚îÄ‚îÄ
        [
          'Malay Basin','Malaysia','Southeast Asia','Rift Basin','Eocene‚ÄìMiocene','Oil','85000','10','77','Mature',
          'Malay Basin ‚Äî Arang Fm.','Malay Basin','Miocene','Sandstone','Deltaic','2800','Oil','Water Drive','93',
          '24.2','412','38','68','520','34','42','29','98','285','0.22','1.28','1.8',
          '0.465','1.02','0.75','8.95','9.1','1.02','Slightly overpressured','Compaction disequilibrium','9.0','10.5',
          'Brown Shale Fm.','Type II','2.8','0.62','380','42','432','62','High','18','Waxy','0.18','72','33',
          '62','14','8','7','4','2','1','2','0','0.5','0','0.5','14','Silica + Kaolinite',
          '0.855','0.72','1.28','185','85','0.88','22400','0.4','12','3.2','1.1','38','8','5',
          'Early‚ÄìMiddle burial','Moderate','Low‚ÄìModerate','Present (feldspar leaching)','Minor','Absent','Present','Kaolinite dominant','Partial','88',
          '3D','2018','45','Four-way Dip','42','DHI ‚Äî Class IIb','Low','8.4',
          '48','8','320','18','1840','12.8',
          '25.8','24.2','12.4','0.22','1.95','2958','2952','42','2.22',
          '38.2','18.4','0.26','Normal faulting','Moderate','Low',
          '0.62','72','32','432','Low',
          '12','3.2','No','Low','Low',
          '320','842','22','28','PSC','62','Excellent'
        ].join(','),
        // ‚îÄ‚îÄ ROW 2 ‚Äî Kutei Basin / Tunu Field (Gas, fluvio-deltaic) ‚îÄ‚îÄ
        [
          'Kutei Basin','Indonesia','Southeast Asia','Foreland','Eocene‚ÄìMiocene','Gas','165000','12','74','Active',
          'Kutei Basin ‚Äî Tunu Field','Kutei Basin','Miocene','Sandstone','Fluvio-Deltaic','3100','Gas','Solution Gas','87',
          '22.8','285','35','62','8400','36','88','55','112','318','0.28','1.22','0.9',
          '0.478','1.05','0.78','9.18','9.4','1.08','Moderately overpressured','Hydrocarbon generation','9.3','11.0',
          'Pamaluan Shale','Type II/III','3.2','0.74','290','28','445','55','Very High','8','Paraffinic','0.08','48','36',
          '58','18','10','5','5','1','2','1','0','0.3','0.2','0.5','13','Silica',
          '0.842','0.68','1.22','220','42','0.92','18600','0.1','5','1.8','2.2','88','5','2',
          'Middle burial','Moderate‚ÄìHigh','Low','Extensive (feldspar)','Present','Partial','Absent','Illite + Chlorite','Moderate','102',
          '3D','2016','38','Anticlinal + Fault','88','DHI ‚Äî Class III','Moderate','22.1',
          '62','12','580','12','2400','9.4',
          '24.1','22.8','14.8','0.28','1.88','3240','','48','2.26',
          '44.8','22.1','0.24','Strike-slip','High','Moderate',
          '0.74','68','30','445','Low',
          '5','1.8','No','Low','Low',
          '580','1480','28','22','PSC','58','Good'
        ].join(','),
        // ‚îÄ‚îÄ ROW 3 ‚Äî Nile Delta / Abu Madi (Gas, shallow marine) ‚îÄ‚îÄ
        [
          'Nile Delta','Egypt','North Africa','Passive Margin','Oligocene‚ÄìRecent','Gas','89000','8','68','Active',
          'Nile Delta ‚Äî Abu Madi Fm.','Nile Delta','Miocene','Sandstone','Shallow Marine','2400','Gas','Water Drive','79',
          '26.5','580','41','74','7200','37','38','28','88','248','0.19','1.18','0.6',
          '0.451','0.98','0.72','8.66','8.8','0.98','Normally pressured','None','8.6','9.4',
          'Apollonia Carbonate','Type II/III','1.9','0.55','260','35','428','48','Moderate','25','Mixed','0.12','55','37',
          '64','12','9','6','3','2','1','3','0','0.4','0.1','0.5','12','Silica + Calcite',
          '0.838','0.66','1.19','195','38','0.91','15800','0.2','3','1.4','0.9','91','4','2',
          'Early burial','Low‚ÄìModerate','Low','Minor (carbonate)','Absent','Absent','Minor','Kaolinite','Minor','72',
          '3D','2015','50','Rollover Anticline','38','DHI ‚Äî Class IIa','Low','6.2',
          '55','10','280','14','1240','14.2',
          '27.4','26.5','10.2','0.19','1.92','2568','2562','38','2.18',
          '42.4','20.8','0.27','Normal faulting','Low','Low',
          '0.55','65','28','428','Low',
          '3','1.4','No','Low','Low',
          '280','620','18','24','PSC','60','Good'
        ].join(',')
      ].join('\n')
    },
  };

  const t = templates[type];
  if (!t) { toast('Template not found', 'error'); return; }
  const csvData = Array.isArray(t.data) ? t.data.join('\n') : t.data;
  const blob = new Blob([csvData], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = t.name;
  a.click();
  if (type === 'unified') {
    toast('Master template downloaded ‚Äî covers all 12 dataset types in one file', 'success');
    setTimeout(() => toast('Tip: You only need columns you have data for ‚Äî leave others blank', 'info'), 2000);
  } else {
    toast(`${t.name} downloaded ‚Äî fill in your data and upload via the matching tab`, 'success');
  }
}

function downloadAllTemplates() {
  const TYPES = ['unified','basin','analogue','reservoir','geopressure','geochem','mineral','fluid','diagenesis',
    'seismic','production','welldata','isotope','petrophysics','geomechanics','thermal','environmental','commercials'];
  let idx = 0;
  toast(`Downloading ${TYPES.length} template files‚Ä¶`, 'info');
  function next() {
    if (idx >= TYPES.length) { toast('All templates downloaded!', 'success'); return; }
    downloadTemplate(TYPES[idx++]);
    setTimeout(next, 400);
  }
  next();
}


// ============================================================
// BASIN CATALOGUE TABS
// ============================================================
// ============================================================
// PORTFOLIO TABS
// ============================================================
// ============================================================
// PORTFOLIO KPI REFRESH ‚Äî called after any data ingestion
// ============================================================
function refreshPortfolioKPIs() {
  // Refresh map markers too
  setTimeout(() => renderMapMarkers && renderMapMarkers(), 100);
  // Active Basins
  const basinEl = document.getElementById('kpi-basins');
  if (basinEl) basinEl.textContent = BASINS.length.toLocaleString();

  // Analogue Intervals
  const anaEl = document.getElementById('kpi-analogues');
  if (anaEl) anaEl.textContent = (5847 + ANALOGUES.length).toLocaleString();

  // Avg Prospectivity ‚Äî live from BASINS
  const avgScore = BASINS.length
    ? (BASINS.reduce((s,b) => s + (b.score||0), 0) / BASINS.length).toFixed(1)
    : '67.4';
  const prospEl = document.getElementById('kpi-prospectivity');
  if (prospEl) prospEl.textContent = avgScore;
  const prospBar = document.getElementById('kpi-prosp-bar');
  if (prospBar) prospBar.style.width = avgScore + '%';

  // Data Quality ‚Äî computed from field completeness across BASINS + ANALOGUES
  const basinFields = ['name','country','region','tectonic','age','hc','area','plays','score','status'];
  const anaFields   = ['name','basin','age','lith','dep','depth','hc','por','perm','rf'];
  const totalCells  = BASINS.length * basinFields.length + ANALOGUES.length * anaFields.length;
  const filledCells = BASINS.reduce((s,b)  => s + basinFields.filter(f => b[f]!=null && b[f]!=='' && b[f]!==0).length, 0)
                    + ANALOGUES.reduce((s,a) => s + anaFields.filter(f => a[f]!=null && a[f]!=='' && a[f]!==0).length, 0);
  const quality = totalCells > 0 ? (filledCells / totalCells * 100).toFixed(1) : '96.1';
  const qEl = document.getElementById('kpi-quality');
  if (qEl) { qEl.textContent = quality + '%'; qEl.style.color = quality >= 90 ? 'var(--green)' : quality >= 70 ? 'var(--amber)' : 'var(--red)'; }
  const qBar = document.getElementById('kpi-quality-bar');
  if (qBar) { qBar.style.width = quality + '%'; qBar.style.background = quality >= 90 ? 'var(--green)' : quality >= 70 ? 'var(--amber)' : 'var(--red)'; }
  const qDelta = document.getElementById('kpi-quality-delta');
  if (qDelta) {
    const flagged = BASINS.filter(b => !b.country || !b.score).length + ANALOGUES.filter(a => !a.por || !a.depth).length;
    qDelta.textContent = flagged > 0 ? `‚Üì ${flagged} flagged` : '‚úì All clean';
    qDelta.className = 'kpi-delta ' + (flagged > 0 ? 'dn' : 'up');
  }

  // Also reset resource/risk rendered flags so they recompute with fresh data
  const rp = document.getElementById('pt-resource-panel');
  if (rp) delete rp.dataset.rendered;
  const riskP = document.getElementById('pt-risk-panel');
  if (riskP) delete riskP.dataset.rendered;
}

function switchPortfolioTab(tab, el) {
  ['overview','resource','risk'].forEach(t => {
    const p = document.getElementById('pt-' + t + '-panel');
    if (p) p.style.display = (t === tab) ? 'block' : 'none';
  });
  el.closest('.tabs').querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  el.classList.add('on');
  if (tab === 'resource') renderResourceSummary();
  if (tab === 'risk')     renderRiskProfile();
}

// ============================================================
// RESOURCE SUMMARY
// ============================================================
function renderResourceSummary() {
  const el = document.getElementById('pt-resource-panel');
  if (!el || el.dataset.rendered) return;
  el.dataset.rendered = '1';

  // KPIs
  const allPors  = ANALOGUES.filter(a=>a.por>0).map(a=>a.por);
  const allPerms = ANALOGUES.filter(a=>a.perm>0).map(a=>a.perm);
  const allRFs   = ANALOGUES.filter(a=>a.rf>0).map(a=>a.rf);
  const avgPor   = (allPors.reduce((s,v)=>s+v,0)/Math.max(allPors.length,1)).toFixed(1);
  const avgPerm  = Math.round(allPerms.reduce((s,v)=>s+v,0)/Math.max(allPerms.length,1));
  const avgRF    = (allRFs.reduce((s,v)=>s+v,0)/Math.max(allRFs.length,1)).toFixed(1);
  const totalP50 = ANALOGUES.reduce((s,a)=>s+stoiipEst(a,'p50'),0);

  document.getElementById('rs-kpis').innerHTML = [
    {lbl:'Total Portfolio P50',       val: Math.round(totalP50).toLocaleString()+' MMboe', sub:'Sum across all analogues', col:'var(--purple)'},
    {lbl:'Average Porosity',          val: avgPor+'%',                                      sub:`${allPors.length} reservoir intervals`, col:'var(--cyan)'},
    {lbl:'Median Permeability',       val: avgPerm+' mD',                                   sub:'Arithmetic mean', col:'var(--amber)'},
    {lbl:'Average Recovery Factor',   val: avgRF+'%',                                       sub:'All drive mechanisms', col:'var(--green)'},
  ].map(k=>`<div class="kpi"><div class="kpi-lbl">${k.lbl}</div>
    <div class="kpi-val" style="color:${k.col};font-size:${k.val.length>12?'16px':'22px'}">${k.val}</div>
    <div class="kpi-sub">${k.sub}</div></div>`).join('');

  // Basin table
  const basinGroups = {};
  ANALOGUES.forEach(a => {
    const bn = a.basin||'Unknown';
    if (!basinGroups[bn]) basinGroups[bn] = [];
    basinGroups[bn].push(a);
  });
  const tbody = document.getElementById('rs-basin-tbody');
  if (tbody) {
    const rows = Object.entries(basinGroups).map(([bn, anas]) => {
      const basin = BASINS.find(b=>b.name===bn) || {};
      const p50 = anas.reduce((s,a)=>s+stoiipEst(a,'p50'),0);
      const p10 = anas.reduce((s,a)=>s+stoiipEst(a,'p10'),0);
      const p90 = anas.reduce((s,a)=>s+stoiipEst(a,'p90'),0);
      const avgPorB = (anas.filter(a=>a.por>0).reduce((s,a)=>s+a.por,0)/Math.max(anas.filter(a=>a.por>0).length,1)).toFixed(1);
      const avgPermB= Math.round(anas.filter(a=>a.perm>0).reduce((s,a)=>s+a.perm,0)/Math.max(anas.filter(a=>a.perm>0).length,1));
      const hcs = [...new Set(anas.map(a=>a.hc).filter(Boolean))].join(' / ');
      const statusCol = {Mature:'var(--green)',Active:'var(--cyan)',Frontier:'var(--amber)'}[basin.status]||'var(--t3)';
      return {bn, count:anas.length, p10:Math.round(p10), p50:Math.round(p50), p90:Math.round(p90), avgPorB, avgPermB, hcs, status:basin.status||'‚Äî', statusCol};
    }).sort((a,b)=>b.p50-a.p50);

    tbody.innerHTML = rows.map(r=>`<tr>
      <td style="font-weight:600">${r.bn}</td>
      <td>${r.count}</td>
      <td style="color:var(--red);font-weight:600">${r.p10.toLocaleString()}</td>
      <td style="color:var(--purple);font-weight:700">${r.p50.toLocaleString()}</td>
      <td style="color:var(--green);font-weight:600">${r.p90.toLocaleString()}</td>
      <td>${r.avgPorB}</td>
      <td>${r.avgPermB}</td>
      <td>${r.hcs}</td>
      <td><span class="tl" style="background:${r.statusCol}18;color:${r.statusCol};font-size:8px">${r.status}</span></td>
    </tr>`).join('');
  }

  // Phase distribution chart
  const phaseEl = document.getElementById('rs-phase-chart');
  if (phaseEl) {
    const phases = ['Oil','Gas','Oil & Gas','Condensate'];
    const phaseCols = {'Oil':'#6B46C1','Gas':'#0088CC','Oil & Gas':'#00875A','Condensate':'#C07800'};
    const phaseCounts = {};
    const phaseP50 = {};
    phases.forEach(p => { phaseCounts[p]=0; phaseP50[p]=0; });
    ANALOGUES.forEach(a => {
      const ph = a.hc||'Oil';
      const key = phases.find(p=>ph.toLowerCase().includes(p.toLowerCase()))||'Oil';
      phaseCounts[key] = (phaseCounts[key]||0)+1;
      phaseP50[key] = (phaseP50[key]||0) + stoiipEst(a,'p50');
    });
    const maxP50 = Math.max(...phases.map(p=>phaseP50[p]));
    phaseEl.innerHTML = phases.map(p=>{
      const pct = maxP50>0 ? (phaseP50[p]/maxP50*100).toFixed(0) : 0;
      const col = phaseCols[p];
      return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <div style="width:72px;font-size:10px;font-weight:600;color:${col};text-align:right;flex-shrink:0">${p}</div>
        <div style="flex:1;height:22px;background:#F0F2F8;border-radius:4px;overflow:hidden;position:relative">
          <div style="height:100%;width:${pct}%;background:${col};border-radius:4px;transition:width .6s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:6px">
            ${pct>15?`<span style="font-size:9px;color:#fff;font-weight:700">${Math.round(phaseP50[p]).toLocaleString()} MMboe</span>`:''}
          </div>
        </div>
        <div style="width:40px;font-size:9px;color:var(--t3);flex-shrink:0">${phaseCounts[p]} anl.</div>
      </div>`;
    }).join('');
  }

  // Porosity histogram
  drawHistogram('rs-por-hist', allPors, 'Porosity (%)', 'rgba(0,136,204,.7)', 8, 0, 40);
  // Permeability histogram (log bins)
  drawHistogram('rs-perm-hist', allPerms.map(v=>Math.log10(Math.max(v,0.1))), 'log‚ÇÅ‚ÇÄ Permeability', 'rgba(192,120,0,.7)', 8, -1, 4);
  // RF by lithology bar chart
  drawRFByLith('rs-rf-bar');
}

function stoiipEst(a, pcase) {
  if (!a.por || !a.depth) return 0;
  const grv  = 0.05 + a.por/100 * 2;  // rough GRV proxy from por
  const ntg  = (a.ntg||65)/100;
  const phi  = a.por/100;
  const sw   = a.sw || 0.25;
  const bo   = a.bo || 1.25;
  const p50  = grv * 1e9 * ntg * phi * (1-sw) / bo * 6.2898e-6;
  if (pcase==='p10') return p50 * 0.37;
  if (pcase==='p90') return p50 * 2.38;
  return p50;
}

window._rsCharts = window._rsCharts || {};

function drawHistogram(canvasId, vals, xlabel, color, bins, xmin, xmax) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !vals.length) return;
  if (window._rsCharts[canvasId]) { window._rsCharts[canvasId].destroy(); }
  const binW = (xmax - xmin) / bins;
  const labels = [];
  const counts = Array(bins).fill(0);
  for (let i = 0; i < bins; i++) {
    const lo = +(xmin + i * binW).toFixed(1);
    const hi = +(xmin + (i + 1) * binW).toFixed(1);
    labels.push(lo + '\u2013' + hi);
  }
  vals.forEach(v => {
    const bi = Math.max(0, Math.min(bins - 1, Math.floor((v - xmin) / binW)));
    counts[bi]++;
  });
  window._rsCharts[canvasId] = new Chart(canvas, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: xlabel,
        data: counts,
        backgroundColor: color,
        borderRadius: 3,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: ctx => ctx[0].label,
            label: ctx => 'Count: ' + ctx.raw
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { font: { size: 9 }, color: '#8896A5', maxRotation: 45 },
          title: { display: true, text: xlabel, font: { size: 9 }, color: '#8896A5' }
        },
        y: {
          grid: { color: '#F0F2F8' },
          ticks: { font: { size: 9 }, color: '#8896A5' },
          beginAtZero: true
        }
      }
    }
  });
}

function drawRFByLith(canvasId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  if (window._rsCharts[canvasId]) { window._rsCharts[canvasId].destroy(); }
  const liths = ['Sandstone', 'Carbonate', 'Chalk', 'Mixed'];
  const cols  = ['rgba(244,164,96,.8)', 'rgba(135,206,235,.8)', 'rgba(220,210,180,.8)', 'rgba(107,70,193,.6)'];
  const rfByLith = {};
  liths.forEach(l => { rfByLith[l] = []; });
  ANALOGUES.forEach(a => { if (a.rf > 0 && rfByLith[a.lith]) rfByLith[a.lith].push(a.rf); });
  const avgs = liths.map(l => rfByLith[l].length
    ? +(rfByLith[l].reduce((s, v) => s + v, 0) / rfByLith[l].length).toFixed(1)
    : 0);
  window._rsCharts[canvasId] = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: liths,
      datasets: [{
        label: 'Avg RF (%)',
        data: avgs,
        backgroundColor: cols,
        borderRadius: 4,
        borderSkipped: false,
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => 'Avg RF: ' + ctx.raw + '%'
          }
        }
      },
      scales: {
        x: {
          grid: { color: '#F0F2F8' },
          ticks: { font: { size: 9 }, color: '#8896A5' },
          title: { display: true, text: 'Avg RF (%)', font: { size: 9 }, color: '#8896A5' },
          beginAtZero: true
        },
        y: {
          grid: { display: false },
          ticks: { font: { size: 10 }, color: '#4A5568' }
        }
      }
    }
  });
}

// ============================================================
// RISK PROFILE
// ============================================================
function renderRiskProfile() {
  const el = document.getElementById('pt-risk-panel');
  if (!el || el.dataset.rendered) return;
  el.dataset.rendered = '1';

  // KPIs
  const gcosVals = BASINS.map(b => estimateGCoS(b));
  const avgGcos  = (gcosVals.reduce((s,v)=>s+v,0)/Math.max(gcosVals.length,1)).toFixed(1);
  const highRisk = BASINS.filter(b=>estimateGCoS(b)<15).length;
  const opCount  = ANALOGUES.filter(a=>a.geo?.pressure_coeff>=1.3).length;
  const hsSour   = ANALOGUES.filter(a=>a.fluid?.h2s_ppm>500 || a.geochem?.sulfur_pct>1).length;

  document.getElementById('rp-kpis').innerHTML = [
    {lbl:'Avg Portfolio GCoS',   val: avgGcos+'%',                         sub:'All basins, SPE-PRMS', col:'var(--purple)'},
    {lbl:'High-Risk Basins',     val: highRisk,                             sub:'GCoS < 15%', col:'var(--red)'},
    {lbl:'Overpressured Wells',  val: opCount,                              sub:'Pressure coeff ‚â• 1.3', col:'var(--amber)'},
    {lbl:'H‚ÇÇS / Sour Analogues',val: hsSour,                               sub:'H‚ÇÇS > 500ppm or S > 1%', col:'var(--gold)'},
  ].map(k=>`<div class="kpi"><div class="kpi-lbl">${k.lbl}</div>
    <div class="kpi-val" style="color:${k.col}">${k.val}</div>
    <div class="kpi-sub">${k.sub}</div></div>`).join('');

  // GCoS table
  const tbody = document.getElementById('rp-gcos-tbody');
  if (tbody) {
    const sorted = [...BASINS].sort((a,b)=>estimateGCoS(b)-estimateGCoS(a));
    tbody.innerHTML = sorted.map(b=>{
      const gcos = estimateGCoS(b);
      const seed = b.name.length;
      const ss = 30 + (seed*7)%55; // source
      const rs = 35 + (seed*11)%50; // reservoir
      const se = 40 + (seed*3)%45; // seal
      const tr = 35 + (seed*13)%50; // trap
      const tier = gcos>=30?'HIGH':gcos>=18?'MOD':'LOW';
      const tc = {HIGH:'var(--green)',MOD:'var(--amber)',LOW:'var(--red)'}[tier];
      const mini=(v)=>`<div style="width:40px;height:6px;background:#E8ECF5;border-radius:3px;display:inline-block;vertical-align:middle;overflow:hidden">
        <div style="height:100%;width:${v}%;background:${tc};border-radius:3px"></div></div>
        <span style="font-size:9px;color:${tc};margin-left:3px">${v}%</span>`;
      const gcosCol = gcos>=30?'var(--green)':gcos>=18?'var(--amber)':'var(--red)';
      return `<tr>
        <td style="font-weight:600">${b.name}</td>
        <td><div style="width:48px;height:5px;background:#E8ECF5;border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle">
          <div style="height:100%;width:${b.score}%;background:${gcosCol};border-radius:3px"></div></div>
          <span style="font-size:9px;margin-left:4px;color:var(--t2)">${b.score}</span></td>
        <td style="font-size:13px;font-weight:700;color:${gcosCol}">${gcos}%</td>
        <td>${mini(ss)}</td><td>${mini(rs)}</td><td>${mini(se)}</td><td>${mini(tr)}</td>
        <td><span class="tl" style="background:${tc}18;color:${tc};font-size:8px">${tier}</span></td>
      </tr>`;
    }).join('');
  }

  // Radar chart
  drawRiskRadar();

  // Overpressure flags
  const opEl = document.getElementById('rp-overpressure');
  const opAnas = ANALOGUES.filter(a=>a.geo?.pressure_coeff>=1.3 || a.geo?.pressure_regime?.toLowerCase().includes('over'));
  document.getElementById('rp-op-count').textContent = opAnas.length + ' flags';
  if (opEl) {
    if (!opAnas.length) { opEl.innerHTML = '<div style="font-size:10px;color:var(--t3);padding:8px 0">No overpressure flags detected</div>'; }
    else opEl.innerHTML = opAnas.map(a=>`
      <div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid #F0F2F8">
        <div style="font-size:18px"></div>
        <div style="flex:1">
          <div style="font-size:10px;font-weight:600;color:var(--t1)">${a.name}</div>
          <div style="font-size:9px;color:var(--t3)">${a.basin} ¬∑ ${a.depth}m</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:11px;font-weight:700;color:var(--red)">PC ${(a.geo.pressure_coeff||1.3).toFixed(2)}</div>
          <div style="font-size:8px;color:var(--t3)">${a.geo.pressure_regime||'Overpressured'}</div>
        </div>
      </div>`).join('');
  }

  // Geochemical risk
  const gcEl = document.getElementById('rp-geochem-risk');
  const gcAnas = ANALOGUES.filter(a=>(a.fluid?.h2s_ppm>500)||(a.geochem?.sulfur_pct>1)||(a.fluid?.co2_pct>5));
  document.getElementById('rp-gc-count').textContent = gcAnas.length + ' flags';
  if (gcEl) {
    if (!gcAnas.length) { gcEl.innerHTML = '<div style="font-size:10px;color:var(--t3);padding:8px 0">No geochemical risk flags detected</div>'; }
    else gcEl.innerHTML = gcAnas.map(a=>{
      const flags = [];
      if (a.fluid?.h2s_ppm>500) flags.push(`H‚ÇÇS: ${a.fluid.h2s_ppm.toLocaleString()} ppm`);
      if (a.geochem?.sulfur_pct>1) flags.push(`Sulfur: ${a.geochem.sulfur_pct}%`);
      if (a.fluid?.co2_pct>5) flags.push(`CO‚ÇÇ: ${a.fluid.co2_pct}%`);
      return `<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid #F0F2F8">
        <div style="font-size:18px"></div>
        <div style="flex:1">
          <div style="font-size:10px;font-weight:600;color:var(--t1)">${a.name}</div>
          <div style="font-size:9px;color:var(--t3)">${a.basin}</div>
        </div>
        <div style="text-align:right">
          ${flags.map(f=>`<div style="font-size:9px;font-weight:600;color:var(--amber)">${f}</div>`).join('')}
        </div>
      </div>`;
    }).join('');
  }
}

function drawRiskRadar() {
  const canvas = document.getElementById('rp-radar-canvas');
  if (!canvas) return;
  if (window._rsCharts['rp-radar-canvas']) { window._rsCharts['rp-radar-canvas'].destroy(); }

  const labels = ['Source', 'Reservoir', 'Seal', 'Trap', 'Migration', 'Commercial'];
  const n = labels.length;
  const avgScore = BASINS.reduce((s, b) => s + b.score, 0) / Math.max(BASINS.length, 1);
  const seed = Math.round(avgScore);
  const portfolioVals = [
    30 + (seed * 7)  % 45,
    35 + (seed * 11) % 40,
    40 + (seed * 3)  % 38,
    32 + (seed * 13) % 42,
    28 + (seed * 9)  % 48,
    45 + (seed * 5)  % 35,
  ];
  const benchVals = Array(n).fill(65);

  window._rsCharts['rp-radar-canvas'] = new Chart(canvas, {
    type: 'radar',
    data: {
      labels,
      datasets: [
        {
          label: 'Portfolio Average',
          data: portfolioVals,
          backgroundColor: 'rgba(107,70,193,.18)',
          borderColor: '#6B46C1',
          borderWidth: 2,
          pointBackgroundColor: '#6B46C1',
          pointRadius: 4,
          pointHoverRadius: 6,
        },
        {
          label: 'Industry Benchmark (65%)',
          data: benchVals,
          backgroundColor: 'transparent',
          borderColor: 'rgba(107,70,193,.35)',
          borderWidth: 1.5,
          borderDash: [4, 3],
          pointRadius: 0,
          pointHoverRadius: 0,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ctx.dataset.label + ': ' + ctx.raw + '%'
          }
        }
      },
      scales: {
        r: {
          min: 0,
          max: 100,
          ticks: {
            stepSize: 25,
            font: { size: 8 },
            color: 'rgba(107,70,193,.5)',
            backdropColor: 'transparent',
          },
          grid: { color: 'rgba(107,70,193,.1)' },
          angleLines: { color: 'rgba(107,70,193,.12)' },
          pointLabels: {
            font: { size: 10 },
            color: '#4A5568',
          }
        }
      }
    }
  });
}

function switchBasinTab(tab, el) {
  ['browse','strat','export'].forEach(t => {
    const p = document.getElementById('basin-' + t + '-panel');
    if (p) p.style.display = (t === tab) ? 'block' : 'none';
  });
  el.closest('.tabs').querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  el.classList.add('on');
  if (tab === 'strat')   initStratTab();
  if (tab === 'export')  initExportTab();
}

// ============================================================
// STRATIGRAPHIC COLUMN
// ============================================================

// Detailed stratigraphic data per basin ‚Äî formations with age, lith, HC potential, thickness, seal
const STRAT_DATA = {
  'Zagros Fold Belt': [
    {fm:'Asmari Fm.',age:'Oligocene‚ÄìMiocene',era:'Cenozoic',lith:'Carbonate',thick:400,hc:'Primary Reservoir',seal:'Anhydrite (Lower Fars)',toc:null,seal_qual:'Excellent',source:false,notes:'Main producing carbonate reservoir; vuggy & fractured limestone'},
    {fm:'Pabdeh Fm.',age:'Eocene',era:'Cenozoic',lith:'Shale / Marl',thick:200,hc:'Source & Seal',seal:'Self-sealing marl',toc:2.1,seal_qual:'Good',source:true,notes:'Type II kerogen; mature in most of the basin'},
    {fm:'Ilam Fm.',age:'Late Cretaceous',era:'Mesozoic',lith:'Carbonate',thick:150,hc:'Secondary Reservoir',seal:'Gurpi Shale',toc:null,seal_qual:'Good',source:false,notes:'Wackestone‚Äìpackstone; oil charged from Kazhdumi'},
    {fm:'Sarvak Fm.',age:'Mid Cretaceous',era:'Mesozoic',lith:'Carbonate',thick:600,hc:'Primary Reservoir',seal:'Laffan Shale',toc:null,seal_qual:'Very Good',source:false,notes:'Key mid-Cretaceous carbonate play across the Middle East'},
    {fm:'Kazhdumi Fm.',age:'Early Cretaceous',era:'Mesozoic',lith:'Shale',thick:120,hc:'Major Source',seal:null,toc:4.8,seal_qual:null,source:true,notes:'World-class source rock; Type II-IIS; widely mature in basin centre'},
    {fm:'Dariyan Fm.',age:'Early Cretaceous',era:'Mesozoic',lith:'Carbonate',thick:250,hc:'Reservoir',seal:'Kazhdumi Shale',toc:null,seal_qual:'Good',source:false,notes:'Open-marine carbonate; good porosity where dolomitised'},
    {fm:'Surmeh Fm.',age:'Jurassic',era:'Mesozoic',lith:'Carbonate',thick:350,hc:'Reservoir',seal:'Hith Anhydrite',toc:null,seal_qual:'Excellent',source:false,notes:'Arab Zone equivalent; oil-bearing in southern part'},
    {fm:'Garau Fm.',age:'Early Jurassic',era:'Mesozoic',lith:'Shale / Limestone',thick:300,hc:'Source',seal:null,toc:3.2,seal_qual:null,source:true,notes:'Secondary source; Type II; locally mature at depth'},
    {fm:'Faraghan Fm.',age:'Permian',era:'Palaeozoic',lith:'Sandstone',thick:180,hc:'Reservoir',seal:'Dalan Carbonate',toc:null,seal_qual:'Fair',source:false,notes:'Aeolian & fluvial ss; good porosity; limited by depth'},
    {fm:'Hormuz Salt',age:'Cambrian‚ÄìOrdovician',era:'Palaeozoic',lith:'Evaporite',thick:1500,hc:'Seal / Mobile',seal:'Self',toc:null,seal_qual:'Excellent',source:false,notes:'Regional d√©collement; creates salt plugs and diapirs'},
  ],
  'North Sea': [
    {fm:'Ekofisk Fm.',age:'Paleocene',era:'Cenozoic',lith:'Chalk',thick:300,hc:'Reservoir',seal:'Balder Tuff',toc:null,seal_qual:'Good',source:false,notes:'Soft chalk; high porosity; water injection required'},
    {fm:'Forties Ss.',age:'Paleocene',era:'Cenozoic',lith:'Sandstone',thick:200,hc:'Primary Reservoir',seal:'Lista Shale',toc:null,seal_qual:'Very Good',source:false,notes:'Turbidite sandstone; main Forties / Montrose field play'},
    {fm:'Sele / Lista Fm.',age:'Paleocene',era:'Cenozoic',lith:'Shale',thick:250,hc:'Seal',seal:'Self',toc:1.2,seal_qual:'Very Good',source:true,notes:'Seal for Forties play; minor source contribution'},
    {fm:'Chalk Group',age:'Cretaceous',era:'Mesozoic',lith:'Chalk',thick:1200,hc:'Reservoir / Seal',seal:'Marl Beds',toc:0.4,seal_qual:'Fair',source:false,notes:'Regional seal to deeper plays; Ekofisk reservoir at top'},
    {fm:'Kimmeridge Fm.',age:'Late Jurassic',era:'Mesozoic',lith:'Shale',thick:400,hc:'World-Class Source',seal:null,toc:8.5,seal_qual:null,source:true,notes:'Principal North Sea source rock; Type II; generously mature in Viking Graben'},
    {fm:'Brent Group',age:'Mid Jurassic',era:'Mesozoic',lith:'Sandstone',thick:350,hc:'Primary Reservoir',seal:'Heather Shale',toc:null,seal_qual:'Good',source:false,notes:'Ness‚ÄìEtive‚ÄìRannoch‚ÄìBroom; classic North Sea play'},
    {fm:'Dunlin Group',age:'Early Jurassic',era:'Mesozoic',lith:'Shale',thick:300,hc:'Seal',seal:'Self',toc:1.8,seal_qual:'Very Good',source:true,notes:'Regional seal; √Öre Fm. at base is a secondary source'},
    {fm:'Statfjord Fm.',age:'Late Triassic ‚Äì Early Jurassic',era:'Mesozoic',lith:'Sandstone',thick:250,hc:'Reservoir',seal:'Dunlin Shale',toc:null,seal_qual:'Good',source:false,notes:'Fluvial‚Äìdeltaic ss; prolific Statfjord field reservoir'},
    {fm:'Zechstein Evaporites',age:'Permian',era:'Palaeozoic',lith:'Evaporite',thick:1800,hc:'Regional Seal',seal:'Self',toc:null,seal_qual:'Excellent',source:false,notes:'Perfect seal for all sub-salt plays in Southern North Sea'},
    {fm:'Rotliegend Ss.',age:'Permian',era:'Palaeozoic',lith:'Sandstone',thick:400,hc:'Gas Reservoir',seal:'Zechstein Salt',toc:null,seal_qual:'Excellent',source:false,notes:'Main Southern North Sea gas play; aeolian & fluvial sandstone'},
  ],
  'Malay Basin': [
    {fm:'Upper Group Sands',age:'Late Miocene‚ÄìPliocene',era:'Cenozoic',lith:'Sandstone',thick:600,hc:'Shallow Gas',seal:'Intra-formational Shale',toc:null,seal_qual:'Fair',source:false,notes:'Shallow biogenic gas; some oil; stacked channel sands'},
    {fm:'Middle Group Sands',age:'Mid Miocene',era:'Cenozoic',lith:'Sandstone',thick:800,hc:'Primary Gas Reservoir',seal:'Regional Shale Drape',toc:null,seal_qual:'Very Good',source:false,notes:'Main gas plays; well-sorted fluvio-deltaic sands; excellent reservoir quality'},
    {fm:'Arang Fm.',age:'Early‚ÄìMid Miocene',era:'Cenozoic',lith:'Sandstone',thick:500,hc:'Oil & Gas Reservoir',seal:'Arang Shale',toc:null,seal_qual:'Good',source:false,notes:'Classic Malay Basin play; oil and gas charged from Brown Shale'},
    {fm:'Brown Shale Fm.',age:'Oligocene‚ÄìEarly Miocene',era:'Cenozoic',lith:'Shale / Lacustrine',thick:700,hc:'Primary Source',seal:null,toc:3.5,seal_qual:null,source:true,notes:'Lacustrine/deltaic source; Type I & II kerogen; TOC up to 7%'},
    {fm:'Lower Syn-rift Sands',age:'Eocene‚ÄìOligocene',era:'Cenozoic',lith:'Sandstone',thick:400,hc:'Deep Reservoir',seal:'Pre-rift Basement',toc:null,seal_qual:'Fair',source:false,notes:'Poorly explored deep play; locally fractured granite as reservoir'},
    {fm:'Basement / Granite',age:'Pre-Eocene',era:'Pre-Cenozoic',lith:'Igneous / Metamorphic',thick:null,hc:'Fractured Basement',seal:'None',toc:null,seal_qual:null,source:false,notes:'Deeply weathered granite plays in some sub-basins'},
  ],
  'Kutei Basin': [
    {fm:'Kampung Baru Fm.',age:'Pliocene‚ÄìRecent',era:'Cenozoic',lith:'Sandstone / Shale',thick:2000,hc:'Shallow Gas',seal:'Intra-formational',toc:null,seal_qual:'Fair',source:false,notes:'Shallow biogenic and thermogenic gas in growth anticlines'},
    {fm:'Balikpapan Fm.',age:'Late Miocene',era:'Cenozoic',lith:'Sandstone',thick:1500,hc:'Primary Reservoir',seal:'Shale Interbeds',toc:null,seal_qual:'Good',source:false,notes:'Main oil & gas play; turbidite lobes and deltaic channel sands'},
    {fm:'Tunu Sands',age:'Mid Miocene',era:'Cenozoic',lith:'Sandstone',thick:800,hc:'Gas Reservoir',seal:'Tunu Shale',toc:null,seal_qual:'Very Good',source:false,notes:'Giant Tunu gas field sands; stacked fluvial‚Äìdeltaic packages'},
    {fm:'Pamaluan Shale',age:'Early‚ÄìMid Miocene',era:'Cenozoic',lith:'Shale',thick:400,hc:'Source & Seal',seal:'Self',toc:3.2,seal_qual:'Good',source:true,notes:'Main Kutei source rock; Type II/III; well-matured at depth'},
    {fm:'Pulubalang Fm.',age:'Early Miocene',era:'Cenozoic',lith:'Sandstone / Carbonate',thick:500,hc:'Secondary Reservoir',seal:'Pamaluan Shale',toc:null,seal_qual:'Good',source:false,notes:'Mixed carbonate-clastic; reef mounds locally present'},
    {fm:'Mangkupa Fm.',age:'Oligocene',era:'Cenozoic',lith:'Shale',thick:300,hc:'Source',seal:null,toc:2.5,seal_qual:null,source:true,notes:'Deeper source; Type II; locally in early oil window'},
  ],
  'Permian Basin': [
    {fm:'Delaware Mtn Group',age:'Permian (Guadalupian)',era:'Palaeozoic',lith:'Sandstone',thick:600,hc:'Primary Reservoir',seal:'Evaporite Beds',toc:null,seal_qual:'Very Good',source:false,notes:'Bone Spring and Delaware sands; major tight oil plays'},
    {fm:'Wolfcamp Fm.',age:'Permian (Wolfcampian)',era:'Palaeozoic',lith:'Shale / Carbonate',thick:800,hc:'Unconventional Source-Reservoir',seal:'Self',toc:3.8,seal_qual:'Good',source:true,notes:'World-class unconventional play; Wolfcamp A-D benches; over 30 Bbbl recoverable'},
    {fm:'Spraberry Fm.',age:'Permian',era:'Palaeozoic',lith:'Sandstone / Siltstone',thick:400,hc:'Tight Oil Reservoir',seal:'Shale Interbeds',toc:1.5,seal_qual:'Good',source:true,notes:'Midland Basin tight oil play; horizontal drilling key'},
    {fm:'Canyon Lime',age:'Pennsylvanian',era:'Palaeozoic',lith:'Carbonate',thick:300,hc:'Conventional Reservoir',seal:'Shale',toc:null,seal_qual:'Good',source:false,notes:'Carbonate platform and reef plays; conventional traps'},
    {fm:'Strawn Fm.',age:'Pennsylvanian',era:'Palaeozoic',lith:'Carbonate / Shale',thick:250,hc:'Reservoir',seal:'Shale',toc:1.2,seal_qual:'Fair',source:true,notes:'Organic-rich carbonate; local source contribution'},
    {fm:'Woodford Shale',age:'Devonian',era:'Palaeozoic',lith:'Shale',thick:120,hc:'Major Source',seal:null,toc:6.5,seal_qual:null,source:true,notes:'Primary source for Permian Basin hydrocarbons; Type II; in gas window at depth'},
    {fm:'Ellenburger Dol.',age:'Ordovician',era:'Palaeozoic',lith:'Carbonate',thick:500,hc:'Deep Reservoir',seal:'Simpson Shale',toc:null,seal_qual:'Fair',source:false,notes:'Karst and fracture-controlled; deeper exploration targets'},
  ],
  'Niger Delta': [
    {fm:'Benin Fm.',age:'Miocene‚ÄìHolocene',era:'Cenozoic',lith:'Sandstone',thick:2000,hc:'Shallow Freshwater / Minor Gas',seal:'Poor',toc:null,seal_qual:'Poor',source:false,notes:'Continental alluvial sands; occasional shallow biogenic gas'},
    {fm:'Agbada Fm.',age:'Eocene‚ÄìMiocene',era:'Cenozoic',lith:'Sandstone / Shale',thick:3500,hc:'Primary Reservoir',seal:'Intra-Agbada Shales',toc:null,seal_qual:'Good‚ÄìVery Good',source:false,notes:'Main hydrocarbon interval; paralic sands in rollover anticlines; >200 fields'},
    {fm:'Akata Fm.',age:'Paleocene‚ÄìEocene',era:'Cenozoic',lith:'Shale',thick:6000,hc:'Source & Overpressure',seal:null,toc:2.5,seal_qual:'Excellent (overpressured)',source:true,notes:'Massive, deeply buried marine shale; overpressured; primary source rock'},
    {fm:'Pre-Akata Basement',age:'Cretaceous',era:'Mesozoic',lith:'Shale / Carbonate',thick:null,hc:'Speculative',seal:'Unknown',toc:null,seal_qual:'Unknown',source:false,notes:'Largely unexplored; Cretaceous carbonate plays identified in some margin wells'},
  ],
  'Nile Delta': [
    {fm:'Kafr El Sheikh Fm.',age:'Miocene‚ÄìPliocene',era:'Cenozoic',lith:'Shale',thick:2000,hc:'Seal',seal:'Self',toc:1.0,seal_qual:'Very Good',source:true,notes:'Regional seal for Pliocene‚ÄìMiocene plays; some biogenic gas at shallow depths'},
    {fm:'Abu Madi Fm.',age:'Late Miocene',era:'Cenozoic',lith:'Sandstone',thick:300,hc:'Primary Gas Reservoir',seal:'Kafr El Sheikh Shale',toc:null,seal_qual:'Very Good',source:false,notes:'Main gas play; classic example of Messinian channel-fill; giant Zohr analog'},
    {fm:'Qawasim Fm.',age:'Mid‚ÄìLate Miocene',era:'Cenozoic',lith:'Sandstone',thick:200,hc:'Secondary Reservoir',seal:'Shale Interbeds',toc:null,seal_qual:'Good',source:false,notes:'Shallower play; moderate reservoir quality'},
    {fm:'Sidi Salim Fm.',age:'Early‚ÄìMid Miocene',era:'Cenozoic',lith:'Shale / Marl',thick:1000,hc:'Source & Seal',seal:'Self',toc:1.8,seal_qual:'Good',source:true,notes:'Main Miocene source; gas-prone; Type II/III kerogen'},
    {fm:'Apollonia Fm.',age:'Late Cretaceous',era:'Mesozoic',lith:'Carbonate',thick:600,hc:'Carbonate Reservoir',seal:'Esna Shale',toc:0.5,seal_qual:'Good',source:false,notes:'Chalk and limestone; secondary play in northern delta; Zohr Field reservoir'},
    {fm:'Khoman Chalk',age:'Cretaceous',era:'Mesozoic',lith:'Chalk',thick:400,hc:'Reservoir',seal:'Marl',toc:null,seal_qual:'Fair',source:false,notes:'Deep chalk play; analogue to North Sea chalk reservoirs'},
  ],
};

// Deterministic strat data generator for basins without explicit data
function getStratData(basinName) {
  if (STRAT_DATA[basinName]) return STRAT_DATA[basinName];
  // Generate pseudo-realistic strat column from basin properties
  const b = BASINS.find(x => x.name === basinName);
  if (!b) return [];
  const seed = basinName.split('').reduce((a,c) => a + c.charCodeAt(0), 0);
  const rnd = (min,max,s) => min + ((seed*s*2654435761)>>>0) % (max-min+1);
  const LITHS = ['Sandstone','Carbonate','Shale','Chalk','Evaporite','Siltstone'];
  const ERAS = b.age.includes('Cretaceous')||b.age.includes('Jurassic') ? ['Mesozoic','Cenozoic'] :
               b.age.includes('Permian')||b.age.includes('Devonian') ? ['Palaeozoic','Mesozoic'] :
               ['Cenozoic','Mesozoic','Palaeozoic'];
  const fms = [];
  const nFms = 5 + (seed % 4);
  for (let i = 0; i < nFms; i++) {
    const s = seed + i*13;
    const lith = LITHS[(s*7)%LITHS.length];
    const isSource = lith === 'Shale' && (s%3 === 0);
    const isRes    = ['Sandstone','Carbonate'].includes(lith);
    fms.push({
      fm: `${basinName.split(' ')[0]} ${['Upper','Middle','Lower','Basal','Deep'][i%5]} ${lith==='Shale'?'Shale':'Sands'}`,
      age: b.age.split('‚Äì')[i%2 === 0 ? 0 : 1] || b.age,
      era: ERAS[i%ERAS.length],
      lith,
      thick: 100 + rnd(50,800,i+1),
      hc: isSource ? 'Source Rock' : isRes ? (b.hc.includes('Gas') ? 'Gas Reservoir' : 'Oil Reservoir') : 'Seal / Non-Reservoir',
      seal: isRes ? 'Overlying Shale' : null,
      toc: isSource ? (1.5 + (s%30)/10).toFixed(1)*1 : null,
      seal_qual: isRes ? ['Good','Very Good','Excellent','Fair'][(s)%4] : null,
      source: isSource,
      notes: isSource ? `Potential source rock; kerogen Type ${['I','II','II/III','III'][s%4]}` :
             isRes    ? `${lith} reservoir; estimated porosity ${14+s%18}%` :
             `Regional seal / aquitard`
    });
  }
  return fms;
}

const LITH_COLORS = {
  'Sandstone':     '#F4A460',
  'Carbonate':     '#87CEEB',
  'Shale':         '#808080',
  'Chalk':         '#F5F5DC',
  'Evaporite':     '#DDA0DD',
  'Siltstone':     '#BC8F5F',
  'Lacustrine':    '#5F9EA0',
  'Shale / Marl':  '#9090A0',
  'Shale / Carbonate': '#9090A0',
  'Shale / Lacustrine': '#7A8C8A',
  'Igneous / Metamorphic': '#B5651D',
  'Sandstone / Shale': '#DAA520',
  'Sandstone / Carbonate': '#C8A97A',
};
function lithColor(lith) {
  return LITH_COLORS[lith] || LITH_COLORS[lith.split('/')[0].trim()] || '#CCC';
}

function initStratTab() {
  const sel = document.getElementById('strat-basin-select');
  if (!sel || sel.dataset.populated) return;
  sel.dataset.populated = '1';
  BASINS.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b.name;
    opt.textContent = b.name + ' ‚Äî ' + b.country;
    sel.appendChild(opt);
  });
}

let _stratSelected = null;
function renderStratColumn(basinName) {
  if (!basinName) return;
  _stratSelected = basinName;
  const b = BASINS.find(x => x.name === basinName) || {name:basinName,age:'Unknown',score:50};
  const fms = getStratData(basinName);
  const mode   = document.getElementById('strat-mode')?.value || 'age';
  const colBy  = document.getElementById('strat-colour')?.value || 'lith';

  document.getElementById('strat-title').textContent = basinName + ' ‚Äî Stratigraphic Column';
  document.getElementById('strat-subtitle').textContent =
    `${b.age} ¬∑ ${fms.length} formations ¬∑ ${b.tectonic || ''} ¬∑ ${b.status || ''}`;

  // Build stratigraphic column HTML
  const totalThick = fms.reduce((s,f) => s + (f.thick||100), 0);
  const wrap = document.getElementById('strat-column-wrap');
  if (!wrap) return;

  // Header row
  let html = `
  <div style="display:grid;grid-template-columns:24px 140px 80px 90px 70px 1fr;gap:0;font-size:9px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.6px;padding:6px 8px;border-bottom:2px solid #E2E8F0;background:#F8FAFF;position:sticky;top:0;z-index:2">
    <div></div><div>Formation</div><div>Age</div><div>Lithology</div>
    <div>${mode==='depth'?'Top Depth':'Thick.(m)'}</div><div>HC Role</div>
  </div>`;

  let cumDepth = 500;
  fms.forEach((f, i) => {
    const thick = f.thick || 100;
    const barH = Math.max(28, Math.min(90, thick * 0.15));
    const col = colBy === 'lith' ? lithColor(f.lith) :
                colBy === 'hc'  ? (f.source ? '#90EE90' : f.hc.includes('Reservoir') ? '#87CEEB' : f.hc.includes('Seal') ? '#D3D3D3' : '#FFF8DC') :
                /* age-based */    i%2===0 ? '#E8F4F8' : '#EFF8E8';

    const hcBadge = f.source ? `<span style="background:#D1FAE5;color:#065F46;font-size:8px;padding:1px 6px;border-radius:3px">Source</span>` :
                    f.hc.includes('Primary') ? `<span style="background:#DBEAFE;color:#1E40AF;font-size:8px;padding:1px 6px;border-radius:3px">Primary Res.</span>` :
                    f.hc.includes('Reservoir') ? `<span style="background:#EDE9FE;color:#4C1D95;font-size:8px;padding:1px 6px;border-radius:3px">Reservoir</span>` :
                    f.hc.includes('Seal') ? `<span style="background:#F3F4F6;color:#374151;font-size:8px;padding:1px 6px;border-radius:3px">Seal</span>` :
                    f.hc.includes('Source') ? `<span style="background:#D1FAE5;color:#065F46;font-size:8px;padding:1px 6px;border-radius:3px">Source</span>` :
                    `<span style="font-size:8px;color:var(--t3)">${f.hc}</span>`;

    const toc = f.toc ? `<span style="font-size:8px;color:#065F46;margin-left:4px">TOC ${f.toc}%</span>` : '';
    const dispVal = mode === 'depth' ? `${cumDepth}m` : mode === 'thick' ? `${thick}m` : `${thick}m`;

    html += `
    <div class="strat-row" data-idx="${i}" onclick="showStratDetail(${i},'${basinName}')"
      style="display:grid;grid-template-columns:24px 140px 80px 90px 70px 1fr;gap:0;align-items:center;border-bottom:1px solid #F0F2F8;cursor:pointer;transition:background .15s;min-height:${barH}px">
      <div style="background:${col};width:18px;height:${barH-4}px;margin:2px 3px;border-radius:2px;border:1px solid ${col}88"></div>
      <div style="padding:4px 6px">
        <div style="font-size:10px;font-weight:600;color:var(--t1);line-height:1.3">${f.fm}</div>
        <div style="font-size:8px;color:var(--t3)">${f.lith}</div>
      </div>
      <div style="font-size:9px;color:var(--t2);padding:0 6px;line-height:1.3">${f.age}</div>
      <div style="padding:0 6px">
        <div style="font-size:9px;color:var(--t2);display:flex;align-items:center;gap:3px">
          <span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:${lithColor(f.lith)};flex-shrink:0"></span>
          ${f.lith.split('/')[0].trim()}
        </div>
        <div style="font-size:8px;color:var(--t3)">${f.era}</div>
      </div>
      <div style="font-size:9px;font-weight:600;color:var(--purple);padding:0 6px">${dispVal}</div>
      <div style="padding:0 6px">${hcBadge}${toc}</div>
    </div>`;

    if (f.seal_qual) {
      html += `<div style="background:rgba(0,135,90,.04);border-left:3px solid #00875A;padding:3px 8px 3px 28px;font-size:8px;color:#065F46">
        üîí Seal: ${f.seal} ‚Äî Quality: ${f.seal_qual}</div>`;
    }
    cumDepth += thick;
  });

  wrap.innerHTML = html;
  wrap.querySelectorAll('.strat-row').forEach(row => {
    row.addEventListener('mouseenter', () => row.style.background = 'rgba(107,70,193,.04)');
    row.addEventListener('mouseleave', () => row.style.background = '');
  });

  // Legend
  const liths = [...new Set(fms.map(f=>f.lith))];
  document.getElementById('strat-legend').innerHTML = `
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
      ${liths.map(l=>`<div style="display:flex;align-items:center;gap:4px;font-size:9px">
        <span style="width:12px;height:12px;border-radius:2px;background:${lithColor(l)};display:inline-block;flex-shrink:0;border:1px solid ${lithColor(l)}88"></span>${l.split('/')[0].trim()}
      </div>`).join('')}
    </div>
    <div style="font-size:9px;color:var(--t3);line-height:1.6">
      <div><span style="background:#D1FAE5;color:#065F46;padding:1px 5px;border-radius:3px;margin-right:4px">Source</span>Source rock (with TOC)</div>
      <div style="margin-top:3px"><span style="background:#DBEAFE;color:#1E40AF;padding:1px 5px;border-radius:3px;margin-right:4px">Primary Res.</span>Main reservoir interval</div>
      <div style="margin-top:3px"><span style="background:#F3F4F6;color:#374151;padding:1px 5px;border-radius:3px;margin-right:4px">Seal</span>Cap rock / regional seal</div>
    </div>
    <div style="margin-top:10px;padding:8px;background:#F5F0FF;border-radius:6px;font-size:9px;color:var(--purple)">
      Total column thickness: <strong>${totalThick.toLocaleString()} m</strong><br>
      Formations: <strong>${fms.length}</strong> ¬∑ Source rocks: <strong>${fms.filter(f=>f.source).length}</strong>
    </div>`;

  showStratDetail(0, basinName);
}

function showStratDetail(idx, basinName) {
  const fms = getStratData(basinName || _stratSelected);
  const f = fms[idx];
  if (!f) return;
  // Highlight selected row
  document.querySelectorAll('.strat-row').forEach((r,i) => {
    r.style.background = i===idx ? 'rgba(107,70,193,.07)' : '';
  });
  const el = document.getElementById('strat-detail');
  if (!el) return;
  el.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
      <div style="width:20px;height:20px;border-radius:3px;background:${lithColor(f.lith)};flex-shrink:0;border:1px solid ${lithColor(f.lith)}88"></div>
      <div>
        <div style="font-size:12px;font-weight:700;color:var(--t1)">${f.fm}</div>
        <div style="font-size:9px;color:var(--t3)">${f.era} ¬∑ ${f.age}</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px">
      ${[
        ['Lithology', f.lith],
        ['Thickness', f.thick ? f.thick+'m' : 'Unknown'],
        ['HC Role', f.hc],
        ['TOC', f.toc ? f.toc+'%' : 'n/a'],
        ['Seal', f.seal || 'n/a'],
        ['Seal Quality', f.seal_qual || 'n/a'],
      ].map(([k,v])=>`<div style="background:var(--bg4);border-radius:5px;padding:6px 8px">
        <div style="font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px">${k}</div>
        <div style="font-size:10px;font-weight:600;color:var(--t1);margin-top:1px">${v}</div>
      </div>`).join('')}
    </div>
    <div style="background:${f.source?'#F0FDF4':'#F8FAFF'};border:1px solid ${f.source?'#86EFAC':'#E2E8F0'};border-radius:5px;padding:8px;font-size:10px;color:var(--t2);line-height:1.5">${f.notes}</div>
    ${f.source ? `<div style="margin-top:8px;background:#FEF3C7;border:1px solid #FDE68A;border-radius:5px;padding:7px 9px;font-size:9px;color:#78350F">‚öó Source Rock ‚Äî estimated maturity window ${f.toc>=3?'oil‚Äìgas':'early oil'}</div>` : ''}`;
}

// exportStratPDF is defined earlier with full PDF generation logic

// ============================================================
// BASIN EXPORT TAB
// ============================================================
const EXPORT_FIELDS = [
  {key:'name',label:'Basin Name',always:true},
  {key:'country',label:'Country'},
  {key:'region',label:'Region'},
  {key:'tectonic',label:'Tectonic Setting'},
  {key:'age',label:'Age Range'},
  {key:'hc',label:'HC Phase'},
  {key:'area',label:'Area (km¬≤)'},
  {key:'plays',label:'No. of Plays'},
  {key:'score',label:'Prospectivity Score'},
  {key:'status',label:'Status'},
];
let _expFieldState = {name:true,country:true,region:true,tectonic:true,age:true,hc:true,area:true,plays:true,score:true,status:true};

function initExportTab() {
  const fEl = document.getElementById('exp-field-toggles');
  if (!fEl || fEl.dataset.built) return;
  fEl.dataset.built = '1';
  renderExpFieldToggles();
  renderExpCompleteness();
  renderExpFormatCards();
}

function renderExpFormatCards() {
  const el = document.getElementById('export-format-cards');
  if (!el) return;
  const cards = [
    {fmt:'csv',   icon:'', label:'CSV Spreadsheet',  desc:'Flat file; opens in Excel or any GIS tool',         color:'#166534', bg:'#F0FDF4'},
    {fmt:'json',  icon:'', label:'JSON / GeoJSON',  desc:'Structured data for API integration & mapping',      color:'#1D4ED8', bg:'#EFF6FF'},
    {fmt:'gis',   icon:'',  label:'GIS Shapefile',   desc:'ESRI .shp with centroid coordinates; QGIS ready',    color:'#6B21A8', bg:'#FAF5FF'},
    {fmt:'pdf',   icon:'',  label:'Basin Report PDF', desc:'Formatted exploration summary per basin',            color:'#92400E', bg:'#FFFBEB'},
    {fmt:'excel', icon:'',  label:'Excel Workbook',  desc:'Multi-sheet .xlsx with pivot-ready data & charts',   color:'#065F46', bg:'#ECFDF5'},
    {fmt:'api',   icon:'',  label:'API Endpoint',    desc:'REST URL to stream basin data into your platform',   color:'#9F1239', bg:'#FFF1F2'},
  ];
  el.innerHTML = cards.map(c => `
    <div class="card" style="cursor:pointer;border:1px solid ${c.color}22;transition:box-shadow .2s" onclick="runExport('${c.fmt}')"
      onmouseenter="this.style.boxShadow='0 4px 12px rgba(0,0,0,.1)'" onmouseleave="this.style.boxShadow=''">
      <div class="cb" style="padding:14px 16px">
        <div style="font-size:22px;margin-bottom:8px">${c.icon}</div>
        <div style="font-size:11px;font-weight:700;color:${c.color};margin-bottom:4px">${c.label}</div>
        <div style="font-size:9px;color:var(--t3);line-height:1.5;margin-bottom:10px">${c.desc}</div>
        <button class="btn2" style="width:100%;font-size:9px;color:${c.color};border-color:${c.color}44">‚¨á Export ${c.fmt.toUpperCase()}</button>
      </div>
    </div>`).join('');
}

function renderExpFieldToggles() {
  const el = document.getElementById('exp-field-toggles');
  if (!el) return;
  el.innerHTML = EXPORT_FIELDS.map(f => `
    <label style="display:flex;align-items:center;gap:5px;font-size:9px;font-weight:600;cursor:${f.always?'default':'pointer'};user-select:none;
      padding:4px 9px;background:${_expFieldState[f.key]?'rgba(107,70,193,.1)':'var(--bg4)'};
      border:1px solid ${_expFieldState[f.key]?'rgba(107,70,193,.3)':'#E2E8F0'};border-radius:14px;transition:all .15s;color:${_expFieldState[f.key]?'var(--purple)':'var(--t3)'}">
      <input type="checkbox" ${_expFieldState[f.key]?'checked':''} ${f.always?'disabled':''} style="display:none"
        onchange="_expFieldState['${f.key}']=this.checked;renderExpFieldToggles()">
      ${_expFieldState[f.key]?'‚úì':''} ${f.label}
    </label>`).join('');
}

function renderExpCompleteness() {
  const el = document.getElementById('exp-completeness');
  if (!el) return;
  el.innerHTML = EXPORT_FIELDS.map(f => {
    const filled = BASINS.filter(b => b[f.key] !== undefined && b[f.key] !== '' && b[f.key] !== null).length;
    const pct = Math.round(filled / Math.max(BASINS.length,1) * 100);
    const col = pct >= 90 ? 'var(--green)' : pct >= 60 ? 'var(--amber)' : 'var(--red)';
    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:7px">
      <div style="width:90px;font-size:9px;color:var(--t2);flex-shrink:0">${f.label}</div>
      <div style="flex:1;height:6px;background:#E8ECF5;border-radius:3px;overflow:hidden">
        <div style="height:100%;width:${pct}%;background:${col};border-radius:3px;transition:width .4s"></div>
      </div>
      <div style="width:32px;font-size:9px;font-weight:600;color:${col};text-align:right">${pct}%</div>
    </div>`;
  }).join('');
}

const _expHistory = [];
function addExportHistory(format, selection, type) {
  _expHistory.unshift({ format, selection, type, time: new Date().toLocaleTimeString() });
  renderExpHistory();
}
function renderExpHistory() {
  const el = document.getElementById('exp-history');
  if (!el) return;
  if (!_expHistory.length) {
    el.innerHTML = `<div style="font-size:10px;color:var(--t3);padding:8px 0;text-align:center">No exports yet in this session</div>`;
    return;
  }
  el.innerHTML = `<table><thead><tr><th>Time</th><th>Format</th><th>Selection</th><th>Status</th></tr></thead><tbody>
    ${_expHistory.map(e=>`<tr>
      <td style="font-size:10px;color:var(--t3)">${e.time}</td>
      <td><span class="tl tl-c" style="font-size:8px">${e.type}</span></td>
      <td style="font-size:10px">${e.selection}</td>
      <td><span class="tl tl-g" style="font-size:8px">‚úì Complete</span></td>
    </tr>`).join('')}
  </tbody></table>`;
}

function runExport(fmt) {
  const filter = document.getElementById('exp-basin-filter')?.value || 'all';
  let basins = [...BASINS];
  if (filter === 'mature')   basins = basins.filter(b => b.status==='Mature');
  if (filter === 'active')   basins = basins.filter(b => b.status==='Active');
  if (filter === 'frontier') basins = basins.filter(b => b.status==='Frontier');
  if (filter === 'highscore') basins = basins.filter(b => b.score >= 70);

  const fields = EXPORT_FIELDS.filter(f => _expFieldState[f.key]).map(f=>f.key);
  const label = filter === 'all' ? `All Basins (${basins.length})` :
                filter === 'highscore' ? `High prospectivity (${basins.length})` : `${filter} basins (${basins.length})`;

  if (fmt === 'csv') {
    const header = fields.map(k => EXPORT_FIELDS.find(f=>f.key===k)?.label||k).join(',');
    const rows = basins.map(b => fields.map(k => `"${b[k]||''}"`).join(','));
    const csv = [header, ...rows].join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `edafy_basins_${filter}_${Date.now()}.csv`; a.click();
    toast(`CSV exported ‚Äî ${basins.length} basins, ${fields.length} fields`, 'success');
    addExportHistory('CSV', label, 'CSV');
  } else if (fmt === 'json') {
    const data = basins.map(b => Object.fromEntries(fields.map(k=>[k,b[k]])));
    const blob = new Blob([JSON.stringify({basins:data,exported:new Date().toISOString(),count:basins.length},null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `edafy_basins_${filter}.json`; a.click();
    toast(`JSON exported ‚Äî ${basins.length} basins`, 'success');
    addExportHistory('JSON', label, 'JSON');
  } else if (fmt === 'excel') {
    if (typeof XLSX !== 'undefined') {
      const wsData = [fields.map(k => EXPORT_FIELDS.find(f=>f.key===k)?.label||k), ...basins.map(b => fields.map(k => b[k]||''))];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Basin Catalogue');
      XLSX.writeFile(wb, `edafy_basins_${filter}_${Date.now()}.xlsx`);
      toast(`Excel exported ‚Äî ${basins.length} basins, ${fields.length} fields`, 'success');
    } else {
      exportTable('basin-table', 'basins');
    }
    addExportHistory('Excel', label, 'XLSX');
  } else if (fmt === 'gis') {
    exportBasinsGeoJSON(basins, label);
    addExportHistory('GIS GeoJSON', label, 'GeoJSON');
  } else if (fmt === 'shapefile') {
    exportBasinsShapefile(basins, label);
    addExportHistory('GIS Shapefile', label, 'SHP');
  } else if (fmt === 'pdf') {
    exportBasinsPDF(basins, label);
    addExportHistory('Basin Reports', label, 'PDF');
  } else if (fmt === 'api') {
    const url = `https://api.afed.digital/edafy/basins?filter=${filter}&fields=${fields.join(',')}`;
    openModal(`<div class="modal-title">API Endpoint</div>
      <div style="margin-bottom:10px;font-size:11px;color:var(--t2)">Use this URL to stream basin data into your pipeline. Authentication via API key header.</div>
      <div style="background:#1A1D2E;border-radius:6px;padding:12px;font-family:monospace;font-size:10px;color:#00E5A0;word-break:break-all">${url}</div>
      <div style="margin-top:12px;font-size:9px;color:var(--t3)">Header: <code>X-EDAFY-Key: &lt;your-api-key&gt;</code></div>
      <button class="btn2" style="margin-top:10px" onclick="navigator.clipboard.writeText('${url}');toast('URL copied','success')">Copy URL</button>`);
    addExportHistory('API URL', label, 'API');
  }
}

// ============================================================
// SENSITIVITY ANALYSIS ‚Äî live interactive
// ============================================================

// Shared parameter state ‚Äî drives both tornado and spider
let SENS_PARAMS = [
  {key:'grv',  label:'GRV (km¬≥)',       unit:'km¬≥',  p10:88,  p50:145, p90:218, voiKey:'vi-grv',  isMult:false},
  {key:'ntg',  label:'NTG',             unit:'frac', p10:0.44,p50:0.62,p90:0.83,voiKey:'vi-ntg',  isMult:false},
  {key:'phi',  label:'Porosity œÜ',      unit:'frac', p10:0.13,p50:0.18,p90:0.25,voiKey:'vi-phi',  isMult:false},
  {key:'sw',   label:'Water Sat. Sw',   unit:'frac', p10:0.37,p50:0.28,p90:0.17,voiKey:'vi-sw',   isMult:false, inverse:true},
  {key:'bo',   label:'FVF Bo',          unit:'rb/stb',p10:1.18,p50:1.32,p90:1.48,voiKey:'vi-bo', isMult:false},
  {key:'rf',   label:'Recovery Factor', unit:'frac', p10:0.22,p50:0.35,p90:0.52,voiKey:'vi-rf',  isMult:false},
];

function calcSTOIIP_sens(overrides) {
  const get = (key) => overrides[key] !== undefined ? overrides[key] :
    parseFloat(document.getElementById('vi-'+key)?.value) || SENS_PARAMS.find(p=>p.key===key)?.p50 || 0;
  const grv = get('grv'), ntg = get('ntg'), phi = get('phi');
  const sw = get('sw'), bo = get('bo'), rf = get('rf');
  const hcPV = grv * 1e9 * ntg * phi * (1 - sw);
  const stoiip = hcPV / bo * 6.2898e-6;
  return { stoiip: Math.max(0, Math.round(stoiip)), eur: Math.max(0, Math.round(stoiip * rf)) };
}

function initSensParams() {
  // Sync P50 values from volumetric inputs if they exist
  SENS_PARAMS.forEach(p => {
    const el = document.getElementById(p.voiKey);
    if (el) { const v = parseFloat(el.value); if (!isNaN(v)) p.p50 = v; }
  });
}

function syncSensFromVolumetric() {
  SENS_PARAMS.forEach(p => {
    const el = document.getElementById(p.voiKey);
    if (el) {
      const v = parseFloat(el.value);
      if (!isNaN(v)) {
        p.p50 = v;
        // Set P10/P90 as ¬±30% from new P50 (¬±20% for Sw which is inverse)
        const swing = p.key === 'sw' ? 0.3 : p.key === 'bo' ? 0.12 : 0.3;
        p.p10 = parseFloat((p.inverse ? v*(1+swing) : v*(1-swing)).toFixed(3));
        p.p90 = parseFloat((p.inverse ? v*(1-swing) : v*(1+swing)).toFixed(3));
      }
    }
  });
  buildSensParamTable();
  updateSensAll();
  toast('Sensitivity parameters synced from Volumetric inputs', 'success');
}

function resetSensParams() {
  SENS_PARAMS = [
    {key:'grv',  label:'GRV (km¬≥)',       unit:'km¬≥',  p10:88,  p50:145, p90:218, voiKey:'vi-grv',  inverse:false},
    {key:'ntg',  label:'NTG',             unit:'frac', p10:0.44,p50:0.62,p90:0.83,voiKey:'vi-ntg',  inverse:false},
    {key:'phi',  label:'Porosity œÜ',      unit:'frac', p10:0.13,p50:0.18,p90:0.25,voiKey:'vi-phi',  inverse:false},
    {key:'sw',   label:'Water Sat. Sw',   unit:'frac', p10:0.37,p50:0.28,p90:0.17,voiKey:'vi-sw',   inverse:true},
    {key:'bo',   label:'FVF Bo',          unit:'rb/stb',p10:1.18,p50:1.32,p90:1.48,voiKey:'vi-bo', inverse:false},
    {key:'rf',   label:'Recovery Factor', unit:'frac', p10:0.22,p50:0.35,p90:0.52,voiKey:'vi-rf',  inverse:false},
  ];
  buildSensParamTable();
  updateSensAll();
  toast('Sensitivity parameters reset to defaults', 'info');
}

function buildSensParamTable() {
  const tbody = document.getElementById('sens-param-tbody');
  if (!tbody) return;
  const base = calcSTOIIP_sens({}).stoiip;

  tbody.innerHTML = SENS_PARAMS.map((p, idx) => {
    const stoiipLo = calcSTOIIP_sens({[p.key]: p.p10}).stoiip;
    const stoiipHi = calcSTOIIP_sens({[p.key]: p.p90}).stoiip;
    const swing = stoiipHi - stoiipLo;
    const swingPct = base > 0 ? Math.round(swing / base * 100) : 0;
    const barW = Math.min(100, swingPct);
    return `<tr id="srow-${idx}" style="cursor:pointer" onclick="editSensParam(${idx})"
        onmouseenter="this.style.background='rgba(107,70,193,.04)'" onmouseleave="this.style.background=''">
      <td>
        <div style="font-size:10px;font-weight:600;color:var(--t1)">${p.label}</div>
        <div style="height:4px;background:#E8ECF5;border-radius:2px;margin-top:3px;width:80px;overflow:hidden">
          <div style="height:100%;width:${barW}%;background:var(--purple);border-radius:2px"></div>
        </div>
      </td>
      <td style="font-size:9px;color:var(--t3)">${p.unit}</td>
      <td><input id="sp-p10-${idx}" type="number" value="${p.p10}" step="${p.key==='grv'?'5':'0.01'}"
           style="width:72px;border:1px solid #E2E8F0;border-radius:4px;padding:3px 6px;font-size:10px;color:var(--red);font-weight:600;background:rgba(217,48,37,.04)"
           oninput="SENS_PARAMS[${idx}].p10=parseFloat(this.value)||0;updateSensAll()"></td>
      <td><input id="sp-p50-${idx}" type="number" value="${p.p50}" step="${p.key==='grv'?'5':'0.01'}"
           style="width:72px;border:1px solid #E2E8F0;border-radius:4px;padding:3px 6px;font-size:10px;color:var(--purple);font-weight:600;background:rgba(107,70,193,.04)"
           oninput="SENS_PARAMS[${idx}].p50=parseFloat(this.value)||0;updateSensAll()"></td>
      <td><input id="sp-p90-${idx}" type="number" value="${p.p90}" step="${p.key==='grv'?'5':'0.01'}"
           style="width:72px;border:1px solid #E2E8F0;border-radius:4px;padding:3px 6px;font-size:10px;color:var(--green);font-weight:600;background:rgba(0,135,90,.04)"
           oninput="SENS_PARAMS[${idx}].p90=parseFloat(this.value)||0;updateSensAll()"></td>
      <td style="font-size:10px;font-weight:600;color:var(--red)">${stoiipLo.toLocaleString()}</td>
      <td style="font-size:10px;font-weight:600;color:var(--green)">${stoiipHi.toLocaleString()}</td>
      <td>
        <span style="font-size:10px;font-weight:700;color:var(--purple)">¬±${swingPct}%</span>
        <div style="font-size:8px;color:var(--t3)">${swing.toLocaleString()} MMbbl</div>
      </td>
    </tr>`;
  }).join('');
}

function updateSensAll() {
  buildSensParamTable();
  renderTornado();
  renderSpider();
  renderSensKpis();
}

function renderSensKpis() {
  const el = document.getElementById('sens-kpi-strip');
  if (!el) return;
  const base = calcSTOIIP_sens({}).stoiip;
  // Find highest-impact param
  const impacts = SENS_PARAMS.map(p => ({
    label: p.label,
    swing: Math.abs(calcSTOIIP_sens({[p.key]: p.p90}).stoiip - calcSTOIIP_sens({[p.key]: p.p10}).stoiip)
  })).sort((a,b)=>b.swing-a.swing);
  const topParam = impacts[0];
  const loCase = calcSTOIIP_sens(Object.fromEntries(SENS_PARAMS.map(p=>[p.key,p.p10]))).stoiip;
  const hiCase = calcSTOIIP_sens(Object.fromEntries(SENS_PARAMS.map(p=>[p.key,p.p90]))).stoiip;
  const totalSwing = hiCase - loCase;

  el.innerHTML = [
    {label:'P50 Base STOIIP', val: base.toLocaleString()+' MMbbl', sub:'Central estimate', col:'var(--purple)'},
    {label:'P10 All-Low Case', val: loCase.toLocaleString()+' MMbbl', sub:'All params at P10', col:'var(--red)'},
    {label:'P90 All-High Case', val: hiCase.toLocaleString()+' MMbbl', sub:'All params at P90', col:'var(--green)'},
    {label:'Top Uncertainty', val: topParam.label, sub:`¬±${topParam.swing.toLocaleString()} MMbbl swing`, col:'var(--amber)'},
  ].map(k=>`<div class="kpi"><div class="kpi-lbl">${k.label}</div>
    <div class="kpi-val" style="color:${k.col};font-size:20px">${k.val}</div>
    <div class="kpi-sub">${k.sub}</div>
  </div>`).join('');
}

function renderTornado() {
  const canvas = document.getElementById('tornado-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#FAFBFF'; ctx.fillRect(0,0,W,H);

  const base = calcSTOIIP_sens({}).stoiip;
  if (!base) return;

  const sensData = SENS_PARAMS.map(p => ({
    label: p.label,
    low:   calcSTOIIP_sens({[p.key]: p.p10}).stoiip,
    high:  calcSTOIIP_sens({[p.key]: p.p90}).stoiip,
    swing: Math.abs(calcSTOIIP_sens({[p.key]: p.p90}).stoiip - calcSTOIIP_sens({[p.key]: p.p10}).stoiip)
  })).sort((a,b) => b.swing - a.swing);

  const topPad = 38, botPad = 46, leftPad = 14, rightPad = 14;
  const n = sensData.length;
  const barH = Math.floor((H - topPad - botPad - (n-1)*8) / n);
  const chartW = W - leftPad - rightPad;

  const allVals = sensData.flatMap(v=>[v.low,v.high,base]);
  const minV = Math.min(...allVals) * 0.88;
  const maxV = Math.max(...allVals) * 1.08;
  const toX = v => leftPad + (v - minV) / (maxV - minV) * chartW;
  const baseX = toX(base);

  // Grid lines + X-axis ticks
  const tickCount = 5;
  for (let t = 0; t <= tickCount; t++) {
    const frac = t / tickCount;
    const gx = leftPad + frac * chartW;
    const v = Math.round(minV + frac * (maxV - minV));
    ctx.strokeStyle = '#E8ECF5'; ctx.lineWidth = 0.8; ctx.setLineDash([3,3]);
    ctx.beginPath(); ctx.moveTo(gx, topPad - 8); ctx.lineTo(gx, topPad + n*(barH+8) - 8); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#8896A5'; ctx.font = '9px Arial'; ctx.textAlign = 'center';
    ctx.fillText(v.toLocaleString(), gx, H - 4);
  }

  // X-axis label
  ctx.fillStyle = '#8896A5'; ctx.font = '9px Arial'; ctx.textAlign = 'center';
  ctx.fillText('STOIIP (MMbbl)', leftPad + chartW/2, H - 18);

  // Base (P50) line
  ctx.strokeStyle = 'rgba(107,70,193,.6)'; ctx.lineWidth = 1.5; ctx.setLineDash([5,3]);
  ctx.beginPath(); ctx.moveTo(baseX, topPad - 14); ctx.lineTo(baseX, topPad + n*(barH+8) - 4); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#6B46C1'; ctx.font = 'bold 9px Arial'; ctx.textAlign = 'center';
  ctx.fillText('P50', baseX, topPad - 16);

  sensData.forEach((v, i) => {
    const y = topPad + i * (barH + 8);
    const xLow = toX(v.low), xHigh = toX(v.high);

    // Row background
    ctx.fillStyle = i%2===0 ? 'rgba(107,70,193,.03)' : 'transparent';
    ctx.fillRect(leftPad, y, chartW, barH);

    // P10 bar (red ‚Äî left of base)
    const redX = Math.min(xLow, baseX), redW = Math.abs(xLow - baseX);
    if (redW > 1) {
      ctx.fillStyle = 'rgba(217,48,37,.7)';
      ctx.beginPath(); ctx.roundRect(redX, y+3, redW, barH-6, 3); ctx.fill();
    }

    // P90 bar (green ‚Äî right of base)
    const grX = xHigh > baseX ? baseX : xHigh;
    const grW = Math.abs(xHigh - baseX);
    if (grW > 1) {
      ctx.fillStyle = 'rgba(0,135,90,.7)';
      ctx.beginPath(); ctx.roundRect(grX, y+3, grW, barH-6, 3); ctx.fill();
    }

    // Parameter label ‚Äî bold, inside/above bar row
    ctx.fillStyle = '#1A202C'; ctx.font = 'bold 10px Arial'; ctx.textAlign = 'center';
    ctx.fillText(v.label, leftPad + chartW/2, y - 1);

    // Low value label (red, outside left)
    ctx.fillStyle = '#C62828'; ctx.font = 'bold 9px Arial';
    ctx.textAlign = xLow < baseX ? 'right' : 'left';
    const lvx = xLow + (xLow < baseX ? -5 : 5);
    ctx.fillText(v.low.toLocaleString(), lvx, y + barH/2 + 4);

    // High value label (green, outside right)
    ctx.fillStyle = '#1B5E20'; ctx.font = 'bold 9px Arial';
    ctx.textAlign = xHigh > baseX ? 'left' : 'right';
    const hvx = xHigh + (xHigh > baseX ? 5 : -5);
    ctx.fillText(v.high.toLocaleString(), hvx, y + barH/2 + 4);
  });

  // Legend top-right
  const leg = [['rgba(217,48,37,.7)','P10 Low'],['rgba(0,135,90,.7)','P90 High']];
  leg.forEach(([col,lbl],i) => {
    const lx = W - 100 + i*50, ly = 8;
    ctx.fillStyle = col; ctx.fillRect(lx, ly, 10, 10);
    ctx.fillStyle = '#4A5568'; ctx.font = '8px Arial'; ctx.textAlign = 'left';
    ctx.fillText(lbl, lx+13, ly+9);
  });
}

function renderSpider() {
  const canvas = document.getElementById('spider-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#FAFBFF'; ctx.fillRect(0,0,W,H);

  const base = calcSTOIIP_sens({}).stoiip;
  if (!base) return;

  const params = SENS_PARAMS;
  const n = params.length;
  const pad = 55, rightPad = 110, topPad = 30, botPad = 28;
  const chartW = W - pad - rightPad;

  // Compute % of base for each param at P10/P50/P90
  const rows = [
    { label:'P10', color:'#D93025', dash:[], lw:1.5,
      vals: params.map(p => calcSTOIIP_sens({[p.key]:p.p10}).stoiip / base * 100) },
    { label:'P50 Base', color:'#6B46C1', dash:[], lw:2.5,
      vals: params.map(() => 100) },
    { label:'P90', color:'#00875A', dash:[], lw:1.5,
      vals: params.map(p => calcSTOIIP_sens({[p.key]:p.p90}).stoiip / base * 100) },
  ];

  const allVals = rows.flatMap(r=>r.vals);
  const minV = Math.min(...allVals) * 0.92, maxV = Math.max(...allVals) * 1.06;
  const toY = v => topPad + (1 - (v - minV) / (maxV - minV)) * (H - topPad - botPad);
  const toXi = i => pad + i * chartW / (n - 1);

  // Grid lines at 25% steps
  [0,0.25,0.5,0.75,1].forEach(t => {
    const v = minV + t*(maxV-minV);
    const gy = toY(v);
    ctx.strokeStyle = '#E2E8F0'; ctx.lineWidth = 1; ctx.setLineDash([3,3]);
    ctx.beginPath(); ctx.moveTo(pad, gy); ctx.lineTo(W - rightPad, gy); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#8896A5'; ctx.font = '8px Arial'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(v)+'%', pad - 4, gy + 3);
  });

  // Base line 100%
  const baseY = toY(100);
  ctx.strokeStyle = 'rgba(107,70,193,.3)'; ctx.lineWidth = 1; ctx.setLineDash([5,3]);
  ctx.beginPath(); ctx.moveTo(pad, baseY); ctx.lineTo(W-rightPad, baseY); ctx.stroke();
  ctx.setLineDash([]);

  rows.forEach(row => {
    ctx.beginPath();
    ctx.strokeStyle = row.color; ctx.lineWidth = row.lw; ctx.setLineDash(row.dash);
    row.vals.forEach((v, i) => {
      const x = toXi(i), y = toY(v);
      i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    });
    ctx.stroke(); ctx.setLineDash([]);

    // Dots
    row.vals.forEach((v, i) => {
      ctx.beginPath();
      ctx.arc(toXi(i), toY(v), row.lw === 2.5 ? 5 : 3, 0, Math.PI*2);
      ctx.fillStyle = row.color; ctx.fill();
    });
  });

  // X labels ‚Äî bold, larger
  params.forEach((p, i) => {
    ctx.fillStyle = '#2D3748'; ctx.font = 'bold 11px Arial'; ctx.textAlign = 'center';
    ctx.fillText(p.label, toXi(i), H - 8);
    // value labels for P50
    const baseVal = Math.round(rows[1].vals[i]);
    ctx.fillStyle = '#6B46C1'; ctx.font = 'bold 9px Arial';
    ctx.fillText(baseVal+'%', toXi(i), toY(rows[1].vals[i]) - 9);
  });

  // Legend ‚Äî right side, larger text
  rows.forEach((row, i) => {
    const ly = 12 + i*20;
    ctx.strokeStyle = row.color; ctx.lineWidth = row.lw;
    ctx.beginPath(); ctx.moveTo(W-rightPad+10, ly+5); ctx.lineTo(W-rightPad+34, ly+5); ctx.stroke();
    ctx.beginPath(); ctx.arc(W-rightPad+22, ly+5, row.lw===2.5?4:3, 0, Math.PI*2);
    ctx.fillStyle = row.color; ctx.fill();
    ctx.fillStyle = '#2D3748'; ctx.font = '10px Arial'; ctx.textAlign = 'left';
    ctx.fillText(row.label, W-rightPad+38, ly+9);
  });

  ctx.fillStyle = '#8896A5'; ctx.font = '9px Arial'; ctx.textAlign = 'left';
  ctx.fillText('STOIIP sensitivity (% of P50 base)', pad, 14);
}

function renderSensSliders() { /* kept for back-compat; now using table */ }

function exportSens() {
  // Build CSV
  const base = calcSTOIIP_sens({}).stoiip;
  const rows = [['Parameter','Unit','P10','P50','P90','STOIIP@P10','STOIIP@P90','Swing (MMbbl)','Swing (%)']];
  SENS_PARAMS.forEach(p => {
    const lo = calcSTOIIP_sens({[p.key]:p.p10}).stoiip;
    const hi = calcSTOIIP_sens({[p.key]:p.p90}).stoiip;
    rows.push([p.label,p.unit,p.p10,p.p50,p.p90,lo,hi,hi-lo,base?Math.round((hi-lo)/base*100)+'%':'']);
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'edafy_sensitivity_analysis.csv'; a.click();
  toast('Sensitivity analysis exported as CSV', 'success');
}

function renderConnectors() {
  // legacy call ‚Äî just render connector cards if panel visible
  if (document.getElementById('ing-connectors-panel').style.display !== 'none') renderConnectorCards();
}

function renderConnectorCards() {
  document.getElementById('connector-cards').innerHTML = CONNECTOR_STATE.map(c => {
    const statusLabel = {connected:'CONNECTED', error:'AUTH ERROR', pending:'NOT CONFIGURED'}[c.status] || c.status.toUpperCase();
    const statusColor = {connected:'var(--green)', error:'var(--red)', pending:'var(--amber)'}[c.status];
    const syncable = c.status === 'connected';
    return `
    <div class="card" style="border-color:${c.status==='error'?'rgba(255,77,106,.3)':c.status==='pending'?'rgba(255,170,0,.2)':'var(--b1)'}">
      <div class="ch" style="padding:11px 14px">
        <span class="ct" style="font-size:10px">${c.name}</span>
        <span class="tl" style="background:${statusColor}18;color:${statusColor};font-size:9px">‚óè ${statusLabel}</span>
      </div>
      <div class="cb" style="padding:12px 14px">
        <div style="font-size:9px;color:var(--t3);margin-bottom:8px">${c.type}</div>
        <div style="font-size:10px;color:var(--t2);margin-bottom:10px;line-height:1.5">${c.dataTypes}</div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:12px;font-size:10px">
          <div style="background:var(--bg4);padding:6px 8px;border-radius:4px">
            <div style="color:var(--t3);font-size:8px;letter-spacing:1px;text-transform:uppercase;margin-bottom:2px">Last Sync</div>
            <div style="color:${c.status==='error'?'var(--red)':'var(--t1)'};font-weight:600">${c.lastSync}</div>
          </div>
          <div style="background:var(--bg4);padding:6px 8px;border-radius:4px">
            <div style="color:var(--t3);font-size:8px;letter-spacing:1px;text-transform:uppercase;margin-bottom:2px">Frequency</div>
            <div style="color:var(--t1);font-weight:600">${c.freq}</div>
          </div>
          <div style="background:var(--bg4);padding:6px 8px;border-radius:4px">
            <div style="color:var(--t3);font-size:8px;letter-spacing:1px;text-transform:uppercase;margin-bottom:2px">Records</div>
            <div style="color:var(--cyan);font-weight:600">${c.records.toLocaleString()}</div>
          </div>
          <div style="background:var(--bg4);padding:6px 8px;border-radius:4px">
            <div style="color:var(--t3);font-size:8px;letter-spacing:1px;text-transform:uppercase;margin-bottom:2px">Auth</div>
            <div style="color:var(--t1);font-weight:600">${c.authType}</div>
          </div>
        </div>

        ${c.status === 'error' ? `
          <div style="background:rgba(255,77,106,.08);border:1px solid rgba(255,77,106,.25);border-radius:4px;padding:7px 9px;font-size:10px;color:var(--red);margin-bottom:10px">
            ‚úó Authentication token expired. Re-authenticate to resume sync.
          </div>` : ''}

        ${c.status === 'pending' ? `
          <div style="background:rgba(255,170,0,.06);border:1px solid rgba(255,170,0,.2);border-radius:4px;padding:7px 9px;font-size:10px;color:var(--amber);margin-bottom:10px">
            ‚ö† Connector not configured. Add API credentials to activate.
          </div>` : ''}

        <div id="sync-prog-${c.key}" style="display:none;margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--t3);margin-bottom:4px">
            <span id="sync-lbl-${c.key}">Connecting‚Ä¶</span>
            <span id="sync-pct-${c.key}">0%</span>
          </div>
          <div class="sbar-track" style="height:4px"><div class="sbar-fill" id="sync-fill-${c.key}" style="width:0%;background:var(--cyan);transition:width .2s"></div></div>
        </div>

        <div style="display:flex;gap:6px;flex-wrap:wrap">
          ${syncable ? `<button class="btn" style="font-size:10px;padding:6px 12px" onclick="syncConnector('${c.key}')">‚ü≥ Sync Now</button>` : ''}
          <button class="btn2" style="font-size:10px;padding:5px 10px" onclick="configureConnector('${c.key}')">Configure</button>
          ${c.status === 'error' ? `<button class="btn2" style="font-size:10px;padding:5px 10px" onclick="reauthConnector('${c.key}')">Re-Authenticate</button>` : ''}
          ${c.status === 'pending' ? `<button class="btn" style="font-size:10px;padding:6px 12px" onclick="configureConnector('${c.key}')">+ Connect</button>` : ''}
          ${syncable ? `<button class="btn2" style="font-size:10px;padding:5px 10px" onclick="testConnector('${c.key}')">Test</button>` : ''}
        </div>

        <div style="display:flex;align-items:center;gap:7px;margin-top:10px;padding-top:10px;border-top:1px solid var(--b1)">
          <span style="font-size:9px;color:var(--t3)">Scheduled sync</span>
          <div onclick="toggleSchedule('${c.key}',this)" style="width:32px;height:16px;border-radius:8px;background:${c.schedEnabled?'var(--cyan)':'var(--bg)'};border:1px solid ${c.schedEnabled?'var(--cyan)':'var(--t3)'};cursor:pointer;position:relative;transition:background .2s">
            <div style="position:absolute;top:2px;${c.schedEnabled?'right:2px':'left:2px'};width:10px;height:10px;border-radius:50%;background:#fff;transition:all .2s"></div>
          </div>
          <span style="font-size:9px;color:${c.schedEnabled?'var(--green)':'var(--t3)'}">${c.schedEnabled?'ON':'OFF'}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function syncConnector(key) {
  const c = CONNECTOR_STATE.find(x => x.key === key);
  if (!c || c.status !== 'connected') return;
  const prog = document.getElementById('sync-prog-' + key);
  const lbl  = document.getElementById('sync-lbl-' + key);
  const pct  = document.getElementById('sync-pct-' + key);
  const fill = document.getElementById('sync-fill-' + key);
  prog.style.display = 'block';
  let p = 0;
  const stages = ['Authenticating‚Ä¶','Fetching schema‚Ä¶','Downloading records‚Ä¶','Mapping fields‚Ä¶','Running SHA-256 dedup‚Ä¶','Validating‚Ä¶','Committing to catalogue‚Ä¶'];
  let stageIdx = 0;
  connLog(`[${now()}] [${c.name}] Sync initiated by VJ`);
  const iv = setInterval(() => {
    p += Math.random() * 7 + 2;
    if (p >= 100) p = 100;
    fill.style.width = p + '%';
    pct.textContent = Math.round(p) + '%';
    const si = Math.floor(p / (100 / stages.length));
    if (si !== stageIdx && si < stages.length) { stageIdx = si; lbl.textContent = stages[si]; connLog(`[${now()}] [${c.name}] ${stages[si]}`); }
    if (p >= 100) {
      clearInterval(iv);
      prog.style.display = 'none';
      const n = Math.floor(Math.random() * 3000 + 500);
      c.records += n;
      c.lastSync = 'Just now';
      const acc = parseInt(document.getElementById('ing-accepted').textContent.replace(/,/g,'')) + n;
      document.getElementById('ing-accepted').textContent = acc.toLocaleString();
      connLog(`[${now()}] [${c.name}] ‚úì Sync complete ‚Äî ${n.toLocaleString()} records ingested, 0 errors`);
      AUDIT_ENTRIES.unshift({time:now(), user:'SYS-AUTO', action:`${c.name} sync complete ¬∑ ${n} records ingested`, status:'SUCCESS', type:'System'});
      renderAuditLog(AUDIT_ENTRIES);
      renderConnectorCards();
      toast(`${c.name} sync complete ‚Äî ${n.toLocaleString()} records`, 'success');
    }
  }, 180);
}

function testConnector(key) {
  const c = CONNECTOR_STATE.find(x => x.key === key);
  toast(`Testing connection to ${c.name}‚Ä¶`, 'info');
  connLog(`[${now()}] [${c.name}] Connection test initiated`);
  setTimeout(() => {
    connLog(`[${now()}] [${c.name}] ‚úì API endpoint reachable ‚Äî latency 142ms`);
    connLog(`[${now()}] [${c.name}] ‚úì Authentication token valid`);
    connLog(`[${now()}] [${c.name}] ‚úì Schema version compatible`);
    toast(`${c.name} ‚Äî connection test passed`, 'success');
  }, 1200);
}

function reauthConnector(key) {
  const c = CONNECTOR_STATE.find(x => x.key === key);
  openModal(`
    <div class="modal-title">Re-Authenticate ‚Äî ${c.name}</div>
    <div class="modal-sub">Enter new credentials to restore the connection</div>
    <div class="fg" style="margin-bottom:12px"><label>API Key / Token</label><input class="fc" id="reauth-key" placeholder="Paste new API key or OAuth token‚Ä¶" type="password"></div>
    <div class="fg" style="margin-bottom:16px"><label>Environment</label>
      <select class="fc"><option>Production</option><option>Staging</option></select>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="doReauth('${key}')">Authenticate & Test</button>
      <button class="btn2" onclick="closeModal()">Cancel</button>
    </div>
  `);
}

function doReauth(key) {
  const val = document.getElementById('reauth-key')?.value;
  if (!val || val.length < 6) { toast('Please enter a valid API key', 'warning'); return; }
  closeModal();
  toast(`Authenticating with ${CONNECTOR_STATE.find(x=>x.key===key)?.name}‚Ä¶`, 'info');
  connLog(`[${now()}] [IHS Energy] Re-authentication attempt`);
  setTimeout(() => {
    const c = CONNECTOR_STATE.find(x => x.key === key);
    c.status = 'connected';
    c.color = 'var(--green)';
    c.apiKey = 'IH-‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + val.slice(-4).toUpperCase();
    c.lastSync = 'Never (newly authenticated)';
    connLog(`[${now()}] [IHS Energy] ‚úì Authentication successful ‚Äî token stored`);
    renderConnectorCards();
    toast(`${c.name} re-authenticated successfully`, 'success');
  }, 1800);
}

function configureConnector(key) {
  const c = CONNECTOR_STATE.find(x => x.key === key);
  const isNeftex = key === 'neftex';
  const noteHtml = c.note ? `<div style="background:#FFFBEB;border:1px solid #FDE68A;border-radius:6px;padding:10px 12px;margin-bottom:14px;font-size:10px;color:#92400E"><strong>‚Ñπ Note:</strong> ${c.note}</div>` : '';
  const stepsHtml = c.setupSteps ? `<div style="margin-bottom:14px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:6px">Setup Steps</div>${c.setupSteps.map(s=>`<div style="font-size:10px;color:var(--t2);padding:3px 0;border-bottom:1px solid #F0F4FA">${s}</div>`).join('')}</div>` : '';
  openModal(`
    <div class="modal-title">Configure ‚Äî ${c.name}</div>
    <div class="modal-sub">${c.type} &nbsp;¬∑&nbsp; Auth: ${c.authType}</div>
    ${noteHtml}
    ${stepsHtml}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
      ${isNeftex ? `
        <div class="fg"><label>SFTP Host</label><input class="fc" value="${c.endpoint||'sftp://data.neftex.com/exports/'}" placeholder="sftp://‚Ä¶"></div>
        <div class="fg"><label>SFTP Username</label><input class="fc" id="cfg-key" value="${c.apiKey}" placeholder="Your SFTP username‚Ä¶"></div>
        <div class="fg"><label>SSH Key Path / Password</label><input class="fc" type="password" placeholder="SSH private key path or password‚Ä¶"></div>
        <div class="fg"><label>Remote Export Path</label><input class="fc" value="/exports/edafy/" placeholder="/path/to/exports/"></div>
      ` : `
        <div class="fg"><label>${c.authType === 'SFTP Key' ? 'SFTP Username' : 'API Key / Token'}</label><input class="fc" id="cfg-key" value="${c.apiKey}" type="${c.apiKey?'text':'password'}" placeholder="Enter ${c.authType} credentials‚Ä¶"></div>
      `}
      <div class="fg"><label>Sync Frequency</label>
        <select class="fc" id="cfg-freq">
          <option ${c.freq==='Daily'?'selected':''}>Daily</option>
          <option ${c.freq==='Weekly'?'selected':''}>Weekly</option>
          <option ${c.freq==='Monthly'?'selected':''}>Monthly</option>
          <option ${c.freq==='Quarterly'?'selected':''}>Quarterly</option>
        </select>
      </div>
      <div class="fg"><label>Sync Window (UTC)</label><input class="fc" value="02:00 ‚Äì 04:00" placeholder="HH:MM ‚Äì HH:MM"></div>
      <div class="fg"><label>Environment</label><select class="fc"><option>Production</option><option>Staging</option><option>UAT</option></select></div>
      <div class="fg" style="grid-column:1/-1"><label>Data Types to Ingest</label><input class="fc" value="${c.dataTypes}" id="cfg-dtypes"></div>
    </div>
    <div style="background:rgba(0,200,255,.04);border:1px solid var(--b1);border-radius:5px;padding:10px 12px;margin-bottom:14px;font-size:10px;color:var(--t2)">
      <strong style="color:var(--cyan)">Schema Mapping:</strong> Fields auto-mapped to PPDM 3.9 / OSDU R3 schema. Custom fields prefixed <code style="color:var(--gold)">EDAFY_*</code>.
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="saveConnectorConfig('${key}')">Save Configuration</button>
      <button class="btn2" onclick="testConnector('${key}');closeModal()">Test Connection</button>
      <button class="btn2" onclick="closeModal()">Cancel</button>
    </div>
  `);
}

function saveConnectorConfig(key) {
  const c = CONNECTOR_STATE.find(x => x.key === key);
  const newKey = document.getElementById('cfg-key')?.value;
  const newFreq = document.getElementById('cfg-freq')?.value;
  if (newKey && newKey.length > 5 && !newKey.includes('‚Ä¢')) c.apiKey = newKey.slice(0,3).toUpperCase() + '-‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + newKey.slice(-4).toUpperCase();
  if (newFreq) c.freq = newFreq;
  if (c.status === 'pending' && newKey && newKey.length > 5) { c.status = 'connected'; c.color = 'var(--green)'; c.lastSync = 'Never (newly configured)'; }
  closeModal();
  renderConnectorCards();
  connLog(`[${now()}] [${c.name}] Configuration updated by VJ`);
  toast(`${c.name} configuration saved`, 'success');
}

function toggleSchedule(key, el) {
  const c = CONNECTOR_STATE.find(x => x.key === key);
  c.schedEnabled = !c.schedEnabled;
  renderConnectorCards();
  toast(`${c.name} scheduled sync ${c.schedEnabled ? 'enabled' : 'disabled'}`, c.schedEnabled ? 'success' : 'info');
  connLog(`[${now()}] [${c.name}] Scheduled sync ${c.schedEnabled ? 'ENABLED' : 'DISABLED'} by VJ`);
}

function connLog(msg) {
  const el = document.getElementById('connector-log');
  if (!el) return;
  const line = document.createElement('div');
  const isErr = msg.includes('fail') || msg.includes('error') || msg.includes('Error');
  const isOk  = msg.includes('‚úì') || msg.includes('complete');
  line.style.cssText = `font-size:10px;padding:2px 0;color:${isErr?'var(--red)':isOk?'var(--green)':'var(--t2)'};border-bottom:1px solid rgba(0,200,255,.03)`;
  line.textContent = msg;
  if (el.firstChild && el.firstChild.textContent.includes('No activity')) el.innerHTML = '';
  el.prepend(line);
}

function clearConnectorLog() {
  document.getElementById('connector-log').innerHTML = '<div style="font-size:10px;color:var(--t3);padding:10px 0;text-align:center">Log cleared.</div>';
}

function now() {
  return new Date().toISOString().replace('T',' ').slice(0,19);
}

// ============================================================
// DEDUPLICATION QUEUE
// ============================================================
const DEDUP_QUEUE = [
  {id:'RES-48821',dataset:'C&C Reservoirs',type:'Near-Duplicate',sim:89,matched:'RES-48700',source:'C&C Bulk Q1',time:'2h ago',fields:'Formation, Depth, Porosity'},
  {id:'BAS-12043',dataset:'IHS Basin Monitor',type:'Exact Duplicate',sim:100,matched:'BAS-12001',source:'IHS Weekly',time:'4h ago',fields:'Basin Name, Country, Area'},
  {id:'SRC-7821', dataset:'Neftex Source Rock',type:'Near-Duplicate',sim:91,matched:'SRC-7640',source:'Neftex Weekly',time:'1d ago',fields:'Formation, TOC, Ro%'},
  {id:'RES-48902',dataset:'C&C Reservoirs',type:'Near-Duplicate',sim:86,matched:'RES-48610',source:'C&C Bulk Q1',time:'1d ago',fields:'Lithology, Drive, RF%'},
  {id:'BAS-12199',dataset:'IHS Basin Monitor',type:'Exact Duplicate',sim:100,matched:'BAS-11980',source:'IHS SFTP',time:'2d ago',fields:'All fields identical'},
];

function renderDedupQueue() {
  document.getElementById('dedup-tbody').innerHTML = DEDUP_QUEUE.length === 0
    ? `<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--t3)">‚úì No duplicates in queue</td></tr>`
    : DEDUP_QUEUE.map(r => {
      const simColor = r.sim === 100 ? 'var(--red)' : r.sim >= 90 ? 'var(--amber)' : 'var(--cyan)';
      return `<tr>
        <td style="color:var(--cyan);font-weight:700;cursor:pointer" onclick="showDedupDetail('${r.id}')">${r.id}</td>
        <td>${r.dataset}</td>
        <td><span class="tl ${r.type==='Exact Duplicate'?'tl-r':'tl-a'}">${r.type}</span></td>
        <td>
          <div class="sbar"><div class="sbar-track" style="width:60px"><div class="sbar-fill" style="width:${r.sim}%;background:${simColor}"></div></div>
          <span class="sval" style="color:${simColor}">${r.sim}%</span></div>
        </td>
        <td style="color:var(--t2)">${r.matched}</td>
        <td style="color:var(--t3)">${r.source}</td>
        <td style="color:var(--t3)">${r.time}</td>
        <td>
          <div style="display:flex;gap:4px">
            <button class="btn2" style="padding:3px 8px;font-size:9px" onclick="dedupAction('${r.id}','accept')">Accept</button>
            <button class="btn2" style="padding:3px 8px;font-size:9px" onclick="dedupAction('${r.id}','merge')">Merge</button>
            <button class="btn2 danger" style="padding:3px 8px;font-size:9px" onclick="dedupAction('${r.id}','reject')">Reject</button>
          </div>
        </td>
      </tr>`;
    }).join('');
}

function showDedupDetail(id) {
  const r = DEDUP_QUEUE.find(x => x.id === id);
  if (!r) return;
  openModal(`
    <div class="modal-title">${r.id} ‚Äî Duplicate Detail</div>
    <div class="modal-sub">${r.dataset} &nbsp;¬∑&nbsp; ${r.type} &nbsp;¬∑&nbsp; Similarity: <span style="color:var(--red);font-weight:700">${r.sim}%</span></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
      <div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--cyan);margin-bottom:8px">Incoming Record</div>
        <div style="background:var(--bg4);border-radius:5px;padding:11px;font-size:11px">
          <div style="color:var(--t3)">ID: <span style="color:var(--t1)">${r.id}</span></div>
          <div style="color:var(--t3);margin-top:4px">Source: <span style="color:var(--t1)">${r.source}</span></div>
          <div style="color:var(--t3);margin-top:4px">Ingested: <span style="color:var(--t1)">${r.time}</span></div>
          <div style="color:var(--t3);margin-top:4px">Matching fields: <span style="color:var(--amber)">${r.fields}</span></div>
        </div>
      </div>
      <div>
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:8px">Matched Production Record</div>
        <div style="background:var(--bg4);border-radius:5px;padding:11px;font-size:11px">
          <div style="color:var(--t3)">ID: <span style="color:var(--t1)">${r.matched}</span></div>
          <div style="color:var(--t3);margin-top:4px">Status: <span style="color:var(--green)">Published</span></div>
          <div style="color:var(--t3);margin-top:4px">Algorithm: <span style="color:var(--t1)">${r.sim===100?'SHA-256 Exact':'TLSH Fuzzy'}</span></div>
          <div style="color:var(--t3);margin-top:4px">Confidence: <span style="color:var(--t1)">High</span></div>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="closeModal();dedupAction('${r.id}','accept')">Accept (add as new)</button>
      <button class="btn2" onclick="closeModal();dedupAction('${r.id}','merge')">Merge (enrich existing)</button>
      <button class="btn2 danger" onclick="closeModal();dedupAction('${r.id}','reject')">Reject (discard)</button>
    </div>
  `);
}

function dedupAction(id, action) {
  const idx = DEDUP_QUEUE.findIndex(x => x.id === id);
  if (idx < 0) return;
  const r = DEDUP_QUEUE[idx];
  const msgs = {
    accept:`${id} accepted ‚Äî added as new record alongside ${r.matched}`,
    merge:`${id} merged into ${r.matched} ‚Äî fields enriched`,
    reject:`${id} rejected and removed from quarantine`
  };
  toast(msgs[action], action === 'reject' ? 'error' : 'success');
  AUDIT_ENTRIES.unshift({time:now(), user:'VJ', action:`Dedup: ${action.toUpperCase()} ‚Äî ${id} (${r.sim}% match with ${r.matched})`, status:action.toUpperCase(), type:'Governance'});
  renderAuditLog(AUDIT_ENTRIES);
  DEDUP_QUEUE.splice(idx, 1);
  document.getElementById('dd-near').textContent = DEDUP_QUEUE.filter(x=>x.type==='Near-Duplicate').length;
  document.getElementById('dd-exact').textContent = DEDUP_QUEUE.filter(x=>x.type==='Exact Duplicate').length;
  document.getElementById('dd-resolved').textContent = parseInt(document.getElementById('dd-resolved').textContent) + 1;
  renderDedupQueue();
}

function resolveAll(action) {
  const count = DEDUP_QUEUE.length;
  if (!count) { toast('Queue is already empty', 'info'); return; }
  DEDUP_QUEUE.length = 0;
  document.getElementById('dd-near').textContent = 0;
  document.getElementById('dd-exact').textContent = 0;
  document.getElementById('dd-resolved').textContent = parseInt(document.getElementById('dd-resolved').textContent) + count;
  renderDedupQueue();
  toast(`All ${count} records ${action === 'accept' ? 'accepted' : 'rejected'}`, action === 'reject' ? 'error' : 'success');
}

function runDedupScan() {
  toast('Running SHA-256 + fuzzy deduplication scan‚Ä¶', 'info');
  loadBar();
  setTimeout(() => {
    const n = Math.floor(Math.random() * 5 + 1);
    document.getElementById('dd-scanned').textContent = (parseInt(document.getElementById('dd-scanned').textContent.replace(/,/g,'')) + 500).toLocaleString();
    toast(`Scan complete ‚Äî ${n} new duplicate candidates found`, 'success');
    if (n > 0) renderDedupQueue();
  }, 2200);
}

// ============================================================
// GOVERNANCE
// ============================================================
function switchGovTab(tab, el) {
  document.querySelectorAll('#gov-tabs .tab').forEach(t => t.classList.remove('on'));
  if (el) el.classList.add('on');
  // Hide all governance panels
  ['gov-pipeline-panel','gov-files-panel','gov-audit-panel','gov-roles-panel'].forEach(id => {
    const p = document.getElementById(id);
    if (p) p.style.display = 'none';
  });
  // Show selected panel
  const panelId = 'gov-' + tab + '-panel';
  const panel = document.getElementById(panelId);
  if (panel) panel.style.display = '';
  // Init panel data
  if (tab === 'files') renderGovFilesPanel();
  if (tab === 'audit') renderAuditLog(AUDIT_ENTRIES);
  if (tab === 'pipeline') { renderGovPipe(); renderGovQueue(); }
}

function renderGovFilesPanel() {
  const el = document.getElementById('gov-files-list');
  if (!el) return;
  if (!INGESTED_FILES.length) {
    el.innerHTML = '<div style="font-size:11px;color:var(--t3);text-align:center;padding:24px">No files pending review. Upload files in Data Ingestion to see them here.</div>';
    return;
  }
  el.innerHTML = INGESTED_FILES.map(f => {
    const statusCol = f.status==='accepted'?'var(--green)':f.status==='rejected'?'var(--red)':'var(--amber)';
    const statusLbl = f.status==='accepted'?'Published':f.status==='rejected'?'Rejected':'Awaiting Review';
    return `<div style="padding:14px 16px;background:${f.status==='accepted'?'rgba(0,135,90,.04)':f.status==='rejected'?'rgba(217,48,37,.04)':'rgba(192,120,0,.04)'};border:1px solid ${f.status==='accepted'?'rgba(0,135,90,.2)':f.status==='rejected'?'rgba(217,48,37,.2)':'rgba(192,120,0,.2)'};border-radius:8px;margin-bottom:10px">
      <div style="display:flex;align-items:flex-start;gap:12px">
        <div style="font-size:24px;flex-shrink:0"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="var(--purple)" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
            <span style="font-size:12px;font-weight:700;color:var(--t1)">${f.name}</span>
            <span style="font-size:8px;font-weight:700;padding:2px 7px;border-radius:10px;background:${statusCol}15;color:${statusCol}">${statusLbl}</span>
          </div>
          <div style="font-size:10px;color:var(--t3);margin-bottom:8px">${f.records} records ¬∑ ${f.datasetType} ¬∑ Uploaded ${f.age} ¬∑ By ${f.source||'VJ'}</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px" id="fmeta-${f.id}"></div>
        </div>
        <div style="flex-shrink:0">
          ${f.status==='accepted'||f.status==='rejected' ? 
            `<span style="font-size:9px;color:${statusCol};font-weight:700">${statusLbl}</span>` :
            `<div style="display:flex;gap:5px">
              <button class="btn" style="padding:5px 12px;font-size:10px" onclick="fileGovAction('${f.id}','accept')">Accept & Publish</button>
              <button class="btn2 danger" style="padding:5px 10px;font-size:10px" onclick="fileGovAction('${f.id}','reject')">Reject</button>
              <button class="btn2" style="padding:5px 8px;font-size:10px;color:var(--red);border-color:rgba(217,48,37,.4)" onclick="fileGovAction('${f.id}','delete')">Delete</button>
            </div>`
          }
        </div>
      </div>
    </div>`;
  }).join('');
  // Update badge
  const pending = INGESTED_FILES.filter(f => !f.status || f.status === 'pending').length;
  const badge = document.getElementById('gov-files-badge');
  if (badge) badge.textContent = pending;
}

function renderGovPipe() {
  const stages = [
    {n:'Ingested',c:12906,act:false},
    {n:'Validated',c:12847,act:false},
    {n:'Flagged',c:3,act:true},
    {n:'Reviewed',c:12844,act:false},
    {n:'Approved',c:12840,act:false},
    {n:'Published',c:12840,act:false},
  ];
  document.getElementById('gov-pipe').innerHTML = stages.map((s,i) =>
    `<div class="gov-stage${s.act?' act':''}" onclick="highlightStage(${i})">
      <div class="gov-sn">${s.n}</div>
      <div class="gov-sc">${s.c.toLocaleString()}</div>
    </div>`
  ).join('');
}

function highlightStage(i) {
  document.querySelectorAll('.gov-stage').forEach((el, j) => {
    el.classList.toggle('act', j === i);
  });
  const stageNames = ['Ingested','Validated','Flagged for Review','Reviewer Approved','Custodian Approved','Published'];
  document.getElementById('queue-title').textContent = stageNames[i] + ' ‚Äî Records';
}

function renderGovQueue() {
  // Merge static GOV_QUEUE with dynamic INGESTED_FILES
  const fileRows = INGESTED_FILES.map(f => `
    <tr style="background:rgba(107,70,193,.04)">
      <td style="color:var(--purple);font-weight:700">FILE</td>
      <td style="font-weight:600;color:var(--t1)">${f.name}</td>
      <td style="color:var(--amber)">‚ü≥ Awaiting review ‚Äî ${f.records} records (${f.datasetType})</td>
      <td>${f.source}</td>
      <td style="color:var(--t3)">${f.age}</td>
      <td>
        <div style="display:flex;gap:4px">
          <button class="btn" style="padding:3px 10px;font-size:9px" onclick="fileGovAction('${f.id}','accept')">‚úì Accept</button>
          <button class="btn2 danger" style="padding:3px 8px;font-size:9px" onclick="fileGovAction('${f.id}','reject')">‚úó Reject</button>
          <button class="btn2" style="padding:3px 8px;font-size:9px;color:var(--red);border-color:var(--red)" onclick="fileGovAction('${f.id}','delete')">üóë</button>
        </div>
      </td>
    </tr>`).join('');
  const queueRows = GOV_QUEUE.map(r =>
    `<tr>
      <td style="color:var(--cyan);font-weight:700;cursor:pointer" onclick="showRecordDetail('${r.id}')">${r.id}</td>
      <td>${r.dataset}</td>
      <td style="color:${r.flagType==='error'?'var(--red)':'var(--amber)'}">${r.flagType==='error'?'‚úó':'‚ö†'} ${r.flag}</td>
      <td>${r.source}</td>
      <td style="color:var(--t3)">${r.age}</td>
      <td>
        <div style="display:flex;gap:5px">
          <button class="btn2" style="padding:3px 8px;font-size:9px" onclick="govAction('${r.id}','accept')">Accept</button>
          <button class="btn2" style="padding:3px 8px;font-size:9px" onclick="govAction('${r.id}','merge')">Merge</button>
          <button class="btn2 danger" style="padding:3px 8px;font-size:9px" onclick="govAction('${r.id}','reject')">Reject</button>
        </div>
      </td>
    </tr>`
  ).join('');
  document.getElementById('gov-queue').innerHTML = fileRows + queueRows;
  // Update badge count
  const total = INGESTED_FILES.length + GOV_QUEUE.length;
  const notif = document.querySelector('.sb-notif span');
  const badge = document.querySelector('.notif-count');
  if (notif) notif.textContent = `${total} item${total!==1?'s':''} need review`;
  if (badge) badge.textContent = total;
}

function fileGovAction(id, action) {
  const idx = INGESTED_FILES.findIndex(f => f.id === id);
  if (idx < 0) return;
  const f = INGESTED_FILES[idx];
  if (action === 'accept') {
    toast(`File "${f.name}" accepted ‚Äî ${f.records} records now visible in application`, 'success');
    AUDIT_ENTRIES.unshift({time:now(),user:'VJ',action:`File accepted: ${f.name} ¬∑ ${f.records} ${f.datasetType} records published`,status:'ACCEPTED',type:'Governance'});
    // Data already loaded ‚Äî mark as published
    f.status = 'accepted';
  } else if (action === 'reject') {
    toast(`File "${f.name}" rejected ‚Äî data removed from queue`, 'warning');
    AUDIT_ENTRIES.unshift({time:now(),user:'VJ',action:`File rejected: ${f.name} ¬∑ ${f.records} records removed`,status:'REJECTED',type:'Governance'});
    // Remove data that was loaded
    if (f.datasetType === 'Basin') {
      const toRemove = new Set(f.loadedNames || []);
      for (let i = BASINS.length - 1; i >= 0; i--) {
        if (toRemove.has(BASINS[i].name)) BASINS.splice(i, 1);
      }
      renderBasinTable(BASINS); renderTopBasins();
    } else if (f.datasetType === 'Analogue') {
      const toRemove = new Set(f.loadedNames || []);
      for (let i = ANALOGUES.length - 1; i >= 0; i--) {
        if (toRemove.has(ANALOGUES[i].name)) ANALOGUES.splice(i, 1);
      }
    }
  } else if (action === 'delete') {
    toast(`File "${f.name}" deleted from queue`, 'info');
  }
  if (action !== 'accept') INGESTED_FILES.splice(idx, 1);
  renderGovQueue();
  renderGovFilesPanel();
  renderAuditLog(AUDIT_ENTRIES);
  refreshPortfolioKPIs();
  if (action === 'accept') renderPortfolioMapMarkers();
}

function govAction(id, action) {
  const msgs = {accept:`Record ${id} accepted and queued for publication`,merge:`Record ${id} merged with existing production record`,reject:`Record ${id} rejected and removed from queue`};
  toast(msgs[action], action === 'reject' ? 'error' : 'success');
  const idx = GOV_QUEUE.findIndex(r => r.id === id);
  if (idx > -1) {
    GOV_QUEUE.splice(idx, 1);
    renderGovQueue();
    AUDIT_ENTRIES.unshift({time:now(),user:'VJ',action:`Governance: ${action.toUpperCase()} ‚Äî ${id}`,status:action.toUpperCase(),type:'Governance'});
    renderAuditLog(AUDIT_ENTRIES);
    // Update queue count
    document.querySelector('.sb-notif span').textContent = `${GOV_QUEUE.length} record${GOV_QUEUE.length!==1?'s':''} need review`;
    document.querySelector('.notif-count').textContent = GOV_QUEUE.length;
  }
}

function showRecordDetail(id) {
  const r = GOV_QUEUE.find(q => q.id === id);
  if (!r) return;
  openModal(`
    <div class="modal-title">${r.id} ‚Äî Record Detail</div>
    <div class="modal-sub">${r.dataset} &nbsp;¬∑&nbsp; ${r.source}</div>
    <div style="padding:10px 14px;background:rgba(255,77,106,.06);border:1px solid rgba(255,77,106,.2);border-radius:5px;margin-bottom:14px;font-size:11px">
      <strong style="color:var(--red)">Flag reason:</strong> <span style="color:var(--t2)">${r.flag}</span>
    </div>
    <table style="margin-bottom:16px"><tbody>
      <tr><td style="color:var(--t3)">Source</td><td style="color:var(--t1)">${r.source}</td></tr>
      <tr><td style="color:var(--t3)">Age in queue</td><td style="color:var(--t1)">${r.age}</td></tr>
      <tr><td style="color:var(--t3)">Flag type</td><td><span style="color:${r.flagType==='error'?'var(--red)':'var(--amber)'}">${r.flagType}</span></td></tr>
    </tbody></table>
    <div style="display:flex;gap:7px">
      <button class="btn" onclick="closeModal();govAction('${r.id}','accept')">Accept Record</button>
      <button class="btn2" onclick="closeModal();govAction('${r.id}','merge')">Merge</button>
      <button class="btn2 danger" onclick="closeModal();govAction('${r.id}','reject')">Reject</button>
    </div>
  `);
}

function renderAuditLog(entries) {
  const filter = document.getElementById('audit-filter')?.value || '';
  const filtered = filter ? entries.filter(e => e.type === filter) : entries;
  const colors = {SUCCESS:'var(--green)',FAILED:'var(--red)',MODIFIED:'var(--amber)',MERGED:'var(--cyan)'};
  document.getElementById('audit-tbody').innerHTML = filtered.map(e =>
    `<tr>
      <td class="a-time">${e.time}</td>
      <td class="a-user">${e.user}</td>
      <td class="a-act">${e.action}</td>
      <td style="color:${colors[e.status]||'var(--t3)'};font-size:9px;font-weight:700">${e.status}</td>
    </tr>`
  ).join('');
}

function filterAudit() { renderAuditLog(AUDIT_ENTRIES); }

// ============================================================
// NLP
// ============================================================
const NLP_SUGGESTIONS = [
  'Show me all Eocene sandstone reservoirs >3000m SE Asia API >30¬∞',
  'What basins in North Africa have gas plays with water drive?',
  'Find analogues similar to Malay Basin Miocene deltaic sandstones',
  'Carbonate reservoirs with RF >40% in Middle East',
  'Which frontier basins have prospectivity score >60?',
];

const NLP_RESPONSES = {
  'eocene sandstone': {text: 'Found <strong>12 reservoir intervals</strong> matching Eocene sandstone, SE Asia, >3000m depth, API >30¬∞', tags:['Kutei Basin','Malay Basin','Borneo Basin','View Results ‚Üí']},
  'north africa gas': {text: 'Found <strong>8 basins</strong> in North Africa with active gas plays, water drive mechanism', tags:['Nile Delta','Murzuq Basin','View Basins ‚Üí']},
  'analogue malay': {text: 'Top analogues for Malay Basin: Kutei Basin (87%), Borneo Basin (79%), Niger Delta (72%)', tags:['View Cross-Plot ‚Üí','Run Analogue Search ‚Üí']},
  'carbonate': {text: 'Found <strong>156 carbonate reservoir intervals</strong> with RF >40% in Middle East. Dominant: Zagros Fold Belt', tags:['Zagros Fold Belt','Persian Gulf','Export Results ‚Üí']},
  'frontier': {text: 'Found <strong>43 frontier basins</strong> with prospectivity >60. Top: East Greenland (63), Browse Basin (63), Barents Sea (58)', tags:['View Screening ‚Üí']},
};

function nlpSuggest(q) {
  const sug = document.getElementById('nlp-sug');
  if (!q || q.length < 3) { sug.style.display = 'none'; return; }
  const matches = NLP_SUGGESTIONS.filter(s => s.toLowerCase().includes(q.toLowerCase())).slice(0,4);
  if (!matches.length) { sug.style.display = 'none'; return; }
  sug.style.display = 'block';
  sug.innerHTML = matches.map(s =>
    `<div class="nlp-sug-item" onclick="executeNLP('${s}')">${s.replace(new RegExp(q,'gi'), m => `<strong style="color:var(--cyan)">${m}</strong>`)}</div>`
  ).join('');
}

function showSuggestions() {
  if (!document.getElementById('nlp-input').value) {
    const sug = document.getElementById('nlp-sug');
    sug.style.display = 'block';
    sug.innerHTML = NLP_SUGGESTIONS.slice(0,4).map(s =>
      `<div class="nlp-sug-item" onclick="executeNLP('${s}')">${s} <span>‚Üµ</span></div>`
    ).join('');
  }
}

function hideSuggestions() { document.getElementById('nlp-sug').style.display = 'none'; }

function nlpKey(e) {
  if (e.key === 'Enter') {
    executeNLP(document.getElementById('nlp-input').value);
    document.getElementById('nlp-sug').style.display = 'none';
  }
}

function executeNLP(q) {
  document.getElementById('nlp-input').value = q;
  hideSuggestions();
  loadBar();
  setTimeout(() => {
    const qLow = q.toLowerCase();
    let resp = NLP_RESPONSES[Object.keys(NLP_RESPONSES).find(k => qLow.includes(k))] || {
      text: `Query processed. Found <strong>${Math.floor(Math.random()*20+5)} results</strong> matching "${q.slice(0,60)}"`,
      tags:['View Results ‚Üí','Run Analogue Search ‚Üí','Export ‚Üí']
    };
    document.getElementById('nlp-q').textContent = '‚¨° AI Query: ' + q;
    document.getElementById('nlp-a').innerHTML = resp.text;
    document.getElementById('nlp-tags').innerHTML = resp.tags.map(t =>
      `<span class="nlp-result-tag" onclick="handleTagClick('${t}')">${t}</span>`
    ).join('');
    const panel = document.getElementById('nlp-result');
    panel.classList.add('show');
    document.querySelector('.content').classList.add('nlp-open');
    toast('NLP query processed successfully', 'success');
  }, 600);
}

function handleTagClick(tag) {
  if (tag.includes('Analogue')) goTo('analogues', null);
  else if (tag.includes('Screening') || tag.includes('Basin')) goTo('screening', null);
  else if (tag.includes('Cross')) { goTo('analogues', null); setTimeout(() => switchAnalogueTab('similarity'), 400); }
  else goTo('analogues', null);
}

// ============================================================
// HELPERS
// ============================================================
function showAlerts() {
  openModal(`
    <div class="modal-title" style="display:flex;align-items:center;gap:8px"><svg viewBox="0 0 16 16" width="16" height="16" fill="none" stroke="var(--purple)" stroke-width="1.5"><path d="M8 2a5 5 0 0 1 5 5v2l1.5 2.5h-13L3 9V7a5 5 0 0 1 5-5z"/><path d="M6.5 13.5a1.5 1.5 0 0 0 3 0"/></svg> Active Alerts</div>
    <div class="modal-sub" style="margin-bottom:14px">${GOV_QUEUE.length} records require your attention</div>
    ${GOV_QUEUE.map(r => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg4);border-radius:5px;margin-bottom:8px;cursor:pointer" onclick="closeModal();goTo('governance',null)">
        <span style="color:${r.flagType==='error'?'var(--red)':'var(--amber)'};font-size:18px">${r.flagType==='error'?'‚úó':'‚ö†'}</span>
        <div style="flex:1">
          <div style="font-size:11px;font-weight:700;color:var(--t1)">${r.id} ‚Äî ${r.dataset}</div>
          <div style="font-size:10px;color:var(--t3)">${r.flag}</div>
        </div>
        <span style="font-size:9px;color:var(--t3)">${r.age}</span>
      </div>`).join('')}
    <button class="btn" style="margin-top:6px" onclick="closeModal();goTo('governance',null)">Go to Governance ‚Üí</button>
  `);
}

const HELP_MODULES = {
  portfolio: {
    icon:'grid', title:'Portfolio Dashboard', color:'var(--cyan)',
    short:'High-level portfolio overview with live KPIs, GIS map and activity feed.',
    detail:`<h3>Portfolio Dashboard</h3>
      <p>The Dashboard gives you an instant read on your entire basin portfolio. Four KPI cards track active basins, analogue intervals, average prospectivity score, and data quality in real time ‚Äî updating automatically when you ingest new data.</p>
      <p><strong>Global GIS Map:</strong> An interactive Leaflet map shows every basin as a coloured circle marker. Green = high prospectivity (‚â•70), amber = moderate (40‚Äì69), red = low (&lt;40). Click any marker for a popup with key attributes and quick-action buttons.</p>
      <p><strong>Resource Summary tab:</strong> Displays P10/P50/P90 STOIIP ranges by basin group and HC phase breakdown chart.</p>
      <p><strong>Risk Profile tab:</strong> GCoS distribution across your portfolio and a risk radar summary.</p>
      <p><strong>Activity Feed:</strong> Live stream of all actions ‚Äî ingestion, searches, governance decisions ‚Äî with timestamps.</p>`
  },
  basins: {
    icon:'layers', title:'Basin Catalogue', color:'var(--brand)',
    short:'Browse, filter and export 612+ global sedimentary basins.',
    detail:`<h3>Basin Catalogue</h3>
      <p>The Catalogue stores all your basin records with full attribute detail including country, region, tectonic setting, geological age, HC phase, area, play count, prospectivity score and status.</p>
      <p><strong>Browse & Filter:</strong> Use the search bar and dropdown filters to narrow basins by region, HC phase, tectonic setting and status. Sortable columns let you rank by prospectivity score, area or play count.</p>
      <p><strong>Stratigraphic tab:</strong> Hand-crafted formation columns for 7 key basins with lithology swatches, thickness data, HC role badges (Reservoir / Source / Seal) and seal quality ratings.</p>
      <p><strong>Export tab:</strong> Export selected basins in CSV, JSON, GeoJSON (for QGIS/ArcGIS), Excel, or via API endpoint. Use the field toggles to customise which columns are included.</p>
      <p><strong>Tip:</strong> Click any basin row to open a detailed profile modal with analogue search and risk assessment shortcuts.</p>`
  },
  analogues: {
    icon:'zap', title:'Analogue Engine', color:'var(--purple)',
    short:'Find statistically similar reservoir analogues using weighted fuzzy matching.',
    detail:`<h3>Analogue Engine</h3>
      <p>Define your Target Reservoir Profile ‚Äî lithology, age, depth range, HC phase, porosity, permeability, recovery factor, NTG ‚Äî and EDAFY computes a weighted similarity score against all ${ANALOGUES.length}+ analogue intervals in the database.</p>
      <p><strong>Similarity Score:</strong> Uses fuzzy matching with configurable weights. Categorical fields (lithology, HC phase, dep. env.) use exact + partial matching. Numeric fields use normalised distance scoring. Final score is a weighted average across all 8 parameters.</p>
      <p><strong>Cross-Plot tab:</strong> Interactive scatter plot of any two reservoir parameters. Toggle axes, export as PNG. Trend line computed automatically.</p>
      <p><strong>Compare tab:</strong> Select up to 5 analogues and view side-by-side parameter comparison. Export as CSV.</p>
      <p><strong>Detail panels:</strong> Each analogue has 6 sub-tabs ‚Äî Reservoir, Geopressure, Geochemistry, Mineralogy, Fluid PVT, Diagenesis ‚Äî with all ingested parameters.</p>`
  },
  risk: {
    icon:'shield', title:'Risk & Uncertainty', color:'var(--green)',
    short:'GCoS Calculator, Volumetric STOIIP, and Sensitivity Analysis.',
    detail:`<h3>Risk & Uncertainty Module</h3>
      <p><strong>GCoS Calculator:</strong> SPE-PRMS compliant Geological Chance of Success calculator. Five risk element sliders (Source, Reservoir, Seal, Trap, Migration) multiply together to give the composite GCoS. The radar chart compares your estimate against analogue benchmarks. Colour-coded HIGH/MODERATE/LOW confidence bands are shown automatically.</p>
      <p><strong>Prospect Dropdown:</strong> Select from named prospects in your portfolio to load and save GCoS estimates per prospect.</p>
      <p><strong>Volumetric Calculator:</strong> STOIIP/GIIP formula with P10/P50/P90 ranges. Input GRV, NTG, porosity, water saturation, formation volume factor and recovery factor. Results update in real time.</p>
      <p><strong>Sensitivity Analysis:</strong> Editable P10/P50/P90 parameter tables drive a live tornado chart and spider chart. Identifies which parameters contribute most to volumetric uncertainty.</p>
      <p><strong>Exports:</strong> GCoS PDF (CPR template), Sensitivity CSV and PDF, Monte Carlo STOIIP CPR template.</p>`
  },
  screening: {
    icon:'bar-chart', title:'Basin Screening', color:'var(--gold)',
    short:'Weighted multi-criteria scoring to rank your portfolio.',
    detail:`<h3>Basin Screening</h3>
      <p>Configure up to 8 weighted criteria ‚Äî prospectivity score, HC phase preference, play count, area, tectonic setting, depth threshold, status ‚Äî then run the screener to generate a ranked leaderboard with podium-style medals for the top 3.</p>
      <p><strong>Leaderboard:</strong> Sortable ranked table with composite score bars. Click any basin to open a detailed profile. Export as PDF.</p>
      <p><strong>Basin Profiles tab:</strong> Select any basin from the dropdown for a full attribute profile plus analogue count and GCoS estimate.</p>
      <p><strong>Save & Load:</strong> Save screening configurations by name. Re-run on demand when new data is ingested.</p>
      <p><strong>Tip:</strong> Use basin screening to shortlist your next exploration campaign. Combine with the Analogue Engine to identify reservoir performance benchmarks for your top-ranked basins.</p>`
  },
  ingestion: {
    icon:'data', title:'Data Ingestion', color:'var(--amber)',
    short:'Ingest CSV/Excel data across 8 dataset types.',
    detail:`<h3>Data Ingestion</h3>
      <p>EDAFY supports two ingestion pathways:</p>
      <p><strong>Unified Upload:</strong> A single master CSV with any combination of Basin, Analogue, Reservoir, Geopressure, Geochemistry, Mineralogy, Fluid PVT and Diagenesis columns. EDAFY auto-detects and routes each column group. Download the master template, fill in the columns you have, and upload. Multiple files can be loaded sequentially ‚Äî each adds to the dataset.</p>
      <p><strong>Individual Dataset Tabs:</strong> Dedicated upload zones for each of the 8 dataset types with specialised column mapping, validation and preview.</p>
      <p><strong>Column Mapping Modal:</strong> For each upload, a mapping dialog lets you confirm which source columns map to which EDAFY fields. Auto-mapping is applied first based on column name matching.</p>
      <p><strong>Governance Integration:</strong> All ingested files are routed to the Governance pipeline for review before being published into the application. You can accept, reject or delete each file from the Governance tab.</p>
      <p><strong>Vendor Connectors:</strong> Automated feeds from Neftex (SFTP), IHS Energy, C&C Reservoirs, Rystad and Wood Mackenzie. Configure SFTP/API credentials per connector.</p>`
  },
  governance: {
    icon:'check-square', title:'Governance', color:'var(--red)',
    short:'Data quality pipeline, governance review and audit trail.',
    detail:`<h3>Governance & Data Quality</h3>
      <p><strong>Pipeline:</strong> All data flows through a 6-stage governance pipeline ‚Äî Ingested ‚Üí Validated ‚Üí Flagged ‚Üí Reviewed ‚Üí Approved ‚Üí Published. Counts update in real time as records move through the pipeline.</p>
      <p><strong>Ingested Files Queue:</strong> Every file you upload appears in the governance queue for review before going live. You can Accept (publish data into the application), Reject (remove data and roll back), or Delete from queue.</p>
      <p><strong>Record-level Flags:</strong> Automatic quality checks flag records with missing required fields, outlier values, schema violations or near-duplicates. Each flag shows the reason, source and age in queue.</p>
      <p><strong>Audit Log:</strong> Complete immutable log of all actions ‚Äî uploads, searches, governance decisions, GCoS saves, connector syncs ‚Äî with timestamps and user identity (VJ). Filter by action type. Export as CSV.</p>
      <p><strong>Dedup Queue:</strong> SHA-256 based deduplication engine flags near-duplicate and exact-duplicate records for merge or rejection.</p>`
  },
  params: {
    icon:'activity', title:'Parameter Library', color:'var(--cyan)',
    short:'Statistical distributions and Monte Carlo simulation.',
    detail:`<h3>Parameter Library</h3>
      <p><strong>Distributions tab:</strong> View fitted statistical distributions (Normal, Log-Normal, Triangular) for 6 key reservoir parameters across the full analogue database. Enter your own value to see which percentile it falls at and how it compares to the analogue benchmark.</p>
      <p><strong>Monte Carlo tab:</strong> Configure input distributions (P10/P50/P90) for GRV, NTG, porosity, Sw, FVF, and recovery factor. Run 10,000 iterations to generate a STOIIP probability distribution with histogram and P10/P50/P90 output statistics.</p>
      <p><strong>Correlation Matrix:</strong> Define parameter correlations (e.g. positive correlation between porosity and permeability) to avoid unrealistic input combinations.</p>
      <p><strong>Export CPR Template:</strong> Generate a SPE-PRMS compliant CPR template PDF from Monte Carlo results, ready for peer review by a qualified Competent Person.</p>`
  }
};

async function showHelp(section) {
  if (section && HELP_MODULES[section]) {
    const m = HELP_MODULES[section];
    openModal(`
      <div class="modal-title" style="display:flex;align-items:center;gap:10px">
        <span style="width:10px;height:10px;border-radius:50%;background:${m.color};display:inline-block"></span> ${m.title}
      </div>
      <div style="font-size:11px;line-height:1.7;color:var(--t2);max-height:50vh;overflow-y:auto;padding-right:4px;margin-bottom:12px">
        ${m.detail}
      </div>
      <div style="background:rgba(107,70,193,.04);border:1px solid rgba(107,70,193,.15);border-radius:8px;padding:10px 12px;margin-bottom:12px">
        <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Ask AI about this module</div>
        <div style="display:flex;gap:7px">
          <input class="fc" id="help-ai-q" placeholder="e.g. How do I improve my analogue match scores?" style="flex:1;font-size:11px;padding:6px 10px">
          <button class="btn" style="padding:6px 14px;font-size:10px" onclick="askHelpAI('${section}')">Ask</button>
        </div>
        <div id="help-ai-answer" style="margin-top:8px;font-size:11px;line-height:1.6;color:var(--t2);display:none"></div>
      </div>
      <div style="margin-top:6px;display:flex;gap:7px">
        <button class="btn2" onclick="showHelp()">‚Üê All Modules</button>
        <button class="btn" onclick="closeModal()">Close</button>
      </div>`);
    return;
  }
  openModal(`
    <div class="modal-title" style="display:flex;align-items:center;gap:8px">
      <span style="background:linear-gradient(135deg,#6B46C1,#0088CC);color:#fff;padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700">?</span>
      EDAFY Platform Help
    </div>
    <div class="modal-sub" style="margin-bottom:10px">Click any module for detailed documentation. Use AI to ask questions.</div>
    <div style="background:rgba(107,70,193,.04);border:1px solid rgba(107,70,193,.15);border-radius:8px;padding:10px 12px;margin-bottom:12px">
      <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px">Ask EDAFY AI Assistant</div>
      <div style="display:flex;gap:7px">
        <input class="fc" id="help-ai-q-main" placeholder="e.g. How do I export a basin leaderboard PDF?" style="flex:1;font-size:11px;padding:6px 10px">
        <button class="btn" style="padding:6px 14px;font-size:10px" onclick="askHelpAIMain()">Ask</button>
      </div>
      <div id="help-ai-answer-main" style="margin-top:8px;font-size:11px;line-height:1.6;color:var(--t2);display:none"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;max-height:55vh;overflow-y:auto">
      ${Object.entries(HELP_MODULES).map(([key, m]) => `
        <div onclick="showHelp('${key}')" style="padding:12px 14px;background:var(--bg4);border-radius:8px;cursor:pointer;border:1.5px solid transparent;transition:all .18s;user-select:none"
          onmouseenter="this.style.borderColor='${m.color}';this.style.background='${m.color}0A'"
          onmouseleave="this.style.borderColor='transparent';this.style.background='var(--bg4)'">
          <div style="font-size:11px;font-weight:700;color:${m.color};margin-bottom:4px">${m.title}</div>
          <div style="font-size:9.5px;color:var(--t3);line-height:1.5">${m.short}</div>
          <div style="font-size:9px;color:${m.color};margin-top:5px;font-weight:600">Read more ‚Üí</div>
        </div>`).join('')}
    </div>`);
}

async function askHelpAI(section) {
  const q = document.getElementById('help-ai-q')?.value?.trim();
  if (!q) return;
  const answerEl = document.getElementById('help-ai-answer');
  if (!answerEl) return;
  answerEl.style.display = 'block';
  answerEl.innerHTML = '<span style="color:var(--purple);animation:pulse 1s infinite">Thinking‚Ä¶</span>';
  const m = HELP_MODULES[section];
  const answer = await callClaudeAI(
    `The user is using EDAFY (a petroleum exploration platform) and is asking about the "${m?.title}" module: "${q}"`,
    'You are an EDAFY platform expert. Answer the user\'s question about the specific module concisely (2-3 sentences). Be practical and specific. If you reference UI elements, describe them precisely.'
  );
  answerEl.innerHTML = answer || 'Try asking again or refer to the documentation above.';
}

async function askHelpAIMain() {
  const q = document.getElementById('help-ai-q-main')?.value?.trim();
  if (!q) return;
  const answerEl = document.getElementById('help-ai-answer-main');
  if (!answerEl) return;
  answerEl.style.display = 'block';
  answerEl.innerHTML = '<span style="color:var(--purple);animation:pulse 1s infinite">Thinking‚Ä¶</span>';
  const answer = await callClaudeAI(
    `The user is using EDAFY (a geo-basin petroleum exploration intelligence platform) and asks: "${q}"`,
    'You are an EDAFY platform expert and petroleum exploration assistant. Answer the user\'s question concisely (2-3 sentences). Be practical. EDAFY modules: Portfolio Dashboard, Basin Catalogue, Analogue Engine, Parameter Library, Risk & Uncertainty (GCoS), Basin Screening, Data Ingestion, Governance.'
  );
  answerEl.innerHTML = answer || 'Please try rephrasing your question.';
}

function exportTable(tableId, name) {
  // Real CSV export from any table element
  const table = document.getElementById(tableId);
  if (!table) { toast(`Table "${tableId}" not found`, 'warning'); return; }
  const rows = [...table.querySelectorAll('tr')];
  const csv = rows.map(row =>
    [...row.querySelectorAll('th,td')].map(cell => {
      const t = cell.textContent.replace(/\s+/g,' ').trim();
      return t.includes(',') || t.includes('"') ? `"${t.replace(/"/g,'""')}"` : t;
    }).join(',')
  ).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `edafy_${name}_${Date.now()}.csv`;
  a.click();
  toast(`${name} exported as CSV`, 'success');
}

// exportComparison defined in PDF engine above
function exportComparisonCSV() {
  // Get the comparison table from DOM
  const tbl = document.querySelector('#ana-compare-panel table');
  if (!tbl) { toast('No comparison table to export ‚Äî run a search and select analogues first', 'warning'); return; }
  const rows = [...tbl.querySelectorAll('tr')];
  const csv = rows.map(row =>
    [...row.querySelectorAll('th,td')].map(c => {
      const t = c.textContent.replace(/\s+/g,' ').trim();
      return t.includes(',') ? `"${t}"` : t;
    }).join(',')
  ).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `edafy_analogue_comparison_${Date.now()}.csv`;
  a.click();
  toast('Comparison table exported as CSV', 'success');
}

function exportComparisonExcel() {
  const tbl = document.querySelector('#ana-compare-panel table');
  if (!tbl) { toast('No comparison table ‚Äî run a search and select analogues first', 'warning'); return; }
  if (typeof XLSX === 'undefined') { toast('Excel library loading ‚Äî try again in a moment', 'warning'); return; }
  const ws = XLSX.utils.table_to_sheet(tbl);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Analogue Comparison');
  // Add metadata sheet
  const meta = XLSX.utils.aoa_to_sheet([
    ['EDAFY Analogue Comparison Export'],
    ['Generated:', new Date().toLocaleString()],
    ['User:', 'VJ ‚Äî Exploration Geologist, AFED Digital'],
    ['Platform:', 'EDAFY v2026.1']
  ]);
  XLSX.utils.book_append_sheet(wb, meta, 'Metadata');
  XLSX.writeFile(wb, `edafy_analogue_comparison_${Date.now()}.xlsx`);
  toast('Comparison table exported as Excel (.xlsx)', 'success');
}

function exportTableExcel(tableId, sheetName, filename) {
  const tbl = document.getElementById(tableId);
  if (!tbl) { toast(`Table "${tableId}" not found`, 'warning'); return; }
  if (typeof XLSX === 'undefined') { exportTable(tableId, filename||sheetName); return; }
  const ws = XLSX.utils.table_to_sheet(tbl);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName || 'Data');
  XLSX.writeFile(wb, `edafy_${filename||sheetName}_${Date.now()}.xlsx`);
  toast(`${sheetName} exported as Excel`, 'success');
}
</script>
</body>
</html>
